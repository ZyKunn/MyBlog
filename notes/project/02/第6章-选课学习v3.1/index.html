<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.63">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="./img/logo.png"><title>第 6 章 选课学习 v3.1 | ZyKunのBlog</title><meta name="description" content="">
    <link rel="preload" href="/MyBlog/assets/style-57272a59.css" as="style"><link rel="stylesheet" href="/MyBlog/assets/style-57272a59.css">
    <link rel="modulepreload" href="/MyBlog/assets/app-a153c100.js"><link rel="modulepreload" href="/MyBlog/assets/index.html-389e66df.js"><link rel="modulepreload" href="/MyBlog/assets/index.html-7f689b28.js"><link rel="prefetch" href="/MyBlog/assets/index.html-ab0151fa.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1249ab5a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4d02565e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1c68c797.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-93acf26d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2bc953d6.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0c526d7c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-636c9f52.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d4177c6b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7624decc.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d0b4a798.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-aa378d7b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ddd44d65.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-adbb7f41.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-34576599.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1079a374.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-88d4ebe7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5e927142.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9a6f13b8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4c85da23.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-69e813d7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-545062a2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-bd7a4fcb.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-910949e0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-459b0c71.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9a036060.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f62ffe74.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-841a86c0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b31c8bb6.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-85bae056.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-73555735.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6d5456cd.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d2dfbeec.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-746091c2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9cc627ff.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d411448a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4454f425.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-57aa84f4.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2ce52087.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-76657200.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-90d9409e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4d6ba5e7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-41bc7856.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6140daf4.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ea30461d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-00114784.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f3fa86cb.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-386f0bd2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b46ac77e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-256a258e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4ebf55b3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7268161e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5a8852c0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-19373782.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4e33bb6b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-de5ff178.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fd5da14a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-dbee5a73.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-64025c89.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9bd15ac7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4812edff.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1f3f5c2b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-3f85e131.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1d66d048.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-67b1b38e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-17f10f72.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ad1b5dc8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b14e7669.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fa35810b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-acb9b7bf.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f2ba9a88.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-abdb28e5.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b3cc33e9.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ef13eee8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-73fa0dcc.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6f7449c7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-3857ef8d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e5af1d8f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d5d14c1f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-94a8b9a2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-3931e4d3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0978879b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-617bd5bf.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4fe008c8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0e33aa95.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-00725025.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8e05ec6e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-72ca6b4c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-427c5181.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-3b3baf42.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-40a790c3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9709e7c9.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8eb00d02.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0c849262.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-eda16f63.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-81242655.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2c9f6820.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-79188b74.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5775eee0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-eff0510c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-305de307.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e83a5de7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-761a9548.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-c12ae66e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-87a73e5c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d720473a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b960b5b6.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-bbd98f93.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-76195dca.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-3bd0cfa7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8c87d147.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-bac2e853.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1ee6bc34.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ab7381d6.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5b97f6b8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fd33ca6f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-684189de.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-63731ad7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-895bfca1.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6d1ff4c2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b71bf26f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ce6f983b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-c185f9a2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-29c62d64.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-52c91de2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-55aa1c06.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-c87ef63a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ff1d9f51.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-a12aedeb.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-298f19f2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f881f599.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2c32406a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d4217479.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7edb7ce1.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8671126f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-da565d04.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f9deb3ec.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ee7cf1b5.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-270d6327.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ec786b75.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e98adf02.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7233a0e2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-79c193cf.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9714081e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d5dea51d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-a235e4bb.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e3209a23.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-cdce2101.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-652ee4f6.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-025e6f4e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-60711e70.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6edc93de.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-11bd39b1.js" as="script"><link rel="prefetch" href="/MyBlog/assets/404.html-60b35caa.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-53015219.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-74dcd8ae.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2dd727db.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-11b329fb.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-3b6f3614.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-70ce719f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f6ca4d92.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5a6833de.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-bf03220c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-a2edab58.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f1e5cf7a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-21d4e18d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5235fca9.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2dc704c0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-57630906.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ff165209.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6ec253a3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f9e4f0c3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-664b232d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-adf015a3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4667c0e6.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-cc407710.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1752d212.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9b5d99c4.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-43c48ae2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e8a616b7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-93e7405b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-22a72a56.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-42ce3023.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f8eeab22.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-dd50991a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-af520db8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5ab2bfac.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-965bc04f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-81ebef01.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-79d19f4d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9600bdfb.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-560df48d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4fb22a4f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-bd4caa82.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-370323f9.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f673ebfa.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-78d88460.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8b54347c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d30f0340.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e26bc4de.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7d37b036.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-3aa565ce.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4c69f238.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-76d60030.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7116a5e4.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d8f649cc.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-adbbb7c9.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-90bb86fd.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e23936a3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-19ad952b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-07245162.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-038b3afd.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-084fe5c1.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-098421fe.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7baefce4.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fffdfb9c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d8c9612c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-05c42fda.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e1615934.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-da824146.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fa2d32f0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-545dbea7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f3ca58cb.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b9e2188a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4fc5f1f7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1ec5c70d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-cbf2aa55.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8beb0c08.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ee54da9f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fd28b91d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-98aa51a1.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-03f9381a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2c9009c5.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-71b7cfbe.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1759170e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-aa84186f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-53160af7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-51b685b4.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ecb8e229.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9c507901.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-c6362722.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-faf67dd8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d7f20950.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-a088985c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-93b7982c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b76e6179.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d976d39c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b16efd78.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1301757e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-c3240cbe.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-a2ddd21c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-74fb5e20.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-128f5026.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8fd9f38a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-82e84e23.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-007ef014.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f3dd860c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-382a2bae.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7b6beaec.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2eb17cfa.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-c6f50213.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0c8aef39.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-133f4d38.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-cffd2be1.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-a798219d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6b5fde77.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-13275b71.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4b6a02c3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7f179a12.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f45bc33f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0574e5e5.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0921816f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-631fbc02.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8586017d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-c4dbf09b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-967486c0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-aad17dde.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ff644d77.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-78a4df64.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8d2180e8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-53fbcd20.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-a3387e5e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-979f5ac4.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0938c506.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-51707e22.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b1e917a0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6b56a071.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d15eb498.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7b0a97c0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fda196b5.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-bcc5faac.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-490c208f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-dce28479.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-62825d3c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b5a4af15.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-eb40da96.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8d6d1c61.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-618cf3f0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f2a35430.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-64f564d2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-bca2187b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-85181f96.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-62aa623a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b0c39cc5.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-73b8fff0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5466ae58.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fbd0bcfa.js" as="script"><link rel="prefetch" href="/MyBlog/assets/404.html-5f041a2b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/style-e9220a04.js" as="script"><link rel="prefetch" href="/MyBlog/assets/docsearch-1d421ddb.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index-5161ad19.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/MyBlog/" class=""><!----><span class="site-name can-hide">ZyKunのBlog</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/MyBlog/" class="" aria-label="🌱Home"><!--[--><!--]--> 🌱Home <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🥝Java"><span class="title">🥝Java</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🥝Java"><span class="title">🥝Java</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/01/" class="" aria-label="基础语法"><!--[--><!--]--> 基础语法 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/02/" class="" aria-label="面向对象编程"><!--[--><!--]--> 面向对象编程 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/03/" class="" aria-label="常用类&amp;集合框架"><!--[--><!--]--> 常用类&amp;集合框架 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/04/" class="" aria-label="JDBC"><!--[--><!--]--> JDBC <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/05/" class="" aria-label="Java高级"><!--[--><!--]--> Java高级 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/06/" class="" aria-label="JavaWeb"><!--[--><!--]--> JavaWeb <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🐍Python"><span class="title">🐍Python</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🐍Python"><span class="title">🐍Python</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/python/01/" class="" aria-label="Python入门"><!--[--><!--]--> Python入门 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🌋微服务"><span class="title">🌋微服务</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🌋微服务"><span class="title">🌋微服务</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/microservices/01/" class="" aria-label="实用篇"><!--[--><!--]--> 实用篇 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/microservices/02/" class="" aria-label="高级篇"><!--[--><!--]--> 高级篇 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/MyBlog/notes/mysql/" class="" aria-label="🍓Mysql"><!--[--><!--]--> 🍓Mysql <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🍤前端"><span class="title">🍤前端</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🍤前端"><span class="title">🍤前端</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/01/" class="" aria-label="HTML&amp;CSS"><!--[--><!--]--> HTML&amp;CSS <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/02/" class="" aria-label="JavaScript"><!--[--><!--]--> JavaScript <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/03/" class="" aria-label="JQuery"><!--[--><!--]--> JQuery <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/04/" class="" aria-label="Layui"><!--[--><!--]--> Layui <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/05/" class="" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🎢Project"><span class="title">🎢Project</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🎢Project"><span class="title">🎢Project</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/project/01/" class="" aria-label="Reggie"><!--[--><!--]--> Reggie <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/project/02/" class="router-link-active" aria-label="51XueCheng"><!--[--><!--]--> 51XueCheng <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/MyBlog/notes/record/" class="" aria-label="🍍随笔"><!--[--><!--]--> 🍍随笔 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/ZyKunn" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!--[--><div id="docsearch-container" style="display:none;"></div><div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"><svg width="15" height="15" class="DocSearch-Control-Key-Icon"><path d="M4.505 4.496h2M5.505 5.496v5M8.216 4.496l.055 5.993M10 7.5c.333.333.5.667.5 1v2M12.326 4.5v5.996M8.384 4.496c1.674 0 2.116 0 2.116 1.5s-.442 1.5-2.116 1.5M3.205 9.303c-.09.448-.277 1.21-1.241 1.203C1 10.5.5 9.513.5 8V7c0-1.57.5-2.5 1.464-2.494.964.006 1.134.598 1.24 1.342M12.553 10.5h1.953" stroke-width="1.2" stroke="currentColor" fill="none" stroke-linecap="square"></path></svg></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/MyBlog/" class="" aria-label="🌱Home"><!--[--><!--]--> 🌱Home <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🥝Java"><span class="title">🥝Java</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🥝Java"><span class="title">🥝Java</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/01/" class="" aria-label="基础语法"><!--[--><!--]--> 基础语法 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/02/" class="" aria-label="面向对象编程"><!--[--><!--]--> 面向对象编程 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/03/" class="" aria-label="常用类&amp;集合框架"><!--[--><!--]--> 常用类&amp;集合框架 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/04/" class="" aria-label="JDBC"><!--[--><!--]--> JDBC <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/05/" class="" aria-label="Java高级"><!--[--><!--]--> Java高级 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/06/" class="" aria-label="JavaWeb"><!--[--><!--]--> JavaWeb <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🐍Python"><span class="title">🐍Python</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🐍Python"><span class="title">🐍Python</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/python/01/" class="" aria-label="Python入门"><!--[--><!--]--> Python入门 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🌋微服务"><span class="title">🌋微服务</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🌋微服务"><span class="title">🌋微服务</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/microservices/01/" class="" aria-label="实用篇"><!--[--><!--]--> 实用篇 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/microservices/02/" class="" aria-label="高级篇"><!--[--><!--]--> 高级篇 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/MyBlog/notes/mysql/" class="" aria-label="🍓Mysql"><!--[--><!--]--> 🍓Mysql <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🍤前端"><span class="title">🍤前端</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🍤前端"><span class="title">🍤前端</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/01/" class="" aria-label="HTML&amp;CSS"><!--[--><!--]--> HTML&amp;CSS <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/02/" class="" aria-label="JavaScript"><!--[--><!--]--> JavaScript <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/03/" class="" aria-label="JQuery"><!--[--><!--]--> JQuery <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/04/" class="" aria-label="Layui"><!--[--><!--]--> Layui <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/05/" class="" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🎢Project"><span class="title">🎢Project</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🎢Project"><span class="title">🎢Project</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/project/01/" class="" aria-label="Reggie"><!--[--><!--]--> Reggie <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/project/02/" class="router-link-active" aria-label="51XueCheng"><!--[--><!--]--> 51XueCheng <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/MyBlog/notes/record/" class="" aria-label="🍍随笔"><!--[--><!--]--> 🍍随笔 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/ZyKunn" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/MyBlog/notes/project/02/" class="router-link-active sidebar-item sidebar-heading active" aria-label="51XueCheng"><!--[--><!--]--> 51XueCheng <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a href="/MyBlog/notes/project/02/%E7%AC%AC1%E7%AB%A0-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D_%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BAv3.1/" class="sidebar-item" aria-label="第 1 章 项目介绍&amp;环境搭建 v3.1"><!--[--><!--]--> 第 1 章 项目介绍&amp;环境搭建 v3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E7%AC%AC2%E7%AB%A0-%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/" class="sidebar-item" aria-label="第 2 章 内容管理模块 v3.1"><!--[--><!--]--> 第 2 章 内容管理模块 v3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/" class="sidebar-item" aria-label="第 3 章媒资管理模块 v3.1"><!--[--><!--]--> 第 3 章媒资管理模块 v3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E7%AC%AC4%E7%AB%A0-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83v3.1/" class="sidebar-item" aria-label="第 4 章 课程发布 v3.1"><!--[--><!--]--> 第 4 章 课程发布 v3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/" class="sidebar-item" aria-label="第 5 章 认证授权 v3.1"><!--[--><!--]--> 第 5 章 认证授权 v3.1 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="第 6 章 选课学习 v3.1"><!--[--><!--]--> 第 6 章 选课学习 v3.1 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_1-模块需求分析" class="router-link-active router-link-exact-active sidebar-item" aria-label="1 模块需求分析"><!--[--><!--]--> 1 模块需求分析 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_1-1-模块介绍" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.1 模块介绍"><!--[--><!--]--> 1.1 模块介绍 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_1-2-业务流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.2 业务流程"><!--[--><!--]--> 1.2 业务流程 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_1-2-1-学习引导" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.2.1 学习引导"><!--[--><!--]--> 1.2.1 学习引导 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_1-2-2-选课流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.2.2 选课流程"><!--[--><!--]--> 1.2.2 选课流程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_1-2-3-支付流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.2.3 支付流程"><!--[--><!--]--> 1.2.3 支付流程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_1-2-4-在线学习" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.2.4 在线学习"><!--[--><!--]--> 1.2.4 在线学习 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_1-2-5-免费课程续期" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.2.5 免费课程续期"><!--[--><!--]--> 1.2.5 免费课程续期 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-添加选课" class="router-link-active router-link-exact-active sidebar-item" aria-label="2 添加选课"><!--[--><!--]--> 2 添加选课 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-1-需求分析" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.1 需求分析"><!--[--><!--]--> 2.1 需求分析 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-1-1-数据模型" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.1.1 数据模型"><!--[--><!--]--> 2.1.1 数据模型 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-1-2-执行流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.1.2 执行流程"><!--[--><!--]--> 2.1.2 执行流程 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-2-接口开发" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2 接口开发"><!--[--><!--]--> 2.2 接口开发 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-2-1-部署学习中心工程" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.1 部署学习中心工程"><!--[--><!--]--> 2.2.1 部署学习中心工程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-2-2-添加查询课程接口" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.2 添加查询课程接口"><!--[--><!--]--> 2.2.2 添加查询课程接口 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-2-3-测试查询课程信息接口" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.3 测试查询课程信息接口"><!--[--><!--]--> 2.2.3 测试查询课程信息接口 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-2-5-添加选课接口" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.5 添加选课接口"><!--[--><!--]--> 2.2.5 添加选课接口 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-2-5-1-接口分析" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.5.1 接口分析"><!--[--><!--]--> 2.2.5.1 接口分析 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-2-5-2-接口定义" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.5.2 接口定义"><!--[--><!--]--> 2.2.5.2 接口定义 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-2-5-3-添加免费课程" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.5.3 添加免费课程"><!--[--><!--]--> 2.2.5.3 添加免费课程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-2-5-4-添加我的课程表" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.5.4 添加我的课程表"><!--[--><!--]--> 2.2.5.4 添加我的课程表 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-2-5-5-添加收费课程" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.5.5 添加收费课程"><!--[--><!--]--> 2.2.5.5 添加收费课程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-2-5-6-获取学习资格" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.5.6 获取学习资格"><!--[--><!--]--> 2.2.5.6 获取学习资格 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-2-5-7-service-接口完善" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.5.7 service 接口完善"><!--[--><!--]--> 2.2.5.7 service 接口完善 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-2-5-8-完善-controller" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.5.8 完善 controller"><!--[--><!--]--> 2.2.5.8 完善 controller <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-3-接口测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.3 接口测试"><!--[--><!--]--> 2.3 接口测试 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-3-1-单元测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.3.1 单元测试"><!--[--><!--]--> 2.3.1 单元测试 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-3-2-前后端联调" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.3.2 前后端联调"><!--[--><!--]--> 2.3.2 前后端联调 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-支付" class="router-link-active router-link-exact-active sidebar-item" aria-label="3 支付"><!--[--><!--]--> 3 支付 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-1-需求分析" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.1 需求分析"><!--[--><!--]--> 3.1 需求分析 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-1-1-执行流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.1.1 执行流程"><!--[--><!--]--> 3.1.1 执行流程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-1-2-通用订单服务设计" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.1.2 通用订单服务设计"><!--[--><!--]--> 3.1.2 通用订单服务设计 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-2-支付接口调研" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.2 支付接口调研"><!--[--><!--]--> 3.2 支付接口调研 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-2-1-微信支付接口调研" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.2.1 微信支付接口调研"><!--[--><!--]--> 3.2.1 微信支付接口调研 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-2-2-支付宝接口调研" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.2.2 支付宝接口调研"><!--[--><!--]--> 3.2.2 支付宝接口调研 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-3-准备开发环境" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.3 准备开发环境"><!--[--><!--]--> 3.3 准备开发环境 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-3-1-支付宝开发环境" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.3.1 支付宝开发环境"><!--[--><!--]--> 3.3.1 支付宝开发环境 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-3-2-创建订单服务" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.3.2 创建订单服务"><!--[--><!--]--> 3.3.2 创建订单服务 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-4-支付接口测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.4 支付接口测试"><!--[--><!--]--> 3.4 支付接口测试 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-4-1-阅读接口定义" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.4.1 阅读接口定义"><!--[--><!--]--> 3.4.1 阅读接口定义 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-4-2-下单执行流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.4.2 下单执行流程"><!--[--><!--]--> 3.4.2 下单执行流程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-4-3-支付接口测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.4.3 支付接口测试"><!--[--><!--]--> 3.4.3 支付接口测试 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-4-3-1-编写下单代码" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.4.3.1 编写下单代码"><!--[--><!--]--> 3.4.3.1 编写下单代码 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-4-3-2-生成二维码" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.4.3.2 生成二维码"><!--[--><!--]--> 3.4.3.2 生成二维码 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-4-3-3-接口测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.4.3.3 接口测试"><!--[--><!--]--> 3.4.3.3 接口测试 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-4-4-支付结果查询接口" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.4.4 支付结果查询接口"><!--[--><!--]--> 3.4.4 支付结果查询接口 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-4-5-支付结果通知接口" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.4.5 支付结果通知接口"><!--[--><!--]--> 3.4.5 支付结果通知接口 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-4-5-1-准备环境" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.4.5.1 准备环境"><!--[--><!--]--> 3.4.5.1 准备环境 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-4-5-2-编写测试代码" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.4.5.2 编写测试代码"><!--[--><!--]--> 3.4.5.2 编写测试代码 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-4-5-3-通知接口测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.4.5.3 通知接口测试"><!--[--><!--]--> 3.4.5.3 通知接口测试 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-5-生成支付二维码" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.5 生成支付二维码"><!--[--><!--]--> 3.5 生成支付二维码 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-5-1-需求分析" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.5.1 需求分析"><!--[--><!--]--> 3.5.1 需求分析 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-5-1-1-执行流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.5.1.1 执行流程"><!--[--><!--]--> 3.5.1.1 执行流程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-5-1-2-数据模型" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.5.1.2 数据模型"><!--[--><!--]--> 3.5.1.2 数据模型 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-5-2-接口定义" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.5.2 接口定义"><!--[--><!--]--> 3.5.2 接口定义 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-5-3-接口实现" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.5.3 接口实现"><!--[--><!--]--> 3.5.3 接口实现 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-5-3-1-保存商品订单" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.5.3.1 保存商品订单"><!--[--><!--]--> 3.5.3.1 保存商品订单 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-5-3-2-创建支付记录" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.5.3.2 创建支付记录"><!--[--><!--]--> 3.5.3.2 创建支付记录 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-5-3-3-生成支付二维码" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.5.3.3 生成支付二维码"><!--[--><!--]--> 3.5.3.3 生成支付二维码 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-5-3-4-生成二维码接口完善" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.5.3.4 生成二维码接口完善"><!--[--><!--]--> 3.5.3.4 生成二维码接口完善 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-5-3-5-扫码下单接口" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.5.3.5 扫码下单接口"><!--[--><!--]--> 3.5.3.5 扫码下单接口 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-5-3-支付测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.5.3 支付测试"><!--[--><!--]--> 3.5.3 支付测试 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-5-4-重复支付问题" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.5.4 重复支付问题"><!--[--><!--]--> 3.5.4 重复支付问题 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-6-查询支付结果" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.6 查询支付结果"><!--[--><!--]--> 3.6 查询支付结果 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-6-1-接口定义" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.6.1 接口定义"><!--[--><!--]--> 3.6.1 接口定义 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-6-2-接口实现" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.6.2 接口实现"><!--[--><!--]--> 3.6.2 接口实现 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-6-2-1-service-总体接口" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.6.2.1 service 总体接口"><!--[--><!--]--> 3.6.2.1 service 总体接口 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-6-2-2-查询支付结果" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.6.2.2 查询支付结果"><!--[--><!--]--> 3.6.2.2 查询支付结果 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-6-2-3-保存支付结果" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.6.2.3 保存支付结果"><!--[--><!--]--> 3.6.2.3 保存支付结果 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-6-3-接口测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.6.3 接口测试"><!--[--><!--]--> 3.6.3 接口测试 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-7-接收支付通知" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.7 接收支付通知"><!--[--><!--]--> 3.7 接收支付通知 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-7-1-接口定义" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.7.1 接口定义"><!--[--><!--]--> 3.7.1 接口定义 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-7-2-接口实现" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.7.2 接口实现"><!--[--><!--]--> 3.7.2 接口实现 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-7-4-接口测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.7.4 接口测试"><!--[--><!--]--> 3.7.4 接口测试 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-支付通知" class="router-link-active router-link-exact-active sidebar-item" aria-label="4 支付通知"><!--[--><!--]--> 4 支付通知 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-1-需求分析" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.1 需求分析"><!--[--><!--]--> 4.1 需求分析 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-2-技术方案" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.2 技术方案"><!--[--><!--]--> 4.2 技术方案 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-3-发送支付结果" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.3 发送支付结果"><!--[--><!--]--> 4.3 发送支付结果 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-3-1-订单服务集成-mq" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.3.1 订单服务集成 MQ"><!--[--><!--]--> 4.3.1 订单服务集成 MQ <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-3-2-发送支付结果" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.3.2 发送支付结果"><!--[--><!--]--> 4.3.2 发送支付结果 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-4-接收支付结果" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.4 接收支付结果"><!--[--><!--]--> 4.4 接收支付结果 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-4-1-学习中心服务集成-mq" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.4.1 学习中心服务集成 MQ"><!--[--><!--]--> 4.4.1 学习中心服务集成 MQ <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-4-2-接收支付结果" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.4.2 接收支付结果"><!--[--><!--]--> 4.4.2 接收支付结果 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-5-通知支付结果测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.5 通知支付结果测试"><!--[--><!--]--> 4.5 通知支付结果测试 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-在线学习" class="router-link-active router-link-exact-active sidebar-item" aria-label="4 在线学习"><!--[--><!--]--> 4 在线学习 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-1-需求分析-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.1 需求分析"><!--[--><!--]--> 4.1 需求分析 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-2-查询课程信息" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.2 查询课程信息"><!--[--><!--]--> 4.2 查询课程信息 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-3-获取视频" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.3 获取视频"><!--[--><!--]--> 4.3 获取视频 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-3-1-需求分析" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.3.1 需求分析"><!--[--><!--]--> 4.3.1 需求分析 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-3-2-接口定义" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.3.2 接口定义"><!--[--><!--]--> 4.3.2 接口定义 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-3-3-获取视频远程接口" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.3.3 获取视频远程接口"><!--[--><!--]--> 4.3.3 获取视频远程接口 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-3-5-学习资格校验" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.3.5 学习资格校验"><!--[--><!--]--> 4.3.5 学习资格校验 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-3-6-测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.3.6 测试"><!--[--><!--]--> 4.3.6 测试 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-4-我的课表" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.4 我的课表"><!--[--><!--]--> 4.4 我的课表 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-4-1-需求分析" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.4.1 需求分析"><!--[--><!--]--> 4.4.1 需求分析 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-4-1-1-业务流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.4.1.1 业务流程"><!--[--><!--]--> 4.4.1.1 业务流程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-4-1-2-配置-nginx" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.4.1.2 配置 nginx"><!--[--><!--]--> 4.4.1.2 配置 nginx <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-4-2-接口定义" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.4.2 接口定义"><!--[--><!--]--> 4.4.2 接口定义 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-4-3-接口开发" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.4.3 接口开发"><!--[--><!--]--> 4.4.3 接口开发 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-4-3-1dao" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.4.3.1DAO"><!--[--><!--]--> 4.4.3.1DAO <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-4-3-2-service" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.4.3.2 Service"><!--[--><!--]--> 4.4.3.2 Service <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-4-4-接口测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.4.4 接口测试"><!--[--><!--]--> 4.4.4 接口测试 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul></li><li><a href="/MyBlog/notes/project/02/%E7%AC%AC7%E7%AB%A0-%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2v3.1/" class="sidebar-item" aria-label="第 7 章 项目部署 v3.1"><!--[--><!--]--> 第 7 章 项目部署 v3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E7%AC%AC8%E7%AB%A0-%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%963.1/" class="sidebar-item" aria-label="第 8 章 项目优化 3.1"><!--[--><!--]--> 第 8 章 项目优化 3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83-%E9%83%A8%E7%BD%B2%E9%97%A8%E6%88%B7%E6%96%87%E6%A1%A3/" class="sidebar-item" aria-label="课程发布-部署门户文档 v3.1"><!--[--><!--]--> 课程发布-部署门户文档 v3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E5%BE%AE%E4%BF%A1%E6%89%AB%E7%A0%81%E7%99%BB%E5%BD%95%E9%85%8D%E7%BD%AE/" class="sidebar-item" aria-label="微信扫码登录配置"><!--[--><!--]--> 微信扫码登录配置 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AEv3.1/" class="sidebar-item" aria-label="学成在线项目开发环境配置 v3.1"><!--[--><!--]--> 学成在线项目开发环境配置 v3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E6%94%AF%E4%BB%98%E5%AE%9D%E6%B2%99%E7%AE%B1%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" class="sidebar-item" aria-label="支付宝沙箱环境"><!--[--><!--]--> 支付宝沙箱环境 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93/" class="sidebar-item" aria-label="项目总结"><!--[--><!--]--> 项目总结 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="第-6-章-选课学习-v3-1" tabindex="-1"><a class="header-anchor" href="#第-6-章-选课学习-v3-1" aria-hidden="true">#</a> <strong>第 6 章 选课学习 v3.1</strong></h1><nav class="table-of-contents"><ul><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_1-模块需求分析" class="router-link-active router-link-exact-active">1 模块需求分析</a><ul><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_1-1-模块介绍" class="router-link-active router-link-exact-active">1.1 模块介绍</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_1-2-业务流程" class="router-link-active router-link-exact-active">1.2 业务流程</a></li></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-添加选课" class="router-link-active router-link-exact-active">2 添加选课</a><ul><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-1-需求分析" class="router-link-active router-link-exact-active">2.1 需求分析</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-2-接口开发" class="router-link-active router-link-exact-active">2.2 接口开发</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_2-3-接口测试" class="router-link-active router-link-exact-active">2.3 接口测试</a></li></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-支付" class="router-link-active router-link-exact-active">3 支付</a><ul><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-1-需求分析" class="router-link-active router-link-exact-active">3.1 需求分析</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-2-支付接口调研" class="router-link-active router-link-exact-active">3.2 支付接口调研</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-3-准备开发环境" class="router-link-active router-link-exact-active">3.3 准备开发环境</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-4-支付接口测试" class="router-link-active router-link-exact-active">3.4 支付接口测试</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-5-生成支付二维码" class="router-link-active router-link-exact-active">3.5 生成支付二维码</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-6-查询支付结果" class="router-link-active router-link-exact-active">3.6 查询支付结果</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_3-7-接收支付通知" class="router-link-active router-link-exact-active">3.7 接收支付通知</a></li></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-支付通知" class="router-link-active router-link-exact-active">4 支付通知</a><ul><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-1-需求分析" class="router-link-active router-link-exact-active">4.1 需求分析</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-2-技术方案" class="router-link-active router-link-exact-active">4.2 技术方案</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-3-发送支付结果" class="router-link-active router-link-exact-active">4.3 发送支付结果</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-4-接收支付结果" class="router-link-active router-link-exact-active">4.4 接收支付结果</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-5-通知支付结果测试" class="router-link-active router-link-exact-active">4.5 通知支付结果测试</a></li></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-在线学习" class="router-link-active router-link-exact-active">4 在线学习</a><ul><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-1-需求分析-1" class="router-link-active router-link-exact-active">4.1 需求分析</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-2-查询课程信息" class="router-link-active router-link-exact-active">4.2 查询课程信息</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-3-获取视频" class="router-link-active router-link-exact-active">4.3 获取视频</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/#_4-4-我的课表" class="router-link-active router-link-exact-active">4.4 我的课表</a></li></ul></li></ul></nav><h2 id="_1-模块需求分析" tabindex="-1"><a class="header-anchor" href="#_1-模块需求分析" aria-hidden="true">#</a> <strong>1 模块需求分析</strong></h2><h3 id="_1-1-模块介绍" tabindex="-1"><a class="header-anchor" href="#_1-1-模块介绍" aria-hidden="true">#</a> <strong>1.1 模块介绍</strong></h3><p>本模块实现了学生选课、下单支付、学习的整体流程。</p><p>网站的课程有免费和收费两种，对于免费课程学生选课后可直接学习，对于收费课程学生需要下单且支付成功方可选课、学习。</p><p>选课：是将课程加入我的课程表的过程。</p><p>我的课程表：记录我在网站学习的课程，我的课程表中有免费课程和收费课程两种，对于免费课程可直接添加到我的课程表，对于收费课程需要下单、支付成功后自动加入我的课程表。</p><p>模块整体流程如下：</p><p><img src="/MyBlog/assets/image-20230611154802958-ccb8b1bd.png" alt="image-20230611154802958"></p><h3 id="_1-2-业务流程" tabindex="-1"><a class="header-anchor" href="#_1-2-业务流程" aria-hidden="true">#</a> <strong>1.2 业务流程</strong></h3><h4 id="_1-2-1-学习引导" tabindex="-1"><a class="header-anchor" href="#_1-2-1-学习引导" aria-hidden="true">#</a> <strong>1.2.1 学习引导</strong></h4><p>用户通过搜索课程、课程推荐等信息进入课程详情页面，点击“马上学习” 引导进入学习界面去学习。</p><p>流程如下：</p><p><img src="/MyBlog/assets/image-20230611154832783-f27c5efe.png" alt="image-20230611154832783">1、进入课程详情点击马上学习</p><p><img src="/MyBlog/assets/image-20230611154838147-4d93de17.png" alt="image-20230611154838147">2、课程免费时引导加入我的课程表、或进入学习界面。</p><p><img src="/MyBlog/assets/image-20230611154844659-4ef6b95e.png" alt="image-20230611154844659"></p><p>3、课程收费时引导去支付、或试学。</p><p><img src="/MyBlog/assets/image-20230611154849591-3d021039.png" alt="image-20230611154849591"></p><h4 id="_1-2-2-选课流程" tabindex="-1"><a class="header-anchor" href="#_1-2-2-选课流程" aria-hidden="true">#</a> <strong>1.2.2 选课流程</strong></h4><p>选课是将课程加入我的课程表的过程。</p><p>对免费课程选课后可直接加入我的课程表，对收费课程选课后需要下单支付成功系统自动加入我的课程表。</p><p>流程如下：</p><p><img src="/MyBlog/assets/image-20230611154901217-c4d357c6.png" alt="image-20230611154901217"></p><h4 id="_1-2-3-支付流程" tabindex="-1"><a class="header-anchor" href="#_1-2-3-支付流程" aria-hidden="true">#</a> <strong>1.2.3 支付流程</strong></h4><p>本项目与第三方支付平台对接完成支付操作。</p><p>流程如下：</p><p><img src="/MyBlog/assets/image-20230611154906310-77f845f1.png" alt="image-20230611154906310"></p><h4 id="_1-2-4-在线学习" tabindex="-1"><a class="header-anchor" href="#_1-2-4-在线学习" aria-hidden="true">#</a> <strong>1.2.4 在线学习</strong></h4><p>选课成功用户可以在线学习，对于免费课程无需选课即可在线学习。</p><p>流程如下：</p><p><img src="/MyBlog/assets/image-20230611154911811-aa2effc8.png" alt="image-20230611154911811"></p><h4 id="_1-2-5-免费课程续期" tabindex="-1"><a class="header-anchor" href="#_1-2-5-免费课程续期" aria-hidden="true">#</a> <strong>1.2.5 免费课程续期</strong></h4><p>免费课程加入我的课程表默认为 1 年有效期，到期用户可申请续期，流程如下：</p><p><img src="/MyBlog/assets/image-20230611154916637-518fe440.png" alt="image-20230611154916637"></p><h2 id="_2-添加选课" tabindex="-1"><a class="header-anchor" href="#_2-添加选课" aria-hidden="true">#</a> <strong>2 添加选课</strong></h2><h3 id="_2-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_2-1-需求分析" aria-hidden="true">#</a> <strong>2.1 需求分析</strong></h3><h4 id="_2-1-1-数据模型" tabindex="-1"><a class="header-anchor" href="#_2-1-1-数据模型" aria-hidden="true">#</a> <strong>2.1.1 数据模型</strong></h4><p>选课是将课程加入我的课程表的过程，根据选课的业务流程进行详细分析，业务流程如下：</p><p><img src="/MyBlog/assets/image-20230611154901217-c4d357c6.png" alt="image-20230611155104121"></p><p>选课信息存入选课记录表，免费课程被选课除了进入选课记录表同时进入我的课程表，收费课程进入选课记录表后需要经过下单、支付成功才可以进入我的课程表。</p><p>我的课程表记录了用户学习的课程，包括免费课程、收费课程（已经支付）。</p><p>1、选课记录表</p><p>当用户将课程添加到课程表时需要先创建选课记录。</p><p>结构如下：</p><p><img src="/MyBlog/assets/image-20230611155108997-c87c54c8.png" alt="image-20230611155108997"></p><p>选课类型：免费课程、收费课程。</p><p>选课状态：选课成功、待支付、选课删除。</p><p>对于免费课程：课程价格为 0，有效期默认 365，开始服务时间为选课时间，结束服务时间为选课时间加 1 年后的时间，选课状态为选课成功。</p><p>对于收费课程：按课程的现价、有效期确定开始服务时间、结束服务时间，选课状态为待支付。</p><p>收费课程的选课记录需要支付成功后选课状态为成功。</p><p>2、我的课程表</p><p>我的课程表中记录了用户选课成功的课程，所以我的课程表的数据来源于选课记录表。</p><p>对于免费课程创建选课记录后同时向我的课程表添加记录。</p><p>对于收费课程创建选课记录后需要下单支付成功后自动向我的课程表添加记录。</p><p><img src="/MyBlog/assets/image-20230611155115475-0a1686cb.png" alt="image-20230611155115475"></p><h4 id="_2-1-2-执行流程" tabindex="-1"><a class="header-anchor" href="#_2-1-2-执行流程" aria-hidden="true">#</a> <strong>2.1.2 执行流程</strong></h4><p>在学习引导处，可以直接将免费课程加入我的课程表，如下图：</p><p><img src="/MyBlog/assets/image-20230611154844659-4ef6b95e.png" alt="image-20230611155120825"></p><p>对于收费课程先创建选课记录表，支付成功后，收到支付结果由系统自动加入我的课程表。</p><p>执行流程如下：</p><p><img src="/MyBlog/assets/image-20230611155126023-57ae0de1.png" alt="image-20230611155126023"></p><h3 id="_2-2-接口开发" tabindex="-1"><a class="header-anchor" href="#_2-2-接口开发" aria-hidden="true">#</a> <strong>2.2 接口开发</strong></h3><h4 id="_2-2-1-部署学习中心工程" tabindex="-1"><a class="header-anchor" href="#_2-2-1-部署学习中心工程" aria-hidden="true">#</a> <strong>2.2.1 部署学习中心工程</strong></h4><p>从课程资料拷贝学习中心服务工程到自己的工程目录，结构如下：</p><p><img src="/MyBlog/assets/image-20230611155131637-af9766e4.png" alt="image-20230611155131637">注意去修改 nacos 的命名空间。</p><p>创建数据库 xc_learning，并导入数据</p><p>修改数据库的连接，改成自己的数据库。</p><p>nacos 配置文件：learning-api-dev.yaml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>
    <span class="token key atrule">context-path</span><span class="token punctuation">:</span> /learning
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">63020</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>learning-service-dev.yaml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.101.65<span class="token punctuation">:</span>3306/xc1010_learning<span class="token punctuation">?</span>serverTimezone=UTC<span class="token important">&amp;userUnicode=true&amp;useSSL=false&amp;</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> mysql
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-2-添加查询课程接口" tabindex="-1"><a class="header-anchor" href="#_2-2-2-添加查询课程接口" aria-hidden="true">#</a> <strong>2.2.2 添加查询课程接口</strong></h4><p>内容管理服务提供查询课程信息接口，此接口从课程发布表查询。</p><p>此接口主要提供其它微服务远程调用，所以此接口不用授权，本项目标记此类接口统一以 /r 开头。</p><p>在课程发布 controller 类中定义课程发布信息查询接口。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;查询课程发布信息&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/r/coursepublish/{courseId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">CoursePublish</span> <span class="token function">getCoursepublish</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;courseId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">CoursePublish</span> coursePublish <span class="token operator">=</span> coursePublishService<span class="token punctuation">.</span><span class="token function">getCoursePublish</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> coursePublish<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Service 如下：</p><p>如果课程发布状态正常则正常返回，否则返回空。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token class-name">CoursePublish</span> <span class="token function">getCoursePublish</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">CoursePublish</span> coursePublish <span class="token operator">=</span> coursePublishMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> coursePublish <span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试：</p><p>启动内容管理服务，使用 httpclient 测试</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>
#### 查询课程发布信息
GET {{content_host}}/content/r/coursepublish/2

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于是在网关处进行令牌校验，所以在微服务处不再校验令牌的合法性，修改内容管理 content-api 工程的 ResouceServerConfig 类，屏蔽 authenticated()。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
  http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//          .antMatchers(&quot;/r/**&quot;,&quot;/course/**&quot;).authenticated()//所有/r/**的请求必须认证通过</span>
          <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-3-测试查询课程信息接口" tabindex="-1"><a class="header-anchor" href="#_2-2-3-测试查询课程信息接口" aria-hidden="true">#</a> <strong>2.2.3 测试查询课程信息接口</strong></h4><p>学生中心服务远程调用内容管理服务的查询课程发布信息接口。</p><p>导入的学习中心工程已经存在 ContentServiceClient 接口，通过此接口远程调用课程查询接口。</p><p>编写测试接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">CoursePublish</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>feignclient<span class="token punctuation">.</span></span><span class="token class-name">ContentServiceClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Assertions</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> Feign接口测试类
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/10/24 17:15
 * <span class="token keyword">@version</span> 1.0
 */</span>
 <span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignClientTest</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">ContentServiceClient</span> contentServiceClient<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Test</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testContentServiceClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token class-name">CoursePublish</span> coursepublish <span class="token operator">=</span> contentServiceClient<span class="token punctuation">.</span><span class="token function">getCoursepublish</span><span class="token punctuation">(</span><span class="token number">18L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertNotNull</span><span class="token punctuation">(</span>coursepublish<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>在进行 feign 远程调用时会将字符串转成 LocalDateTime，在 CoursePublish 类中 LocalDateTime 的属性上边添加如下代码：</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@JsonFormat</span><span class="token punctuation">(</span>shape <span class="token operator">=</span> <span class="token class-name">JsonFormat<span class="token punctuation">.</span>Shape</span><span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>pattern <span class="token operator">=</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-5-添加选课接口" tabindex="-1"><a class="header-anchor" href="#_2-2-5-添加选课接口" aria-hidden="true">#</a> <strong>2.2.5 添加选课接口</strong></h4><h5 id="_2-2-5-1-接口分析" tabindex="-1"><a class="header-anchor" href="#_2-2-5-1-接口分析" aria-hidden="true">#</a> <strong>2.2.5.1 接口分析</strong></h5><p>本接口支持免费课程选课、收费课程选课。</p><p>免费课程选课：添加选课记录、添加我的课程表。</p><p>收费课程选课：添加选课记录。</p><h5 id="_2-2-5-2-接口定义" tabindex="-1"><a class="header-anchor" href="#_2-2-5-2-接口定义" aria-hidden="true">#</a> <strong>2.2.5.2 接口定义</strong></h5><p>1、请求参数：课程 id、当前用户 id</p><p>2、响应结果：选课记录信息、学习资格</p><p>学习资格：[{&quot;code&quot;:&quot;702001&quot;,&quot;desc&quot;:&quot;正常学习&quot;},{&quot;code&quot;:&quot;702002&quot;,&quot;desc&quot;:&quot;没有选课或选课后没有支付&quot;},{&quot;code&quot;:&quot;702003&quot;,&quot;desc&quot;:&quot;已过期需要申请续期或重新支付&quot;}]</p><p>接口定义如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>api</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>execption<span class="token punctuation">.</span></span><span class="token class-name">XueChengPlusException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">RestResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">XcUser</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">XcChooseCourseDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">MyCourseTablesService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">SecurityUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Api</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiOperation</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> 我的课程表接口
 * <span class="token keyword">@date</span> 2022/10/2 14:52
 */</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;我的课程表接口&quot;</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">&quot;我的课程表接口&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyCourseTablesController</span> <span class="token punctuation">{</span>


    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;添加选课&quot;</span><span class="token punctuation">)</span>
     <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/choosecourse/{courseId}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">XcChooseCourseDto</span> <span class="token function">addChooseCourse</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;courseId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span>  <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Service 接口定义：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">XcChooseCourseDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">XcChooseCourse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">XcCourseTables</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 我的课程表service接口
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/10/2 16:07
 * <span class="token keyword">@version</span> 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MyCourseTablesService</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 添加选课
 * <span class="token keyword">@param</span> <span class="token parameter">userId</span> 用户id
 * <span class="token keyword">@param</span> <span class="token parameter">courseId</span> 课程id
 * <span class="token keyword">@return</span> com.xuecheng.learning.model.dto.XcChooseCourseDto
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/10/24 17:33
*/</span>
 <span class="token keyword">public</span> <span class="token class-name">XcChooseCourseDto</span> <span class="token function">addChooseCourse</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Service 接口执行流程</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">LambdaQueryWrapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>execption<span class="token punctuation">.</span></span><span class="token class-name">XueChengPlusException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">CoursePublish</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>feignclient<span class="token punctuation">.</span></span><span class="token class-name">ContentServiceClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">XcChooseCourseMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">XcCourseTablesMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">XcChooseCourseDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">XcChooseCourse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">XcCourseTables</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">MyCourseTablesService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>statement<span class="token punctuation">.</span></span><span class="token class-name">StatementUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">BeanUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> TODO
 * <span class="token keyword">@date</span> 2022/10/2 16:12
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyCourseTablesServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">MyCourseTablesService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcChooseCourseMapper</span> xcChooseCourseMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcCourseTablesMapper</span> xcCourseTablesMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">ContentServiceClient</span> contentServiceClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MyCourseTablesService</span> myCourseTablesService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MyCourseTablesServiceImpl</span> currentProxy<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">XcChooseCourseDto</span> <span class="token function">addChooseCourse</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//查询课程信息</span>
        <span class="token class-name">CoursePublish</span> coursepublish <span class="token operator">=</span> contentServiceClient<span class="token punctuation">.</span><span class="token function">getCoursepublish</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//课程收费标准</span>
        <span class="token class-name">String</span> charge <span class="token operator">=</span> coursepublish<span class="token punctuation">.</span><span class="token function">getCharge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//选课记录</span>
        <span class="token class-name">XcChooseCourse</span> chooseCourse <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">&quot;201000&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>charge<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//课程免费</span>
            <span class="token comment">//添加免费课程</span>
            chooseCourse  <span class="token operator">=</span> <span class="token function">addFreeCoruse</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> coursepublish<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//添加到我的课程表</span>
            <span class="token class-name">XcCourseTables</span> xcCourseTables <span class="token operator">=</span> <span class="token function">addCourseTabls</span><span class="token punctuation">(</span>chooseCourse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token comment">//添加收费课程</span>
            chooseCourse  <span class="token operator">=</span> <span class="token function">addChargeCoruse</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> coursepublish<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//获取学习资格</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>




<span class="token comment">//添加免费课程,免费课程加入选课记录表、我的课程表</span>
<span class="token keyword">public</span> <span class="token class-name">XcChooseCourse</span> <span class="token function">addFreeCoruse</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span> <span class="token class-name">CoursePublish</span> coursepublish<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//添加收费课程</span>
<span class="token keyword">public</span> <span class="token class-name">XcChooseCourse</span> <span class="token function">addChargeCoruse</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span><span class="token class-name">CoursePublish</span> coursepublish<span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//添加到我的课程表</span>
<span class="token keyword">public</span> <span class="token class-name">XcCourseTables</span> <span class="token function">addCourseTabls</span><span class="token punctuation">(</span><span class="token class-name">XcChooseCourse</span> xcChooseCourse<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-2-5-3-添加免费课程" tabindex="-1"><a class="header-anchor" href="#_2-2-5-3-添加免费课程" aria-hidden="true">#</a> <strong>2.2.5.3 添加免费课程</strong></h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>

<span class="token comment">//添加免费课程,免费课程加入选课记录表、我的课程表</span>
<span class="token keyword">public</span> <span class="token class-name">XcChooseCourse</span> <span class="token function">addFreeCoruse</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span> <span class="token class-name">CoursePublish</span> coursepublish<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//查询选课记录表是否存在免费的且选课成功的订单</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcChooseCourse</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    queryWrapper <span class="token operator">=</span> queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcChooseCourse</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcChooseCourse</span><span class="token operator">::</span><span class="token function">getCourseId</span><span class="token punctuation">,</span> coursepublish<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcChooseCourse</span><span class="token operator">::</span><span class="token function">getOrderType</span><span class="token punctuation">,</span> <span class="token string">&quot;700001&quot;</span><span class="token punctuation">)</span><span class="token comment">//免费课程</span>
            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcChooseCourse</span><span class="token operator">::</span><span class="token function">getStatus</span><span class="token punctuation">,</span> <span class="token string">&quot;701001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//选课成功</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcChooseCourse</span><span class="token punctuation">&gt;</span></span> xcChooseCourses <span class="token operator">=</span> xcChooseCourseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xcChooseCourses <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> xcChooseCourses<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> xcChooseCourses<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//添加选课记录信息</span>
    <span class="token class-name">XcChooseCourse</span> xcChooseCourse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcChooseCourse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcChooseCourse<span class="token punctuation">.</span><span class="token function">setCourseId</span><span class="token punctuation">(</span>coursepublish<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcChooseCourse<span class="token punctuation">.</span><span class="token function">setCourseName</span><span class="token punctuation">(</span>coursepublish<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcChooseCourse<span class="token punctuation">.</span><span class="token function">setCoursePrice</span><span class="token punctuation">(</span><span class="token number">0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//免费课程价格为0</span>
    xcChooseCourse<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcChooseCourse<span class="token punctuation">.</span><span class="token function">setCompanyId</span><span class="token punctuation">(</span>coursepublish<span class="token punctuation">.</span><span class="token function">getCompanyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcChooseCourse<span class="token punctuation">.</span><span class="token function">setOrderType</span><span class="token punctuation">(</span><span class="token string">&quot;700001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//免费课程</span>
    xcChooseCourse<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcChooseCourse<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;701001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//选课成功</span>

    xcChooseCourse<span class="token punctuation">.</span><span class="token function">setValidDays</span><span class="token punctuation">(</span><span class="token number">365</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//免费课程默认365</span>
    xcChooseCourse<span class="token punctuation">.</span><span class="token function">setValidtimeStart</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcChooseCourse<span class="token punctuation">.</span><span class="token function">setValidtimeEnd</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusDays</span><span class="token punctuation">(</span><span class="token number">365</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcChooseCourseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>xcChooseCourse<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> xcChooseCourse<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-2-5-4-添加我的课程表" tabindex="-1"><a class="header-anchor" href="#_2-2-5-4-添加我的课程表" aria-hidden="true">#</a> <strong>2.2.5.4 添加我的课程表</strong></h5><p>我的课程表的记录来源于选课记录，选课记录成功将课程信息添加到我的课程表。</p><p>如果我的课程表已存在课程可能已经过期，如果有新的选课记录则需要更新我的课程表中的现有信息。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 添加到我的课程表
 * <span class="token keyword">@param</span> <span class="token parameter">xcChooseCourse</span> 选课记录
 * <span class="token keyword">@return</span> com.xuecheng.learning.model.po.XcCourseTables
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/10/3 11:24
*/</span>
<span class="token keyword">public</span> <span class="token class-name">XcCourseTables</span> <span class="token function">addCourseTabls</span><span class="token punctuation">(</span><span class="token class-name">XcChooseCourse</span> xcChooseCourse<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//选课记录完成且未过期可以添加课程到课程表</span>
    <span class="token class-name">String</span> status <span class="token operator">=</span> xcChooseCourse<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">&quot;701001&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;选课未成功，无法添加到课程表&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//查询我的课程表</span>
    <span class="token class-name">XcCourseTables</span> xcCourseTables <span class="token operator">=</span> <span class="token function">getXcCourseTables</span><span class="token punctuation">(</span>xcChooseCourse<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> xcChooseCourse<span class="token punctuation">.</span><span class="token function">getCourseId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>xcCourseTables<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token keyword">return</span> xcCourseTables<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">XcCourseTables</span> xcCourseTablesNew <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcCourseTables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcCourseTablesNew<span class="token punctuation">.</span><span class="token function">setChooseCourseId</span><span class="token punctuation">(</span>xcChooseCourse<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcCourseTablesNew<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>xcChooseCourse<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcCourseTablesNew<span class="token punctuation">.</span><span class="token function">setCourseId</span><span class="token punctuation">(</span>xcChooseCourse<span class="token punctuation">.</span><span class="token function">getCourseId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcCourseTablesNew<span class="token punctuation">.</span><span class="token function">setCompanyId</span><span class="token punctuation">(</span>xcChooseCourse<span class="token punctuation">.</span><span class="token function">getCompanyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcCourseTablesNew<span class="token punctuation">.</span><span class="token function">setCourseName</span><span class="token punctuation">(</span>xcChooseCourse<span class="token punctuation">.</span><span class="token function">getCourseName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcCourseTablesNew<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcCourseTablesNew<span class="token punctuation">.</span><span class="token function">setValidtimeStart</span><span class="token punctuation">(</span>xcChooseCourse<span class="token punctuation">.</span><span class="token function">getValidtimeStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcCourseTablesNew<span class="token punctuation">.</span><span class="token function">setValidtimeEnd</span><span class="token punctuation">(</span>xcChooseCourse<span class="token punctuation">.</span><span class="token function">getValidtimeEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcCourseTablesNew<span class="token punctuation">.</span><span class="token function">setCourseType</span><span class="token punctuation">(</span>xcChooseCourse<span class="token punctuation">.</span><span class="token function">getOrderType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcCourseTablesMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>xcCourseTablesNew<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> xcCourseTablesNew<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 根据课程和用户查询我的课程表中某一门课程
 * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
 * <span class="token keyword">@param</span> <span class="token parameter">courseId</span>
 * <span class="token keyword">@return</span> com.xuecheng.learning.model.po.XcCourseTables
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/10/2 17:07
*/</span>
<span class="token keyword">public</span> <span class="token class-name">XcCourseTables</span> <span class="token function">getXcCourseTables</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">XcCourseTables</span> xcCourseTables <span class="token operator">=</span> xcCourseTablesMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcCourseTables</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcCourseTables</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcCourseTables</span><span class="token operator">::</span><span class="token function">getCourseId</span><span class="token punctuation">,</span> courseId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> xcCourseTables<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-2-5-5-添加收费课程" tabindex="-1"><a class="header-anchor" href="#_2-2-5-5-添加收费课程" aria-hidden="true">#</a> <strong>2.2.5.5 添加收费课程</strong></h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token comment">//添加收费课程</span>
<span class="token keyword">public</span> <span class="token class-name">XcChooseCourse</span> <span class="token function">addChargeCoruse</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span><span class="token class-name">CoursePublish</span> coursepublish<span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token comment">//如果存在待支付记录直接返回</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcChooseCourse</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    queryWrapper <span class="token operator">=</span> queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcChooseCourse</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcChooseCourse</span><span class="token operator">::</span><span class="token function">getCourseId</span><span class="token punctuation">,</span> coursepublish<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcChooseCourse</span><span class="token operator">::</span><span class="token function">getOrderType</span><span class="token punctuation">,</span> <span class="token string">&quot;700002&quot;</span><span class="token punctuation">)</span><span class="token comment">//收费订单</span>
            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcChooseCourse</span><span class="token operator">::</span><span class="token function">getStatus</span><span class="token punctuation">,</span> <span class="token string">&quot;701002&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//待支付</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcChooseCourse</span><span class="token punctuation">&gt;</span></span> xcChooseCourses <span class="token operator">=</span> xcChooseCourseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xcChooseCourses <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> xcChooseCourses<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> xcChooseCourses<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">XcChooseCourse</span> xcChooseCourse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcChooseCourse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcChooseCourse<span class="token punctuation">.</span><span class="token function">setCourseId</span><span class="token punctuation">(</span>coursepublish<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcChooseCourse<span class="token punctuation">.</span><span class="token function">setCourseName</span><span class="token punctuation">(</span>coursepublish<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcChooseCourse<span class="token punctuation">.</span><span class="token function">setCoursePrice</span><span class="token punctuation">(</span>coursepublish<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcChooseCourse<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcChooseCourse<span class="token punctuation">.</span><span class="token function">setCompanyId</span><span class="token punctuation">(</span>coursepublish<span class="token punctuation">.</span><span class="token function">getCompanyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcChooseCourse<span class="token punctuation">.</span><span class="token function">setOrderType</span><span class="token punctuation">(</span><span class="token string">&quot;700002&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//收费课程</span>
    xcChooseCourse<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcChooseCourse<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;701002&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//待支付</span>

    xcChooseCourse<span class="token punctuation">.</span><span class="token function">setValidDays</span><span class="token punctuation">(</span>coursepublish<span class="token punctuation">.</span><span class="token function">getValidDays</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcChooseCourse<span class="token punctuation">.</span><span class="token function">setValidtimeStart</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcChooseCourse<span class="token punctuation">.</span><span class="token function">setValidtimeEnd</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusDays</span><span class="token punctuation">(</span>coursepublish<span class="token punctuation">.</span><span class="token function">getValidDays</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcChooseCourseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>xcChooseCourse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> xcChooseCourse<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-2-5-6-获取学习资格" tabindex="-1"><a class="header-anchor" href="#_2-2-5-6-获取学习资格" aria-hidden="true">#</a> <strong>2.2.5.6 获取学习资格</strong></h5><p>定义获取学习资格接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MyCourseTablesService</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">XcChooseCourseDto</span> <span class="token function">addChooseCourse</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * <span class="token keyword">@description</span> 判断学习资格
     * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
     * <span class="token keyword">@param</span> <span class="token parameter">courseId</span>
     * <span class="token keyword">@return</span> XcCourseTablesDto 学习资格状态 [<span class="token punctuation">{</span>&quot;code&quot;:&quot;702001&quot;,&quot;desc&quot;:&quot;正常学习&quot;<span class="token punctuation">}</span>,<span class="token punctuation">{</span>&quot;code&quot;:&quot;702002&quot;,&quot;desc&quot;:&quot;没有选课或选课后没有支付&quot;<span class="token punctuation">}</span>,<span class="token punctuation">{</span>&quot;code&quot;:&quot;702003&quot;,&quot;desc&quot;:&quot;已过期需要申请续期或重新支付&quot;<span class="token punctuation">}</span>]
     * <span class="token keyword">@author</span> Mr.M
     * <span class="token keyword">@date</span> 2022/10/3 7:37
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">XcCourseTablesDto</span> <span class="token function">getLearningStatus</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接口实现如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 判断学习资格
 * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
 * <span class="token keyword">@param</span> <span class="token parameter">courseId</span>
 * <span class="token keyword">@return</span> XcCourseTablesDto 学习资格状态 [<span class="token punctuation">{</span>&quot;code&quot;:&quot;702001&quot;,&quot;desc&quot;:&quot;正常学习&quot;<span class="token punctuation">}</span>,<span class="token punctuation">{</span>&quot;code&quot;:&quot;702002&quot;,&quot;desc&quot;:&quot;没有选课或选课后没有支付&quot;<span class="token punctuation">}</span>,<span class="token punctuation">{</span>&quot;code&quot;:&quot;702003&quot;,&quot;desc&quot;:&quot;已过期需要申请续期或重新支付&quot;<span class="token punctuation">}</span>]
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/10/3 7:37
*/</span>
<span class="token keyword">public</span> <span class="token class-name">XcCourseTablesDto</span> <span class="token function">getLearningStatus</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//查询我的课程表</span>
    <span class="token class-name">XcCourseTables</span> xcCourseTables <span class="token operator">=</span> <span class="token function">getXcCourseTables</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>xcCourseTables<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">XcCourseTablesDto</span> xcCourseTablesDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcCourseTablesDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//没有选课或选课后没有支付</span>
        xcCourseTablesDto<span class="token punctuation">.</span><span class="token function">setLearnStatus</span><span class="token punctuation">(</span><span class="token string">&quot;702002&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> xcCourseTablesDto<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">XcCourseTablesDto</span> xcCourseTablesDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcCourseTablesDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>xcCourseTables<span class="token punctuation">,</span>xcCourseTablesDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//是否过期,true过期，false未过期</span>
    <span class="token keyword">boolean</span> isExpires <span class="token operator">=</span> xcCourseTables<span class="token punctuation">.</span><span class="token function">getValidtimeEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isExpires<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//正常学习</span>
        xcCourseTablesDto<span class="token punctuation">.</span><span class="token function">setLearnStatus</span><span class="token punctuation">(</span><span class="token string">&quot;702001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> xcCourseTablesDto<span class="token punctuation">;</span>

    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token comment">//已过期</span>
        xcCourseTablesDto<span class="token punctuation">.</span><span class="token function">setLearnStatus</span><span class="token punctuation">(</span><span class="token string">&quot;702003&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> xcCourseTablesDto<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-2-5-7-service-接口完善" tabindex="-1"><a class="header-anchor" href="#_2-2-5-7-service-接口完善" aria-hidden="true">#</a> <strong>2.2.5.7 service 接口完善</strong></h5><p>完善 Service 接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">XcChooseCourseDto</span> <span class="token function">addChooseCourse</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//查询课程信息</span>
    <span class="token class-name">CoursePublish</span> coursepublish <span class="token operator">=</span> contentServiceClient<span class="token punctuation">.</span><span class="token function">getCoursepublish</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//课程收费标准</span>
    <span class="token class-name">String</span> charge <span class="token operator">=</span> coursepublish<span class="token punctuation">.</span><span class="token function">getCharge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//选课记录</span>
    <span class="token class-name">XcChooseCourse</span> chooseCourse <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;201000&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>charge<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//课程免费</span>
        <span class="token comment">//添加免费课程</span>
        chooseCourse <span class="token operator">=</span> <span class="token function">addFreeCoruse</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> coursepublish<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//添加到我的课程表</span>
        <span class="token class-name">XcCourseTables</span> xcCourseTables <span class="token operator">=</span> <span class="token function">addCourseTabls</span><span class="token punctuation">(</span>chooseCourse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//添加收费课程</span>
        chooseCourse <span class="token operator">=</span> <span class="token function">addChargeCoruse</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> coursepublish<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">XcChooseCourseDto</span> xcChooseCourseDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcChooseCourseDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>chooseCourse<span class="token punctuation">,</span>xcChooseCourseDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//获取学习资格</span>
    <span class="token class-name">XcCourseTablesDto</span> xcCourseTablesDto <span class="token operator">=</span> <span class="token function">getLearningStatus</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcChooseCourseDto<span class="token punctuation">.</span><span class="token function">setLearnStatus</span><span class="token punctuation">(</span>xcCourseTablesDto<span class="token punctuation">.</span><span class="token function">getLearnStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> xcChooseCourseDto<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-2-5-8-完善-controller" tabindex="-1"><a class="header-anchor" href="#_2-2-5-8-完善-controller" aria-hidden="true">#</a> <strong>2.2.5.8 完善 controller</strong></h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">MyCourseTablesService</span> courseTablesService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;添加选课&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/choosecourse/{courseId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">XcChooseCourseDto</span> <span class="token function">addChooseCourse</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;courseId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//登录用户</span>
    <span class="token class-name">SecurityUtil<span class="token punctuation">.</span>XcUser</span> user <span class="token operator">=</span> <span class="token class-name">SecurityUtil</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;请登录后继续选课&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> userId <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span>  courseTablesService<span class="token punctuation">.</span><span class="token function">addChooseCourse</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;查询学习资格&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/choosecourse/learnstatus/{courseId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">XcCourseTablesDto</span> <span class="token function">getLearnstatus</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;courseId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//登录用户</span>
    <span class="token class-name">SecurityUtil<span class="token punctuation">.</span>XcUser</span> user <span class="token operator">=</span> <span class="token class-name">SecurityUtil</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;请登录后继续选课&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> userId <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span>  courseTablesService<span class="token punctuation">.</span><span class="token function">getLeanringStatus</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-接口测试" tabindex="-1"><a class="header-anchor" href="#_2-3-接口测试" aria-hidden="true">#</a> <strong>2.3 接口测试</strong></h3><h4 id="_2-3-1-单元测试" tabindex="-1"><a class="header-anchor" href="#_2-3-1-单元测试" aria-hidden="true">#</a> <strong>2.3.1 单元测试</strong></h4><p>1、准备测试环境</p><p>发布两门课程，一门为免费，一门为收费。</p><p>小技巧：可以更改课程发布表已有课程的收费标准进行测试。</p><p>2、测试添加免费课程</p><p>成功：选课记录表一条记录、我的课程表一条记录。</p><p>3、测试添加收费课程</p><p>成功：选课记录表一条记录</p><p>4、重复添加选课</p><p>重复添加相同的课程，观察是否存在异常。</p><p>5、生成令牌，为方便生成令牌暂时将 PasswordAuthServiceImpl 类中的验证码屏蔽</p><p>6、使用 httpclient 测试如下：</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>#### 添加选课
POST {{learning_host}}/learning/choosecourse/2
<span class="token header"><span class="token header-name keyword">Authorization</span><span class="token punctuation">:</span> <span class="token header-value">Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJ7XCJiaXJ0aGRheVwiOlwiMjAyMi0wOS0yOFQxOToyODo0NlwiLFwiY3JlYXRlVGltZVwiOlwiMjAyMi0wOS0yOFQwODozMjowM1wiLFwiaWRcIjpcIjUwXCIsXCJuYW1lXCI6XCLlrabnlJ8xXCIsXCJuaWNrbmFtZVwiOlwi5aSn5rC054mbXCIsXCJwZXJtaXNzaW9uc1wiOltcInhjX3N5c21hbmFnZXJcIixcInhjX3N5c21hbmFnZXJfdXNlclwiLFwieGNfc3lzbWFuYWdlcl91c2VyX2FkZFwiLFwieGNfc3lzbWFuYWdlcl91c2VyX2VkaXRcIixcInhjX3N5c21hbmFnZXJfdXNlcl92aWV3XCIsXCJ4Y19zeXNtYW5hZ2VyX3VzZXJfZGVsZXRlXCIsXCJ4Y19zeXNtYW5hZ2VyX2RvY1wiLFwieGNfc3lzbWFuYWdlcl9sb2dcIixcInhjX3RlYWNobWFuYWdlcl9jb3Vyc2VcIixcInhjX3RlYWNobWFuYWdlcl9jb3Vyc2VfYWRkXCIsXCJ4Y190ZWFjaG1hbmFnZXJfY291cnNlX2Jhc2VcIixcInhjX3N5c21hbmFnZXJfY29tcGFueVwiLFwieGNfdGVhY2htYW5hZ2VyX2NvdXJzZV9saXN0XCJdLFwic2V4XCI6XCIxXCIsXCJzdGF0dXNcIjpcIjFcIixcInVzZXJuYW1lXCI6XCJzdHUxXCIsXCJ1c2VycGljXCI6XCJodHRwOi8vZmlsZS54dWVjaGVuZy1wbHVzLmNvbS9kZGRmXCIsXCJ1dHlwZVwiOlwiMTAxMDAxXCJ9Iiwic2NvcGUiOlsiYWxsIl0sImV4cCI6MTY2NzI5OTQwNiwiYXV0aG9yaXRpZXMiOlsieGNfc3lzbWFuYWdlcl9kb2MiLCJ4Y19zeXNtYW5hZ2VyX3VzZXJfdmlldyIsInhjX3RlYWNobWFuYWdlcl9jb3Vyc2UiLCJ4Y19zeXNtYW5hZ2VyX3VzZXJfYWRkIiwieGNfc3lzbWFuYWdlcl9jb21wYW55IiwieGNfc3lzbWFuYWdlcl91c2VyX2RlbGV0ZSIsInhjX3N5c21hbmFnZXJfdXNlciIsInhjX3RlYWNobWFuYWdlcl9jb3Vyc2VfYmFzZSIsInhjX3RlYWNobWFuYWdlcl9jb3Vyc2VfbGlzdCIsInhjX3N5c21hbmFnZXIiLCJ4Y19zeXNtYW5hZ2VyX2xvZyIsInhjX3N5c21hbmFnZXJfdXNlcl9lZGl0IiwieGNfdGVhY2htYW5hZ2VyX2NvdXJzZV9hZGQiXSwianRpIjoiOTYyOTYzMWQtYjRiMC00NTlkLTgzYzktM2Q4MmRiNmI4NDEzIiwiY2xpZW50X2lkIjoiWGNXZWJBcHAifQ.b77ZreiNlPoN-_dnAWxuBfH32tPIoRwg2ePgKn_aZ8c</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-2-前后端联调" tabindex="-1"><a class="header-anchor" href="#_2-3-2-前后端联调" aria-hidden="true">#</a> <strong>2.3.2 前后端联调</strong></h4><p>测试流程：</p><p>1、启动认证服务、网关服务、验证码服务、学习中心服务、内容管理服务。</p><p>2、发布一门免费课程、一门收费课程</p><p>3、进入课程详情界面，点击“马上学习”</p><p>4、报名成功，自动跳转到学习界面。</p><p>5、观察选课记录表、我的课程表数据是否正确。</p><p>对于免费课程在课程详情页面点击“马上学习”，通过引导界面添加选课。</p><p>1、进入课程详情点击马上学习</p><p><img src="/MyBlog/assets/image-20230611154838147-4d93de17.png" alt="image-20230611155550670"></p><p>2、课程免费时引导加入我的课程表、或进入学习界面。</p><p><img src="/MyBlog/assets/image-20230611154844659-4ef6b95e.png" alt="image-20230611155554764"></p><h2 id="_3-支付" tabindex="-1"><a class="header-anchor" href="#_3-支付" aria-hidden="true">#</a> <strong>3 支付</strong></h2><h3 id="_3-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_3-1-需求分析" aria-hidden="true">#</a> <strong>3.1 需求分析</strong></h3><h4 id="_3-1-1-执行流程" tabindex="-1"><a class="header-anchor" href="#_3-1-1-执行流程" aria-hidden="true">#</a> <strong>3.1.1 执行流程</strong></h4><p>用户去学习收费课程时引导其去支付，如下图：</p><p><img src="/MyBlog/assets/image-20230611154849591-3d021039.png" alt="image-20230611155559312"></p><p>当用户点击“微信支付”或支付宝支付时执行流程如下：</p><p><img src="/MyBlog/assets/image-20230611155603305-105cd717.png" alt="image-20230611155603305"></p><p>1、请求学习中心服务创建选课记录</p><p>2、请求订单服务创建商品订单、生成支付二维码。</p><p>3、用户扫码请求订单支付服务，订单支付服务请求第三方支付平台生成支付订单。</p><p>4、前端唤起支付客户端，用户输入密码完成支付。</p><p>5、第三方支付平台支付完成发起支付通知。</p><p>6、订单支付服务接收第三方支付通知结果。</p><p>7、用户在前端查询支付结果，请求订单支付服务查询支付结果。</p><p>8、订单支付服务向学习中心服务通知支付结果。</p><p>9、学习中心服务收到支付结果，如果支付成功则更新选课记录，并添加到我的课程表。</p><h4 id="_3-1-2-通用订单服务设计" tabindex="-1"><a class="header-anchor" href="#_3-1-2-通用订单服务设计" aria-hidden="true">#</a> <strong>3.1.2 通用订单服务设计</strong></h4><p>在本项目中不仅选课需要下单、购买学习资料、老师一对一答疑等所以收费项目都需要下单支付。</p><p>所以本项目设计通用的订单服务，通用的订单服务承接各业务模块的收费支付需求，当用户需要交费时统一生成商品订单并进行支付。</p><p><img src="/MyBlog/assets/image-20230611155609750-14c4d6cc.png" alt="image-20230611155609750"></p><p>所有收费业务最终转换为商品订单记录在订单服务的商品订单表。</p><p><img src="/MyBlog/assets/image-20230611155614327-a1cc34a0.png" alt="image-20230611155614327"></p><p>以选课为例，选课记录表的 ID 记录在商品订单表的 out_business_id 字段。</p><p><img src="/MyBlog/assets/image-20230611155618433-12fb514d.png" alt="image-20230611155618433"></p><h3 id="_3-2-支付接口调研" tabindex="-1"><a class="header-anchor" href="#_3-2-支付接口调研" aria-hidden="true">#</a> <strong>3.2 支付接口调研</strong></h3><h4 id="_3-2-1-微信支付接口调研" tabindex="-1"><a class="header-anchor" href="#_3-2-1-微信支付接口调研" aria-hidden="true">#</a> <strong>3.2.1 微信支付接口调研</strong></h4><p>一般情况下，一个网站要支持在线支付功能通常接入第三方支付平台，比如：微信支付、支付宝、其它的聚合支付平台。</p><p>本项目的需求实现手机扫码支付，现在对微信、支付宝的支付接口进行调研。</p><p>微信目前提供的支付方式如下：</p><p>地址：https://pay.weixin.qq.com/static/product/product_index.shtml</p><p><img src="/MyBlog/assets/image-20230611155624227-53090a7f.png" alt="image-20230611155624227"></p><p>1、付款码支付是指用户展示微信钱包内的“付款码”给商户系统扫描后直接完成支付，适用于线下场所面对面收银的场景，例如商超、便利店、餐饮、医院、学校、电影院和旅游景区等具有明确经营地址的实体场所。</p><p><img src="/MyBlog/assets/image-20230611155628749-1eb9f012.png" alt="image-20230611155628749"></p><p>2、JSAPI 支付是指商户通过调用微信支付提供的 JSAPI 接口，在支付场景中调起微信支付模块完成收款</p><p>线下场所：调用接口生成二维码，用户扫描二维码后在微信浏览器中打开页面后完成支付</p><p>公众号场景：用户在微信公众账号内进入商家公众号，打开某个主页面，完成支付</p><p>PC 网站场景：在网站中展示二维码，用户扫描二维码后在微信浏览器中打开页面后完成支付</p><p><img src="/MyBlog/assets/image-20230611155634450-36b7ed24.png" alt="image-20230611155634450"></p><p>3、小程序支付是指商户通过调用微信支付小程序支付接口，在微信小程序平台内实现支付功能；用户打开商家助手小程序下单，输入支付密码并完成支付后，返回商家小程序。</p><p><img src="/MyBlog/assets/image-20230611155637962-092f0d2b.png" alt="image-20230611155637962"></p><p>4、Native 支付是指商户系统按微信支付协议生成支付二维码，用户再用微信“扫一扫”完成支付的模式。该模式适用于 PC 网站、实体店单品或订单、媒体广告支付等场景。</p><p><img src="/MyBlog/assets/image-20230611155642831-3438d409.png" alt="image-20230611155642831"></p><p>5、APP 支付是指商户通过在移动端应用 APP 中集成开放 SDK 调起微信支付模块来完成支付。适用于在移动端 APP 中集成微信支付功能的场景。</p><p><img src="/MyBlog/assets/image-20230611155647113-f7259439.png" alt="image-20230611155647113"></p><p>6、刷脸支付是指用户在刷脸设备前通过摄像头刷脸、识别身份后进行的一种支付方式，安全便捷。适用于线下实体场所的收银场景，如商超、餐饮、便利店、医院、学校等。</p><p><img src="/MyBlog/assets/image-20230611155651198-2877e862.png" alt="image-20230611155651198"></p><blockquote><p>以上接口 native 和 JSAPI 都可以实现 pc 网站实现扫码支付，两者区别是什么？怎么选择？</p></blockquote><p>JSAPI 除了在 pc 网站扫码支付还可以实现公众号页面内支付，可以实现在手机端 H5 页面唤起微信客户端完成支付。</p><p>本项目选择 JSAPI 支付接口。</p><p>接口文档：https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_1_1.shtml</p><blockquote><p>如何开通 JSAPI 支付接口?</p></blockquote><p>以企业身份注册微信公众号<a href="https://mp.weixin.qq.com/" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><img src="/MyBlog/assets/image-20230611155706237-6dcbdc15.png" alt="image-20230611155706237"></p><p>登录公众号，点击左侧菜单“微信支付”开通微信支付，如下：</p><p>需要提供营业执照、身份证等信息。</p><p><img src="/MyBlog/assets/image-20230611155710577-f01f66ae.png" alt="image-20230611155710577"></p><p>点击申请接入，需要注册微信商户号。</p><p><img src="/MyBlog/assets/image-20230611155714951-08228c06.png" alt="image-20230611155714951"></p><p>注册微信商户号的过程请参考官方文档，本文档略。参考地址如下：</p><p><a href="https://pay.weixin.qq.com/index.php/apply/applyment_home/guide_normal#none" target="_blank" rel="noopener noreferrer">https://pay.weixin.qq.com/index.php/apply/applyment_home/guide_normal#none<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>开通微信支付后即可在微信商户平台（pay.weixin.qq.com）开通 JSAPI 支付。</p><p>登录商品平台，进入产品中心，开通 JSAPI 支付：</p><p><img src="/MyBlog/assets/image-20230611155720368-e19ff395.png" alt="image-20230611155720368"></p><p>注意：JSAPI 支付方式需要在公众号配置回调域名，此域名为已经备案的外网域名。</p><p>最后在公众号开发信息中获取：开发者 id、开发者密码。</p><h4 id="_3-2-2-支付宝接口调研" tabindex="-1"><a class="header-anchor" href="#_3-2-2-支付宝接口调研" aria-hidden="true">#</a> <strong>3.2.2 支付宝接口调研</strong></h4><p>支付宝支付产品如下：</p><p>文档：https://b.alipay.com/signing/productSetV2.htm</p><p><img src="/MyBlog/assets/image-20230611155726032-759f7027.png" alt="image-20230611155726032"></p><p>与本项目需求相关的接口：电脑网站支付、手机网站支付。</p><p>1、电脑网站支付</p><p>PC 网站轻松收款，资金马上到账：用户在商家 PC 网站消费，自动跳转支付宝 PC 网站收银台完成付款。 交易资金直接打入商家支付宝账户，实时到账。</p><p><img src="/MyBlog/assets/image-20230611155730666-f935cf24.png" alt="image-20230611155730666"></p><p>2、手机网站支付</p><p>用户在商家手机网站消费，通过浏览器自动跳转支付宝 APP 或支付宝网页完成付款。 轻松实现和 APP 支付相同的支付体验。</p><p><img src="/MyBlog/assets/image-20230611155735458-c710e05a.png" alt="image-20230611155735458"></p><p>对比两种支付方式：手机网站支付方式可以在 H5 网页唤起支付宝，手机扫码支付可以使用手机网站支付方式来完成，相比电脑网站支付形式更灵活。</p><p>本项目选择手机网站支付方式。</p><p>文档：https://opendocs.alipay.com/open/02ivbt</p><blockquote><p>如何开通支付宝手机网站支付接口？</p></blockquote><p>进入网址：https://b.alipay.com/signing/productDetailV2.htm?productId=I1011000290000001001</p><p>点击：立即开通</p><p>上传营业执照等资料，提交审核，根据提示进行开通。</p><p><img src="/MyBlog/assets/image-20230611155748587-1508fbda.png" alt="image-20230611155748587"></p><h3 id="_3-3-准备开发环境" tabindex="-1"><a class="header-anchor" href="#_3-3-准备开发环境" aria-hidden="true">#</a> <strong>3.3 准备开发环境</strong></h3><h4 id="_3-3-1-支付宝开发环境" tabindex="-1"><a class="header-anchor" href="#_3-3-1-支付宝开发环境" aria-hidden="true">#</a> <strong>3.3.1 支付宝开发环境</strong></h4><p>第三方支付接口流程大同小异，考虑开发及教学的方便性，支付宝提供支付宝沙箱环境开发支付接口，在教学中接入支付宝手机网站支付接口。</p><p>1、配置沙箱环境</p><p>沙箱环境是支付宝开放平台为开发者提供的与生产环境完全隔离的联调测试环境，开发者在沙箱环境中完成的接口调用不会对生产环境中的数据造成任何影响。</p><p>接入手机网站支付需要具备如下条件：</p><p>申请前必须拥有经过实名认证的支付宝账户；</p><p>企业或个体工商户可申请；</p><p>需提供真实有效的营业执照，且支付宝账户名称需与营业执照主体一致；</p><p>网站能正常访问且页面显示完整，网站需要明确经营内容且有完整的商品信息；</p><p>网站必须通过 ICP 备案。如为个体工商户，网站备案主体需要与支付宝账户主体名称一致；</p><p>如为个体工商户，则团购不开放，且古玩、珠宝等奢侈品、投资类行业无法申请本产品。</p><p>详细参见：<a href="https://docs.open.alipay.com/203" target="_blank" rel="noopener noreferrer">https://docs.open.alipay.com/203<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>本文档使用支付宝沙箱进行开发测试，这里主要介绍支付宝沙箱环境配置。</p><p>详细参见：<a href="https://docs.open.alipay.com/200/105311/" target="_blank" rel="noopener noreferrer">https://docs.open.alipay.com/200/105311/<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>开发过程需要三个支付参数：app_id、应用私钥、支付宝公钥，下边在支付宝开发平台配置沙箱环境。</p><p>进入支付宝开放平台：https://open.alipay.com/</p><p><img src="/MyBlog/assets/image-20230611160557635-062d627f.png" alt="image-20230611160557635"></p><p>点击登录，使用自己的支付宝账号扫码登录即可。</p><p>登录成功，进入控制台：</p><p><img src="/MyBlog/assets/image-20230611160602595-b1bda681.png" alt="image-20230611160602595"></p><p>在控制台首页最下方 点击进入沙箱环境</p><p><img src="/MyBlog/assets/image-20230611160605932-54e6180e.png" alt="image-20230611160605932"></p><p>进入沙箱环境页面列出了应用信息，其中就有我们需要的 appid。</p><p><img src="/MyBlog/assets/image-20230611160608908-6a56bf45.png" alt="image-20230611160608908"></p><p>点击“查看”，查看密钥，开发需要支付宝公钥和应用私钥，稍后我们需要使用它们进行开发测试。</p><p><img src="/MyBlog/assets/image-20230611160614175-848e6254.png" alt="image-20230611160614175"></p><p>根据测试需要进行充值（沙箱环境为虚拟充值）</p><p><img src="/MyBlog/assets/image-20230611160618118-b69373fa.png" alt="image-20230611160618118"></p><p>2、模拟器</p><p>下载模拟器：<a href="http://mumu.163.com/" target="_blank" rel="noopener noreferrer">http://mumu.163.com/<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>安装模拟器，安装在没有空格和中文的目录。</p><p>安装成功，启动模拟器</p><p><img src="/MyBlog/assets/image-20230611160623067-7b997999.png" alt="image-20230611160623067"></p><p>下一步在模拟器安装支付宝：</p><p>选择课程资料中支付宝安装包 wallet_101521226_client_release_201812261416.apk（沙箱版本）</p><p><img src="/MyBlog/assets/image-20230611160627678-6facb5ba.png" alt="image-20230611160627678"></p><p>安装成功后支付宝客户端的快捷方式出现在桌面上。</p><p><img src="/MyBlog/assets/image-20230611160632712-9d6071eb.png" alt="image-20230611160632712"></p><p>使用沙箱环境的买家账号登录沙箱版本的支付宝。</p><p>查看沙箱环境的账号：</p><p><img src="/MyBlog/assets/image-20230611160636353-177d8cc6.png" alt="image-20230611160636353"></p><h4 id="_3-3-2-创建订单服务" tabindex="-1"><a class="header-anchor" href="#_3-3-2-创建订单服务" aria-hidden="true">#</a> <strong>3.3.2 创建订单服务</strong></h4><p>拷贝课程资料目录下的订单服务工程 xuecheng-plus-orders 到自己的工程目录。</p><p><img src="/MyBlog/assets/image-20230611160641126-c8fe7bbf.png" alt="image-20230611160641126"></p><p>创建 xc_orders 数据库，并导入 xcplus_orders.sql</p><p>修改 nacos 中 orders-service-dev.yaml 的数据库连接参数。</p><h3 id="_3-4-支付接口测试" tabindex="-1"><a class="header-anchor" href="#_3-4-支付接口测试" aria-hidden="true">#</a> <strong>3.4 支付接口测试</strong></h3><h4 id="_3-4-1-阅读接口定义" tabindex="-1"><a class="header-anchor" href="#_3-4-1-阅读接口定义" aria-hidden="true">#</a> <strong>3.4.1 阅读接口定义</strong></h4><p>手机网站支付接入流程详细参见：<a href="https://docs.open.alipay.com/203/105285/" target="_blank" rel="noopener noreferrer">https://docs.open.alipay.com/203/105285/<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>1、接口交互流程如下：</p><p><img src="/MyBlog/assets/image-20230611160650446-752b2108.png" alt="image-20230611160650446"></p><p>1）用户在商户的 H5 网站下单支付后，商户系统按照<a href="https://docs.open.alipay.com/203/107090" target="_blank" rel="noopener noreferrer">手机网站支付接口 alipay.trade.wap.pay<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>API 的参数规范生成订单数据</p><p>2）前端页面通过 Form 表单的形式请求到支付宝。此时支付宝会自动将页面跳转至支付宝 H5 收银台页面，如果用户手机上安装了支付宝 APP，则自动唤起支付宝 APP。</p><p>3）输入支付密码完成支付。</p><p>4）用户在支付宝 APP 或 H5 收银台完成支付后，会根据商户在手机网站支付 API 中传入的前台回跳地址 return_url 自动跳转回商户页面，同时在 URL 请求中以 Query String 的形式附带上支付结果参数，详细回跳参数见“手机网站支付接口 alipay.trade.wap.pay”<a href="https://docs.open.alipay.com/203/107090#s2" target="_blank" rel="noopener noreferrer">前台回跳参数<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</p><p>5）支付宝还会根据原始支付 API 中传入的异步通知地址 notify_url，通过 POST 请求的形式将支付结果作为参数通知到商户系统，详情见<a href="https://docs.open.alipay.com/203/105286" target="_blank" rel="noopener noreferrer">支付结果异步通知<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</p><p>2、接口定义</p><p>文档：https://opendocs.alipay.com/open/203/107090</p><p>接口定义：外部商户请求支付宝创建订单并支付</p><p>公共参数</p><p><strong>请求地址</strong>：</p><p>开发中使用沙箱地址：<a href="https://openapi.alipaydev.com/gateway.do" target="_blank" rel="noopener noreferrer">https://openapi.alipaydev.com/gateway.do<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>请求参数：</p><p>详细查阅https://opendocs.alipay.com/open/203/107090</p><p>一部分由 sdk 设置，一部分需要编写程序时指定。</p><p><img src="/MyBlog/assets/image-20230611160700930-1cca8224.png" alt="image-20230611160700930"></p><p><img src="/MyBlog/assets/image-20230611160707737-c06df359.png" alt="image-20230611160707737"></p><p><img src="/MyBlog/assets/image-20230611160711897-5d443f9f.png" alt="image-20230611160711897"></p><p><img src="/MyBlog/assets/image-20230611160714869-54f6d4e2.png" alt="image-20230611160714869"></p><p>其它扩展参数参见接口文档。</p><p>3、示例代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doPost</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> httpRequest<span class="token punctuation">,</span>
                   <span class="token class-name">HttpServletResponse</span> httpResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">AlipayClient</span> alipayClient <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">//获得初始化的AlipayClient</span>
    <span class="token class-name">AlipayTradeWapPayRequest</span> alipayRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayTradeWapPayRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建API对应的request</span>
    alipayRequest<span class="token punctuation">.</span><span class="token function">setReturnUrl</span><span class="token punctuation">(</span><span class="token string">&quot;http://domain.com/CallBack/return_url.jsp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    alipayRequest<span class="token punctuation">.</span><span class="token function">setNotifyUrl</span><span class="token punctuation">(</span><span class="token string">&quot;http://domain.com/CallBack/notify_url.jsp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在公共参数中设置回跳和通知地址</span>
    alipayRequest<span class="token punctuation">.</span><span class="token function">setBizContent</span><span class="token punctuation">(</span><span class="token string">&quot;{&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;    \&quot;out_trade_no\&quot;:\&quot;20150320010101002\&quot;,&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;    \&quot;total_amount\&quot;:88.88,&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;    \&quot;subject\&quot;:\&quot;Iphone6 16G\&quot;,&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;    \&quot;product_code\&quot;:\&quot;QUICK_WAP_WAY\&quot;&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;  }&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//填充业务参数</span>
    <span class="token class-name">String</span> form <span class="token operator">=</span> alipayClient<span class="token punctuation">.</span><span class="token function">pageExecute</span><span class="token punctuation">(</span>alipayRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调用SDK生成表单</span>
    httpResponse<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;text/html;charset=&quot;</span> <span class="token operator">+</span> <span class="token class-name">AlipayServiceEnvConstants</span><span class="token punctuation">.</span><span class="token constant">CHARSET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//直接将完整的表单html输出到页面</span>
    httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-4-2-下单执行流程" tabindex="-1"><a class="header-anchor" href="#_3-4-2-下单执行流程" aria-hidden="true">#</a> <strong>3.4.2 下单执行流程</strong></h4><p>根据接口描述，支付宝下单接口的执行流程如下：</p><p><img src="/MyBlog/assets/image-20230611160731156-728b04b8.png" alt="image-20230611160731156"></p><h4 id="_3-4-3-支付接口测试" tabindex="-1"><a class="header-anchor" href="#_3-4-3-支付接口测试" aria-hidden="true">#</a> <strong>3.4.3 支付接口测试</strong></h4><h5 id="_3-4-3-1-编写下单代码" tabindex="-1"><a class="header-anchor" href="#_3-4-3-1-编写下单代码" aria-hidden="true">#</a> <strong>3.4.3.1 编写下单代码</strong></h5><p>根据接口流程，首先在订单服务编写测试类请求支付宝下单的接口。</p><p>在订单服务 api 工程添加依赖：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>
<span class="token comment">&lt;!-- 支付宝SDK --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alipay.sdk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>alipay-sdk-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.7.73.ALL<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 支付宝SDK依赖的日志 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>commons-logging<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-logging<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下载示例代码https://opendocs.alipay.com/open/203/105910</p><p>拷贝示例代码，修改、测试。</p><p>拷贝 AlipayConfig.java 到订单服务的 service 工程。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>orders<span class="token punctuation">.</span>api</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">AlipayApiException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">AlipayClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">DefaultAlipayClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>api<span class="token punctuation">.</span>request<span class="token punctuation">.</span></span><span class="token class-name">AlipayTradeWapPayRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>orders<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">AlipayConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> 测试支付宝接口
 * <span class="token keyword">@date</span> 2022/10/20 22:19
 */</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayTestController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${pay.alipay.APP_ID}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token constant">APP_ID</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${pay.alipay.APP_PRIVATE_KEY}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token constant">APP_PRIVATE_KEY</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${pay.alipay.ALIPAY_PUBLIC_KEY}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token constant">ALIPAY_PUBLIC_KEY</span><span class="token punctuation">;</span>



    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/alipaytest&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doPost</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> httpRequest<span class="token punctuation">,</span>
                       <span class="token class-name">HttpServletResponse</span> httpResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">AlipayApiException</span> <span class="token punctuation">{</span>
        <span class="token class-name">AlipayClient</span> alipayClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAlipayClient</span><span class="token punctuation">(</span><span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">,</span> <span class="token constant">APP_ID</span><span class="token punctuation">,</span> <span class="token constant">APP_PRIVATE_KEY</span><span class="token punctuation">,</span> <span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token constant">FORMAT</span><span class="token punctuation">,</span> <span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token constant">CHARSET</span><span class="token punctuation">,</span> <span class="token constant">ALIPAY_PUBLIC_KEY</span><span class="token punctuation">,</span><span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token constant">SIGNTYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获得初始化的AlipayClient</span>
        <span class="token class-name">AlipayTradeWapPayRequest</span> alipayRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayTradeWapPayRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建API对应的request</span>
<span class="token comment">//        alipayRequest.setReturnUrl(&quot;http://domain.com/CallBack/return_url.jsp&quot;);</span>
<span class="token comment">//        alipayRequest.setNotifyUrl(&quot;http://domain.com/CallBack/notify_url.jsp&quot;);//在公共参数中设置回跳和通知地址</span>
        alipayRequest<span class="token punctuation">.</span><span class="token function">setBizContent</span><span class="token punctuation">(</span><span class="token string">&quot;{&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;    \&quot;out_trade_no\&quot;:\&quot;202210100010101002\&quot;,&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;    \&quot;total_amount\&quot;:0.1,&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;    \&quot;subject\&quot;:\&quot;Iphone6 16G\&quot;,&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;    \&quot;product_code\&quot;:\&quot;QUICK_WAP_WAY\&quot;&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;  }&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//填充业务参数</span>
        <span class="token class-name">String</span> form <span class="token operator">=</span> alipayClient<span class="token punctuation">.</span><span class="token function">pageExecute</span><span class="token punctuation">(</span>alipayRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调用SDK生成表单</span>
        httpResponse<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;text/html;charset=&quot;</span> <span class="token operator">+</span> <span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token constant">CHARSET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//直接将完整的表单html输出到页面</span>
        httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-4-3-2-生成二维码" tabindex="-1"><a class="header-anchor" href="#_3-4-3-2-生成二维码" aria-hidden="true">#</a> <strong>3.4.3.2 生成二维码</strong></h5><p>用户在前端使用支付宝沙箱通过扫码请求下单接口，我们需要生成订单服务的下单接口的二维码。</p><p>ZXing 是一个开源的类库，是用 Java 编写的多格式的 1D / 2D 条码图像处理库，使用 ZXing 可以生成、识别 QR Code（二维码）。常用的二维码处理库还有 zbar，近几年已经不再更新代码，下边介绍 ZXing 生成二维码的方法。</p><p>1）引入依赖</p><p>在 base 工程 pom.xml 中添加依赖：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>
        <span class="token comment">&lt;!-- 二维码生成&amp;识别组件 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.google.zxing<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.3.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.google.zxing<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>javase<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.3.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-lang3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2）生成二维码方法</p><p>拷贝课程资料中 utils 下的 QRCodeUtil.java 到 base 工程 util 包下。</p><p>测试根据内容生成二维码方法，在 QRCodeUtil 中添加 main 方法如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">QRCodeUtil</span> qrCodeUtil <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QRCodeUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>qrCodeUtil<span class="token punctuation">.</span><span class="token function">createQRCode</span><span class="token punctuation">(</span><span class="token string">&quot;http://www.itcast.cn/&quot;</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行 main 方法输入二维码图片的 base64 串，如下：</p><div class="language-tex line-numbers-mode" data-ext="tex"><pre class="language-tex"><code>
data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADIAQAAAACFI5MzAAABQElEQVR42u2YPZKDMAyF5aFIuUfIUThafDSOwhEoUzC8fZKMySSbrVI8ZuICBX8uIvtZPxjeDfuSf8liPi7LFSgrzRTvV3XCKawXYLptFobviz6ZzB2xEfTjhyS9OwXB3A7jbMSngLOQ0I4v2AZf96wqTWJ9+9/dYEHSx2RYqfg/oqUgiX3nFBVfcCepcSbiJP67iwZ1G+5+Am7kyTzW9OcW/kRAX+QJ953+uCl8zO5PV5UsaffUp8rqP5+jiySJU8jtNxcNrysetCNK6A/V4lEQeU+xa0eZREE1tOTpFYod0VKXsKCqvRqMkW5pkza8Ggy3WgEuTvZcz0dcUBc+9MneL1DqkXjQz0eaZA1LqVtmzcMffTKPiPwz1mh2zkGyNwtT9kguTVI7LWv6ul7DCpOjX9iaGV66HDny/ZL1WfILfc/hMHLUpekAAAAASUVORK5CYII=


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将 base64 串复制到浏览器地址后回车将展示一个二维码，用户用手机扫此二维码将请求至http://www.itcast.cn/。</p><p><img src="/MyBlog/assets/image-20230611160853225-962d0509.png" alt="image-20230611160853225"></p><h5 id="_3-4-3-3-接口测试" tabindex="-1"><a class="header-anchor" href="#_3-4-3-3-接口测试" aria-hidden="true">#</a> <strong>3.4.3.3 接口测试</strong></h5><p>1、生成订单服务下单接口的二维码</p><p>修改二维码生成的代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token class-name">QRCodeUtil</span> qrCodeUtil <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QRCodeUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>qrCodeUtil<span class="token punctuation">.</span><span class="token function">createQRCode</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:63030/orders/alipaytest&quot;</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意：http://localhost:63030 地址用模拟器无法访问，进入 cmd 命令状态，输入命令 ipconfig -all 查看本地网卡分配的局域网 ip 地址，将上边的地址修改如下：</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>
<span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//192.168.101.1:63030/orders/alipaytest</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行 main 方法，复制输出到控制台的 base64 串。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>
data:image/png<span class="token punctuation">;</span>base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADIAQAAAACFI5MzAAABxUlEQVR42u2YO46EMBBEGxE45AjcBC6GhCUuNtzER3DoANFbZT4zu9KmNavVOLAwj6BV/TXmvy37kL9Oopl1sS+DWV/M2oRzKyWL+95tfXDfenyzJK/vlCTZ0G1WGpzDDlKA9ST2YbfJrMnz2wiE8WQw8A2E/lkc6kQ66afnBKTGKCwaru179ApIXVBnzNb7gy+/ZbCAQJgB5zLCyrD6ZnSSlPAxm1VNyphh28NmKUFI7F3EQ55qrXJfL3VUBOGZJyssF74C45tWSjbEBW2DJslG94QPtQTNYsyzH9WSrgmXOiqCCBlgFmIUhMLwKCVcSFHkxsaagcY1vmSwgkRDZE5WO4YzT6tYSuIprNTEzskBedq5lNS4wEs2TOiEbT1tUxGslaW6OoX98+5ZKhLpmhYFi8LsTNY7T1WE7apNzE5UCgiDD2cpca+T612v0zNGZYQWMVDhJG7h2dE1BOoMSIujUjQcZUYxOWcXBodzeuKmJdddhtNTqZNcc1cxDTnuMmwbxr7dup5wjl8S44J9O75Mdkpyzo1hr/eqV9tUBE+8waBy80p1T3YictxpDyexcQUXk+Muw9m5RohZnWKU5PMX55+RLyKnzJvqtaeFAAAAAElFTkSuQmCC


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>打开模拟器，在模拟器中打开浏览器，将 base64 串复制到浏览器的地址栏。</p><p><img src="/MyBlog/assets/image-20230611160927317-fec0c69d.png" alt="image-20230611160927317"></p><p>使用截屏工具进行截屏，稍后使用支付宝沙箱客户端扫此图片。</p><p><img src="/MyBlog/assets/image-20230611160931802-815ce84f.png" alt="image-20230611160931802"></p><p>2、启动订单服务</p><p>3、打开模拟器，在模拟器中打开支付宝沙箱客户端，并使用沙箱客户端账号密码登录。</p><p><img src="/MyBlog/assets/image-20230611160938363-bb05bf62.png" alt="image-20230611160938363"></p><p>点击扫一扫选择相册中刚才截屏的二维码</p><p><img src="/MyBlog/assets/image-20230611160944292-bbf8223f.png" alt="image-20230611160944292"></p><p><img src="/MyBlog/assets/image-20230611160950503-154a99cc.png" alt="image-20230611160950503"></p><p>扫码后如果提示系统繁忙再重试</p><p><img src="/MyBlog/assets/image-20230611160958247-31d09cea.png" alt="image-20230611160958247"></p><p>如果提示请求勿重复提交则需要修改下单测试代码中指定的 out_trade_no 商品订单号，订单号在每个商户是唯一的，每次支付前修改 out_trade_no 为一个没有使用过的订单号。</p><p><img src="/MyBlog/assets/image-20230611161005577-c12dcd32.png" alt="image-20230611161005577"></p><p>修改订单号后重启订单服务，再使用沙箱支付宝客户端扫码</p><p><img src="/MyBlog/assets/image-20230611161011597-075d325f.png" alt="image-20230611161011597"></p><p>输入支付密码进行支付。</p><p>支付密码为沙箱账号的支付密码，此支付所扣款为沙箱账号的虚拟货币余额。</p><p><img src="/MyBlog/assets/image-20230611161021705-9687fe28.png" alt="image-20230611161021705"></p><p>支付成功界面：</p><p><img src="/MyBlog/assets/image-20230611161029711-3a2bd41b.png" alt="image-20230611161029711"></p><h4 id="_3-4-4-支付结果查询接口" tabindex="-1"><a class="header-anchor" href="#_3-4-4-支付结果查询接口" aria-hidden="true">#</a> <strong>3.4.4 支付结果查询接口</strong></h4><p>支付完成可以调用第三方支付平台的支付结果查询接口 查询支付结果。</p><p>文档：https://opendocs.alipay.com/open/02ivbt</p><p>示例代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token class-name">AlipayClient</span> alipayClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAlipayClient</span><span class="token punctuation">(</span><span class="token string">&quot;https://openapi.alipay.com/gateway.do&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;app_id&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;your private_key&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;json&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;GBK&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;alipay_public_key&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;RSA2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">AlipayTradeQueryRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayTradeQueryRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">JSONObject</span> bizContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bizContent<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;20150320010101001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//bizContent.put(&quot;trade_no&quot;, &quot;2014112611001004680073956707&quot;);</span>
request<span class="token punctuation">.</span><span class="token function">setBizContent</span><span class="token punctuation">(</span>bizContent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">AlipayTradeQueryResponse</span> response <span class="token operator">=</span> alipayClient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;调用成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;调用失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>刚才订单付款成功，可以使用 out_trade_no 商品订单号或支付宝的交易流水号 trade_no 去查询支付结果。</p><p>out_trade_no 商品订单号: 是在下单请求时指定的商品订单号。</p><p>支付宝的交易流水号 trade_no：是支付完成后支付宝通知支付结果时发送的 trade_no</p><p>我们使用 out_trade_no 商品订单号去查询，代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>orders<span class="token punctuation">.</span>api</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">AlipayApiException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">AlipayClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">DefaultAlipayClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>api<span class="token punctuation">.</span>request<span class="token punctuation">.</span></span><span class="token class-name">AlipayTradeQueryRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>api<span class="token punctuation">.</span>response<span class="token punctuation">.</span></span><span class="token class-name">AlipayTradeQueryResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> 支付宝查询接口
 * <span class="token keyword">@date</span> 2022/10/4 17:18
 */</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AliPayTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${pay.alipay.APP_ID}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token constant">APP_ID</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${pay.alipay.APP_PRIVATE_KEY}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token constant">APP_PRIVATE_KEY</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${pay.alipay.ALIPAY_PUBLIC_KEY}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token constant">ALIPAY_PUBLIC_KEY</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">queryPayResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AlipayApiException</span> <span class="token punctuation">{</span>
    <span class="token class-name">AlipayClient</span> alipayClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAlipayClient</span><span class="token punctuation">(</span><span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">,</span> <span class="token constant">APP_ID</span><span class="token punctuation">,</span> <span class="token constant">APP_PRIVATE_KEY</span><span class="token punctuation">,</span> <span class="token string">&quot;json&quot;</span><span class="token punctuation">,</span> <span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token constant">CHARSET</span><span class="token punctuation">,</span> <span class="token constant">ALIPAY_PUBLIC_KEY</span><span class="token punctuation">,</span> <span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token constant">SIGNTYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获得初始化的AlipayClient</span>
    <span class="token class-name">AlipayTradeQueryRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayTradeQueryRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JSONObject</span> bizContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bizContent<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;202210100010101002&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//bizContent.put(&quot;trade_no&quot;, &quot;2014112611001004680073956707&quot;);</span>
    request<span class="token punctuation">.</span><span class="token function">setBizContent</span><span class="token punctuation">(</span>bizContent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AlipayTradeQueryResponse</span> response <span class="token operator">=</span> alipayClient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;调用成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> resultJson <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//转map</span>
        <span class="token class-name">Map</span> resultMap <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>resultJson<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> alipay_trade_query_response <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;alipay_trade_query_response&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//支付结果</span>
        <span class="token class-name">String</span> trade_status <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> alipay_trade_query_response<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;trade_status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>trade_status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;调用失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行代码，输出如下：</p><div class="language-tex line-numbers-mode" data-ext="tex"><pre class="language-tex"><code>
调用成功
TRADE_SUCCESS

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果即是调用支付宝查询接口查询到的支付结果</p><p><img src="/MyBlog/assets/image-20230611161115931-d5999707.png" alt="image-20230611161115931"></p><p>参考文档https://opendocs.alipay.com/open/02ivbt 查阅每个参数的意义。</p><p>我们主要需要下边的参数：</p><p>&quot;out_trade_no&quot; : &quot;20220520010101026&quot;,</p><p>&quot;trade_no&quot;:&quot;2022100422001422760505740639&quot; ： 支付宝交易流水号</p><p>&quot;total_amount&quot; : &quot;1.30&quot;</p><p>&quot;trade_status&quot; : &quot;TRADE_SUCCESS&quot;： 交易状态</p><p>交易状态类型：</p><p>交易状态：WAIT_BUYER_PAY（交易创建，等待买家付款）</p><p>TRADE_CLOSED（未付款交易超时关闭，或支付完成后全额退款）</p><p>TRADE_SUCCESS（交易支付成功）</p><p>TRADE_FINISHED（交易结束，不可退款）</p><h4 id="_3-4-5-支付结果通知接口" tabindex="-1"><a class="header-anchor" href="#_3-4-5-支付结果通知接口" aria-hidden="true">#</a> <strong>3.4.5 支付结果通知接口</strong></h4><h5 id="_3-4-5-1-准备环境" tabindex="-1"><a class="header-anchor" href="#_3-4-5-1-准备环境" aria-hidden="true">#</a> <strong>3.4.5.1 准备环境</strong></h5><p>对于手机网站支付产生的交易，支付宝会通知商户支付结果，有两种通知方式，通过 return_url、notify_url 进行通知，使用 return_url 不能保证通知到位，推荐使用 notify_url 完成支付结构通知。</p><p><img src="/MyBlog/assets/image-20230611161122366-8d60cba4.png" alt="image-20230611161122366"></p><p>具体的使用方法是在调用下单接口的 API 中传入的异步通知地址 notify_url，通过 POST 请求的形式将支付结果作为参数通知到商户系统。详情可查看 <a href="https://opendocs.alipay.com/support/01raw4" target="_blank" rel="noopener noreferrer">支付宝异步通知说明<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 。</p><p>文档：https://opendocs.alipay.com/open/203/105286</p><p>根据下单执行流程，订单服务收到支付结果需要对内容进行验签，验签过程如下：</p><p>在通知返回参数列表中，除去 sign、sign_type 两个参数外，凡是通知返回回来的参数皆是待验签的参数。将剩下参数进行 url_decode，然后进行字典排序，组成字符串，得到待签名字符串； 生活号异步通知组成的待验签串里需要保留 sign_type 参数。</p><p>将签名参数（sign）使用 base64 解码为字节码串；</p><p>使用 RSA 的验签方法，通过签名字符串、签名参数（经过 base64 解码）及支付宝公钥验证签名。</p><p>验证签名正确后，必须再严格按照如下描述校验通知数据的正确性。</p><p>在上述验证通过后，商户必须根据支付宝不同类型的业务通知，正确的进行不同的业务处理，并且过滤重复的通知结果数据。</p><p>通过验证 out_trade_no、total_amount、appid 参数的正确性判断通知请求的合法性。</p><p>验证的过程可以参考 sdk demo 代码，下载 sdk demo 代码，https://opendocs.alipay.com/open/203/105910</p><p><img src="/MyBlog/assets/image-20230611161134639-aeef8c38.png" alt="image-20230611161134639"></p><p>参考 demo 中的 alipay.trade.wap.pay-java-utf-8\WebContent\ notify_url.jsp</p><p>另外，支付宝通知订单服务的地址必须为外网域名且备案通过可以正常访问。</p><p>此接口仍然使用内网穿透技术。</p><h5 id="_3-4-5-2-编写测试代码" tabindex="-1"><a class="header-anchor" href="#_3-4-5-2-编写测试代码" aria-hidden="true">#</a> <strong>3.4.5.2 编写测试代码</strong></h5><p>1、在下单请求时设置通知地址 request.setNotifyUrl(&quot;商户自己的 notify_url 地址&quot;);</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/alipaytest&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">alipaytest</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> httpRequest<span class="token punctuation">,</span>
                           <span class="token class-name">HttpServletResponse</span> httpResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//构造sdk的客户端对象</span>
        <span class="token class-name">AlipayClient</span> alipayClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAlipayClient</span><span class="token punctuation">(</span>serverUrl<span class="token punctuation">,</span> <span class="token constant">APP_ID</span><span class="token punctuation">,</span> <span class="token constant">APP_PRIVATE_KEY</span><span class="token punctuation">,</span> <span class="token string">&quot;json&quot;</span><span class="token punctuation">,</span> <span class="token constant">CHARSET</span><span class="token punctuation">,</span> <span class="token constant">ALIPAY_PUBLIC_KEY</span><span class="token punctuation">,</span> sign_type<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获得初始化的AlipayClient</span>
        <span class="token class-name">AlipayTradeWapPayRequest</span> alipayRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayTradeWapPayRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建API对应的request</span>
<span class="token comment">//        alipayRequest.setReturnUrl(&quot;http://domain.com/CallBack/return_url.jsp&quot;);</span>
        alipayRequest<span class="token punctuation">.</span><span class="token function">setNotifyUrl</span><span class="token punctuation">(</span><span class="token string">&quot;http://tjxt-user-t.itheima.net/xuecheng/orders/paynotify&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在公共参数中设置回跳和通知地址</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、编写接收通知接口，接收参数并验签</p><p>参考课程资料下的 alipay.trade.wap.pay-java-utf-8\WebContent\notify_url.jsp</p><p>代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token comment">//接收通知</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/paynotify&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">paynotify</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnsupportedEncodingException</span><span class="token punctuation">,</span> <span class="token class-name">AlipayApiException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span> requestParams <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iter <span class="token operator">=</span> requestParams<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> requestParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> valueStr <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> values<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            valueStr <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> values<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> valueStr <span class="token operator">+</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                    <span class="token operator">:</span> valueStr <span class="token operator">+</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//乱码解决，这段代码在出现乱码时使用。如果mysign和sign不相等也可以使用这段代码转化</span>
        <span class="token comment">//valueStr = new String(valueStr.getBytes(&quot;ISO-8859-1&quot;), &quot;gbk&quot;);</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> valueStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">//获取支付宝的通知返回参数，可参考技术文档中页面跳转同步通知参数列表(以上仅供参考)//</span>
    <span class="token comment">//计算得出通知验证结果</span>
    <span class="token comment">//boolean AlipaySignature.rsaCheckV1(Map&lt;String, String&gt; params, String publicKey, String charset, String sign_type)</span>
    <span class="token keyword">boolean</span> verify_result <span class="token operator">=</span> <span class="token class-name">AlipaySignature</span><span class="token punctuation">.</span><span class="token function">rsaCheckV1</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token constant">ALIPAY_PUBLIC_KEY</span><span class="token punctuation">,</span> <span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token constant">CHARSET</span><span class="token punctuation">,</span> <span class="token string">&quot;RSA2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>verify_result<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//验证成功</span>
        <span class="token comment">//////////////////////////////////////////////////////////////////////////////////////////</span>
        <span class="token comment">//请在这里加上商户的业务逻辑程序代码</span>

         <span class="token comment">//商户订单号</span>
        <span class="token class-name">String</span> out_trade_no <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">&quot;ISO-8859-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//支付宝交易号</span>

        <span class="token class-name">String</span> trade_no <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;trade_no&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">&quot;ISO-8859-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//交易状态</span>
        <span class="token class-name">String</span> trade_status <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;trade_status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">&quot;ISO-8859-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//——请根据您的业务逻辑来编写程序（以下代码仅作参考）——</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>trade_status<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_FINISHED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//交易结束</span>
            <span class="token comment">//判断该笔订单是否在商户网站中已经做过处理</span>
            <span class="token comment">//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序</span>
            <span class="token comment">//请务必判断请求时的total_fee、seller_id与通知时获取的total_fee、seller_id为一致的</span>
            <span class="token comment">//如果有做过处理，不执行商户的业务程序</span>

            <span class="token comment">//注意：</span>
            <span class="token comment">//如果签约的是可退款协议，退款日期超过可退款期限后（如三个月可退款），支付宝系统发送该交易状态通知</span>
            <span class="token comment">//如果没有签约可退款协议，那么付款完成后，支付宝系统发送该交易状态通知。</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>trade_status<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_SUCCESS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//交易成功</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>trade_status<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//判断该笔订单是否在商户网站中已经做过处理</span>
            <span class="token comment">//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序</span>
            <span class="token comment">//请务必判断请求时的total_fee、seller_id与通知时获取的total_fee、seller_id为一致的</span>
            <span class="token comment">//如果有做过处理，不执行商户的业务程序</span>

            <span class="token comment">//注意：</span>
            <span class="token comment">//如果签约的是可退款协议，那么付款完成后，支付宝系统发送该交易状态通知。</span>
        <span class="token punctuation">}</span>
        response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;fail&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-4-5-3-通知接口测试" tabindex="-1"><a class="header-anchor" href="#_3-4-5-3-通知接口测试" aria-hidden="true">#</a> <strong>3.4.5.3 通知接口测试</strong></h5><p>1、重启订单服务，并在接收通知接口中打上断点</p><p>2、配置内网穿透的本地端口为订单服务端口，启动内网穿透客户端。</p><p>3、打开模拟器、支付宝沙箱，扫码、支付。</p><p>4、观察接收订单支付数据等是否正常。</p><h3 id="_3-5-生成支付二维码" tabindex="-1"><a class="header-anchor" href="#_3-5-生成支付二维码" aria-hidden="true">#</a> <strong>3.5 生成支付二维码</strong></h3><h4 id="_3-5-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_3-5-1-需求分析" aria-hidden="true">#</a> <strong>3.5.1 需求分析</strong></h4><h5 id="_3-5-1-1-执行流程" tabindex="-1"><a class="header-anchor" href="#_3-5-1-1-执行流程" aria-hidden="true">#</a> <strong>3.5.1.1 执行流程</strong></h5><p>再次打开课程支付引导界面，<code>点击“支付宝支付”按钮系统该如何处理？</code></p><p><img src="/MyBlog/assets/image-20230611154849591-3d021039.png" alt="image-20230611161211867"></p><p>点击“支付宝支付”此时打开支付二维码，用户扫码支付。</p><p>所以首先需要生成支付二维码，用户扫描二维码开始请求支付宝下单，在向支付宝下单前需要添加选课记录、创建商品订单、生成支付记录。</p><p>生成二维码执行流程如下：</p><p><img src="/MyBlog/assets/image-20230611161217060-3228d871.png" alt="image-20230611161217060"></p><p>执行流程：</p><p>1、前端调用学习中心服务的添加选课接口。</p><p>2、添加选课成功请求订单服务生成支付二维码接口。</p><p>3、生成二维码接口：创建商品订单、生成支付记录、生成二维码。</p><p>4、将二维码返回到前端，用户扫码。</p><p>用户扫码支付流程如下：</p><p><img src="/MyBlog/assets/image-20230611160731156-728b04b8.png" alt="image-20230611161222339"></p><p>执行流程：</p><p>1、用户输入支付密码，支付成功。</p><p>2、接收第三方平台通知的支付结果。</p><p>3、根据支付结果更新支付记录的支付状态为支付成功。</p><h5 id="_3-5-1-2-数据模型" tabindex="-1"><a class="header-anchor" href="#_3-5-1-2-数据模型" aria-hidden="true">#</a> <strong>3.5.1.2 数据模型</strong></h5><p>订单支付模式的核心由三张表组成：订单表、订单明细表、支付记录表。</p><p><img src="/MyBlog/assets/image-20230611161228016-96dd2ffc.png" alt="image-20230611161228016"></p><p>订单表：记录订单信息</p><p><img src="/MyBlog/assets/image-20230611161232342-9a810975.png" alt="image-20230611161232342"></p><p>订单明细表记录订单的详细信息</p><p><img src="/MyBlog/assets/image-20230611161235094-eccd760b.png" alt="image-20230611161235094"></p><p>支付记录表记录每次支付的详细信息</p><p><img src="/MyBlog/assets/image-20230611161238383-8771bfa7.png" alt="image-20230611161238383"></p><blockquote><p>为什么创建支付记录表？</p></blockquote><p>在请求微信、支付宝或其它第三方支付平台下单接口时需要传入商户的订单号，如果将我们系统的商品订单号直接传给第三方支付平台，<strong>当支付交易关闭或其它什么原因就导致第三方支付平台报“订单号已存在”，此时我们系统的订单将无法完成支付</strong>，我们的需求是用户什么时候想支付都可以完成支付。</p><p>解决以上问题的方案是：</p><p>1、用户每次发起支付都创建一个新的支付记录 ，此支付记录与商品订单关联。</p><p>2、将支付记录的流水号传给第三方支付系统的下单接口，这样即可解决上边的问题。</p><p>3、不过在程序中要考虑重复支付的问题。</p><p><img src="/MyBlog/assets/image-20230611161245410-216afbd8.png" alt="image-20230611161245410"></p><h4 id="_3-5-2-接口定义" tabindex="-1"><a class="header-anchor" href="#_3-5-2-接口定义" aria-hidden="true">#</a> <strong>3.5.2 接口定义</strong></h4><p>在订单服务中定义生成支付二维码接口。</p><p>请求：订单信息</p><p>响应：支付记录及二维码</p><p>下边先定义模型类再定义接口：</p><p>请求的订单模型类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>orders<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>orders<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">XcOrders</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">ToString</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> 创建商品订单
 * <span class="token keyword">@date</span> 2022/10/4 10:21
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AddOrderDto</span>  <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 总价
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Float</span> totalPrice<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 订单类型
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> orderType<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 订单名称
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> orderName<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 订单描述
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> orderDescrip<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 订单明细json，不可为空
     * [<span class="token punctuation">{</span>&quot;goodsId&quot;:&quot;&quot;,&quot;goodsType&quot;:&quot;&quot;,&quot;goodsName&quot;:&quot;&quot;,&quot;goodsPrice&quot;:&quot;&quot;,&quot;goodsDetail&quot;:&quot;&quot;<span class="token punctuation">}</span>,<span class="token punctuation">{</span>...<span class="token punctuation">}</span>]
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> orderDetail<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 外部系统业务id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> outBusinessId<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>响应：支付记录信息及二维码信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayRecordDto</span> <span class="token keyword">extends</span> <span class="token class-name">XcPayRecord</span> <span class="token punctuation">{</span>

    <span class="token comment">//二维码</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> qrcode<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>生成支付二维码定义如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;订单支付接口&quot;</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">&quot;订单支付接口&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;生成支付二维码&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/generatepaycode&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">PayRecordDto</span> <span class="token function">generatePayCode</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">AddOrderDto</span> addOrderDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-5-3-接口实现" tabindex="-1"><a class="header-anchor" href="#_3-5-3-接口实现" aria-hidden="true">#</a> <strong>3.5.3 接口实现</strong></h4><h5 id="_3-5-3-1-保存商品订单" tabindex="-1"><a class="header-anchor" href="#_3-5-3-1-保存商品订单" aria-hidden="true">#</a> <strong>3.5.3.1 保存商品订单</strong></h5><p>定义保存订单信息接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>


   <span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 创建商品订单
 * <span class="token keyword">@param</span> <span class="token parameter">addOrderDto</span> 订单信息
 * <span class="token keyword">@return</span> PayRecordDto 支付记录(包括二维码)
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/10/4 11:02
*/</span>
<span class="token keyword">public</span> <span class="token class-name">PayRecordDto</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span><span class="token class-name">AddOrderDto</span> addOrderDto<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在保存订单接口中需要完成创建商品订单、创建支付记录，接口实现方法如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcOrdersMapper</span> ordersMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcOrdersGoodsMapper</span> ordersGoodsMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcPayRecordMapper</span> payRecordMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">PayRecordDto</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span> <span class="token class-name">AddOrderDto</span> addOrderDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">//添加商品订单</span>

        <span class="token comment">//添加支付记录</span>

        <span class="token comment">//生成二维码</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>编写创建商品订单方法：</p></blockquote><p>第一：确定订单号的生成规则</p><p>订单号注意唯一性、安全性、尽量短等特点，生成方案常用的如下：</p><p>1、时间戳+随机数</p><p>年月日时分秒毫秒+随机数</p><p>2、高并发场景</p><p>年月日时分秒毫秒+随机数+redis 自增序列</p><p>3、订单号中加上业务标识</p><p>订单号加上业务标识方便客服，比如：第 10 位是业务类型，第 11 位是用户类型等。</p><p>4、雪花算法</p><p>雪花算法是推特内部使用的分布式环境下的唯一 ID 生成算法，它基于时间戳生成，保证有序递增，加以入计算机硬件等元素，可以满足高并发环境下 ID 不重复。</p><p>本项目订单号生成采用雪花算法。</p><p>第二：商品订单的数据来源于选课记录，在订单表需要存入选课记录的 ID，这里需要作好幂等处理。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token class-name">XcOrders</span> <span class="token function">saveXcOrders</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span><span class="token class-name">AddOrderDto</span> addOrderDto<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//幂等性处理</span>
    <span class="token class-name">XcOrders</span> order <span class="token operator">=</span> <span class="token function">getOrderByBusinessId</span><span class="token punctuation">(</span>addOrderDto<span class="token punctuation">.</span><span class="token function">getOutBusinessId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>order<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> order<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//生成订单号</span>
    <span class="token keyword">long</span> orderId <span class="token operator">=</span> <span class="token class-name">IdWorkerUtils</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setTotalPrice</span><span class="token punctuation">(</span>addOrderDto<span class="token punctuation">.</span><span class="token function">getTotalPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;600001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//未支付</span>
    order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setOrderType</span><span class="token punctuation">(</span>addOrderDto<span class="token punctuation">.</span><span class="token function">getOrderType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setOrderName</span><span class="token punctuation">(</span>addOrderDto<span class="token punctuation">.</span><span class="token function">getOrderName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setOrderDetail</span><span class="token punctuation">(</span>addOrderDto<span class="token punctuation">.</span><span class="token function">getOrderDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setOrderDescrip</span><span class="token punctuation">(</span>addOrderDto<span class="token punctuation">.</span><span class="token function">getOrderDescrip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setOutBusinessId</span><span class="token punctuation">(</span>addOrderDto<span class="token punctuation">.</span><span class="token function">getOutBusinessId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//选课记录id</span>
    ordersMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> orderDetailJson <span class="token operator">=</span> addOrderDto<span class="token punctuation">.</span><span class="token function">getOrderDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcOrdersGoods</span><span class="token punctuation">&gt;</span></span> xcOrdersGoodsList <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseArray</span><span class="token punctuation">(</span>orderDetailJson<span class="token punctuation">,</span> <span class="token class-name">XcOrdersGoods</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcOrdersGoodsList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>goods<span class="token operator">-&gt;</span><span class="token punctuation">{</span>
        <span class="token class-name">XcOrdersGoods</span> xcOrdersGoods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcOrdersGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>goods<span class="token punctuation">,</span>xcOrdersGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xcOrdersGoods<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//订单号</span>
        ordersGoodsMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>xcOrdersGoods<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> order<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//根据业务id查询订单</span>
<span class="token keyword">public</span> <span class="token class-name">XcOrders</span> <span class="token function">getOrderByBusinessId</span><span class="token punctuation">(</span><span class="token class-name">String</span> businessId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">XcOrders</span> orders <span class="token operator">=</span> ordersMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcOrders</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcOrders</span><span class="token operator">::</span><span class="token function">getOutBusinessId</span><span class="token punctuation">,</span> businessId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> orders<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-5-3-2-创建支付记录" tabindex="-1"><a class="header-anchor" href="#_3-5-3-2-创建支付记录" aria-hidden="true">#</a> <strong>3.5.3.2 创建支付记录</strong></h5><p>编写创建支付记录的方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token class-name">XcPayRecord</span> <span class="token function">createPayRecord</span><span class="token punctuation">(</span><span class="token class-name">XcOrders</span> orders<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>order<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;订单不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;600002&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;订单已支付&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">XcPayRecord</span> payRecord <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcPayRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//生成支付交易流水号</span>
    <span class="token keyword">long</span> payNo <span class="token operator">=</span> <span class="token class-name">IdWorkerUtils</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payRecord<span class="token punctuation">.</span><span class="token function">setPayNo</span><span class="token punctuation">(</span>payNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    payRecord<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//商品订单号</span>
    payRecord<span class="token punctuation">.</span><span class="token function">setOrderName</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getOrderName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payRecord<span class="token punctuation">.</span><span class="token function">setTotalPrice</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getTotalPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payRecord<span class="token punctuation">.</span><span class="token function">setCurrency</span><span class="token punctuation">(</span><span class="token string">&quot;CNY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payRecord<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payRecord<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;601001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//未支付</span>
    payRecord<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>orders<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payRecordMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>payRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> payRecord<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-5-3-3-生成支付二维码" tabindex="-1"><a class="header-anchor" href="#_3-5-3-3-生成支付二维码" aria-hidden="true">#</a> <strong>3.5.3.3 生成支付二维码</strong></h5><p>1、在 nacos 中 orders-service-dev.yaml 配置二维码的 url</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
pay<span class="token operator">:</span>
 qrcodeurl<span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.101</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">63030</span><span class="token operator">/</span>orders<span class="token operator">/</span>requestpay<span class="token operator">?</span>payNo<span class="token operator">=</span><span class="token operator">%</span>s

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、完善创建订单 service 方法:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${pay.qrcodeurl}&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">String</span> qrcodeurl<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">PayRecordDto</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span> <span class="token class-name">AddOrderDto</span> addOrderDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//创建商品订单</span>
    <span class="token class-name">XcOrders</span> orders <span class="token operator">=</span> <span class="token function">saveXcOrders</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> addOrderDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>orders<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;订单创建失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//生成支付记录</span>
    <span class="token class-name">XcPayRecord</span> payRecord <span class="token operator">=</span> <span class="token function">createPayRecord</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//生成二维码</span>
    <span class="token class-name">String</span> qrCode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//url要可以被模拟器访问到，url为下单接口(稍后定义)</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>qrcodeurl<span class="token punctuation">,</span> payRecord<span class="token punctuation">.</span><span class="token function">getPayNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        qrCode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QRCodeUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createQRCode</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;生成二维码出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">PayRecordDto</span> payRecordDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PayRecordDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>payRecord<span class="token punctuation">,</span>payRecordDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    payRecordDto<span class="token punctuation">.</span><span class="token function">setQrcode</span><span class="token punctuation">(</span>qrCode<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> payRecordDto<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-5-3-4-生成二维码接口完善" tabindex="-1"><a class="header-anchor" href="#_3-5-3-4-生成二维码接口完善" aria-hidden="true">#</a> <strong>3.5.3.4 生成二维码接口完善</strong></h5><p>完善生成支付二维码 controller 接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;生成支付二维码&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/generatepaycode&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">PayRecordDto</span> <span class="token function">generatePayCode</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">AddOrderDto</span> addOrderDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//登录用户</span>
    <span class="token class-name">SecurityUtil<span class="token punctuation">.</span>XcUser</span> user <span class="token operator">=</span> <span class="token class-name">SecurityUtil</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;请登录后继续选课&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   <span class="token keyword">return</span> orderService<span class="token punctuation">.</span><span class="token function">createOrder</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> addOrderDto<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-5-3-5-扫码下单接口" tabindex="-1"><a class="header-anchor" href="#_3-5-3-5-扫码下单接口" aria-hidden="true">#</a> <strong>3.5.3.5 扫码下单接口</strong></h5><p>生成了支付二维码，用户扫码请求第三方支付平台下单，下单成功用户完成支付。</p><p>1、定义用户扫码请求下单接口如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;扫码下单接口&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/requestpay&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">requestpay</span><span class="token punctuation">(</span><span class="token class-name">String</span> payNo<span class="token punctuation">,</span><span class="token class-name">HttpServletResponse</span> httpResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、定义查询支付记录的 Service 接口与实现方法</p><p>扫码下单传入的是支付记录号，根据支付记录号查询支付记录。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 查询支付记录
 * <span class="token keyword">@param</span> <span class="token parameter">payNo</span>  交易记录号
 * <span class="token keyword">@return</span> com.xuecheng.orders.model.po.XcPayRecord
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/10/20 23:38
*/</span>
<span class="token keyword">public</span> <span class="token class-name">XcPayRecord</span> <span class="token function">getPayRecordByPayno</span><span class="token punctuation">(</span><span class="token class-name">String</span> payNo<span class="token punctuation">)</span><span class="token punctuation">;</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">XcPayRecord</span> <span class="token function">getPayRecordByPayno</span><span class="token punctuation">(</span><span class="token class-name">String</span> payNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">XcPayRecord</span> xcPayRecord <span class="token operator">=</span> payRecordMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcPayRecord</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcPayRecord</span><span class="token operator">::</span><span class="token function">getPayNo</span><span class="token punctuation">,</span> payNo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> xcPayRecord<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3、完善扫码下单接口如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${pay.alipay.APP_ID}&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">String</span> <span class="token constant">APP_ID</span><span class="token punctuation">;</span>
<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${pay.alipay.APP_PRIVATE_KEY}&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">String</span> <span class="token constant">APP_PRIVATE_KEY</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${pay.alipay.ALIPAY_PUBLIC_KEY}&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">String</span> <span class="token constant">ALIPAY_PUBLIC_KEY</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;扫码下单接口&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/requestpay&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">requestpay</span><span class="token punctuation">(</span><span class="token class-name">String</span> payNo<span class="token punctuation">,</span><span class="token class-name">HttpServletResponse</span> httpResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果payNo不存在则提示重新发起支付</span>
        <span class="token class-name">XcPayRecord</span> payRecord <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">getPayRecordByPayno</span><span class="token punctuation">(</span>payNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>payRecord <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;请重新点击支付获取二维码&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//支付状态</span>
        <span class="token class-name">String</span> status <span class="token operator">=</span> payRecord<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">&quot;601002&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;订单已支付，请勿重复支付。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//构造sdk的客户端对象</span>
        <span class="token class-name">AlipayClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAlipayClient</span><span class="token punctuation">(</span><span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">,</span> <span class="token constant">APP_ID</span><span class="token punctuation">,</span> <span class="token constant">APP_PRIVATE_KEY</span><span class="token punctuation">,</span> <span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token constant">FORMAT</span><span class="token punctuation">,</span> <span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token constant">CHARSET</span><span class="token punctuation">,</span> <span class="token constant">ALIPAY_PUBLIC_KEY</span><span class="token punctuation">,</span> <span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token constant">SIGNTYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获得初始化的AlipayClient</span>
        <span class="token class-name">AlipayTradeWapPayRequest</span> alipayRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayTradeWapPayRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建API对应的request</span>
<span class="token comment">//        alipayRequest.setReturnUrl(&quot;http://domain.com/CallBack/return_url.jsp&quot;);</span>
<span class="token comment">//        alipayRequest.setNotifyUrl(&quot;http://tjxt-user-t.itheima.net/xuecheng/orders/paynotify&quot;);//在公共参数中设置回跳和通知地址</span>
        alipayRequest<span class="token punctuation">.</span><span class="token function">setBizContent</span><span class="token punctuation">(</span><span class="token string">&quot;{&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot; \&quot;out_trade_no\&quot;:\&quot;&quot;</span><span class="token operator">+</span>payRecord<span class="token punctuation">.</span><span class="token function">getPayNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot; \&quot;total_amount\&quot;:\&quot;&quot;</span><span class="token operator">+</span>payRecord<span class="token punctuation">.</span><span class="token function">getTotalPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot; \&quot;subject\&quot;:\&quot;&quot;</span><span class="token operator">+</span>payRecord<span class="token punctuation">.</span><span class="token function">getOrderName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;,&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot; \&quot;product_code\&quot;:\&quot;QUICK_WAP_PAY\&quot;&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot; }&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//填充业务参数</span>
        <span class="token class-name">String</span> form <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//请求支付宝下单接口,发起http请求</span>
            form <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">pageExecute</span><span class="token punctuation">(</span>alipayRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调用SDK生成表单</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AlipayApiException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        httpResponse<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;text/html;charset=&quot;</span> <span class="token operator">+</span> <span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token constant">CHARSET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//直接将完整的表单html输出到页面</span>
        httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-5-3-支付测试" tabindex="-1"><a class="header-anchor" href="#_3-5-3-支付测试" aria-hidden="true">#</a> <strong>3.5.3 支付测试</strong></h4><p>测试准备：</p><p>1、启动网关服务、认证服务、验证码服务、学习中心服务、订单服务、内容管理服务。</p><p>2、发布一门收费课程。</p><p>3、使用资料目录中的新模板 course_template.ftl</p><p>测试流程：</p><p>1、进入收费课程详细页面，点击马上学习。</p><p>2、跟踪浏览器及微服务，观察选课记录是否创建成功、商品订单是否创建成功、支付记录是否创建成功。</p><p>3、观察生成二维码是否成功</p><p>4、使用模拟器扫码测试，是否可以正常支付。</p><p>如果报订单参数异常报如下错误，需要检查请求支付宝的下单数据是否正确。</p><p><img src="/MyBlog/assets/image-20230611161524922-5cdd660c.png" alt="image-20230611161524922"></p><h4 id="_3-5-4-重复支付问题" tabindex="-1"><a class="header-anchor" href="#_3-5-4-重复支付问题" aria-hidden="true">#</a> <strong>3.5.4 重复支付问题</strong></h4><p>上边实现中，扫码下单时会根据支付记录号判断是否支付完成，生成二维码时也会判断订单的状态是否支付完成，如果支付完成将不再重新支付，即使这样做也无法绝对避免重复支付。</p><p>正常情况下同一个用户的同一个订单不会存在并发扫码支付的问题，但系统是可能存在重复支付的问题的，解决该问题需要单独定义任务，每隔 24 小时查询前一天的订单是否存在重复支付的问题，如果存在则调用第三方支付平台的退款接口进行退款。</p><h3 id="_3-6-查询支付结果" tabindex="-1"><a class="header-anchor" href="#_3-6-查询支付结果" aria-hidden="true">#</a> <strong>3.6 查询支付结果</strong></h3><h4 id="_3-6-1-接口定义" tabindex="-1"><a class="header-anchor" href="#_3-6-1-接口定义" aria-hidden="true">#</a> <strong>3.6.1 接口定义</strong></h4><p>根据前边我们调研的获取支付结果的接口，包括：主动查询支付结果、被动接收支付结果。</p><p>这里先实现主动查询支付结果，当支付完成用户点击 “支付完成” 将请求第三方支付平台查询支付结果。</p><p>在 OrderController 类中定义接口如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;查询支付结果&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payresult&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">PayRecordDto</span> <span class="token function">payresult</span><span class="token punctuation">(</span><span class="token class-name">String</span> payNo<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//查询支付结果</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-6-2-接口实现" tabindex="-1"><a class="header-anchor" href="#_3-6-2-接口实现" aria-hidden="true">#</a> <strong>3.6.2 接口实现</strong></h4><h5 id="_3-6-2-1-service-总体接口" tabindex="-1"><a class="header-anchor" href="#_3-6-2-1-service-总体接口" aria-hidden="true">#</a> <strong>3.6.2.1 service 总体接口</strong></h5><p>1、定义查询支付结果的 service</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token doc-comment comment">/**
 * 请求支付宝查询支付结果
 * <span class="token keyword">@param</span> <span class="token parameter">payNo</span> 支付记录id
 * <span class="token keyword">@return</span> 支付记录信息
 */</span>
<span class="token keyword">public</span> <span class="token class-name">PayRecordDto</span> <span class="token function">queryPayResult</span><span class="token punctuation">(</span><span class="token class-name">String</span> payNo<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、service 实现如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">PayRecordDto</span> <span class="token function">queryPayResult</span><span class="token punctuation">(</span><span class="token class-name">String</span> payNo<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">XcPayRecord</span> payRecord <span class="token operator">=</span> <span class="token function">getPayRecordByPayno</span><span class="token punctuation">(</span>payNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>payRecord <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;请重新点击支付获取二维码&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//支付状态</span>
    <span class="token class-name">String</span> status <span class="token operator">=</span> payRecord<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果支付成功直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;601002&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">PayRecordDto</span> payRecordDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PayRecordDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>payRecord<span class="token punctuation">,</span> payRecordDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> payRecordDto<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//从支付宝查询支付结果</span>
    <span class="token class-name">PayStatusDto</span> payStatusDto <span class="token operator">=</span> <span class="token function">queryPayResultFromAlipay</span><span class="token punctuation">(</span>payNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//保存支付结果</span>
    currentProxy<span class="token punctuation">.</span><span class="token function">saveAliPayStatus</span><span class="token punctuation">(</span> payStatusDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//重新查询支付记录</span>
    payRecord <span class="token operator">=</span> <span class="token function">getPayRecordByPayno</span><span class="token punctuation">(</span>payNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">PayRecordDto</span> payRecordDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PayRecordDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>payRecord<span class="token punctuation">,</span> payRecordDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> payRecordDto<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 请求支付宝查询支付结果
 * <span class="token keyword">@param</span> <span class="token parameter">payNo</span> 支付交易号
 * <span class="token keyword">@return</span> 支付结果
 */</span>
<span class="token keyword">public</span> <span class="token class-name">PayStatusDto</span> <span class="token function">queryPayResultFromAlipay</span><span class="token punctuation">(</span><span class="token class-name">String</span> payNo<span class="token punctuation">)</span><span class="token punctuation">{</span>

<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 保存支付宝支付结果
 * <span class="token keyword">@param</span> <span class="token parameter">payStatusDto</span>  支付结果信息
 * <span class="token keyword">@return</span> void
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/10/4 16:52
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveAliPayStatus</span><span class="token punctuation">(</span><span class="token class-name">PayStatusDto</span> payStatusDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>



</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-6-2-2-查询支付结果" tabindex="-1"><a class="header-anchor" href="#_3-6-2-2-查询支付结果" aria-hidden="true">#</a> <strong>3.6.2.2 查询支付结果</strong></h5><p>定义从支付宝查询支付结果的方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token doc-comment comment">/**
 * 请求支付宝查询支付结果
 * <span class="token keyword">@param</span> <span class="token parameter">payNo</span> 支付交易号
 * <span class="token keyword">@return</span> 支付结果
 */</span>
<span class="token keyword">public</span> <span class="token class-name">PayStatusDto</span> <span class="token function">queryPayResultFromAlipay</span><span class="token punctuation">(</span><span class="token class-name">String</span> payNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//========请求支付宝查询支付结果=============</span>
    <span class="token class-name">AlipayClient</span> alipayClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAlipayClient</span><span class="token punctuation">(</span><span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">,</span> <span class="token constant">APP_ID</span><span class="token punctuation">,</span> <span class="token constant">APP_PRIVATE_KEY</span><span class="token punctuation">,</span> <span class="token string">&quot;json&quot;</span><span class="token punctuation">,</span> <span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token constant">CHARSET</span><span class="token punctuation">,</span> <span class="token constant">ALIPAY_PUBLIC_KEY</span><span class="token punctuation">,</span> <span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token constant">SIGNTYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获得初始化的AlipayClient</span>
    <span class="token class-name">AlipayTradeQueryRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayTradeQueryRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JSONObject</span> bizContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bizContent<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">,</span> payNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">setBizContent</span><span class="token punctuation">(</span>bizContent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AlipayTradeQueryResponse</span> response <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        response <span class="token operator">=</span> alipayClient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;请求支付查询查询失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AlipayApiException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;请求支付宝查询支付结果异常:{}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;请求支付查询查询失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//获取支付结果</span>
    <span class="token class-name">String</span> resultJson <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//转map</span>
    <span class="token class-name">Map</span> resultMap <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>resultJson<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span> alipay_trade_query_response <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;alipay_trade_query_response&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//支付结果</span>
    <span class="token class-name">String</span> trade_status <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> alipay_trade_query_response<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;trade_status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> total_amount <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> alipay_trade_query_response<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;total_amount&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> trade_no <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> alipay_trade_query_response<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;trade_no&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//保存支付结果</span>
    <span class="token class-name">PayStatusDto</span> payStatusDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PayStatusDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payStatusDto<span class="token punctuation">.</span><span class="token function">setOut_trade_no</span><span class="token punctuation">(</span>payNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    payStatusDto<span class="token punctuation">.</span><span class="token function">setTrade_status</span><span class="token punctuation">(</span>trade_status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    payStatusDto<span class="token punctuation">.</span><span class="token function">setApp_id</span><span class="token punctuation">(</span><span class="token constant">APP_ID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payStatusDto<span class="token punctuation">.</span><span class="token function">setTrade_no</span><span class="token punctuation">(</span>trade_no<span class="token punctuation">)</span><span class="token punctuation">;</span>
    payStatusDto<span class="token punctuation">.</span><span class="token function">setTotal_amount</span><span class="token punctuation">(</span>total_amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> payStatusDto<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-6-2-3-保存支付结果" tabindex="-1"><a class="header-anchor" href="#_3-6-2-3-保存支付结果" aria-hidden="true">#</a> <strong>3.6.2.3 保存支付结果</strong></h5><p>1、定义保存支付结果的接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 保存支付宝支付结果
 * <span class="token keyword">@param</span> <span class="token parameter">payStatusDto</span>  支付结果信息
 * <span class="token keyword">@return</span> void
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/10/4 16:52
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveAliPayStatus</span><span class="token punctuation">(</span><span class="token class-name">PayStatusDto</span> payStatusDto<span class="token punctuation">)</span> <span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、编写接口实现</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveAliPayStatus</span><span class="token punctuation">(</span><span class="token class-name">PayStatusDto</span> payStatusDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//支付流水号</span>
    <span class="token class-name">String</span> payNo <span class="token operator">=</span> payStatusDto<span class="token punctuation">.</span><span class="token function">getOut_trade_no</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">XcPayRecord</span> payRecord <span class="token operator">=</span> <span class="token function">getPayRecordByPayno</span><span class="token punctuation">(</span>payNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>payRecord <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;支付记录找不到&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//支付结果</span>
    <span class="token class-name">String</span> trade_status <span class="token operator">=</span> payStatusDto<span class="token punctuation">.</span><span class="token function">getTrade_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;收到支付结果:{},支付记录:{}}&quot;</span><span class="token punctuation">,</span> payStatusDto<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payRecord<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>trade_status<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_SUCCESS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">//支付金额变为分</span>
        <span class="token class-name">Float</span> totalPrice <span class="token operator">=</span> payRecord<span class="token punctuation">.</span><span class="token function">getTotalPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>
        <span class="token class-name">Float</span> total_amount <span class="token operator">=</span> <span class="token class-name">Float</span><span class="token punctuation">.</span><span class="token function">parseFloat</span><span class="token punctuation">(</span>payStatusDto<span class="token punctuation">.</span><span class="token function">getTotal_amount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>
        <span class="token comment">//校验是否一致</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>totalPrice<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> total_amount<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//校验失败</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;校验支付结果失败,支付记录:{},APP_ID:{},totalPrice:{}&quot;</span> <span class="token punctuation">,</span>payRecord<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payStatusDto<span class="token punctuation">.</span><span class="token function">getApp_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>total_amount<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;校验支付结果失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;更新支付结果,支付交易流水号:{},支付结果:{}&quot;</span><span class="token punctuation">,</span> payNo<span class="token punctuation">,</span> trade_status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XcPayRecord</span> payRecord_u <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcPayRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        payRecord_u<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;601002&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//支付成功</span>
        payRecord_u<span class="token punctuation">.</span><span class="token function">setOutPayChannel</span><span class="token punctuation">(</span><span class="token string">&quot;Alipay&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        payRecord_u<span class="token punctuation">.</span><span class="token function">setOutPayNo</span><span class="token punctuation">(</span>payStatusDto<span class="token punctuation">.</span><span class="token function">getTrade_no</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//支付宝交易号</span>
        payRecord_u<span class="token punctuation">.</span><span class="token function">setPaySuccessTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//通知时间</span>
        <span class="token keyword">int</span> update1 <span class="token operator">=</span> payRecordMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>payRecord_u<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcPayRecord</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcPayRecord</span><span class="token operator">::</span><span class="token function">getPayNo</span><span class="token punctuation">,</span> payNo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>update1 <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;更新支付记录状态成功:{}&quot;</span><span class="token punctuation">,</span> payRecord_u<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;更新支付记录状态失败:{}&quot;</span><span class="token punctuation">,</span> payRecord_u<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;更新支付记录状态失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//关联的订单号</span>
        <span class="token class-name">Long</span> orderId <span class="token operator">=</span> payRecord<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XcOrders</span> orders <span class="token operator">=</span> ordersMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>orders <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;根据支付记录[{}}]找不到订单&quot;</span><span class="token punctuation">,</span> payRecord_u<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;根据支付记录找不到订单&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">XcOrders</span> order_u <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order_u<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;600002&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//支付成功</span>
        <span class="token keyword">int</span> update <span class="token operator">=</span> ordersMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>order_u<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcOrders</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcOrders</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>update <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;更新订单表状态成功,订单号:{}&quot;</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;更新订单表状态失败,订单号:{}&quot;</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;更新订单表状态失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-6-3-接口测试" tabindex="-1"><a class="header-anchor" href="#_3-6-3-接口测试" aria-hidden="true">#</a> <strong>3.6.3 接口测试</strong></h4><p>1、完善接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;查询支付结果&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payresult&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">PayRecordDto</span> <span class="token function">payresult</span><span class="token punctuation">(</span><span class="token class-name">String</span> payNo<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//调用支付宝接口查询</span>
    <span class="token class-name">PayRecordDto</span> payRecordDto <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">queryPayResult</span><span class="token punctuation">(</span>payNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> payRecordDto<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、测试流程</p><p>完成生成支付二维码</p><p>用支付宝扫码但不支付</p><p>使用 httpclient 请求查询支付结果，查询失败</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>
#### 查询支付结果
GET {{orders_host}}/orders/payresult?payNo=1628648111951941632
<span class="token header"><span class="token header-name keyword">Authorization</span><span class="token punctuation">:</span> <span class="token header-value">Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJ7XCJiaXJ0aGRheVwiOlwiMjAyMi0wOS0yOFQxOToyODo0NlwiLFwiY3JlYXRlVGltZVwiOlwiMjAyMi0wOS0yOFQwODozMjowM1wiLFwiaWRcIjpcIjUwXCIsXCJuYW1lXCI6XCLlrabnlJ8xXCIsXCJuaWNrbmFtZVwiOlwi5aSn5rC054mbXCIsXCJwZXJtaXNzaW9uc1wiOltdLFwic2V4XCI6XCIxXCIsXCJzdGF0dXNcIjpcIjFcIixcInVzZXJuYW1lXCI6XCJzdHUxXCIsXCJ1c2VycGljXCI6XCJodHRwOi8vZmlsZS41MXh1ZWNoZW5nLmNuL2RkZGZcIixcInV0eXBlXCI6XCIxMDEwMDFcIn0iLCJzY29wZSI6WyJhbGwiXSwiZXhwIjoxNjc3MTQwMDI1LCJhdXRob3JpdGllcyI6WyJwMSJdLCJqdGkiOiJmYThiMmY1OS03ZTQ5LTRmODUtOTBlMC05NzYwNjlkYjE3ODIiLCJjbGllbnRfaWQiOiJYY1dlYkFwcCJ9.89sp5lPdFafZ_HdGhe8Cpv0anMJC3vT4PtaGMHgCkr8</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>用支付宝扫码再次完成支付</p><p>使用 httpclient 请求查询支付结果，支付结果为成功，并更新支付记录状态和订单状态。</p><p>3、使用前后端联调</p><blockquote><p>拷贝资料目录中 LocalDateTimeConfig.java 到 base 工程下，处理 long 转 string 精度损失的问题。</p></blockquote><p>使用最新的门户代码 xc-ui-pc-static-portal.zip</p><h3 id="_3-7-接收支付通知" tabindex="-1"><a class="header-anchor" href="#_3-7-接收支付通知" aria-hidden="true">#</a> <strong>3.7 接收支付通知</strong></h3><h4 id="_3-7-1-接口定义" tabindex="-1"><a class="header-anchor" href="#_3-7-1-接口定义" aria-hidden="true">#</a> <strong>3.7.1 接口定义</strong></h4><p>支付完成后第三方支付系统会主动通知支付结果，要实现主动通知需要在请求支付系统下单时传入 NotifyUrl，这里有两个 url：NotifyUrl 和 ReturnUrl，ReturnUrl 是支付完成后支付系统携带支付结果重定向到 ReturnUrl 地址，NotifyUrl 是支付完成后支付系统在后台定时去通知，使用 NotifyUrl 比使用 ReturnUrl 有保证。</p><p>根据接口描述：https://opendocs.alipay.com/open/203/105286的内容下边在订单服务定义接收支付结果通知的接口。</p><p>首先在下单时指定 NotifyUrl:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>alipayRequest<span class="token punctuation">.</span><span class="token function">setNotifyUrl</span><span class="token punctuation">(</span><span class="token string">&quot;http://tjxt-user-t.itheima.net/xuecheng/orders/receivenotify&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>接收支付结果通知接口如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;接收支付结果通知&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/receivenotify&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receivenotify</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span><span class="token class-name">HttpServletResponse</span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnsupportedEncodingException</span><span class="token punctuation">,</span> <span class="token class-name">AlipayApiException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span> requestParams <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iter <span class="token operator">=</span> requestParams<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> requestParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> valueStr <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> values<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            valueStr <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> values<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> valueStr <span class="token operator">+</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                    <span class="token operator">:</span> valueStr <span class="token operator">+</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> valueStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//验签</span>
    <span class="token keyword">boolean</span> verify_result <span class="token operator">=</span> <span class="token class-name">AlipaySignature</span><span class="token punctuation">.</span><span class="token function">rsaCheckV1</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token constant">ALIPAY_PUBLIC_KEY</span><span class="token punctuation">,</span> <span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token constant">CHARSET</span><span class="token punctuation">,</span> <span class="token string">&quot;RSA2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>verify_result<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//验证成功</span>

        <span class="token comment">//商户订单号</span>
        <span class="token class-name">String</span> out_trade_no <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">&quot;ISO-8859-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//支付宝交易号</span>
        <span class="token class-name">String</span> trade_no <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;trade_no&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">&quot;ISO-8859-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//交易状态</span>
        <span class="token class-name">String</span> trade_status <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;trade_status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">&quot;ISO-8859-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//appid</span>
        <span class="token class-name">String</span> app_id <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;app_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">&quot;ISO-8859-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//total_amount</span>
        <span class="token class-name">String</span> total_amount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;total_amount&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">&quot;ISO-8859-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//交易成功处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>trade_status<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_SUCCESS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

           <span class="token comment">//处理逻辑。。。</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-7-2-接口实现" tabindex="-1"><a class="header-anchor" href="#_3-7-2-接口实现" aria-hidden="true">#</a> <strong>3.7.2 接口实现</strong></h4><p>完善 contorller 接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;接收支付结果通知&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/receivenotify&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receivenotify</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnsupportedEncodingException</span><span class="token punctuation">,</span> <span class="token class-name">AlipayApiException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span> requestParams <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span> iter <span class="token operator">=</span> requestParams<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> requestParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> valueStr <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> values<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            valueStr <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> values<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> valueStr <span class="token operator">+</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                    <span class="token operator">:</span> valueStr <span class="token operator">+</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> valueStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//验签</span>
    <span class="token keyword">boolean</span> verify_result <span class="token operator">=</span> <span class="token class-name">AlipaySignature</span><span class="token punctuation">.</span><span class="token function">rsaCheckV1</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token constant">ALIPAY_PUBLIC_KEY</span><span class="token punctuation">,</span> <span class="token class-name">AlipayConfig</span><span class="token punctuation">.</span><span class="token constant">CHARSET</span><span class="token punctuation">,</span> <span class="token string">&quot;RSA2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>verify_result<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//验证成功</span>

        <span class="token comment">//商户订单号</span>
        <span class="token class-name">String</span> out_trade_no <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">&quot;ISO-8859-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//支付宝交易号</span>
        <span class="token class-name">String</span> trade_no <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;trade_no&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">&quot;ISO-8859-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//交易状态</span>
        <span class="token class-name">String</span> trade_status <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;trade_status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">&quot;ISO-8859-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//appid</span>
        <span class="token class-name">String</span> app_id <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;app_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">&quot;ISO-8859-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//total_amount</span>
        <span class="token class-name">String</span> total_amount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;total_amount&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">&quot;ISO-8859-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//交易成功处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>trade_status<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;TRADE_SUCCESS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token class-name">PayStatusDto</span> payStatusDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PayStatusDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            payStatusDto<span class="token punctuation">.</span><span class="token function">setOut_trade_no</span><span class="token punctuation">(</span>out_trade_no<span class="token punctuation">)</span><span class="token punctuation">;</span>
            payStatusDto<span class="token punctuation">.</span><span class="token function">setTrade_status</span><span class="token punctuation">(</span>trade_status<span class="token punctuation">)</span><span class="token punctuation">;</span>
            payStatusDto<span class="token punctuation">.</span><span class="token function">setApp_id</span><span class="token punctuation">(</span>app_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            payStatusDto<span class="token punctuation">.</span><span class="token function">setTrade_no</span><span class="token punctuation">(</span>trade_no<span class="token punctuation">)</span><span class="token punctuation">;</span>
            payStatusDto<span class="token punctuation">.</span><span class="token function">setTotal_amount</span><span class="token punctuation">(</span>total_amount<span class="token punctuation">)</span><span class="token punctuation">;</span>

           <span class="token comment">//处理逻辑。。。</span>
            orderService<span class="token punctuation">.</span><span class="token function">saveAliPayStatus</span><span class="token punctuation">(</span>payStatusDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-7-4-接口测试" tabindex="-1"><a class="header-anchor" href="#_3-7-4-接口测试" aria-hidden="true">#</a> <strong>3.7.4 接口测试</strong></h4><p>测试准备：</p><p>1、启动网关服务、认证服务、验证码服务、学习中心服务、内容管理服务。</p><p>2、发布一门收费课程。</p><p>测试流程：</p><p>1、对选课进行支付</p><p>2、支付成功跟踪 service 方法的日志，支付成功需要更新支付交易表记录的状态、通知时间、支付宝交易号、支付渠道(Alipay)</p><p>支付成功更新订单表的状态为空。</p><h2 id="_4-支付通知" tabindex="-1"><a class="header-anchor" href="#_4-支付通知" aria-hidden="true">#</a> <strong>4 支付通知</strong></h2><h3 id="_4-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_4-1-需求分析" aria-hidden="true">#</a> <strong>4.1 需求分析</strong></h3><p>订单服务作为通用服务在订单支付成功后需要将支付结果异步通知给其它微服务。</p><p>下图使用了消息队列完成支付结果通知：</p><p><img src="/MyBlog/assets/image-20230611161756277-ae1ea375.png" alt="image-20230611161756277"></p><p>学习中心服务：对收费课程选课需要支付，与订单服务对接完成支付。</p><p>学习资源服务：对收费的学习资料需要购买后下载，与订单服务对接完成支付。</p><p>订单服务完成支付后将支付结果发给每一个与订单服务对接的微服务，订单服务将消息发给交换机，由交换机广播消息，每个订阅消息的微服务都可以接收到支付结果.</p><p>微服务收到支付结果根据订单的类型去更新自己的业务数据。</p><h3 id="_4-2-技术方案" tabindex="-1"><a class="header-anchor" href="#_4-2-技术方案" aria-hidden="true">#</a> <strong>4.2 技术方案</strong></h3><p>使用消息队列进行异步通知需要保证消息的可靠性，即生产端将消息成功通知到消费端。</p><p>消息从生产端发送到消费端经历了如下过程：</p><p>1、消息发送到交换机</p><p>2、消息由交换机发送到队列</p><p>3、消息者收到消息进行处理</p><p>保证消息的可靠性需要保证以上过程的可靠性，本项目使用 RabbitMQ 可以通过如下方面保证消息的可靠性。</p><p>1、生产者确认机制</p><p>发送消息前使用数据库事务将消息保证到数据库表中</p><p>成功发送到交换机将消息从数据库中删除</p><p>2、mq 持久化</p><p>mq 收到消息进行持久化，当 mq 重启即使消息没有消费完也不会丢失。</p><p>需要配置交换机持久化、队列持久化、发送消息时设置持久化。</p><p>3、消费者确认机制</p><p>消费者消费成功自动发送 ack，否则重试消费。</p><h3 id="_4-3-发送支付结果" tabindex="-1"><a class="header-anchor" href="#_4-3-发送支付结果" aria-hidden="true">#</a> <strong>4.3 发送支付结果</strong></h3><h4 id="_4-3-1-订单服务集成-mq" tabindex="-1"><a class="header-anchor" href="#_4-3-1-订单服务集成-mq" aria-hidden="true">#</a> <strong>4.3.1 订单服务集成 MQ</strong></h4><p>订单服务通过消息队列将支付结果发给学习中心服务，消息队列采用发布订阅模式。</p><p>1、订单服务创建支付结果通知交换机。</p><p>2、学习中心服务绑定队列到交换机。</p><p>项目使用 RabbitMQ 作为消息队列，在课前下发的虚拟上已经安装了 RabbitMQ.</p><p>执行 docker start rabbitmq 启动 RabbitMQ。访问：http://192.168.101.65:15672/</p><p>账户密码：guest/guest</p><p>交换机为 Fanout 广播模式。</p><p>首先需要在学习中心服务和订单服务工程配置连接消息队列。</p><p>1、首先在订单服务添加消息队列依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、在 nacos 配置 rabbitmq-dev.yaml 为通用配置文件</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.101.65
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
    <span class="token key atrule">password</span><span class="token punctuation">:</span> guest
    <span class="token key atrule">virtual-host</span><span class="token punctuation">:</span> /
    <span class="token key atrule">publisher-confirm-type</span><span class="token punctuation">:</span> correlated <span class="token comment">#correlated 异步回调，定义ConfirmCallback，MQ返回结果时会回调这个ConfirmCallback</span>
    <span class="token key atrule">publisher-returns</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#开启publish-return功能，同样是基于callback机制，需要定义ReturnCallback</span>
    <span class="token key atrule">template</span><span class="token punctuation">:</span>
      <span class="token key atrule">mandatory</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#定义消息路由失败时的策略。true，则调用ReturnCallback；false：则直接丢弃消息</span>
    <span class="token key atrule">listener</span><span class="token punctuation">:</span>
      <span class="token key atrule">simple</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefetch</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment">#每次只能获取一条消息，处理完成才能获取下一个消息</span>
        <span class="token key atrule">acknowledge-mode</span><span class="token punctuation">:</span> auto <span class="token comment">#auto:出现异常时返回unack，消息回滚到mq；没有异常，返回ack ,manual:手动控制,none:丢弃消息，不回滚到mq</span>
        <span class="token key atrule">retry</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment">#开启消费者失败重试</span>
          <span class="token key atrule">initial-interval</span><span class="token punctuation">:</span> 5000ms <span class="token comment">#初识的失败等待时长为1秒</span>
          <span class="token key atrule">multiplier</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment">#失败的等待时长倍数，下次等待时长 = multiplier * last-interval</span>
          <span class="token key atrule">max-attempts</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment">#最大重试次数</span>
          <span class="token key atrule">stateless</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#true无状态；false有状态。如果业务中包含事务，这里改为false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3、在订单服务接口工程引入 rabbitmq-dev.yaml 配置文件</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">shared-configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> rabbitmq<span class="token punctuation">-</span>$<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>.yaml
    <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
    <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4、拷贝资料中 MQ 配置类到订单服务的 service 工程。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>orders<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MqMessage</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">MqMessageService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RabbitTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">BeansException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Qualifier</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ApplicationContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ApplicationContextAware</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> TODO
 * <span class="token keyword">@date</span> 2023/2/23 16:59
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayNotifyConfig</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationContextAware</span> <span class="token punctuation">{</span>

    <span class="token comment">//交换机</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PAYNOTIFY_EXCHANGE_FANOUT</span> <span class="token operator">=</span> <span class="token string">&quot;paynotify_exchange_fanout&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//支付结果通知消息类型</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">MESSAGE_TYPE</span> <span class="token operator">=</span> <span class="token string">&quot;payresult_notify&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//支付通知队列</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PAYNOTIFY_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;paynotify_queue&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">//声明交换机，且持久化</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token constant">PAYNOTIFY_EXCHANGE_FANOUT</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">FanoutExchange</span> <span class="token function">paynotify_exchange_fanout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 三个参数：交换机名称、是否持久化、当没有queue与其绑定时是否自动删除</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FanoutExchange</span><span class="token punctuation">(</span><span class="token constant">PAYNOTIFY_EXCHANGE_FANOUT</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//支付通知队列,且持久化</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token constant">PAYNOTIFY_QUEUE</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">course_publish_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">PAYNOTIFY_QUEUE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//交换机和支付通知队列绑定</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">binding_course_publish_queue</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token constant">PAYNOTIFY_QUEUE</span><span class="token punctuation">)</span> <span class="token class-name">Queue</span> queue<span class="token punctuation">,</span> <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token constant">PAYNOTIFY_EXCHANGE_FANOUT</span><span class="token punctuation">)</span> <span class="token class-name">FanoutExchange</span> exchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取RabbitTemplate</span>
        <span class="token class-name">RabbitTemplate</span> rabbitTemplate <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">RabbitTemplate</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//消息处理service</span>
        <span class="token class-name">MqMessageService</span> mqMessageService <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">MqMessageService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置ReturnCallback</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setReturnCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> replyCode<span class="token punctuation">,</span> replyText<span class="token punctuation">,</span> exchange<span class="token punctuation">,</span> routingKey<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 投递失败，记录日志</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送失败，应答码{}，原因{}，交换机{}，路由键{},消息{}&quot;</span><span class="token punctuation">,</span>
                    replyCode<span class="token punctuation">,</span> replyText<span class="token punctuation">,</span> exchange<span class="token punctuation">,</span> routingKey<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">MqMessage</span> mqMessage <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">MqMessage</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//将消息再添加到消息表</span>
            mqMessageService<span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span>mqMessage<span class="token punctuation">.</span><span class="token function">getMessageType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>mqMessage<span class="token punctuation">.</span><span class="token function">getBusinessKey1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>mqMessage<span class="token punctuation">.</span><span class="token function">getBusinessKey2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>mqMessage<span class="token punctuation">.</span><span class="token function">getBusinessKey3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启订单服务，登录 rabbitmq，查看交换机自动创建成功</p><p><img src="/MyBlog/assets/image-20230611161913619-88fe79cc.png" alt="image-20230611161913619"></p><p>查看队列自动成功</p><p><img src="/MyBlog/assets/image-20230611161916603-45eb2803.png" alt="image-20230611161916603"></p><h4 id="_4-3-2-发送支付结果" tabindex="-1"><a class="header-anchor" href="#_4-3-2-发送支付结果" aria-hidden="true">#</a> <strong>4.3.2 发送支付结果</strong></h4><p>在 OrderService 中定义接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token doc-comment comment">/**
 * 发送通知结果
 * <span class="token keyword">@param</span> <span class="token parameter">message</span>
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notifyPayResult</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编写接口实现方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notifyPayResult</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//1、消息体，转json</span>
    <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置消息持久化</span>
    <span class="token class-name">Message</span> msgObj <span class="token operator">=</span> <span class="token class-name">MessageBuilder</span><span class="token punctuation">.</span><span class="token function">withBody</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setDeliveryMode</span><span class="token punctuation">(</span><span class="token class-name">MessageDeliveryMode</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.全局唯一的消息ID，需要封装到CorrelationData中</span>
    <span class="token class-name">CorrelationData</span> correlationData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CorrelationData</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.添加callback</span>
    correlationData<span class="token punctuation">.</span><span class="token function">getFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>
            result <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token comment">// 3.1.ack，消息成功</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;通知支付结果消息发送成功, ID:{}&quot;</span><span class="token punctuation">,</span> correlationData<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//删除消息表中的记录</span>
                    mqMessageService<span class="token punctuation">.</span><span class="token function">completed</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                    <span class="token comment">// 3.2.nack，消息失败</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;通知支付结果消息发送失败, ID:{}, 原因{}&quot;</span><span class="token punctuation">,</span>correlationData<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getReason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            ex <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送异常, ID:{}, 原因{}&quot;</span><span class="token punctuation">,</span>correlationData<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送消息</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token class-name">PayNotifyConfig</span><span class="token punctuation">.</span><span class="token constant">PAYNOTIFY_EXCHANGE_FANOUT</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> msgObj<span class="token punctuation">,</span>correlationData<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>订单服务收到第三方平台的支付结果时，在 saveAliPayStatus 方法中添加代码，向数据库消息表添加消息并进行发送消息，如下所示：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveAliPayStatus</span><span class="token punctuation">(</span><span class="token class-name">PayStatusDto</span> payStatusDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//保存消息记录,参数1：支付结果通知类型，2: 业务id，3:业务类型</span>
        <span class="token class-name">MqMessage</span> mqMessage <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span><span class="token string">&quot;payresult_notify&quot;</span><span class="token punctuation">,</span> orders<span class="token punctuation">.</span><span class="token function">getOutBusinessId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orders<span class="token punctuation">.</span><span class="token function">getOrderType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//通知消息</span>
        <span class="token function">notifyPayResult</span><span class="token punctuation">(</span>mqMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-接收支付结果" tabindex="-1"><a class="header-anchor" href="#_4-4-接收支付结果" aria-hidden="true">#</a> <strong>4.4 接收支付结果</strong></h3><h4 id="_4-4-1-学习中心服务集成-mq" tabindex="-1"><a class="header-anchor" href="#_4-4-1-学习中心服务集成-mq" aria-hidden="true">#</a> <strong>4.4.1 学习中心服务集成 MQ</strong></h4><p>1、在学习中心服务添加消息队列依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、在学习中心服务接口工程引入 rabbitmq-dev.yaml 配置文件</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">shared-configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> rabbitmq<span class="token punctuation">-</span>$<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>.yaml
    <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
    <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3、添加配置类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MqMessage</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">MqMessageService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RabbitTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">BeansException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Qualifier</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ApplicationContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ApplicationContextAware</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> TODO
 * <span class="token keyword">@date</span> 2023/2/23 16:59
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayNotifyConfig</span> <span class="token punctuation">{</span>

    <span class="token comment">//交换机</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PAYNOTIFY_EXCHANGE_FANOUT</span> <span class="token operator">=</span> <span class="token string">&quot;paynotify_exchange_fanout&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//支付结果通知消息类型</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">MESSAGE_TYPE</span> <span class="token operator">=</span> <span class="token string">&quot;payresult_notify&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//支付通知队列</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PAYNOTIFY_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;paynotify_queue&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">//声明交换机，且持久化</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token constant">PAYNOTIFY_EXCHANGE_FANOUT</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">FanoutExchange</span> <span class="token function">paynotify_exchange_fanout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 三个参数：交换机名称、是否持久化、当没有queue与其绑定时是否自动删除</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FanoutExchange</span><span class="token punctuation">(</span><span class="token constant">PAYNOTIFY_EXCHANGE_FANOUT</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//支付通知队列,且持久化</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token constant">PAYNOTIFY_QUEUE</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">course_publish_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">PAYNOTIFY_QUEUE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//交换机和支付通知队列绑定</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">binding_course_publish_queue</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token constant">PAYNOTIFY_QUEUE</span><span class="token punctuation">)</span> <span class="token class-name">Queue</span> queue<span class="token punctuation">,</span> <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token constant">PAYNOTIFY_EXCHANGE_FANOUT</span><span class="token punctuation">)</span> <span class="token class-name">FanoutExchange</span> exchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-2-接收支付结果" tabindex="-1"><a class="header-anchor" href="#_4-4-2-接收支付结果" aria-hidden="true">#</a> <strong>4.4.2 接收支付结果</strong></h4><p>监听 MQ，接收支付结果，定义 ReceivePayNotifyService 类如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Channel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">XueChengPlusException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">PayNotifyConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">MyCourseTablesService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MqMessage</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">MqMessageService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Message</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RabbitListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RabbitTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> 接收支付结果
 * <span class="token keyword">@date</span> 2023/2/23 19:04
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReceivePayNotifyService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MqMessageService</span> mqMessageService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MyCourseTablesService</span> myCourseTablesService<span class="token punctuation">;</span>


    <span class="token comment">//监听消息队列接收支付结果通知</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">PayNotifyConfig</span><span class="token punctuation">.</span><span class="token constant">PAYNOTIFY_QUEUE</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receive</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//获取消息</span>
        <span class="token class-name">MqMessage</span> mqMessage <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">MqMessage</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;学习中心服务接收支付结果:{}&quot;</span><span class="token punctuation">,</span> mqMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//消息类型</span>
        <span class="token class-name">String</span> messageType <span class="token operator">=</span> mqMessage<span class="token punctuation">.</span><span class="token function">getMessageType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//订单类型,60201表示购买课程</span>
        <span class="token class-name">String</span> businessKey2 <span class="token operator">=</span> mqMessage<span class="token punctuation">.</span><span class="token function">getBusinessKey2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//这里只处理支付结果通知</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">PayNotifyConfig</span><span class="token punctuation">.</span><span class="token constant">MESSAGE_TYPE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>messageType<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;60201&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>businessKey2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//选课记录id</span>
            <span class="token class-name">String</span> choosecourseId <span class="token operator">=</span> mqMessage<span class="token punctuation">.</span><span class="token function">getBusinessKey1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//添加选课</span>
            <span class="token keyword">boolean</span> b <span class="token operator">=</span> myCourseTablesService<span class="token punctuation">.</span><span class="token function">saveChooseCourseSuccess</span><span class="token punctuation">(</span>choosecourseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>b<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//添加选课失败，抛出异常，消息重回队列</span>
                <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;收到支付结果，添加选课失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 MyCourseTablesService 中定义保存选课成功的接口：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">saveChooseCourseSuccess</span><span class="token punctuation">(</span><span class="token class-name">String</span> chooseCourseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编写接口实现方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">saveChooseCourseSuccess</span><span class="token punctuation">(</span><span class="token class-name">String</span> chooseCourseId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//根据choosecourseId查询选课记录</span>
    <span class="token class-name">XcChooseCourse</span> xcChooseCourse <span class="token operator">=</span> chooseCourseMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>chooseCourseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>xcChooseCourse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;收到支付结果通知没有查询到关联的选课记录,choosecourseId:{}&quot;</span><span class="token punctuation">,</span>chooseCourseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> status <span class="token operator">=</span> xcChooseCourse<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">&quot;701001&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//添加到课程表</span>
        <span class="token function">addCourseTabls</span><span class="token punctuation">(</span>xcChooseCourse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//待支付状态才处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;701002&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//更新为选课成功</span>
        xcChooseCourse<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;701001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> update <span class="token operator">=</span> chooseCourseMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>xcChooseCourse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>update<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;收到支付结果通知处理成功,选课记录:{}&quot;</span><span class="token punctuation">,</span>xcChooseCourse<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//添加到课程表</span>
            <span class="token function">addCourseTabls</span><span class="token punctuation">(</span>xcChooseCourse<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;收到支付结果通知处理失败,选课记录:{}&quot;</span><span class="token punctuation">,</span>xcChooseCourse<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-5-通知支付结果测试" tabindex="-1"><a class="header-anchor" href="#_4-5-通知支付结果测试" aria-hidden="true">#</a> <strong>4.5 通知支付结果测试</strong></h3><p>测试准备：</p><p>1、找一门已发布的收费课程。</p><p>2、如果在我的课程表存储则删除。</p><p>3、删除此课程的选课记录及订单信息。</p><p>测试流程：</p><p>1、进入课程详细页面，点击马上学习，生成二维码进行支付。</p><p>2、支付完成点击“支付完成”，观察订单服务控制台是否发送消息。</p><p>3、观察学习中心服务控制台是否接收到消息。</p><p>4、观察数据库中的消息表的相应记录是否已删除。</p><p>消费重试测试：</p><p>1、在学习中心服务接收支付结果方法中制造异常。</p><p>2、重新执行上边的测试流程，观察是否消费重试。</p><h2 id="_4-在线学习" tabindex="-1"><a class="header-anchor" href="#_4-在线学习" aria-hidden="true">#</a> <strong>4 在线学习</strong></h2><h3 id="_4-1-需求分析-1" tabindex="-1"><a class="header-anchor" href="#_4-1-需求分析-1" aria-hidden="true">#</a> <strong>4.1 需求分析</strong></h3><p>用户通过课程详情界面点击马上学习 进入 视频插放界面进行视频点播。</p><p>获取视频资源时进行学习资格校验，如下图：</p><p><img src="/MyBlog/assets/image-20230611154911811-aa2effc8.png" alt="image-20230611162129552"></p><p>拥有学习资格则继续播放视频，不具有学习资格则引导去购买、续期等操作。</p><blockquote><p>如何判断是否拥有学习资格？</p></blockquote><p>首先判断是否为试学视频，如果为试学视频则可以正常学习。</p><p>如果为非试学课程首先判断用户是否登录，如果已登录则判断是否选课，如果已经选课且没有过期可以正常学习。</p><p>详细流程如下图：</p><p><img src="/MyBlog/assets/image-20230611162136288-435a8ec0.png" alt="image-20230611162136288"></p><h3 id="_4-2-查询课程信息" tabindex="-1"><a class="header-anchor" href="#_4-2-查询课程信息" aria-hidden="true">#</a> <strong>4.2 查询课程信息</strong></h3><p>在视频点播页面需要查询课程信息，课程上线后也需要访问/api/content/course/whole/{courseId}</p><p>课程预览时请求获取课程的接口为：/open/content/course/whole/{courseId}</p><p>在 nginx 中进行配置：</p><p>/open、/api 在 nginx 的配置如下：<code>(已经配置的不要重复配置)</code></p><div class="language-tex line-numbers-mode" data-ext="tex"><pre class="language-tex"><code>
        #api
        location /api/ <span class="token punctuation">{</span>
                proxy_pass http://gatewayserver/;
        <span class="token punctuation">}</span>
        #openapi
        location /open/content/ <span class="token punctuation">{</span>
                proxy_pass http://gatewayserver/content/open/;
        <span class="token punctuation">}</span>
        location /open/media/ <span class="token punctuation">{</span>
                proxy_pass http://gatewayserver/media/open/;
        <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下边实现/api/content/course/whole/{courseId} 获取课程发布信息接口。</p><p>进入内容管理服务 api 工程 CoursePublishController 类，定义查询课程预览信息接口如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;获取课程发布信息&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/course/whole/{courseId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">CoursePreviewDto</span> <span class="token function">getCoursePublish</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;courseId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//查询课程发布信息</span>
    <span class="token class-name">CoursePublish</span> coursePublish <span class="token operator">=</span> coursePublishService<span class="token punctuation">.</span><span class="token function">getCoursePublish</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>coursePublish <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CoursePreviewDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

    <span class="token comment">//课程基本信息</span>
    <span class="token class-name">CourseBaseInfoDto</span> courseBase <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CourseBaseInfoDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>coursePublish<span class="token punctuation">,</span> courseBase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//课程计划</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TeachplanDto</span><span class="token punctuation">&gt;</span></span> teachplans <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseArray</span><span class="token punctuation">(</span>coursePublish<span class="token punctuation">.</span><span class="token function">getTeachplan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TeachplanDto</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CoursePreviewDto</span> coursePreviewInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CoursePreviewDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    coursePreviewInfo<span class="token punctuation">.</span><span class="token function">setCourseBase</span><span class="token punctuation">(</span>courseBase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    coursePreviewInfo<span class="token punctuation">.</span><span class="token function">setTeachplans</span><span class="token punctuation">(</span>teachplans<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> coursePreviewInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启内容管理服务，进入学习界面查看课程计划、课程名称等信息是否显示正常。</p><h3 id="_4-3-获取视频" tabindex="-1"><a class="header-anchor" href="#_4-3-获取视频" aria-hidden="true">#</a> <strong>4.3 获取视频</strong></h3><h4 id="_4-3-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_4-3-1-需求分析" aria-hidden="true">#</a> <strong>4.3.1 需求分析</strong></h4><p><img src="/MyBlog/assets/image-20230611162226958-8db90c9a.png" alt="image-20230611162226958"></p><h4 id="_4-3-2-接口定义" tabindex="-1"><a class="header-anchor" href="#_4-3-2-接口定义" aria-hidden="true">#</a> <strong>4.3.2 接口定义</strong></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>api</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>execption<span class="token punctuation">.</span></span><span class="token class-name">XueChengPlusException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">RestResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">XcUser</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">XcChooseCourseDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">XcCourseTablesDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">LearningService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">MyCourseTablesService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">SecurityUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Api</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiOperation</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> 学习过程管理接口
 * <span class="token keyword">@date</span> 2022/10/2 14:52
 */</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;学习过程管理接口&quot;</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">&quot;学习过程管理接口&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyLearningController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">LearningService</span> learningService<span class="token punctuation">;</span>


  <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;获取视频&quot;</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/open/learn/getvideo/{courseId}/{teachplanId}/{mediaId}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getvideo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;courseId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">,</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;teachplanId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> teachplanId<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;mediaId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> mediaId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//登录用户</span>
        <span class="token class-name">XcUser</span> user <span class="token operator">=</span> <span class="token class-name">SecurityUtil</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> userId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>user <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            userId <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//获取视频</span>


    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>定义 service 接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">RestResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">XcChooseCourseDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">XcCourseTablesDto</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 学习过程管理service接口
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/10/2 16:07
 * <span class="token keyword">@version</span> 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">LearningService</span> <span class="token punctuation">{</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 获取教学视频
 * <span class="token keyword">@param</span> <span class="token parameter">courseId</span> 课程id
 * <span class="token keyword">@param</span> <span class="token parameter">teachplanId</span> 课程计划id
 * <span class="token keyword">@param</span> <span class="token parameter">mediaId</span> 视频文件id
 * <span class="token keyword">@return</span> com.xuecheng.base.model.RestResponse<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.lang.String</span><span class="token punctuation">&gt;</span></span>
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/10/5 9:08
*/</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getVideo</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span><span class="token class-name">Long</span> courseId<span class="token punctuation">,</span><span class="token class-name">Long</span> teachplanId<span class="token punctuation">,</span><span class="token class-name">String</span> mediaId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-3-3-获取视频远程接口" tabindex="-1"><a class="header-anchor" href="#_4-3-3-获取视频远程接口" aria-hidden="true">#</a> <strong>4.3.3 获取视频远程接口</strong></h4><p>在学习中心服务 service 工程中定义媒资管理 Feignclient</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>feignclient</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">RestResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">CoursePublish</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 媒资管理服务远程接口
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/20 20:29
 * <span class="token keyword">@version</span> 1.0
 */</span>
 <span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;media-api&quot;</span><span class="token punctuation">,</span>fallbackFactory <span class="token operator">=</span> <span class="token class-name">MediaServiceClientFallbackFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
 <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/media&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MediaServiceClient</span> <span class="token punctuation">{</span>

 <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/open/preview/{mediaId}&quot;</span><span class="token punctuation">)</span>
 <span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPlayUrlByMediaId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;mediaId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> mediaId<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>FeignClient 接口的降级类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>learning<span class="token punctuation">.</span>feignclient</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">RestResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">CoursePublish</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">feign<span class="token punctuation">.</span>hystrix<span class="token punctuation">.</span></span><span class="token class-name">FallbackFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> TODO
 * <span class="token keyword">@date</span> 2022/10/3 8:03
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MediaServiceClientFallbackFactory</span> <span class="token keyword">implements</span> <span class="token class-name">FallbackFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaServiceClient</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">MediaServiceClient</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MediaServiceClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPlayUrlByMediaId</span><span class="token punctuation">(</span><span class="token class-name">String</span> mediaId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;远程调用媒资管理服务熔断异常：{}&quot;</span><span class="token punctuation">,</span>throwable<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-3-5-学习资格校验" tabindex="-1"><a class="header-anchor" href="#_4-3-5-学习资格校验" aria-hidden="true">#</a> <strong>4.3.5 学习资格校验</strong></h4><p>编写获取视频的接口实现方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getVideo</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">,</span> <span class="token class-name">Long</span> teachplanId<span class="token punctuation">,</span> <span class="token class-name">String</span> mediaId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//查询课程信息</span>
    <span class="token class-name">CoursePublish</span> coursepublish <span class="token operator">=</span> contentServiceClient<span class="token punctuation">.</span><span class="token function">getCoursepublish</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>coursepublish <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">validfail</span><span class="token punctuation">(</span><span class="token string">&quot;课程不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//todo:是否可以试学</span>

    <span class="token comment">//用户已登录</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//取学习资格</span>
        <span class="token class-name">XcCourseTablesDto</span> learningStatus <span class="token operator">=</span> myCourseTablesService<span class="token punctuation">.</span><span class="token function">getLearningStatus</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//学习资格，[{&quot;code&quot;:&quot;702001&quot;,&quot;desc&quot;:&quot;正常学习&quot;},{&quot;code&quot;:&quot;702002&quot;,&quot;desc&quot;:&quot;没有选课或选课后没有支付&quot;},{&quot;code&quot;:&quot;702003&quot;,&quot;desc&quot;:&quot;已过期需要申请续期或重新支付&quot;}]</span>
        <span class="token class-name">String</span> learnStatus <span class="token operator">=</span> learningStatus<span class="token punctuation">.</span><span class="token function">getLearnStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>learnStatus<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;702001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mediaServiceClient<span class="token punctuation">.</span><span class="token function">getPlayUrlByMediaId</span><span class="token punctuation">(</span>mediaId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>learnStatus<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;702002&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">validfail</span><span class="token punctuation">(</span><span class="token string">&quot;无法观看，由于没有选课或选课后没有支付&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>learnStatus<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;702003&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">validfail</span><span class="token punctuation">(</span><span class="token string">&quot;您的选课已过期需要申请续期或重新支付&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//未登录或未选课判断是否收费</span>
    <span class="token class-name">String</span> charge <span class="token operator">=</span> coursepublish<span class="token punctuation">.</span><span class="token function">getCharge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>charge<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;201000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//免费可以正常学习</span>
        <span class="token keyword">return</span> mediaServiceClient<span class="token punctuation">.</span><span class="token function">getPlayUrlByMediaId</span><span class="token punctuation">(</span>mediaId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">validfail</span><span class="token punctuation">(</span><span class="token string">&quot;请购买课程后继续学习&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-3-6-测试" tabindex="-1"><a class="header-anchor" href="#_4-3-6-测试" aria-hidden="true">#</a> <strong>4.3.6 测试</strong></h4><p>1、完善接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;获取视频&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/open/learn/getvideo/{courseId}/{teachplanId}/{mediaId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getvideo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;courseId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;courseId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> teachplanId<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;mediaId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> mediaId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//登录用户</span>
    <span class="token class-name">SecurityUtil<span class="token punctuation">.</span>XcUser</span> user <span class="token operator">=</span> <span class="token class-name">SecurityUtil</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> userId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        userId <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//获取视频</span>
    <span class="token keyword">return</span> learningService<span class="token punctuation">.</span><span class="token function">getVideo</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> courseId<span class="token punctuation">,</span> teachplanId<span class="token punctuation">,</span> mediaId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、测试准备</p><p>选课成功一门课程。</p><p>没有选课的免费课程、收费课程各一门，其中收费课程具有试学课程。</p><p>3、测试项目</p><p>1）选课成功的课程是否可以正常获取视频</p><p>2）免费课程没有选课是否可以正常学习</p><p>可修改选课记录表中的课程 id 为不存在进行测试，测试完再恢复原样。</p><p>3）收费课程没有选课是否可以正常学习</p><p>可修改选课记录表中的课程 id 为不存在进行测试，测试完再恢复原样。</p><h3 id="_4-4-我的课表" tabindex="-1"><a class="header-anchor" href="#_4-4-我的课表" aria-hidden="true">#</a> <strong>4.4 我的课表</strong></h3><h4 id="_4-4-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_4-4-1-需求分析" aria-hidden="true">#</a> <strong>4.4.1 需求分析</strong></h4><h5 id="_4-4-1-1-业务流程" tabindex="-1"><a class="header-anchor" href="#_4-4-1-1-业务流程" aria-hidden="true">#</a> <strong>4.4.1.1 业务流程</strong></h5><p>登录网站，点击“我的学习”进入个人中心，</p><p><img src="/MyBlog/assets/image-20230611162342280-55dbfbe2.png" alt="image-20230611162342280"></p><p>个人中心首页显示我的课程表：</p><p><img src="/MyBlog/assets/image-20230611162345470-45337528.png" alt="image-20230611162345470"></p><p>我的课表中显示了选课成功的免费课程、收费课程。最近学习课程显示了当前用户最近学习的课程信息。</p><p>点击继续学习进入当前学习章节的视频继续学习。</p><p>点击课程评价进入课程评价界面。</p><h5 id="_4-4-1-2-配置-nginx" tabindex="-1"><a class="header-anchor" href="#_4-4-1-2-配置-nginx" aria-hidden="true">#</a> <strong>4.4.1.2 配置 nginx</strong></h5><p>在 nginx 配置用户中心 server ,如下：</p><div class="language-tex line-numbers-mode" data-ext="tex"><pre class="language-tex"><code>    server <span class="token punctuation">{</span>
        listen       80;
        server_name  ucenter.51xuecheng.cn;
        #charset koi8-r;
        ssi on;
        ssi_silent_errors on;
        #access_log  logs/host.access.log  main;
        location / <span class="token punctuation">{</span>
            alias   D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal/ucenter/;
            index  index.html index.htm;
        <span class="token punctuation">}</span>
        location /include <span class="token punctuation">{</span>
            proxy_pass   http://127.0.0.1;
        <span class="token punctuation">}</span>
        location /img/ <span class="token punctuation">{</span>
            proxy_pass   http://127.0.0.1/static/img/;
        <span class="token punctuation">}</span>
        location /api/ <span class="token punctuation">{</span>
                proxy_pass http://gatewayserver/;
        <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-2-接口定义" tabindex="-1"><a class="header-anchor" href="#_4-4-2-接口定义" aria-hidden="true">#</a> <strong>4.4.2 接口定义</strong></h4><p>在 MyCourseTablesController 中定义我的课程表接口：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;我的课程表&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/mycoursetable&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">PageResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcCourseTables</span><span class="token punctuation">&gt;</span></span> <span class="token function">mycoursetable</span><span class="token punctuation">(</span><span class="token class-name">MyCourseTableParams</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-3-接口开发" tabindex="-1"><a class="header-anchor" href="#_4-4-3-接口开发" aria-hidden="true">#</a> <strong>4.4.3 接口开发</strong></h4><h5 id="_4-4-3-1dao" tabindex="-1"><a class="header-anchor" href="#_4-4-3-1dao" aria-hidden="true">#</a> <strong>4.4.3.1DAO</strong></h5><p>使用自动生成的 mapper 即可实现分页查询。</p><h5 id="_4-4-3-2-service" tabindex="-1"><a class="header-anchor" href="#_4-4-3-2-service" aria-hidden="true">#</a> <strong>4.4.3.2 Service</strong></h5><p>在 service 中定义我的课程表接口：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 我的课程表
 * <span class="token keyword">@param</span> <span class="token parameter">params</span>
 * <span class="token keyword">@return</span> com.xuecheng.base.model.PageResult<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>com.xuecheng.learning.model.po.XcCourseTables</span><span class="token punctuation">&gt;</span></span>
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/10/27 9:24
*/</span>
<span class="token keyword">public</span> <span class="token class-name">PageResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcCourseTables</span><span class="token punctuation">&gt;</span></span> <span class="token function">mycoursetables</span><span class="token punctuation">(</span><span class="token class-name">MyCourseTableParams</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编写接口实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">PageResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcCourseTables</span><span class="token punctuation">&gt;</span></span> <span class="token function">mycoursetables</span><span class="token punctuation">(</span> <span class="token class-name">MyCourseTableParams</span> params<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//页码</span>
    <span class="token keyword">long</span> pageNo <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//每页记录数</span>
    <span class="token keyword">long</span> pageSize <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//分页条件</span>
    <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcCourseTables</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>pageNo<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//根据用户id查询</span>
    <span class="token class-name">String</span> userId <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcCourseTables</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcCourseTables</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcCourseTables</span><span class="token operator">::</span><span class="token function">getUserId</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//分页查询</span>
    <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcCourseTables</span><span class="token punctuation">&gt;</span></span> pageResult <span class="token operator">=</span> courseTablesMapper<span class="token punctuation">.</span><span class="token function">selectPage</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcCourseTables</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> pageResult<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//记录总数</span>
    <span class="token keyword">long</span> total <span class="token operator">=</span> pageResult<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">PageResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcCourseTables</span><span class="token punctuation">&gt;</span></span> courseTablesResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>records<span class="token punctuation">,</span> total<span class="token punctuation">,</span> pageNo<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> courseTablesResult<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>完善接口：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;我的课程表&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/mycoursetable&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">PageResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcCourseTables</span><span class="token punctuation">&gt;</span></span> <span class="token function">mycoursetable</span><span class="token punctuation">(</span><span class="token class-name">MyCourseTableParams</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">//登录用户</span>
 <span class="token class-name">SecurityUtil<span class="token punctuation">.</span>XcUser</span> user <span class="token operator">=</span> <span class="token class-name">SecurityUtil</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;请登录后继续选课&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token class-name">String</span> userId <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//设置当前的登录用户</span>
 params<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> myCourseTablesService<span class="token punctuation">.</span><span class="token function">mycourestabls</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-4-接口测试" tabindex="-1"><a class="header-anchor" href="#_4-4-4-接口测试" aria-hidden="true">#</a> <strong>4.4.4 接口测试</strong></h4><p>登录网站，点击“我的学习”进入个人中心，查看我的课程表中课程是否是当前用户所选课程。</p><p><img src="/MyBlog/assets/image-20230611162345470-45337528.png" alt="image-20230611162451588"></p></div><!--[--><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/ZyKunn/edit/main/notes/project/02/第6章-选课学习v3.1/README.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--]--> Edit this page <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">贡献者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 814342838@qq.com">ZyKun</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/" class="" aria-label="第 5 章 认证授权 v3.1"><!--[--><!--]--> 第 5 章 认证授权 v3.1 <!--[--><!--]--></a></span><span class="next"><a href="/MyBlog/notes/project/02/%E7%AC%AC7%E7%AB%A0-%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2v3.1/" class="" aria-label="第 7 章 项目部署 v3.1"><!--[--><!--]--> 第 7 章 项目部署 v3.1 <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/MyBlog/assets/app-a153c100.js" defer></script>
  </body>
</html>
