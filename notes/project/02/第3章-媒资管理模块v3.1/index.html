<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.63">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="./img/logo.png"><title>第 3 章媒资管理模块 v3.1 | ZyKunのBlog</title><meta name="description" content="">
    <link rel="preload" href="/MyBlog/assets/style-57272a59.css" as="style"><link rel="stylesheet" href="/MyBlog/assets/style-57272a59.css">
    <link rel="modulepreload" href="/MyBlog/assets/app-a153c100.js"><link rel="modulepreload" href="/MyBlog/assets/index.html-a235e4bb.js"><link rel="modulepreload" href="/MyBlog/assets/index.html-64f564d2.js"><link rel="prefetch" href="/MyBlog/assets/index.html-ab0151fa.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1249ab5a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4d02565e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1c68c797.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-93acf26d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2bc953d6.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0c526d7c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-636c9f52.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d4177c6b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7624decc.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d0b4a798.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-aa378d7b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ddd44d65.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-adbb7f41.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-34576599.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1079a374.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-88d4ebe7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5e927142.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9a6f13b8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4c85da23.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-69e813d7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-545062a2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-bd7a4fcb.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-910949e0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-459b0c71.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9a036060.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f62ffe74.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-841a86c0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b31c8bb6.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-85bae056.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-73555735.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6d5456cd.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d2dfbeec.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-746091c2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9cc627ff.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d411448a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4454f425.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-57aa84f4.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2ce52087.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-76657200.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-90d9409e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4d6ba5e7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-41bc7856.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6140daf4.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ea30461d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-00114784.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f3fa86cb.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-386f0bd2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b46ac77e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-256a258e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4ebf55b3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7268161e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5a8852c0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-19373782.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4e33bb6b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-de5ff178.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fd5da14a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-dbee5a73.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-64025c89.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9bd15ac7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4812edff.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1f3f5c2b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-3f85e131.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1d66d048.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-67b1b38e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-17f10f72.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ad1b5dc8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b14e7669.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fa35810b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-acb9b7bf.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f2ba9a88.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-abdb28e5.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b3cc33e9.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ef13eee8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-73fa0dcc.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6f7449c7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-3857ef8d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e5af1d8f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d5d14c1f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-94a8b9a2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-3931e4d3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0978879b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-617bd5bf.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4fe008c8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0e33aa95.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-00725025.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8e05ec6e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-72ca6b4c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-427c5181.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-3b3baf42.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-40a790c3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9709e7c9.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8eb00d02.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0c849262.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-eda16f63.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-81242655.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2c9f6820.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-79188b74.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5775eee0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-eff0510c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-305de307.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e83a5de7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-761a9548.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-c12ae66e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-87a73e5c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d720473a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b960b5b6.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-bbd98f93.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-76195dca.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-3bd0cfa7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8c87d147.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-bac2e853.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1ee6bc34.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ab7381d6.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5b97f6b8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fd33ca6f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-684189de.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-63731ad7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-895bfca1.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6d1ff4c2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b71bf26f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ce6f983b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-c185f9a2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-29c62d64.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-52c91de2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-55aa1c06.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-c87ef63a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ff1d9f51.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-a12aedeb.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-298f19f2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f881f599.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2c32406a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d4217479.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7edb7ce1.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8671126f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-da565d04.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f9deb3ec.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ee7cf1b5.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-270d6327.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ec786b75.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e98adf02.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7233a0e2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-79c193cf.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9714081e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d5dea51d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e3209a23.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-cdce2101.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-389e66df.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-652ee4f6.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-025e6f4e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-60711e70.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6edc93de.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-11bd39b1.js" as="script"><link rel="prefetch" href="/MyBlog/assets/404.html-60b35caa.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-53015219.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-74dcd8ae.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2dd727db.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-11b329fb.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-3b6f3614.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-70ce719f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f6ca4d92.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5a6833de.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-bf03220c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-a2edab58.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f1e5cf7a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-21d4e18d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5235fca9.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2dc704c0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-57630906.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ff165209.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6ec253a3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f9e4f0c3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-664b232d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-adf015a3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4667c0e6.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-cc407710.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1752d212.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9b5d99c4.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-43c48ae2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e8a616b7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-93e7405b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-22a72a56.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-42ce3023.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f8eeab22.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-dd50991a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-af520db8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5ab2bfac.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-965bc04f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-81ebef01.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-79d19f4d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9600bdfb.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-560df48d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4fb22a4f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-bd4caa82.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-370323f9.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f673ebfa.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-78d88460.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8b54347c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d30f0340.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e26bc4de.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7d37b036.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-3aa565ce.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4c69f238.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-76d60030.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7116a5e4.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d8f649cc.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-adbbb7c9.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-90bb86fd.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e23936a3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-19ad952b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-07245162.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-038b3afd.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-084fe5c1.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-098421fe.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7baefce4.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fffdfb9c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d8c9612c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-05c42fda.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e1615934.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-da824146.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fa2d32f0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-545dbea7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f3ca58cb.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b9e2188a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4fc5f1f7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1ec5c70d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-cbf2aa55.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8beb0c08.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ee54da9f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fd28b91d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-98aa51a1.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-03f9381a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2c9009c5.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-71b7cfbe.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1759170e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-aa84186f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-53160af7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-51b685b4.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ecb8e229.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9c507901.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-c6362722.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-faf67dd8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d7f20950.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-a088985c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-93b7982c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b76e6179.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d976d39c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b16efd78.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1301757e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-c3240cbe.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-a2ddd21c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-74fb5e20.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-128f5026.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8fd9f38a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-82e84e23.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-007ef014.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f3dd860c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-382a2bae.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7b6beaec.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2eb17cfa.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-c6f50213.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0c8aef39.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-133f4d38.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-cffd2be1.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-a798219d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6b5fde77.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-13275b71.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4b6a02c3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7f179a12.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f45bc33f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0574e5e5.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0921816f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-631fbc02.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8586017d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-c4dbf09b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-967486c0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-aad17dde.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ff644d77.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-78a4df64.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8d2180e8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-53fbcd20.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-a3387e5e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-979f5ac4.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0938c506.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-51707e22.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b1e917a0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6b56a071.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d15eb498.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7b0a97c0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fda196b5.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-bcc5faac.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-490c208f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-dce28479.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-62825d3c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b5a4af15.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-eb40da96.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8d6d1c61.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-618cf3f0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f2a35430.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-bca2187b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-85181f96.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7f689b28.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-62aa623a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b0c39cc5.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-73b8fff0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5466ae58.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fbd0bcfa.js" as="script"><link rel="prefetch" href="/MyBlog/assets/404.html-5f041a2b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/style-e9220a04.js" as="script"><link rel="prefetch" href="/MyBlog/assets/docsearch-1d421ddb.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index-5161ad19.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/MyBlog/" class=""><!----><span class="site-name can-hide">ZyKunのBlog</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/MyBlog/" class="" aria-label="🌱Home"><!--[--><!--]--> 🌱Home <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🥝Java"><span class="title">🥝Java</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🥝Java"><span class="title">🥝Java</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/01/" class="" aria-label="基础语法"><!--[--><!--]--> 基础语法 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/02/" class="" aria-label="面向对象编程"><!--[--><!--]--> 面向对象编程 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/03/" class="" aria-label="常用类&amp;集合框架"><!--[--><!--]--> 常用类&amp;集合框架 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/04/" class="" aria-label="JDBC"><!--[--><!--]--> JDBC <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/05/" class="" aria-label="Java高级"><!--[--><!--]--> Java高级 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/06/" class="" aria-label="JavaWeb"><!--[--><!--]--> JavaWeb <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🐍Python"><span class="title">🐍Python</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🐍Python"><span class="title">🐍Python</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/python/01/" class="" aria-label="Python入门"><!--[--><!--]--> Python入门 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🌋微服务"><span class="title">🌋微服务</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🌋微服务"><span class="title">🌋微服务</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/microservices/01/" class="" aria-label="实用篇"><!--[--><!--]--> 实用篇 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/microservices/02/" class="" aria-label="高级篇"><!--[--><!--]--> 高级篇 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/MyBlog/notes/mysql/" class="" aria-label="🍓Mysql"><!--[--><!--]--> 🍓Mysql <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🍤前端"><span class="title">🍤前端</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🍤前端"><span class="title">🍤前端</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/01/" class="" aria-label="HTML&amp;CSS"><!--[--><!--]--> HTML&amp;CSS <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/02/" class="" aria-label="JavaScript"><!--[--><!--]--> JavaScript <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/03/" class="" aria-label="JQuery"><!--[--><!--]--> JQuery <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/04/" class="" aria-label="Layui"><!--[--><!--]--> Layui <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/05/" class="" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🎢Project"><span class="title">🎢Project</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🎢Project"><span class="title">🎢Project</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/project/01/" class="" aria-label="Reggie"><!--[--><!--]--> Reggie <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/project/02/" class="router-link-active" aria-label="51XueCheng"><!--[--><!--]--> 51XueCheng <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/MyBlog/notes/record/" class="" aria-label="🍍随笔"><!--[--><!--]--> 🍍随笔 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/ZyKunn" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!--[--><div id="docsearch-container" style="display:none;"></div><div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"><svg width="15" height="15" class="DocSearch-Control-Key-Icon"><path d="M4.505 4.496h2M5.505 5.496v5M8.216 4.496l.055 5.993M10 7.5c.333.333.5.667.5 1v2M12.326 4.5v5.996M8.384 4.496c1.674 0 2.116 0 2.116 1.5s-.442 1.5-2.116 1.5M3.205 9.303c-.09.448-.277 1.21-1.241 1.203C1 10.5.5 9.513.5 8V7c0-1.57.5-2.5 1.464-2.494.964.006 1.134.598 1.24 1.342M12.553 10.5h1.953" stroke-width="1.2" stroke="currentColor" fill="none" stroke-linecap="square"></path></svg></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/MyBlog/" class="" aria-label="🌱Home"><!--[--><!--]--> 🌱Home <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🥝Java"><span class="title">🥝Java</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🥝Java"><span class="title">🥝Java</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/01/" class="" aria-label="基础语法"><!--[--><!--]--> 基础语法 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/02/" class="" aria-label="面向对象编程"><!--[--><!--]--> 面向对象编程 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/03/" class="" aria-label="常用类&amp;集合框架"><!--[--><!--]--> 常用类&amp;集合框架 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/04/" class="" aria-label="JDBC"><!--[--><!--]--> JDBC <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/05/" class="" aria-label="Java高级"><!--[--><!--]--> Java高级 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/06/" class="" aria-label="JavaWeb"><!--[--><!--]--> JavaWeb <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🐍Python"><span class="title">🐍Python</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🐍Python"><span class="title">🐍Python</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/python/01/" class="" aria-label="Python入门"><!--[--><!--]--> Python入门 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🌋微服务"><span class="title">🌋微服务</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🌋微服务"><span class="title">🌋微服务</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/microservices/01/" class="" aria-label="实用篇"><!--[--><!--]--> 实用篇 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/microservices/02/" class="" aria-label="高级篇"><!--[--><!--]--> 高级篇 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/MyBlog/notes/mysql/" class="" aria-label="🍓Mysql"><!--[--><!--]--> 🍓Mysql <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🍤前端"><span class="title">🍤前端</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🍤前端"><span class="title">🍤前端</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/01/" class="" aria-label="HTML&amp;CSS"><!--[--><!--]--> HTML&amp;CSS <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/02/" class="" aria-label="JavaScript"><!--[--><!--]--> JavaScript <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/03/" class="" aria-label="JQuery"><!--[--><!--]--> JQuery <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/04/" class="" aria-label="Layui"><!--[--><!--]--> Layui <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/05/" class="" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🎢Project"><span class="title">🎢Project</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🎢Project"><span class="title">🎢Project</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/project/01/" class="" aria-label="Reggie"><!--[--><!--]--> Reggie <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/project/02/" class="router-link-active" aria-label="51XueCheng"><!--[--><!--]--> 51XueCheng <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/MyBlog/notes/record/" class="" aria-label="🍍随笔"><!--[--><!--]--> 🍍随笔 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/ZyKunn" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/MyBlog/notes/project/02/" class="router-link-active sidebar-item sidebar-heading active" aria-label="51XueCheng"><!--[--><!--]--> 51XueCheng <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a href="/MyBlog/notes/project/02/%E7%AC%AC1%E7%AB%A0-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D_%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BAv3.1/" class="sidebar-item" aria-label="第 1 章 项目介绍&amp;环境搭建 v3.1"><!--[--><!--]--> 第 1 章 项目介绍&amp;环境搭建 v3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E7%AC%AC2%E7%AB%A0-%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/" class="sidebar-item" aria-label="第 2 章 内容管理模块 v3.1"><!--[--><!--]--> 第 2 章 内容管理模块 v3.1 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="第 3 章媒资管理模块 v3.1"><!--[--><!--]--> 第 3 章媒资管理模块 v3.1 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_1-模块需求分析" class="router-link-active router-link-exact-active sidebar-item" aria-label="1 模块需求分析"><!--[--><!--]--> 1 模块需求分析 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_1-1-模块介绍" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.1 模块介绍"><!--[--><!--]--> 1.1 模块介绍 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_1-2-业务流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.2 业务流程"><!--[--><!--]--> 1.2 业务流程 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_1-2-1-上传图片" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.2.1 上传图片"><!--[--><!--]--> 1.2.1 上传图片 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_1-2-2-上传视频" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.2.2 上传视频"><!--[--><!--]--> 1.2.2 上传视频 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_1-2-3-处理视频" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.2.3 处理视频"><!--[--><!--]--> 1.2.3 处理视频 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_1-2-4-审核媒资" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.2.4 审核媒资"><!--[--><!--]--> 1.2.4 审核媒资 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_1-2-5-绑定媒资" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.2.5 绑定媒资"><!--[--><!--]--> 1.2.5 绑定媒资 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_1-3-数据模型" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.3 数据模型"><!--[--><!--]--> 1.3 数据模型 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_2-搭建模块环境" class="router-link-active router-link-exact-active sidebar-item" aria-label="2 搭建模块环境"><!--[--><!--]--> 2 搭建模块环境 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_2-1-架构的问题分析" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.1 架构的问题分析"><!--[--><!--]--> 2.1 架构的问题分析 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_2-2-搭建-nacos" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2 搭建 Nacos"><!--[--><!--]--> 2.2 搭建 Nacos <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_2-2-1-服务发现中心" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.1 服务发现中心"><!--[--><!--]--> 2.2.1 服务发现中心 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_2-2-2-配置中心" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.2 配置中心"><!--[--><!--]--> 2.2.2 配置中心 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_2-2-2-1-配置三要素" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.2.1 配置三要素"><!--[--><!--]--> 2.2.2.1 配置三要素 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_2-2-2-2-配置-content-service" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.2.2 配置 content-service"><!--[--><!--]--> 2.2.2.2 配置 content-service <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_2-2-2-3-配置-content-api" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.2.3 配置 content-api"><!--[--><!--]--> 2.2.2.3 配置 content-api <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_2-2-3-公用配置" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.3 公用配置"><!--[--><!--]--> 2.2.3 公用配置 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_2-2-4-配置优先级" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.4 配置优先级"><!--[--><!--]--> 2.2.4 配置优先级 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_2-2-5-导入配置文件" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.5 导入配置文件"><!--[--><!--]--> 2.2.5 导入配置文件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_2-2-6-作业" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.6 作业"><!--[--><!--]--> 2.2.6 作业 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_2-3-搭建-gateway" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.3 搭建 Gateway"><!--[--><!--]--> 2.3 搭建 Gateway <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_2-4-搭建媒资工程" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.4 搭建媒资工程"><!--[--><!--]--> 2.4 搭建媒资工程 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_3-分布式文件系统" class="router-link-active router-link-exact-active sidebar-item" aria-label="3 分布式文件系统"><!--[--><!--]--> 3 分布式文件系统 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_3-1-什么是分布式文件系统" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.1 什么是分布式文件系统"><!--[--><!--]--> 3.1 什么是分布式文件系统 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_3-2-minio" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.2 MinIO"><!--[--><!--]--> 3.2 MinIO <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_3-2-1-介绍" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.2.1 介绍"><!--[--><!--]--> 3.2.1 介绍 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_3-2-2-数据恢复演示" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.2.2 数据恢复演示"><!--[--><!--]--> 3.2.2 数据恢复演示 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_3-2-3-测试-docker-环境" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.2.3 测试 Docker 环境"><!--[--><!--]--> 3.2.3 测试 Docker 环境 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_3-2-4-sdk" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.2.4 SDK"><!--[--><!--]--> 3.2.4 SDK <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_3-2-4-1-上传文件" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.2.4.1 上传文件"><!--[--><!--]--> 3.2.4.1 上传文件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_3-2-4-2-删除文件" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.2.4.2 删除文件"><!--[--><!--]--> 3.2.4.2 删除文件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_3-2-4-3-查询文件" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.2.4.3 查询文件"><!--[--><!--]--> 3.2.4.3 查询文件 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_4-上传图片" class="router-link-active router-link-exact-active sidebar-item" aria-label="4 上传图片"><!--[--><!--]--> 4 上传图片 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_4-1-需求分析" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.1 需求分析"><!--[--><!--]--> 4.1 需求分析 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_4-1-1-业务流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.1.1 业务流程"><!--[--><!--]--> 4.1.1 业务流程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_4-1-2-数据模型" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.1.2 数据模型"><!--[--><!--]--> 4.1.2 数据模型 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_4-2-准备环境" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.2 准备环境"><!--[--><!--]--> 4.2 准备环境 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_4-3-接口定义" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.3 接口定义"><!--[--><!--]--> 4.3 接口定义 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_4-4-接口开发" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.4 接口开发"><!--[--><!--]--> 4.4 接口开发 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_4-4-1-dao-开发" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.4.1 DAO 开发"><!--[--><!--]--> 4.4.1 DAO 开发 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_4-4-2-service-开发" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.4.2 Service 开发"><!--[--><!--]--> 4.4.2 Service 开发 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_4-4-3-完善接口层" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.4.3 完善接口层"><!--[--><!--]--> 4.4.3 完善接口层 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_4-4-4-接口测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.4.4 接口测试"><!--[--><!--]--> 4.4.4 接口测试 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_4-4-5-service-事务优化" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.4.5 Service 事务优化"><!--[--><!--]--> 4.4.5 Service 事务优化 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-上传视频" class="router-link-active router-link-exact-active sidebar-item" aria-label="5 上传视频"><!--[--><!--]--> 5 上传视频 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-1-需求分析" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.1 需求分析"><!--[--><!--]--> 5.1 需求分析 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-2-断点续传技术" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.2 断点续传技术"><!--[--><!--]--> 5.2 断点续传技术 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-2-1-什么是断点续传" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.2.1 什么是断点续传"><!--[--><!--]--> 5.2.1 什么是断点续传 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-2-2-分块与合并测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.2.2 分块与合并测试"><!--[--><!--]--> 5.2.2 分块与合并测试 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-2-3-视频上传流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.2.3 视频上传流程"><!--[--><!--]--> 5.2.3 视频上传流程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-2-4-minio-合并文件测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.2.4 minio 合并文件测试"><!--[--><!--]--> 5.2.4 minio 合并文件测试 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-3-接口定义" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.3 接口定义"><!--[--><!--]--> 5.3 接口定义 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-4-上传分块开发" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.4 上传分块开发"><!--[--><!--]--> 5.4 上传分块开发 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-4-1-dao-开发" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.4.1 DAO 开发"><!--[--><!--]--> 5.4.1 DAO 开发 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-4-2-service-开发" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.4.2 Service 开发"><!--[--><!--]--> 5.4.2 Service 开发 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-4-2-1-检查文件和分块" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.4.2.1 检查文件和分块"><!--[--><!--]--> 5.4.2.1 检查文件和分块 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-4-2-2-上传分块" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.4.2.2 上传分块"><!--[--><!--]--> 5.4.2.2 上传分块 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-4-2-3-上传分块测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.4.2.3 上传分块测试"><!--[--><!--]--> 5.4.2.3 上传分块测试 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-5-合并分块开发" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.5 合并分块开发"><!--[--><!--]--> 5.5 合并分块开发 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-5-1-service-开发" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.5.1 service 开发"><!--[--><!--]--> 5.5.1 service 开发 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-5-2-合并分块测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.5.2 合并分块测试"><!--[--><!--]--> 5.5.2 合并分块测试 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-6-其它问题" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.6 其它问题"><!--[--><!--]--> 5.6 其它问题 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-6-1-分块文件清理问题" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.6.1 分块文件清理问题"><!--[--><!--]--> 5.6.1 分块文件清理问题 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-视频处理" class="router-link-active router-link-exact-active sidebar-item" aria-label="7 视频处理"><!--[--><!--]--> 7 视频处理 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-1-需求" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.1 需求"><!--[--><!--]--> 7.1 需求 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-1-1-总体需求" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.1.1 总体需求"><!--[--><!--]--> 7.1.1 总体需求 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-7-2-什么是视频编码" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.7.2 什么是视频编码"><!--[--><!--]--> 7.7.2 什么是视频编码 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-7-3-ffmpeg-的基本使用" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.7.3 FFmpeg 的基本使用"><!--[--><!--]--> 7.7.3 FFmpeg 的基本使用 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-7-4-视频处理工具类" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.7.4 视频处理工具类"><!--[--><!--]--> 7.7.4 视频处理工具类 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-2-分布式任务处理" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.2 分布式任务处理"><!--[--><!--]--> 7.2 分布式任务处理 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-2-1-什么是分布式任务调度" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.2.1 什么是分布式任务调度"><!--[--><!--]--> 7.2.1 什么是分布式任务调度 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-2-2-xxl-job-介绍" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.2.2 XXL-JOB 介绍"><!--[--><!--]--> 7.2.2 XXL-JOB 介绍 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-2-3-搭建-xxl-job" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.2.3 搭建 XXL-JOB"><!--[--><!--]--> 7.2.3 搭建 XXL-JOB <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-2-3-1-调度中心" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.2.3.1 调度中心"><!--[--><!--]--> 7.2.3.1 调度中心 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-2-3-2-执行器" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.2.3.2 执行器"><!--[--><!--]--> 7.2.3.2 执行器 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-2-3-3-执行任务" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.2.3.3 执行任务"><!--[--><!--]--> 7.2.3.3 执行任务 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-2-4-分片广播" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.2.4 分片广播"><!--[--><!--]--> 7.2.4 分片广播 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-3-技术方案" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.3 技术方案"><!--[--><!--]--> 7.3 技术方案 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-3-1-作业分片方案" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.3.1 作业分片方案"><!--[--><!--]--> 7.3.1 作业分片方案 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-3-2-保证任务不重复执行" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.3.2 保证任务不重复执行"><!--[--><!--]--> 7.3.2 保证任务不重复执行 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-3-3-视频处理方案" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.3.3 视频处理方案"><!--[--><!--]--> 7.3.3 视频处理方案 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-4-查询待处理任务" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.4 查询待处理任务"><!--[--><!--]--> 7.4 查询待处理任务 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-4-1-需求分析" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.4.1 需求分析"><!--[--><!--]--> 7.4.1 需求分析 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-4-2-添加待处理任务" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.4.2 添加待处理任务"><!--[--><!--]--> 7.4.2 添加待处理任务 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-4-3-查询待处理任务" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.4.3 查询待处理任务"><!--[--><!--]--> 7.4.3 查询待处理任务 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-5-开始执行任务" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.5 开始执行任务"><!--[--><!--]--> 7.5 开始执行任务 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-5-1-分布式锁" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.5.1 分布式锁"><!--[--><!--]--> 7.5.1 分布式锁 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-5-2-开启任务" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.5.2 开启任务"><!--[--><!--]--> 7.5.2 开启任务 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-6-更新任务状态" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.6 更新任务状态"><!--[--><!--]--> 7.6 更新任务状态 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-7-视频处理" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.7 视频处理"><!--[--><!--]--> 7.7 视频处理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-8-测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.8 测试"><!--[--><!--]--> 7.8 测试 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-8-1-基本测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.8.1 基本测试"><!--[--><!--]--> 7.8.1 基本测试 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-8-2-失败测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.8.2 失败测试"><!--[--><!--]--> 7.8.2 失败测试 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-8-3-抢占任务测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.8.3 抢占任务测试"><!--[--><!--]--> 7.8.3 抢占任务测试 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-9-其它问题" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.9 其它问题"><!--[--><!--]--> 7.9 其它问题 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-9-1-任务补偿机制" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.9.1 任务补偿机制"><!--[--><!--]--> 7.9.1 任务补偿机制 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-9-2-达到最大失败次数" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.9.2 达到最大失败次数"><!--[--><!--]--> 7.9.2 达到最大失败次数 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_8-绑定媒资" class="router-link-active router-link-exact-active sidebar-item" aria-label="8 绑定媒资"><!--[--><!--]--> 8 绑定媒资 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_8-1-需求分析" class="router-link-active router-link-exact-active sidebar-item" aria-label="8.1 需求分析"><!--[--><!--]--> 8.1 需求分析 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_8-1-1-业务流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="8.1.1 业务流程"><!--[--><!--]--> 8.1.1 业务流程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_8-1-2-数据模型" class="router-link-active router-link-exact-active sidebar-item" aria-label="8.1.2 数据模型"><!--[--><!--]--> 8.1.2 数据模型 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_8-2-接口定义" class="router-link-active router-link-exact-active sidebar-item" aria-label="8.2 接口定义"><!--[--><!--]--> 8.2 接口定义 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_8-3-接口开发" class="router-link-active router-link-exact-active sidebar-item" aria-label="8.3 接口开发"><!--[--><!--]--> 8.3 接口开发 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_8-3-1-dao-开发" class="router-link-active router-link-exact-active sidebar-item" aria-label="8.3.1 DAO 开发"><!--[--><!--]--> 8.3.1 DAO 开发 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_8-3-2-service-开发" class="router-link-active router-link-exact-active sidebar-item" aria-label="8.3.2 Service 开发"><!--[--><!--]--> 8.3.2 Service 开发 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_8-3-3-接口层完善" class="router-link-active router-link-exact-active sidebar-item" aria-label="8.3.3 接口层完善"><!--[--><!--]--> 8.3.3 接口层完善 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_8-3-4-接口测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="8.3.4 接口测试"><!--[--><!--]--> 8.3.4 接口测试 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_8-4-实战-前端代码有问题" class="router-link-active router-link-exact-active sidebar-item" aria-label="8.4 实战（前端代码有问题）"><!--[--><!--]--> 8.4 实战（前端代码有问题） <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a href="/MyBlog/notes/project/02/%E7%AC%AC4%E7%AB%A0-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83v3.1/" class="sidebar-item" aria-label="第 4 章 课程发布 v3.1"><!--[--><!--]--> 第 4 章 课程发布 v3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/" class="sidebar-item" aria-label="第 5 章 认证授权 v3.1"><!--[--><!--]--> 第 5 章 认证授权 v3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/" class="sidebar-item" aria-label="第 6 章 选课学习 v3.1"><!--[--><!--]--> 第 6 章 选课学习 v3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E7%AC%AC7%E7%AB%A0-%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2v3.1/" class="sidebar-item" aria-label="第 7 章 项目部署 v3.1"><!--[--><!--]--> 第 7 章 项目部署 v3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E7%AC%AC8%E7%AB%A0-%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%963.1/" class="sidebar-item" aria-label="第 8 章 项目优化 3.1"><!--[--><!--]--> 第 8 章 项目优化 3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83-%E9%83%A8%E7%BD%B2%E9%97%A8%E6%88%B7%E6%96%87%E6%A1%A3/" class="sidebar-item" aria-label="课程发布-部署门户文档 v3.1"><!--[--><!--]--> 课程发布-部署门户文档 v3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E5%BE%AE%E4%BF%A1%E6%89%AB%E7%A0%81%E7%99%BB%E5%BD%95%E9%85%8D%E7%BD%AE/" class="sidebar-item" aria-label="微信扫码登录配置"><!--[--><!--]--> 微信扫码登录配置 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AEv3.1/" class="sidebar-item" aria-label="学成在线项目开发环境配置 v3.1"><!--[--><!--]--> 学成在线项目开发环境配置 v3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E6%94%AF%E4%BB%98%E5%AE%9D%E6%B2%99%E7%AE%B1%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" class="sidebar-item" aria-label="支付宝沙箱环境"><!--[--><!--]--> 支付宝沙箱环境 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93/" class="sidebar-item" aria-label="项目总结"><!--[--><!--]--> 项目总结 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="第-3-章媒资管理模块-v3-1" tabindex="-1"><a class="header-anchor" href="#第-3-章媒资管理模块-v3-1" aria-hidden="true">#</a> <strong>第 3 章媒资管理模块 v3.1</strong></h1><nav class="table-of-contents"><ul><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_1-模块需求分析" class="router-link-active router-link-exact-active">1 模块需求分析</a><ul><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_1-1-模块介绍" class="router-link-active router-link-exact-active">1.1 模块介绍</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_1-2-业务流程" class="router-link-active router-link-exact-active">1.2 业务流程</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_1-3-数据模型" class="router-link-active router-link-exact-active">1.3 数据模型</a></li></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_2-搭建模块环境" class="router-link-active router-link-exact-active">2 搭建模块环境</a><ul><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_2-1-架构的问题分析" class="router-link-active router-link-exact-active">2.1 架构的问题分析</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_2-2-搭建-nacos" class="router-link-active router-link-exact-active">2.2 搭建 Nacos</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_2-3-搭建-gateway" class="router-link-active router-link-exact-active">2.3 搭建 Gateway</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_2-4-搭建媒资工程" class="router-link-active router-link-exact-active">2.4 搭建媒资工程</a></li></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_3-分布式文件系统" class="router-link-active router-link-exact-active">3 分布式文件系统</a><ul><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_3-1-什么是分布式文件系统" class="router-link-active router-link-exact-active">3.1 什么是分布式文件系统</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_3-2-minio" class="router-link-active router-link-exact-active">3.2 MinIO</a></li></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_4-上传图片" class="router-link-active router-link-exact-active">4 上传图片</a><ul><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_4-1-需求分析" class="router-link-active router-link-exact-active">4.1 需求分析</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_4-2-准备环境" class="router-link-active router-link-exact-active">4.2 准备环境</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_4-3-接口定义" class="router-link-active router-link-exact-active">4.3 接口定义</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_4-4-接口开发" class="router-link-active router-link-exact-active">4.4 接口开发</a></li></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-上传视频" class="router-link-active router-link-exact-active">5 上传视频</a><ul><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-1-需求分析" class="router-link-active router-link-exact-active">5.1 需求分析</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-2-断点续传技术" class="router-link-active router-link-exact-active">5.2 断点续传技术</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-3-接口定义" class="router-link-active router-link-exact-active">5.3 接口定义</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-4-上传分块开发" class="router-link-active router-link-exact-active">5.4 上传分块开发</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-5-合并分块开发" class="router-link-active router-link-exact-active">5.5 合并分块开发</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_5-6-其它问题" class="router-link-active router-link-exact-active">5.6 其它问题</a></li></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-视频处理" class="router-link-active router-link-exact-active">7 视频处理</a><ul><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-1-需求" class="router-link-active router-link-exact-active">7.1 需求</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-2-分布式任务处理" class="router-link-active router-link-exact-active">7.2 分布式任务处理</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-3-技术方案" class="router-link-active router-link-exact-active">7.3 技术方案</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-4-查询待处理任务" class="router-link-active router-link-exact-active">7.4 查询待处理任务</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-5-开始执行任务" class="router-link-active router-link-exact-active">7.5 开始执行任务</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-6-更新任务状态" class="router-link-active router-link-exact-active">7.6 更新任务状态</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-7-视频处理" class="router-link-active router-link-exact-active">7.7 视频处理</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-8-测试" class="router-link-active router-link-exact-active">7.8 测试</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_7-9-其它问题" class="router-link-active router-link-exact-active">7.9 其它问题</a></li></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_8-绑定媒资" class="router-link-active router-link-exact-active">8 绑定媒资</a><ul><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_8-1-需求分析" class="router-link-active router-link-exact-active">8.1 需求分析</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_8-2-接口定义" class="router-link-active router-link-exact-active">8.2 接口定义</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_8-3-接口开发" class="router-link-active router-link-exact-active">8.3 接口开发</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/#_8-4-实战-前端代码有问题" class="router-link-active router-link-exact-active">8.4 实战（前端代码有问题）</a></li></ul></li></ul></nav><h2 id="_1-模块需求分析" tabindex="-1"><a class="header-anchor" href="#_1-模块需求分析" aria-hidden="true">#</a> <strong>1 模块需求分析</strong></h2><h3 id="_1-1-模块介绍" tabindex="-1"><a class="header-anchor" href="#_1-1-模块介绍" aria-hidden="true">#</a> <strong>1.1 模块介绍</strong></h3><p>媒资管理系统是每个在线教育平台所必须具备的，查阅百度百科对它的定义如下：</p><p>媒体资源管理(Media Asset Management，MAM)系统是建立在多媒体、网络、数据库和数字存储等先进技术基础上的一个对各种媒体及内容(如视/音频资料、文本文件、图表等)进行数字化存储、管理以及应用的总体解决方案，包括数字媒体的采集、编目、管理、传输和编码转换等所有环节。其主要是满足<a href="https://baike.baidu.com/item/%E5%AA%92%E4%BD%93?fromModule=lemma_inlink" target="_blank" rel="noopener noreferrer">媒体<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>资源拥有者收集、保存、查找、编辑、发布各种信息的要求，为媒体资源的使用者提供访问内容的便捷方法，实现对媒体资源的高效管理，大幅度提高媒体资源的价值。</p><p>每个教学机构都可以在媒资系统管理自己的教学资源，包括：视频、教案等文件。</p><p>目前媒资管理的主要管理对象是视频、图片、文档等，包括：媒资文件的查询、文件上传、视频处理等。</p><p>媒资查询：教学机构查询自己所拥有的媒资信息。</p><p>文件上传：包括上传图片、上传文档、上传视频。</p><p>视频处理：视频上传成功，系统自动对视频进行编码处理。</p><p>文件删除：教学机构删除自己上传的媒资文件。</p><p>下图是课程编辑与发布的整体流程，通过下图可以看到媒资管理在整体流程的位置：</p><p><img src="/MyBlog/assets/image-20230516200809855-0c0f2854.png" alt="image-20230521172723493"></p><h3 id="_1-2-业务流程" tabindex="-1"><a class="header-anchor" href="#_1-2-业务流程" aria-hidden="true">#</a> <strong>1.2 业务流程</strong></h3><h4 id="_1-2-1-上传图片" tabindex="-1"><a class="header-anchor" href="#_1-2-1-上传图片" aria-hidden="true">#</a> <strong>1.2.1 上传图片</strong></h4><p>教学机构人员在课程信息编辑页面上传课程图片，课程图片统一记录在媒资管理系统。</p><p>下图是上传图片的界面：</p><p><img src="/MyBlog/assets/image-20230521172736026-dcdff67f.png" alt="image-20230521172736026"></p><h4 id="_1-2-2-上传视频" tabindex="-1"><a class="header-anchor" href="#_1-2-2-上传视频" aria-hidden="true">#</a> <strong>1.2.2 上传视频</strong></h4><p>1、教学机构人员进入媒资管理列表查询自己上传的媒资文件。</p><p>点击“媒资管理”</p><p><img src="/MyBlog/assets/image-20230521172741680-7b3acbdf.png" alt="image-20230521172741680"></p><p>进入媒资管理列表页面查询本机构上传的媒资文件。</p><p><img src="/MyBlog/assets/image-20230521172746056-a676d7de.png" alt="image-20230521172746056"></p><p>2、教育机构用户在&quot;媒资管理&quot;页面中点击 &quot;上传视频&quot; 按钮。</p><p><img src="/MyBlog/assets/image-20230521172754168-1b28ee58.png" alt="image-20230521172754168"></p><p>点击“上传视频”打开上传页面</p><p><img src="/MyBlog/assets/image-20230521172759310-c7af05fe.png" alt="image-20230521172759310"></p><p>3、选择要上传的文件，自动执行文件上传，视频上传成功会自动处理。</p><p><img src="/MyBlog/assets/image-20230521172807448-1b4d28cf.png" alt="image-20230521172807448"></p><h4 id="_1-2-3-处理视频" tabindex="-1"><a class="header-anchor" href="#_1-2-3-处理视频" aria-hidden="true">#</a> <strong>1.2.3 处理视频</strong></h4><p>对需要转码处理的视频系统会自动对其处理，处理后生成视频的 URL。</p><p>处理视频没有用户界面，完全是后台自动执行。</p><h4 id="_1-2-4-审核媒资" tabindex="-1"><a class="header-anchor" href="#_1-2-4-审核媒资" aria-hidden="true">#</a> <strong>1.2.4 审核媒资</strong></h4><p>审核媒资包括程序自动审核和人工审核，程序可以通过鉴黄接口(https://www.aliyun.com/product/lvwang?spm=5176.19720258.J_3207526240.51.e93976f4rSq796)审核视频，对有异议的视频由人工进行审核。</p><p>1.运营用户登入运营平台并进入媒资管理页面，查找待审核媒资</p><p><img src="/MyBlog/assets/image-20230521172839945-ace69397.png" alt="image-20230521172839945"></p><p>2.点击列表中媒资名称链接，可预览该媒资，若是视频，则播放视频。</p><p><img src="/MyBlog/assets/image-20230521172852283-2ed79aae.png" alt="image-20230521172852283"></p><p>3.点击列表中某媒资后的&quot;审核&quot; 按钮，既完成媒资的审批过程。</p><p><img src="/MyBlog/assets/image-20230521172906517-f9961011.png" alt="image-20230521172906517"></p><p>点击“审核”，选择审核结果，输入审核意见。</p><p><img src="/MyBlog/assets/image-20230521172913161-aa580986.png" alt="image-20230521172913161"></p><h4 id="_1-2-5-绑定媒资" tabindex="-1"><a class="header-anchor" href="#_1-2-5-绑定媒资" aria-hidden="true">#</a> <strong>1.2.5 绑定媒资</strong></h4><p>课程计划创建好后需要绑定媒资文件，比如：如果课程计划绑定了视频文件，进入课程在线学习界面后点课程计划名称则在线播放视频。如下图：</p><p><img src="/MyBlog/assets/image-20230521172926268-1194aad7.png" alt="image-20230521172926268"></p><p>如何将课程计划绑定媒资呢？</p><p>1.教育机构用户进入课程管理页面并编辑某一个课程，在&quot;课程大纲&quot;标签页的某一小节后可点击”添加视频“。</p><p><img src="/MyBlog/assets/image-20230521172936979-a0af02f0.png" alt="image-20230521172936979"></p><p>2.弹出添加视频对话框，可通过视频关键字搜索已审核通过的视频媒资。</p><p><img src="/MyBlog/assets/image-20230521172943466-f5fa9803.png" alt="image-20230521172943466"></p><p>3.选择视频媒资，点击提交按钮，完成课程计划绑定媒资流程。</p><p><img src="/MyBlog/assets/image-20230521172953841-176a63dd.png" alt="image-20230521172953841"></p><p>课程计划关联视频后如下图：</p><p><img src="/MyBlog/assets/image-20230521172959743-85b2922d.png" alt="image-20230521172959743"></p><h3 id="_1-3-数据模型" tabindex="-1"><a class="header-anchor" href="#_1-3-数据模型" aria-hidden="true">#</a> <strong>1.3 数据模型</strong></h3><p>本模块媒资文件相关的数据表如下：</p><p><img src="/MyBlog/assets/image-20230521173006160-bd1dee18.png" alt="image-20230521173006160"></p><p>媒资文件表：存储文件信息，包括图片、视频、文档等。</p><p>media_process: 待处理视频表。</p><p>media_process_history: 视频处理历史表，记录已经处理成功的视频信息。</p><p>媒资文件与课程计划绑定关系表如下：</p><p><img src="/MyBlog/assets/image-20230521173014279-ffe1a0ca.png" alt="image-20230521173014279"></p><h2 id="_2-搭建模块环境" tabindex="-1"><a class="header-anchor" href="#_2-搭建模块环境" aria-hidden="true">#</a> <strong>2 搭建模块环境</strong></h2><h3 id="_2-1-架构的问题分析" tabindex="-1"><a class="header-anchor" href="#_2-1-架构的问题分析" aria-hidden="true">#</a> <strong>2.1 架构的问题分析</strong></h3><p>当前要开发的是媒资管理服务，目前为止共三个微服务：内容管理、系统管理、媒资管理，如下图：</p><p><img src="/MyBlog/assets/image-20230521173023640-0cdd3615.png" alt="image-20230521173023640"></p><p>后期还会添加更多的微服务，当前这种由前端直接请求微服务的方式存在弊端：</p><p>如果在前端对每个请求地址都配置绝对路径，非常不利于系统维护，比如下边代码中请求系统管理服务的地址使用的是 localhost</p><p><img src="/MyBlog/assets/image-20230521173032950-94f2b353.png" alt="image-20230521173032950"></p><p>当系统上线后这里需要改成公网的域名，如果这种地址非常多则非常麻烦。</p><p>基于这个问题可以采用网关来解决，如下图：</p><p><img src="/MyBlog/assets/image-20230521173044369-beeae50f.png" alt="image-20230521173044369"></p><p>这样在前端的代码中只需要指定每个接口的相对路径，如下所示：</p><p><img src="/MyBlog/assets/image-20230521173050724-c9baec01.png" alt="image-20230521173050724"></p><p>在前端代码的一个固定的地方在接口地址前统一加网关的地址，每个请求统一到网关，由网关将请求转发到具体的微服务。</p><p>为什么所有的请求先到网关呢？</p><p>有了网关就可以对请求进行路由，路由到具体的微服务，减少外界对接微服务的成本，比如：400 电话，路由的试可以根据请求路径进行路由、根据 host 地址进行路由等， 当微服务有多个实例时可以通过负载均衡算法进行路由，如下：</p><p><img src="/MyBlog/assets/image-20230521173104225-cd295f61.png" alt="image-20230521173104225"></p><p>另外，网关还可以实现权限控制、限流等功能。</p><p>项目采用 Spring Cloud Gateway 作为网关，网关在请求路由时需要知道每个微服务实例的地址，项目使用 Nacos 作用服务发现中心和配置中心，整体的架构图如下：</p><p><img src="/MyBlog/assets/image-20230521173111174-07cf65ac.png" alt="image-20230521173111174"></p><p>流程如下：</p><p>1、微服务启动，将自己注册到 Nacos，Nacos 记录了各微服务实例的地址。</p><p>2、网关从 Nacos 读取服务列表，包括服务名称、服务地址等。</p><p>3、请求到达网关，网关将请求路由到具体的微服务。</p><p>要使用网关首先搭建 Nacos，Nacos 有两个作用：</p><p>1、服务发现中心。</p><p>微服务将自身注册至 Nacos，网关从 Nacos 获取微服务列表。</p><p>2、配置中心。</p><p>微服务众多，它们的配置信息也非常复杂，为了提供系统的可维护性，微服务的配置信息统一在 Nacos 配置。</p><h3 id="_2-2-搭建-nacos" tabindex="-1"><a class="header-anchor" href="#_2-2-搭建-nacos" aria-hidden="true">#</a> <strong>2.2 搭建 Nacos</strong></h3><h4 id="_2-2-1-服务发现中心" tabindex="-1"><a class="header-anchor" href="#_2-2-1-服务发现中心" aria-hidden="true">#</a> <strong>2.2.1 服务发现中心</strong></h4><p>Spring Cloud ：一套规范</p><p>Spring Cloud alibaba（类似与接口与实现类的关系）: nacos 服务注册中心，配置中心****</p><p>根据上节讲解的网关的架构图，要使用网关首先搭建 Nacos。</p><p>首先搭建 Nacos 服务发现中心。</p><p>在搭建 Nacos 服务发现中心之前需要搞清楚两个概念：namespace 和 group</p><p>namespace：用于区分环境、比如：开发环境、测试环境、生产环境。</p><p>group：用于区分项目，比如：xuecheng-plus 项目、xuecheng2.0 项目</p><p>首先在 nacos 配置 namespace:</p><p>登录 Centos，启动 Naocs，使用 sh /data/soft/restart.sh 将自动启动 Nacos。</p><p>访问：http://192.168.101.65:8848/nacos/</p><p>账号密码：nacos/nacos</p><p>登录成功，点击左侧菜单“命名空间”进入命名空间管理界面，</p><p><img src="/MyBlog/assets/image-20230521173125710-97f224ec.png" alt="image-20230521173125710"></p><p>点击“新建命名空间”，填写命名空间的相关信息。如下图：</p><p><img src="/MyBlog/assets/image-20230521173132455-80f80f7d.png" alt="image-20230521173132455"></p><p>使用相同的方法再创建“测试环境”、&quot;生产环境&quot;的命名空间。</p><p><img src="/MyBlog/assets/image-20230521173137803-223e339c.png" alt="image-20230521173137803"></p><p><img src="/MyBlog/assets/image-20230521173144339-39d2e089.png" alt="image-20230521173144339"></p><p>创建成功，如下图：</p><p><img src="/MyBlog/assets/image-20230521173156276-bad15a1d.png" alt="image-20230521173156276"></p><p>在教学中可以创建具体班级的命名空间，假如创建 1010 班级的命名空间，如下：</p><p><img src="/MyBlog/assets/image-20230521173201037-9d7510c3.png" alt="image-20230521173201037"></p><p><code>注意：如果使用dev1010命名空间，在下边的配置中对namespace配置为dev1010。</code></p><p>首先完成各服务注册到 Naocs，下边将内容管理服务注册到 nacos 中。</p><p>1) 在 xuecheng-plus-parent 中添加依赖管理</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring-cloud-alibaba.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2）在内容管理模块的接口工程、系统管理模块的接口工程中添加如下依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3）配置 nacos 的地址</p><p>在系统管理的接口工程的配置文件中配置如下信息：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment">##微服务配置</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>service
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.101.65<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在内容管理的接口工程的配置文件中配置如下信息：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>api
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.101.65<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4）重启内容管理服务、系统管理服务。</p><p>待微服务启动成功，进入 Nacos 服务查看服务列表</p><p><img src="/MyBlog/assets/image-20230521173400176-4ad78901.png" alt="image-20230521173400176"></p><p>在 “开发环境” 命名空间下有两个服务这说明内容管理微服务和系统管理微服务在 Nacos 注册成功。</p><p>点击其它一个微服务的“详情”</p><p><img src="/MyBlog/assets/image-20230521173404990-73544b58.png" alt="image-20230521173404990"></p><p>通过上图可以查看微服务实例的地址。</p><h4 id="_2-2-2-配置中心" tabindex="-1"><a class="header-anchor" href="#_2-2-2-配置中心" aria-hidden="true">#</a> <strong>2.2.2 配置中心</strong></h4><h5 id="_2-2-2-1-配置三要素" tabindex="-1"><a class="header-anchor" href="#_2-2-2-1-配置三要素" aria-hidden="true">#</a> <strong>2.2.2.1 配置三要素</strong></h5><p>搭建完成 Nacos 服务发现中心，下边搭建 Nacos 为配置中心，其目的就是通过 Nacos 去管理项目的所有配置。</p><p>先将项目中的配置文件分分类：</p><p><strong>1、每个项目特有的配置</strong></p><p>是指该配置只在有些项目中需要配置，或者该配置在每个项目中配置的值不同。</p><p>比如：spring.application.name 每个项目都需要配置但值不一样，以及有些项目需要连接数据库而有些项目不需要，有些项目需要配置消息队列而有些项目不需要。</p><p><strong>2、项目所公用的配置</strong></p><p>是指在若干项目中配置内容相同的配置。比如：redis 的配置，很多项目用的同一套 redis 服务所以配置也一样。</p><p>另外还需要知道 nacos 如何去定位一个具体的配置文件，即：namespace、group、dataid.</p><p>1、通过 namespace、group 找到具体的环境和具体的项目。</p><p>2、通过 dataid 找到具体的配置文件，dataid 有三部分组成</p><p><code>比如：content-service-dev.yaml配置文件 由（content-service）-（dev）. (yaml)三部分组成</code></p><p>content-service：第一部分，它是在 application.yaml 中配置的应用名，即 spring.application.name 的值。</p><p>dev：第二部分，它是环境名，通过 spring.profiles.active 指定，</p><p>Yaml: 第三部分，它是配置文件 的后缀，目前 nacos 支持 properties、yaml 等格式类型，本项目选择 yaml 格式类型。</p><p>所以，如果我们要配置 content-service 工程的配置文件:</p><p>在开发环境中配置 content-service-dev.yaml</p><p>在测试环境中配置 content-service-test.yaml</p><p>在生产环境中配置 content-service-prod.yaml</p><p>我们启动项目中传入 spring.profiles.active 的参数决定引用哪个环境的配置文件，例如：传入 spring.profiles.active=dev 表示使用 dev 环境的配置文件即 content-service-dev.yaml。</p><h5 id="_2-2-2-2-配置-content-service" tabindex="-1"><a class="header-anchor" href="#_2-2-2-2-配置-content-service" aria-hidden="true">#</a> <strong>2.2.2.2 配置 content-service</strong></h5><p>下边以开发环境为例对 content-service 工程的配置文件进行配置，进入 nacos，进入开发环境。</p><p><img src="/MyBlog/assets/image-20230521173419195-24b80f51.png" alt="image-20230521173419195"></p><p>点击加号，添加一个配置</p><p><img src="/MyBlog/assets/image-20230521173425795-3ffbe389.png" alt="image-20230521173425795"></p><p>输入 data id、group 以及配置文件内容。</p><p>为什么没在 nacos 中配置下边的内容 ？</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>service
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>因为刚才说了 dataid 第一部分就是 spring.application.name，nacos 客户端要根据此值确定配置文件 名称，所以 spring.application.name 不在 nacos 中配置，而是要在工程的本地进行配置。</p><p>在 content-service 工程的 test/resources 中添加 bootstrap.yaml，内容如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>service
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.101.65<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml
        <span class="token key atrule">refresh-enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

  <span class="token comment">#profiles默认为dev</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在内容管理模块的接口工程和 service 工程配置依赖：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置完成，运行 content-service 工程 的单元测试文件，能否正常测试，跟踪单元测试方法可以正常读取数据库的数据，说明从 nacos 读取配置信息正常。</p><p>通过运行观察控制台打印出下边的信息，NacosRestTemplate.java 通过 Post 方式与 nacos 服务端交互读取配置信息。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>NacosRestTemplate.java:476<span class="token punctuation">]</span> - HTTP method: POST, url: http://192.168.101.65:8848/nacos/v1/cs/configs/listener, body: <span class="token punctuation">{</span>Listening-Configs<span class="token operator">=</span>content-service.yaml?xuecheng-plus-project??dev?content-service-dev.yaml?xuecheng-plus-project?88459b1483b8381eccc2ef462bd59182?dev?content-service?xuecheng-plus-project??dev?, <span class="token assign-left variable">tenant</span><span class="token operator">=</span>dev<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-2-2-3-配置-content-api" tabindex="-1"><a class="header-anchor" href="#_2-2-2-3-配置-content-api" aria-hidden="true">#</a> <strong>2.2.2.3 配置 content-api</strong></h5><p>以相同的方法配置 content-api 工程的配置文件，在 nacos 中的开发环境中配置 content-api-dev.yaml，内容如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>
    <span class="token key atrule">context-path</span><span class="token punctuation">:</span> /content
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">63040</span>

<span class="token comment">## 日志文件配置路径</span>
<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>log4j2<span class="token punctuation">-</span>dev.xml

<span class="token comment">## swagger 文档配置</span>
<span class="token key atrule">swagger</span><span class="token punctuation">:</span>
  <span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token string">&#39;学成在线内容管理系统&#39;</span>
  <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">&#39;内容系统管理系统对课程相关信息进行业务管理数据&#39;</span>
  <span class="token key atrule">base-package</span><span class="token punctuation">:</span> com.xuecheng.content
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">version</span><span class="token punctuation">:</span> 1.0.0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 content-api 工程 的本地配置 bootstrap.yaml，内容如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment">##微服务配置</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>api
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.101.65<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml
        <span class="token key atrule">refresh-enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">extension-configs</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>service<span class="token punctuation">-</span>$<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意：因为 api 接口工程依赖了 service 工程 的 jar，所以这里使用 extension-configs 扩展配置文件 的方式引用 service 工程所用到的配置文件。</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">extension-configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>service<span class="token punctuation">-</span>$<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>.yaml
    <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
    <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果添加多个扩展文件，继续在下添加即可，如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">extension-configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>service<span class="token punctuation">-</span>$<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>.yaml
    <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
    <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> 填写文件 dataid
    <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
    <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动 content-api 工程，查询控制台是否打印出了请求 nacos 的日志，如下:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>NacosRestTemplate.java:476<span class="token punctuation">]</span> - HTTP method: POST, url: http://192.168.101.65:8848/nacos/v1/cs/configs/listener

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>并使用 Httpclient 测试课程查询接口是否可以正常查询。</p><h4 id="_2-2-3-公用配置" tabindex="-1"><a class="header-anchor" href="#_2-2-3-公用配置" aria-hidden="true">#</a> <strong>2.2.3 公用配置</strong></h4><p>还有一个优化的点是如何在 nacos 中配置项目的公用配置呢？</p><p>nacos 提供了 shared-configs 可以引入公用配置。</p><p>在 content-api 中配置了 swagger，所有的接口工程 都需要配置 swagger，这里就可以将 swagger 的配置定义为一个公用配置，哪个项目用引入即可。</p><p>单独在 xuecheng-plus-common 分组下创建 xuecheng-plus 的公用配置，进入 nacos 的开发环境，添加 swagger-dev.yaml 公用配置</p><p><img src="/MyBlog/assets/image-20230521173736347-7724532e.png" alt="image-20230521173736347"></p><p>删除接口工程中对 swagger 的配置。</p><p>项目使用 shared-configs 可以引入公用配置。在接口工程的本地配置文件 中引入公用配置，如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>api
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.101.65<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml
        <span class="token key atrule">refresh-enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">extension-configs</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>service<span class="token punctuation">-</span>$<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">shared-configs</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> swagger<span class="token punctuation">-</span>$<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> logging<span class="token punctuation">-</span>$<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再以相同 的方法配置日志的公用配置。</p><p><img src="/MyBlog/assets/image-20230521173754467-13df68aa.png" alt="image-20230521173754467"></p><p>在接口工程和业务工程，引入 loggin-dev.yaml 公用配置文件</p><p><img src="/MyBlog/assets/image-20230521173758499-477c5882.png" alt="image-20230521173758499"></p><p>配置完成，重启 content-api 接口工程，访问 http://localhost:63040/content/swagger-ui.html 查看 swagger 接口文档是否可以正常访问，查看控制台 log4j2 日志输出是否正常。</p><h4 id="_2-2-4-配置优先级" tabindex="-1"><a class="header-anchor" href="#_2-2-4-配置优先级" aria-hidden="true">#</a> <strong>2.2.4 配置优先级</strong></h4><p>到目前为止已将所有微服务的配置统一在 nacos 进行配置，用到的配置文件有本地的配置文件 bootstrap.yaml 和 nacos 上的配置文件，SpringBoot 读取配置文件 的顺序如下：</p><p><img src="/MyBlog/assets/image-20230521173813332-06d85572.png" alt="image-20230521173813332"></p><p>引入配置文件的形式有：</p><p>1、以项目应用名方式引入</p><p>2、以扩展配置文件方式引入</p><p>3、以共享配置文件 方式引入</p><p>4、本地配置文件</p><blockquote><p>各配置文件 的优先级：项目应用名配置文件 &gt; 扩展配置文件 &gt; 共享配置文件 &gt; 本地配置文件。</p></blockquote><p>有时候我们在测试程序时直接在本地加一个配置进行测试，比如下边的例子：</p><p>我们想启动两个内容管理微服务，此时需要在本地指定不同的端口，通过 VM Options 参数，在 IDEA 配置启动参数</p><p><img src="/MyBlog/assets/image-20230521173822900-3f61ab4c.png" alt="image-20230521173822900"></p><p>通过-D 指定参数名和参数值，参数名即在 bootstrap.yml 中配置的 server.port。</p><p><img src="/MyBlog/assets/image-20230521173839490-36a95960.png" alt="image-20230521173839490"></p><p>启动 ContentApplication2，发现端口仍然是 63040，这说明本地的配置没有生效。</p><p>这时我们想让本地最优先，可以在 nacos 配置文件 中配置如下即可实现：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment">##配置本地优先</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">override-none</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再次启动 ContentApplication2，端口为 63041。</p><h4 id="_2-2-5-导入配置文件" tabindex="-1"><a class="header-anchor" href="#_2-2-5-导入配置文件" aria-hidden="true">#</a> <strong>2.2.5 导入配置文件</strong></h4><p>课程资料中提供了系统用的所有配置文件 nacos_config_export.zip，下边将 nacos_config_export.zip 导入 nacos。</p><p>进入具体的命名空间，点击“导入配置”</p><p><img src="/MyBlog/assets/image-20230521173859544-f712d2b8.png" alt="image-20230521173859544"></p><p>打开导入窗口</p><p><img src="/MyBlog/assets/image-20230521173905236-16eb8eaf.png" alt="image-20230521173905236"></p><p>相同的配置选择覆盖配置。</p><p>点击“上传文件”选择资料中的 nacos_config_export.zip 开始导入。</p><h4 id="_2-2-6-作业" tabindex="-1"><a class="header-anchor" href="#_2-2-6-作业" aria-hidden="true">#</a> <strong>2.2.6 作业</strong></h4><p>按照上边的方法 自行将系统管理服务的配置信息在 nacos 上进行配置。</p><h3 id="_2-3-搭建-gateway" tabindex="-1"><a class="header-anchor" href="#_2-3-搭建-gateway" aria-hidden="true">#</a> <strong>2.3 搭建 Gateway</strong></h3><p>本项目使用 Spring Cloud Gateway 作为网关，下边创建网关工程。</p><p>新建一个网关工程。</p><p><img src="/MyBlog/assets/image-20230521173930442-ac478c45.png" alt="image-20230521173930442"></p><p>工程结构</p><p><img src="/MyBlog/assets/image-20230521173937510-22e2aaed.png" alt="image-20230521173937510"></p><p>添加依赖：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.xuecheng<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>xuecheng-plus-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">&gt;</span></span>../xuecheng-plus-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>relativePath</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>xuecheng-plus-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!--网关--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!--服务发现中心--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 排除 Spring Boot 依赖的日志包冲突 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-logging<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Spring Boot 集成 log4j2 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-log4j2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>


<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置网关的 bootstrap.yaml 配置文件</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token comment">##微服务配置</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.101.65<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml
        <span class="token key atrule">refresh-enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">shared-configs</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> logging<span class="token punctuation">-</span>$<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 nacos 上配置网关路由策略：</p><p><img src="/MyBlog/assets/image-20230521174013064-17e56827.png" alt="image-20230521174013064"></p><p>详细配置如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">63010</span> <span class="token comment"># 网关端口</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token comment">#      filter:</span>
      <span class="token comment">#        strip-prefix:</span>
      <span class="token comment">#          enabled: true</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> <span class="token comment"># 网关路由配置</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>api <span class="token comment"># 路由id，自定义，只要唯一即可</span>
          <span class="token comment"># uri: http://127.0.0.1:8081 # 路由的目标地址 http就是固定地址</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//content<span class="token punctuation">-</span>api <span class="token comment"># 路由的目标地址 lb就是负载均衡，后面跟服务名称</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment"># 路由断言，也就是判断请求是否符合路由规则的条件</span>
            <span class="token punctuation">-</span> Path=/content/<span class="token important">**</span> <span class="token comment"># 这个是按照路径匹配，只要以/content/开头就符合要求</span>
        <span class="token comment">#          filters:</span>
        <span class="token comment">#            - StripPrefix=1</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>api
          <span class="token comment"># uri: http://127.0.0.1:8081</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//system<span class="token punctuation">-</span>api
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/system/<span class="token important">**</span>
        <span class="token comment">#          filters:</span>
        <span class="token comment">#            - StripPrefix=1</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> media<span class="token punctuation">-</span>api
          <span class="token comment"># uri: http://127.0.0.1:8081</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//media<span class="token punctuation">-</span>api
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/media/<span class="token important">**</span>
<span class="token comment">##          filters:</span>
<span class="token comment">##            - StripPrefix=1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动网关工程，通过网关工程访问微服务进行测试。</p><p>在 http-client-env.json 中配置网关的地址</p><p><img src="/MyBlog/assets/image-20230521174035750-b6350df8.png" alt="image-20230521174035750"></p><p>使用 httpclient 测试课程查询 接口，如下：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>#### 课程查询列表
POST <span class="token punctuation">{</span><span class="token punctuation">{</span>gateway_host<span class="token punctuation">}</span><span class="token punctuation">}</span>/content/course/list?pageNo=<span class="token number">2</span>&amp;pageSize=<span class="token number">1</span>
Content-Type<span class="token operator">:</span> application/json

<span class="token punctuation">{</span>
  <span class="token property">&quot;auditStatus&quot;</span><span class="token operator">:</span> <span class="token string">&quot;202002&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;courseName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行，观察是否可以正常访问接口 ，如下所示可以正常请求接口。</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>http<span class="token operator">:</span><span class="token comment">//localhost:63010/content/course/list?pageNo=2&amp;pageSize=1</span>

HTTP/<span class="token number">1.1</span> <span class="token number">200</span> OK
transfer-encoding<span class="token operator">:</span> chunked
Content-Type<span class="token operator">:</span> application/json
Date<span class="token operator">:</span> Sun<span class="token punctuation">,</span> <span class="token number">11</span> Sep <span class="token number">2022</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">54</span><span class="token operator">:</span><span class="token number">32</span> GMT

<span class="token punctuation">{</span>
  <span class="token property">&quot;items&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">26</span><span class="token punctuation">,</span>
      <span class="token property">&quot;companyId&quot;</span><span class="token operator">:</span> <span class="token number">1232141425</span><span class="token punctuation">,</span>
      <span class="token property">&quot;companyName&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;spring cloud实战&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;users&quot;</span><span class="token operator">:</span> <span class="token string">&quot;所有人&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
      <span class="token property">&quot;mt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1-3&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;mtName&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
      <span class="token property">&quot;st&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1-3-2&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;stName&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
      <span class="token property">&quot;grade&quot;</span><span class="token operator">:</span> <span class="token string">&quot;200003&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;teachmode&quot;</span><span class="token operator">:</span> <span class="token string">&quot;201001&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;本课程主要从四个章节进行讲解： 1.微服务架构入门 2.spring cloud 基础入门 3.实战Spring Boot 4.注册中心eureka。&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;pic&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://cdn.educba.com/academy/wp-content/uploads/2018/08/Spring-BOOT-Interview-questions.jpg&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;createDate&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2019-09-04 09:56:19&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;changeDate&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2021-12-26 22:10:38&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;createPeople&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
      <span class="token property">&quot;changePeople&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
      <span class="token property">&quot;auditStatus&quot;</span><span class="token operator">:</span> <span class="token string">&quot;202002&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token string">&quot;203001&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;coursePubId&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
      <span class="token property">&quot;coursePubDate&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;counts&quot;</span><span class="token operator">:</span> <span class="token number">29</span><span class="token punctuation">,</span>
  <span class="token property">&quot;page&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token property">&quot;pageSize&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>网关工程搭建完成即可将前端工程中的接口地址改为网关的地址</p><p><img src="/MyBlog/assets/image-20230521174225795-40667565.png" alt="image-20230521174225795"></p><p>启动前端工程，测试之前开发内容管理模块的功能。</p><p>观察网关控制台，通过网关转发课程查询的日志如下：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Handler is being applied: <span class="token punctuation">{</span>uri<span class="token operator">=</span>http://192.168.101.1:63040/content/course/list?pageNo<span class="token operator">=</span><span class="token number">2</span><span class="token operator">&amp;</span><span class="token assign-left variable">pageSize</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">method</span><span class="token operator">=</span>POST<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-搭建媒资工程" tabindex="-1"><a class="header-anchor" href="#_2-4-搭建媒资工程" aria-hidden="true">#</a> <strong>2.4 搭建媒资工程</strong></h3><p>至此网关、Nacos 已经搭建完成，下边将媒资工程导入项目。</p><p>从课程资料中获取媒资工程 xuecheng-plus-media，拷贝到项目工程根目录。</p><p>右键 pom.xml 转为 maven 工程。</p><p><img src="/MyBlog/assets/image-20230521174246366-eba74aa0.png" alt="image-20230521174246366"></p><p>下边做如下配置：</p><p>1、创建媒资数据库 xc_media，并导入资料目录中的 xcplus_media.sql</p><p>2、修改 nacos 上的 media-service-dev.yaml 配置文件中的数据库链接信息</p><p>重启 media-api 工程只要能正常启动成功即可，稍后根据需求写接口。</p><h2 id="_3-分布式文件系统" tabindex="-1"><a class="header-anchor" href="#_3-分布式文件系统" aria-hidden="true">#</a> <strong>3 分布式文件系统</strong></h2><h3 id="_3-1-什么是分布式文件系统" tabindex="-1"><a class="header-anchor" href="#_3-1-什么是分布式文件系统" aria-hidden="true">#</a> <strong>3.1 什么是分布式文件系统</strong></h3><p>要理解分布式文件系统首先了解什么是文件系统。</p><p>查阅百度百科：</p><p><img src="/MyBlog/assets/image-20230521174256887-a4403dc1.png" alt="image-20230521174256887"></p><p>文件系统是负责管理和存储文件的系统软件，操作系统通过文件系统提供的接口去存取文件，用户通过操作系统访问磁盘上的文件。</p><p>下图指示了文件系统所处的位置：</p><p><img src="/MyBlog/assets/image-20230521174301218-24e58423.png" alt="image-20230521174301218"></p><p>常见的文件系统：FAT16/FAT32、NTFS、HFS、UFS、APFS、XFS、Ext4 等 。</p><p>现在有个问题，一此短视频平台拥有大量的视频、图片，这些视频文件、图片文件该如何存储呢？如何存储可以满足互联网上海量用户的浏览。</p><p>今天讲的分布式文件系统就是海量用户查阅海量文件的方案。</p><p>我们阅读百度百科去理解分布式文件系统的定义：</p><p><img src="/MyBlog/assets/image-20230521174316618-8bdb5559.png" alt="image-20230521174316618"></p><p>通过概念可以简单理解为：一个计算机无法存储海量的文件，通过网络将若干计算机组织起来共同去存储海量的文件，去接收海量用户的请求，这些组织起来的计算机通过网络进行通信，如下图：</p><p><img src="/MyBlog/assets/image-20230521174324104-4a9a4f65.png" alt="image-20230521174324104"></p><p>好处：</p><p>1、一台计算机的文件系统处理能力扩充到多台计算机同时处理。</p><p>2、一台计算机挂了还有另外副本计算机提供数据。</p><p>3、每台计算机可以放在不同的地域，这样用户就可以就近访问，提高访问速度。</p><p>市面上有哪些分布式文件系统的产品呢？</p><p>1、NFS</p><p>阅读百度百科：</p><p><img src="/MyBlog/assets/image-20230521174332940-58c85c5a.png" alt="image-20230521174332940"></p><p><img src="/MyBlog/assets/image-20230521174339285-07848f14.png" alt="image-20230521174339285"></p><p>特点：</p><p>1）在客户端上映射 NFS 服务器的驱动器。</p><p>2）客户端通过网络访问 NFS 服务器的硬盘完全透明。</p><p>2、GFS</p><p><img src="/MyBlog/assets/image-20230521174350504-af4004b2.png" alt="image-20230521174350504"></p><p><img src="/MyBlog/assets/image-20230521174356095-a3e6d6a2.png" alt="image-20230521174356095"></p><p>1）GFS 采用主从结构，一个 GFS 集群由一个 master 和大量的 chunkserver 组成。</p><p>2）master 存储了数据文件的元数据，一个文件被分成了若干块存储在多个 chunkserver 中。</p><p>3）用户从 master 中获取数据元信息，向 chunkserver 存储数据。</p><p>3) HDFS</p><p>HDFS，是 Hadoop Distributed File System 的简称，是 Hadoop 抽象文件系统的一种实现。HDFS 是一个高度容错性的系统，适合部署在廉价的机器上。HDFS 能提供高吞吐量的数据访问，非常适合大规模数据集上的应用。 HDFS 的文件分布在集群机器上，同时提供副本进行容错及可靠性保证。例如客户端写入读取文件的直接操作都是分布在集群各个机器上的，没有单点性能压力。</p><p>下图是 HDFS 的架构图：</p><p><img src="/MyBlog/assets/image-20230521174405599-0ae10664.png" alt="image-20230521174405599"></p><p>1）HDFS 采用主从结构，一个 HDFS 集群由一个名称结点和若干数据结点组成。</p><p>2) 名称结点存储数据的元信息，一个完整的数据文件分成若干块存储在数据结点。</p><p>3）客户端从名称结点获取数据的元信息及数据分块的信息，得到信息客户端即可从数据块来存取数据。</p><p><strong>4、云计算厂家</strong></p><p>阿里云对象存储服务（Object Storage Service，简称 OSS），是阿里云提供的海量、安全、低成本、高可靠的云存储服务。其数据设计持久性不低于 99.9999999999%（12 个 9），服务设计可用性（或业务连续性）不低于 99.995%。</p><p><em>官方网站：<a href="https://www.aliyun.com/product/oss" target="_blank" rel="noopener noreferrer">https://www.aliyun.com/product/oss<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></em></p><p>百度对象存储 BOS 提供稳定、安全、高效、高可扩展的云存储服务。您可以将任意数量和形式的非结构化数据存入 BOS，并对数据进行管理和处理。BOS 支持标准、低频、冷和归档存储等多种存储类型，满足多场景的存储需求。</p><p><em>官方网站：<a href="https://cloud.baidu.com/product/bos.html" target="_blank" rel="noopener noreferrer">https://cloud.baidu.com/product/bos.html<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></em></p><h3 id="_3-2-minio" tabindex="-1"><a class="header-anchor" href="#_3-2-minio" aria-hidden="true">#</a> <strong>3.2 MinIO</strong></h3><h4 id="_3-2-1-介绍" tabindex="-1"><a class="header-anchor" href="#_3-2-1-介绍" aria-hidden="true">#</a> <strong>3.2.1 介绍</strong></h4><p>本项目采用 MinIO 构建分布式文件系统，MinIO 是一个非常轻量的服务,可以很简单的和其他应用的结合使用，它兼容亚马逊 S3 云存储服务接口，非常适合于存储大容量非结构化的数据，例如图片、视频、日志文件、备份数据和容器/虚拟机镜像等。</p><p>它一大特点就是轻量，使用简单，功能强大，支持各种平台，单个文件最大 5TB，兼容 Amazon S3 接口，提供了 Java、Python、GO 等多版本 SDK 支持。</p><p>官网：https://min.io</p><p>中文：https://www.minio.org.cn/，http://docs.minio.org.cn/docs/</p><p>MinIO 集群采用去中心化共享架构，每个结点是对等关系，通过 Nginx 可对 MinIO 进行负载均衡访问。</p><p>去中心化有什么好处？</p><p>在大数据领域，通常的设计理念都是无中心和分布式。Minio 分布式模式可以帮助你搭建一个高可用的对象存储服务，你可以使用这些存储设备，而不用考虑其真实物理位置。</p><p>它将分布在不同服务器上的多块硬盘组成一个对象存储服务。由于硬盘分布在不同的节点上，分布式 Minio 避免了单点故障。如下图：</p><p><img src="/MyBlog/assets/image-20230521174422689-0b701b9b.png" alt="image-20230521174422689"></p><p>Minio 使用<strong>纠删码</strong>技术来保护数据，它是一种恢复丢失和损坏数据的数学算法，它将数据分块冗余的分散存储在各各节点的磁盘上，所有的可用磁盘组成一个集合，上图由 8 块硬盘组成一个集合，当上传一个文件时会通过纠删码算法计算对文件进行分块存储，除了将文件本身分成 4 个数据块，还会生成 4 个校验块，数据块和校验块会分散的存储在这 8 块硬盘上。</p><p>使用纠删码的好处是即便丢失一半数量（N/2）的硬盘，仍然可以恢复数据。 比如上边集合中有 4 个以内的硬盘损害仍可保证数据恢复，不影响上传和下载，如果多于一半的硬盘坏了则无法恢复。</p><h4 id="_3-2-2-数据恢复演示" tabindex="-1"><a class="header-anchor" href="#_3-2-2-数据恢复演示" aria-hidden="true">#</a> <strong>3.2.2 数据恢复演示</strong></h4><p>下边在本机演示 MinIO 恢复数据的过程，在本地创建 4 个目录表示 4 个硬盘。</p><p><img src="/MyBlog/assets/image-20230521174429441-fe8bf6db.png" alt="image-20230521174429441"></p><p>下载 minio，下载地址在https://dl.min.io/server/minio/release/，可从课程资料找到MinIO的安装文件minio.zip解压即可使用，CMD进入有minio.exe的目录，运行下边的命令：</p><div class="language-tex line-numbers-mode" data-ext="tex"><pre class="language-tex"><code>minio.exe server D:<span class="token function selector">\develop</span><span class="token function selector">\minio</span>_data<span class="token function selector">\data</span>1  D:<span class="token function selector">\develop</span><span class="token function selector">\minio</span>_data<span class="token function selector">\data</span>2  D:<span class="token function selector">\develop</span><span class="token function selector">\minio</span>_data<span class="token function selector">\data</span>3  D:<span class="token function selector">\develop</span><span class="token function selector">\minio</span>_data<span class="token function selector">\data</span>4

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>启动结果如下：</p><p><img src="/MyBlog/assets/image-20230521174516437-f9b09631.png" alt="image-20230521174516437"></p><p>说明如下：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>WARNING: MINIO_ACCESS_KEY <span class="token operator">and</span> MINIO_SECRET_KEY are deprecated<span class="token punctuation">.</span>
         Please <span class="token keyword">use</span> MINIO_ROOT_USER <span class="token operator">and</span> MINIO_ROOT_PASSWORD
Formatting <span class="token number">1</span>st pool<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">set</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span> drives per <span class="token keyword">set</span><span class="token punctuation">.</span>
WARNING: Host <span class="token keyword">local</span> has more than <span class="token number">2</span> drives <span class="token keyword">of</span> <span class="token keyword">set</span><span class="token punctuation">.</span> A host failure will result <span class="token operator">in</span> <span class="token keyword">data</span> becoming unavailable<span class="token punctuation">.</span>
WARNING: Detected <span class="token keyword">default</span> credentials <span class="token string">&#39;minioadmin:minioadmin&#39;</span><span class="token punctuation">,</span> we recommend that you change these <span class="token keyword">values</span> <span class="token keyword">with</span> <span class="token string">&#39;MINIO_ROOT_USER&#39;</span> <span class="token operator">and</span> <span class="token string">&#39;MINIO_ROOT_PASSWORD&#39;</span> environment variables

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1）老版本使用的 MINIO_ACCESS_KEY 和 MINIO_SECRET_KEY 不推荐使用，推荐使用 MINIO_ROOT_USER 和 MINIO_ROOT_PASSWORD 设置账号和密码。</p><p>2）pool 即 minio 节点组成的池子，当前有一个 pool 和 4 个硬盘组成的 set 集合</p><p>3）因为集合是 4 个硬盘，大于 2 的硬盘损坏数据将无法恢复。</p><p>4）账号和密码默认为 minioadmin、minioadmin，可以在环境变量中设置通过&#39;MINIO_ROOT_USER&#39; and &#39;MINIO_ROOT_PASSWORD&#39; 进行设置。</p><p>下边输入 http://localhost:9000 进行登录，账号和密码为：minioadmin/minioadmin</p><p><img src="/MyBlog/assets/image-20230521174542920-04fae96a.png" alt="image-20230521174542920"></p><p>登录成功：</p><p><img src="/MyBlog/assets/image-20230521174550651-0329b8d4.png" alt="image-20230521174550651">下一步创建 bucket，桶，它相当于存储文件的目录，可以创建若干的桶。</p><p><img src="/MyBlog/assets/image-20230521174556135-4a8110f2.png" alt="image-20230521174556135"></p><p>输入 bucket 的名称，点击“CreateBucket”，创建成功</p><p><img src="/MyBlog/assets/image-20230521174601980-808b15b7.png" alt="image-20230521174601980"></p><p>点击“upload”上传文件。</p><p>下边上传几个文件</p><p><img src="/MyBlog/assets/image-20230521174611447-14fded21.png" alt="image-20230521174611447"></p><p>下边去四个目录观察文件的存储情况</p><p><img src="/MyBlog/assets/image-20230521174618445-2a4d6358.png" alt="image-20230521174618445"></p><p>我们发现上传的 1.mp4 文件存储在了四个目录，即四个硬盘上。</p><p>下边测试 minio 的数据恢复过程：</p><p>1、首先删除一个目录。</p><p>删除目录后仍然可以在 web 控制台上传文件和下载文件。</p><p>稍等片刻删除的目录自动恢复。</p><p>2、删除两个目录。</p><p>删除两个目录也会自动恢复。</p><p>3、删除三个目录 。</p><p>由于 集合中共有 4 块硬盘，有大于一半的硬盘损坏数据无法恢复。</p><p>此时报错：We encountered an internal error, please try again. (Read failed. Insufficient number of drives online)在线驱动器数量不足。</p><h4 id="_3-2-3-测试-docker-环境" tabindex="-1"><a class="header-anchor" href="#_3-2-3-测试-docker-环境" aria-hidden="true">#</a> <strong>3.2.3 测试 Docker 环境</strong></h4><p>开发阶段和生产阶段统一使用 Docker 下的 MINIO。</p><p>在下发的虚拟机中已安装了 MinIO 的镜像和容器，执行 sh /data/soft /restart.sh 启动 Docker 下的 MinIO</p><p>启动完成登录 MinIO 查看是否正常。</p><p>访问http://192.168.101.65:9000</p><p><img src="/MyBlog/assets/image-20230521174632760-d2754acf.png" alt="image-20230521174632760">本项目创建两个 buckets：</p><p>mediafiles： 普通文件</p><p>video：视频文件</p><h4 id="_3-2-4-sdk" tabindex="-1"><a class="header-anchor" href="#_3-2-4-sdk" aria-hidden="true">#</a> <strong>3.2.4 SDK</strong></h4><h5 id="_3-2-4-1-上传文件" tabindex="-1"><a class="header-anchor" href="#_3-2-4-1-上传文件" aria-hidden="true">#</a> <strong>3.2.4.1 上传文件</strong></h5><p>MinIO 提供多个语言版本 SDK 的支持，下边找到 java 版本的文档：</p><p>地址：https://docs.min.io/docs/java-client-quickstart-guide.html</p><p>最低需求 Java 1.8 或更高版本:</p><p>maven 依赖如下：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.minio<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>minio<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>8.4.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.squareup.okhttp3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>okhttp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.8.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 media-service 工程添加此依赖。</p><p>参数说明：</p><p>需要三个参数才能连接到 minio 服务。</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>参数</td><td>说明</td></tr><tr><td>Endpoint</td><td>对象存储服务的 URL</td></tr><tr><td>Access Key</td><td>Access key 就像用户 ID，可以唯一标识你的账户。</td></tr><tr><td>Secret Key</td><td>Secret key 是你账户的密码。</td></tr></tbody></table><p>官方的示例代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span></span><span class="token class-name">BucketExistsArgs</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span></span><span class="token class-name">MakeBucketArgs</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span></span><span class="token class-name">MinioClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span></span><span class="token class-name">UploadObjectArgs</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span>errors<span class="token punctuation">.</span></span><span class="token class-name">MinioException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">InvalidKeyException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">NoSuchAlgorithmException</span></span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileUploader</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// Create a minioClient with the MinIO server playground, its access key and secret key.</span>
      <span class="token class-name">MinioClient</span> minioClient <span class="token operator">=</span>
          <span class="token class-name">MinioClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">endpoint</span><span class="token punctuation">(</span><span class="token string">&quot;https://play.min.io&quot;</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">credentials</span><span class="token punctuation">(</span><span class="token string">&quot;Q3AM3UQ867SPQQA43P2F&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;zuf+tfteSlswRu7BJ86wekitnifILbZam1KYY3TG&quot;</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Make &#39;asiatrip&#39; bucket if not exist.</span>
      <span class="token keyword">boolean</span> found <span class="token operator">=</span>
          minioClient<span class="token punctuation">.</span><span class="token function">bucketExists</span><span class="token punctuation">(</span><span class="token class-name">BucketExistsArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">&quot;asiatrip&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>found<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Make a new bucket called &#39;asiatrip&#39;.</span>
        minioClient<span class="token punctuation">.</span><span class="token function">makeBucket</span><span class="token punctuation">(</span><span class="token class-name">MakeBucketArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">&quot;asiatrip&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Bucket &#39;asiatrip&#39; already exists.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Upload &#39;/home/user/Photos/asiaphotos.zip&#39; as object name &#39;asiaphotos-2015.zip&#39; to bucket</span>
      <span class="token comment">// &#39;asiatrip&#39;.</span>
      minioClient<span class="token punctuation">.</span><span class="token function">uploadObject</span><span class="token punctuation">(</span>
          <span class="token class-name">UploadObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">&quot;asiatrip&quot;</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">&quot;asiaphotos-2015.zip&quot;</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">filename</span><span class="token punctuation">(</span><span class="token string">&quot;/home/user/Photos/asiaphotos.zip&quot;</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>
          <span class="token string">&quot;&#39;/home/user/Photos/asiaphotos.zip&#39; is successfully uploaded as &quot;</span>
              <span class="token operator">+</span> <span class="token string">&quot;object &#39;asiaphotos-2015.zip&#39; to bucket &#39;asiatrip&#39;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MinioException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Error occurred: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;HTTP trace: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">httpTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>参考示例在 media-service 工程中 测试上传文件功能，</p><p>首先创建一个用于测试的 bucket</p><p><img src="/MyBlog/assets/image-20230521174732420-4e9bfebd.png" alt="image-20230521174732420"></p><p>点击“Manage”修改 bucket 的访问权限</p><p><img src="/MyBlog/assets/image-20230521174737096-bf9a48fc.png" alt="image-20230521174737096"></p><p>选择 public 权限</p><p><img src="/MyBlog/assets/image-20230521174743840-00f5681a.png" alt="image-20230521174743840"></p><p>在 xuecheng-plus-media-service 工程 的 test 下编写测试代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span></span><span class="token class-name">BucketExistsArgs</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span></span><span class="token class-name">MakeBucketArgs</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span></span><span class="token class-name">MinioClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span></span><span class="token class-name">UploadObjectArgs</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span>errors<span class="token punctuation">.</span></span><span class="token class-name">MinioException</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">InvalidKeyException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">NoSuchAlgorithmException</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 测试MinIO
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/11 21:24
 * <span class="token keyword">@version</span> 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MinioTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token class-name">MinioClient</span> minioClient <span class="token operator">=</span>
            <span class="token class-name">MinioClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">endpoint</span><span class="token punctuation">(</span><span class="token string">&quot;http://192.168.101.65:9000&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">credentials</span><span class="token punctuation">(</span><span class="token string">&quot;minioadmin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;minioadmin&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//上传文件</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">UploadObjectArgs</span> testbucket <span class="token operator">=</span> <span class="token class-name">UploadObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">&quot;testbucket&quot;</span><span class="token punctuation">)</span>
<span class="token comment">//                    .object(&quot;test001.mp4&quot;)</span>
                    <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">&quot;001/test001.mp4&quot;</span><span class="token punctuation">)</span><span class="token comment">//添加子目录</span>
                    <span class="token punctuation">.</span><span class="token function">filename</span><span class="token punctuation">(</span><span class="token string">&quot;D:\\develop\\upload\\1mp4.temp&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span><span class="token string">&quot;video/mp4&quot;</span><span class="token punctuation">)</span><span class="token comment">//默认根据扩展名确定文件内容类型，也可以指定</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            minioClient<span class="token punctuation">.</span><span class="token function">uploadObject</span><span class="token punctuation">(</span>testbucket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;上传成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;上传失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行 upload 方法，分别测试向桶的根目录上传文件以及子目录上传文件。</p><p>上传成功，通过 web 控制台查看文件，并预览文件。</p><p>说明：</p><p>设置 contentType 可以通过 com.j256.simplemagic.ContentType 枚举类查看常用的 mimeType（媒体类型）</p><p>通过扩展名得到 mimeType，代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token comment">//根据扩展名取出mimeType</span>
    <span class="token class-name">ContentInfo</span> extensionMatch <span class="token operator">=</span> <span class="token class-name">ContentInfoUtil</span><span class="token punctuation">.</span><span class="token function">findExtensionMatch</span><span class="token punctuation">(</span><span class="token string">&quot;.mp4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> mimeType <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_OCTET_STREAM_VALUE</span><span class="token punctuation">;</span><span class="token comment">//通用mimeType，字节流</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>完善上边的代码 如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//根据扩展名取出mimeType (工具类 在base工程中 Pom simplemagic)</span>
        <span class="token class-name">ContentInfo</span> extensionMatch <span class="token operator">=</span> <span class="token class-name">ContentInfoUtil</span><span class="token punctuation">.</span><span class="token function">findExtensionMatch</span><span class="token punctuation">(</span><span class="token string">&quot;.mp4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> mimeType <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_OCTET_STREAM_VALUE</span><span class="token punctuation">;</span><span class="token comment">//通用mimeType，字节流</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>extensionMatch<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            mimeType <span class="token operator">=</span> extensionMatch<span class="token punctuation">.</span><span class="token function">getMimeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">UploadObjectArgs</span> testbucket <span class="token operator">=</span> <span class="token class-name">UploadObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">&quot;testbucket&quot;</span><span class="token punctuation">)</span>
<span class="token comment">//                    .object(&quot;test001.mp4&quot;)</span>
                    <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">&quot;001/test001.mp4&quot;</span><span class="token punctuation">)</span><span class="token comment">//添加子目录</span>
                    <span class="token punctuation">.</span><span class="token function">filename</span><span class="token punctuation">(</span><span class="token string">&quot;D:\\develop\\upload\\1mp4.temp&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span>mimeType<span class="token punctuation">)</span><span class="token comment">//默认根据扩展名确定文件内容类型，也可以指定</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            minioClient<span class="token punctuation">.</span><span class="token function">uploadObject</span><span class="token punctuation">(</span>testbucket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;上传成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;上传失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-2-4-2-删除文件" tabindex="-1"><a class="header-anchor" href="#_3-2-4-2-删除文件" aria-hidden="true">#</a> <strong>3.2.4.2 删除文件</strong></h5><p>下边测试删除文件</p><p>参考：https://docs.min.io/docs/java-client-api-reference#removeObject</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        minioClient<span class="token punctuation">.</span><span class="token function">removeObject</span><span class="token punctuation">(</span>
               <span class="token class-name">RemoveObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">&quot;testbucket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">&quot;001/test001.mp4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;删除成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;删除失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-2-4-3-查询文件" tabindex="-1"><a class="header-anchor" href="#_3-2-4-3-查询文件" aria-hidden="true">#</a> <strong>3.2.4.3 查询文件</strong></h5><p>通过查询文件查看文件是否存在 minio 中。</p><p>参考：https://docs.min.io/docs/java-client-api-reference#getObject</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//查询文件</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">GetObjectArgs</span> getObjectArgs <span class="token operator">=</span> <span class="token class-name">GetObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">&quot;testbucket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">&quot;test001.mp4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span><span class="token punctuation">(</span>
        <span class="token class-name">FilterInputStream</span> inputStream <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>getObjectArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FileOutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;D:\\develop\\upload\\1_2.mp4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span>outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>校验文件的完整性，对文件计算出 md5 值，比较原始文件的 md5 和目标文件的 md5，一致则说明完整</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//校验文件的完整性对文件的内容进行md5</span>
<span class="token class-name">FileInputStream</span> fileInputStream1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;D:\\develop\\upload\\1.mp4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> source_md5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>fileInputStream1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;D:\\develop\\upload\\1a.mp4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> local_md5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>source_md5<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>local_md5<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;下载成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 个人认为这种 做法有问题 没有实际意义</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-上传图片" tabindex="-1"><a class="header-anchor" href="#_4-上传图片" aria-hidden="true">#</a> <strong>4 上传图片</strong></h2><h3 id="_4-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_4-1-需求分析" aria-hidden="true">#</a> <strong>4.1 需求分析</strong></h3><h4 id="_4-1-1-业务流程" tabindex="-1"><a class="header-anchor" href="#_4-1-1-业务流程" aria-hidden="true">#</a> <strong>4.1.1 业务流程</strong></h4><p>课程图片是宣传课程非常重要的信息，在新增课程界面上传课程图片，也可以修改课程图片。</p><p>如下图：</p><p><img src="/MyBlog/assets/image-20230521174916606-55b71828.png" alt="image-20230521174916606"></p><p>上传课程图片总体上包括两部分：</p><p>1、上传课程图片前端请求媒资管理服务将文件上传至分布式文件系统，并且在媒资管理数据库保存文件信息。</p><p>2、上传图片成功保存图片地址到课程基本信息表中。</p><p>详细流程如下：</p><p><img src="/MyBlog/assets/image-20230521174923069-80a452d5.png" alt="image-20230521174923069"></p><p>1、前端进入上传图片界面</p><p>2、上传图片，请求媒资管理服务。</p><p>3、媒资管理服务将图片文件存储在 MinIO。</p><p>4、媒资管理记录文件信息到数据库。</p><p>5、前端请求内容管理服务保存课程信息，在内容管理数据库保存图片地址。</p><h4 id="_4-1-2-数据模型" tabindex="-1"><a class="header-anchor" href="#_4-1-2-数据模型" aria-hidden="true">#</a> <strong>4.1.2 数据模型</strong></h4><p>涉及到的数据表有：课程信息表中的图片字段、媒资数据库的文件表，下边主要看媒资数据库的文件表。</p><p><img src="/MyBlog/assets/image-20230521174930515-77797c2f.png" alt="image-20230521174930515"></p><p>各字段描述如下：</p><h3 id="_4-2-准备环境" tabindex="-1"><a class="header-anchor" href="#_4-2-准备环境" aria-hidden="true">#</a> <img src="/MyBlog/assets/image-20230521174935560-5bb4a506.png" alt="image-20230521174935560"><strong>4.2 准备环境</strong></h3><p>首先在 minio 配置 bucket，bucket 名称为：mediafiles，并设置 bucket 的权限为公开。</p><p><img src="/MyBlog/assets/image-20230521174942568-e44b793b.png" alt="image-20230521174942568"></p><p>在 nacos 配置中 minio 的相关信息，进入 media-service-dev.yaml:</p><p><img src="/MyBlog/assets/image-20230521174948380-8e67c1e0.png" alt="image-20230521174948380"></p><p>配置信息如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">minio</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.101.65<span class="token punctuation">:</span><span class="token number">9000</span>
  <span class="token key atrule">accessKey</span><span class="token punctuation">:</span> minioadmin
  <span class="token key atrule">secretKey</span><span class="token punctuation">:</span> minioadmin
  <span class="token key atrule">bucket</span><span class="token punctuation">:</span>
    <span class="token key atrule">files</span><span class="token punctuation">:</span> mediafiles
    <span class="token key atrule">videofiles</span><span class="token punctuation">:</span> video
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 media-service 工程编写 minio 的配置类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span></span><span class="token class-name">MinioClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> minio配置
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/12 19:32
 * <span class="token keyword">@version</span> 1.0
 */</span>
 <span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MinioConfig</span> <span class="token punctuation">{</span>


 <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${minio.endpoint}&quot;</span><span class="token punctuation">)</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> endpoint<span class="token punctuation">;</span>
 <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${minio.accessKey}&quot;</span><span class="token punctuation">)</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> accessKey<span class="token punctuation">;</span>
 <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${minio.secretKey}&quot;</span><span class="token punctuation">)</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> secretKey<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@Bean</span>
 <span class="token keyword">public</span> <span class="token class-name">MinioClient</span> <span class="token function">minioClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token class-name">MinioClient</span> minioClient <span class="token operator">=</span>
          <span class="token class-name">MinioClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">endpoint</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">credentials</span><span class="token punctuation">(</span>accessKey<span class="token punctuation">,</span> secretKey<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> minioClient<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-接口定义" tabindex="-1"><a class="header-anchor" href="#_4-3-接口定义" aria-hidden="true">#</a> <strong>4.3 接口定义</strong></h3><p>根据需求分析，下边进行接口定义，此接口定义为一个通用的上传文件接口，可以上传图片或其它文件。</p><p>首先分析接口：</p><p>请求地址：/media/upload/coursefile</p><p>请求内容：<strong>Content-Type:</strong> multipart/form-data;</p><p>form-data; name=&quot;filedata&quot;; filename=&quot;具体的文件名称&quot;</p><p>响应参数：文件信息，如下</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;a16da7a132559daf9e1193166b3e7f52&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;companyId&quot;</span><span class="token operator">:</span> <span class="token number">1232141425</span><span class="token punctuation">,</span>
  <span class="token property">&quot;companyName&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">&quot;filename&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.jpg&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;fileType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;001001&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;bucket&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/testbucket/2022/09/12/a16da7a132559daf9e1193166b3e7f52.jpg&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;fileId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;a16da7a132559daf9e1193166b3e7f52&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/testbucket/2022/09/12/a16da7a132559daf9e1193166b3e7f52.jpg&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;timelength&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">&quot;createDate&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2022-09-12T21:57:18&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;changeDate&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;remark&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;auditStatus&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">&quot;auditMind&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">&quot;fileSize&quot;</span><span class="token operator">:</span> <span class="token number">248329</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>定义上传响应模型类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MediaFiles</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">ToString</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 上传普通文件成功响应结果
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/12 18:49
 * <span class="token keyword">@version</span> 1.0
 */</span>
 <span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UploadFileResultDto</span> <span class="token keyword">extends</span> <span class="token class-name">MediaFiles</span> <span class="token punctuation">{</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>定义接口如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;上传文件&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/upload/coursefile&quot;</span><span class="token punctuation">,</span> consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">MULTIPART_FORM_DATA_VALUE</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">UploadFileResultDto</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">&quot;filedata&quot;</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> upload<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接口定义好后可以用 httpclient 工具测试一下</p><p>使用 httpclient 测试</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>#### 上传文件
POST <span class="token punctuation">{</span><span class="token punctuation">{</span>media_host<span class="token punctuation">}</span><span class="token punctuation">}</span>/media/upload/coursefile
Content-Type<span class="token operator">:</span> multipart/form-data; boundary=WebAppBoundary

--WebAppBoundary
Content-Disposition<span class="token operator">:</span> form-data; name=<span class="token string">&quot;filedata&quot;</span>; filename=<span class="token string">&quot;1.jpg&quot;</span>
Content-Type<span class="token operator">:</span> application/octet-stream

&lt; d<span class="token operator">:</span>/develop/upload/<span class="token number">1</span>.jpg

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-接口开发" tabindex="-1"><a class="header-anchor" href="#_4-4-接口开发" aria-hidden="true">#</a> <strong>4.4 接口开发</strong></h3><h4 id="_4-4-1-dao-开发" tabindex="-1"><a class="header-anchor" href="#_4-4-1-dao-开发" aria-hidden="true">#</a> <strong>4.4.1 DAO 开发</strong></h4><p>根据需求分析 DAO 层实现向 media_files 表插入一条记录，使用 media_files 表生成的 mapper 即可。</p><h4 id="_4-4-2-service-开发" tabindex="-1"><a class="header-anchor" href="#_4-4-2-service-开发" aria-hidden="true">#</a> <strong>4.4.2 Service 开发</strong></h4><p>Service 方法需要提供一个更加通用的保存文件的方法。</p><p>定义请求参数类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MediaFiles</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">ToString</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 上传普通文件请求参数
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/12 18:49
 * <span class="token keyword">@version</span> 1.0
 */</span>
 <span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UploadFileParamsDto</span> <span class="token punctuation">{</span>

 <span class="token doc-comment comment">/**
  * 文件名称
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> filename<span class="token punctuation">;</span>


 <span class="token doc-comment comment">/**
  * 文件类型（文档，音频，视频）
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> fileType<span class="token punctuation">;</span>
 <span class="token doc-comment comment">/**
  * 文件大小
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">Long</span> fileSize<span class="token punctuation">;</span>

 <span class="token doc-comment comment">/**
  * 标签
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> tags<span class="token punctuation">;</span>

 <span class="token doc-comment comment">/**
  * 上传人
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>

 <span class="token doc-comment comment">/**
  * 备注
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> remark<span class="token punctuation">;</span>



<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>定义 service 方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 上传文件
 * <span class="token keyword">@param</span> <span class="token parameter">companyId</span> 机构id
 * <span class="token keyword">@param</span> <span class="token parameter">uploadFileParamsDto</span> 上传文件信息
 * <span class="token keyword">@param</span> <span class="token parameter">localFilePath</span> 文件磁盘路径
 * <span class="token keyword">@return</span> 文件信息
 */</span>
<span class="token keyword">public</span> <span class="token class-name">UploadFileResultDto</span> <span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span> <span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">,</span> <span class="token class-name">String</span> localFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现方法如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">MinioClient</span> minioClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">MediaFilesMapper</span> mediaFilesMapper<span class="token punctuation">;</span>

<span class="token comment">//普通文件桶</span>
<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${minio.bucket.files}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> bucket_Files<span class="token punctuation">;</span>


<span class="token comment">//获取文件默认存储目录路径 年/月/日</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getDefaultFolderPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SimpleDateFormat</span> sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> folder <span class="token operator">=</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> folder<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//获取文件的md5</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getFileMd5</span><span class="token punctuation">(</span><span class="token class-name">File</span> file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> fileMd5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> fileMd5<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getMimeType</span><span class="token punctuation">(</span><span class="token class-name">String</span> extension<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>extension<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span>
        extension <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//根据扩展名取出mimeType</span>
    <span class="token class-name">ContentInfo</span> extensionMatch <span class="token operator">=</span> <span class="token class-name">ContentInfoUtil</span><span class="token punctuation">.</span><span class="token function">findExtensionMatch</span><span class="token punctuation">(</span>extension<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//通用mimeType，字节流</span>
    <span class="token class-name">String</span> mimeType <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_OCTET_STREAM_VALUE</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>extensionMatch<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        mimeType <span class="token operator">=</span> extensionMatch<span class="token punctuation">.</span><span class="token function">getMimeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> mimeType<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 将文件写入minIO
 * <span class="token keyword">@param</span> <span class="token parameter">localFilePath</span>  文件地址
 * <span class="token keyword">@param</span> <span class="token parameter">bucket</span>  桶
 * <span class="token keyword">@param</span> <span class="token parameter">objectName</span> 对象名称
 * <span class="token keyword">@return</span> void
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/10/12 21:22
 */</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">addMediaFilesToMinIO</span><span class="token punctuation">(</span><span class="token class-name">String</span> localFilePath<span class="token punctuation">,</span><span class="token class-name">String</span> mimeType<span class="token punctuation">,</span><span class="token class-name">String</span> bucket<span class="token punctuation">,</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">UploadObjectArgs</span> testbucket <span class="token operator">=</span> <span class="token class-name">UploadObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>objectName<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filename</span><span class="token punctuation">(</span>localFilePath<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span>mimeType<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        minioClient<span class="token punctuation">.</span><span class="token function">uploadObject</span><span class="token punctuation">(</span>testbucket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;上传文件到minio成功,bucket:{},objectName:{}&quot;</span><span class="token punctuation">,</span>bucket<span class="token punctuation">,</span>objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;上传成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;上传文件到minio出错,bucket:{},objectName:{},错误原因:{}&quot;</span><span class="token punctuation">,</span>bucket<span class="token punctuation">,</span>objectName<span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;上传文件到文件系统失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 将文件信息添加到文件表
 * <span class="token keyword">@param</span> <span class="token parameter">companyId</span>  机构id
 * <span class="token keyword">@param</span> <span class="token parameter">fileMd5</span>  文件md5值
 * <span class="token keyword">@param</span> <span class="token parameter">uploadFileParamsDto</span>  上传文件的信息
 * <span class="token keyword">@param</span> <span class="token parameter">bucket</span>  桶
 * <span class="token keyword">@param</span> <span class="token parameter">objectName</span> 对象名称
 * <span class="token keyword">@return</span> com.xuecheng.media.model.po.MediaFiles
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/10/12 21:22
 */</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token class-name">MediaFiles</span> <span class="token function">addMediaFilesToDb</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span><span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">,</span><span class="token class-name">String</span> bucket<span class="token punctuation">,</span><span class="token class-name">String</span> objectName<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//从数据库查询文件</span>
    <span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mediaFiles <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mediaFiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//拷贝基本信息</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>uploadFileParamsDto<span class="token punctuation">,</span> mediaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setFileId</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setCompanyId</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> bucket <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setBucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setFilePath</span><span class="token punctuation">(</span>objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setAuditStatus</span><span class="token punctuation">(</span><span class="token string">&quot;002003&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//保存文件信息到文件表</span>
        <span class="token keyword">int</span> insert <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>insert <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;保存文件信息到数据库失败,{}&quot;</span><span class="token punctuation">,</span>mediaFiles<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;保存文件信息失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;保存文件信息到数据库成功,{}&quot;</span><span class="token punctuation">,</span>mediaFiles<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> mediaFiles<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">UploadFileResultDto</span> <span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span> <span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">,</span> <span class="token class-name">String</span> localFilePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>localFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;文件不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//文件名称</span>
    <span class="token class-name">String</span> filename <span class="token operator">=</span> uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件扩展名</span>
    <span class="token class-name">String</span> extension <span class="token operator">=</span> filename<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>filename<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件mimeType</span>
    <span class="token class-name">String</span> mimeType <span class="token operator">=</span> <span class="token function">getMimeType</span><span class="token punctuation">(</span>extension<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件的md5值</span>
    <span class="token class-name">String</span> fileMd5 <span class="token operator">=</span> <span class="token function">getFileMd5</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件的默认目录</span>
    <span class="token class-name">String</span> defaultFolderPath <span class="token operator">=</span> <span class="token function">getDefaultFolderPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//存储到minio中的对象名(带目录)</span>
    <span class="token class-name">String</span>  objectName <span class="token operator">=</span> defaultFolderPath <span class="token operator">+</span> fileMd5 <span class="token operator">+</span> exension<span class="token punctuation">;</span>
    <span class="token comment">//将文件上传到minio</span>
    <span class="token keyword">boolean</span> b <span class="token operator">=</span> <span class="token function">addMediaFilesToMinIO</span><span class="token punctuation">(</span>localFilePath<span class="token punctuation">,</span> mimeType<span class="token punctuation">,</span> bucket_files<span class="token punctuation">,</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件大小</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFileSize</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将文件信息存储到数据库</span>
    <span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> <span class="token function">addMediaFilesToDb</span><span class="token punctuation">(</span>companyId<span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> uploadFileParamsDto<span class="token punctuation">,</span> bucket_files<span class="token punctuation">,</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//准备返回数据</span>
    <span class="token class-name">UploadFileResultDto</span> uploadFileResultDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UploadFileResultDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">,</span> uploadFileResultDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> uploadFileResultDto<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-3-完善接口层" tabindex="-1"><a class="header-anchor" href="#_4-4-3-完善接口层" aria-hidden="true">#</a> <strong>4.4.3 完善接口层</strong></h4><p>完善接口层代码 ：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;上传文件&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/upload/coursefile&quot;</span><span class="token punctuation">,</span>consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">MULTIPART_FORM_DATA_VALUE</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">UploadFileResultDto</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">&quot;filedata&quot;</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> upload<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;folder&quot;</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> folder<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;objectName&quot;</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

        <span class="token class-name">Long</span> companyId <span class="token operator">=</span> <span class="token number">1232141425L</span><span class="token punctuation">;</span>
    <span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UploadFileParamsDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件大小</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFileSize</span><span class="token punctuation">(</span>filedata<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//图片</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFileType</span><span class="token punctuation">(</span><span class="token string">&quot;001001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件名称</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFilename</span><span class="token punctuation">(</span>filedata<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//文件名称</span>
    <span class="token comment">//文件大小</span>
    <span class="token keyword">long</span> fileSize <span class="token operator">=</span> filedata<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFileSize</span><span class="token punctuation">(</span>fileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建临时文件</span>
    <span class="token class-name">File</span> tempFile <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">.</span><span class="token function">createTempFile</span><span class="token punctuation">(</span><span class="token string">&quot;minio&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;temp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//上传的文件拷贝到临时文件</span>
    filedata<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span>tempFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件路径</span>
    <span class="token class-name">String</span> absolutePath <span class="token operator">=</span> tempFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//上传文件</span>
    <span class="token class-name">UploadFileResultDto</span> uploadFileResultDto <span class="token operator">=</span> mediaFileService<span class="token punctuation">.</span><span class="token function">uploadFile</span><span class="token punctuation">(</span>companyId<span class="token punctuation">,</span> uploadFileParamsDto<span class="token punctuation">,</span> absolutePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> uploadFileResultDto<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-4-接口测试" tabindex="-1"><a class="header-anchor" href="#_4-4-4-接口测试" aria-hidden="true">#</a> <strong>4.4.4 接口测试</strong></h4><p>1、首先使用 httpclient 测试</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>#### 上传文件
POST <span class="token punctuation">{</span><span class="token punctuation">{</span>media_host<span class="token punctuation">}</span><span class="token punctuation">}</span>/media/upload/coursefile
Content-Type<span class="token operator">:</span> multipart/form-data; boundary=WebAppBoundary

--WebAppBoundary
Content-Disposition<span class="token operator">:</span> form-data; name=<span class="token string">&quot;filedata&quot;</span>; filename=<span class="token string">&quot;1.jpg&quot;</span>
Content-Type<span class="token operator">:</span> application/octet-stream

&lt; d<span class="token operator">:</span>/develop/upload/<span class="token number">1</span>.jpg

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、再进行前后端联调测试</p><p>在新增课程、编辑课程界面上传图，保存课程信息后再次进入编辑课程界面，查看是否可以正常保存课程图片信息。</p><p><img src="/MyBlog/assets/image-20230521172736026-dcdff67f.png" alt="image-20230521175306531"></p><p>上图图片完成后，进入媒资管理，查看文件列表中是否有刚刚上传的图片信息。</p><p><img src="/MyBlog/assets/image-20230521172746056-a676d7de.png" alt="image-20230521175312589"></p><h4 id="_4-4-5-service-事务优化" tabindex="-1"><a class="header-anchor" href="#_4-4-5-service-事务优化" aria-hidden="true">#</a> <strong>4.4.5 Service 事务优化</strong></h4><p>上边的 service 方法优化后并测试通过，现在思考关于 uploadFile 方法的是否应该开启事务。</p><p>目前是在 uploadFile 方法上添加@Transactional，当调用 uploadFile 方法前会开启数据库事务，如果上传文件过程时间较长那么数据库的事务持续时间就会变长，这样数据库链接释放就慢，最终导致数据库链接不够用。</p><p>我们只将 addMediaFilesToDb 方法添加事务控制即可,uploadFile 方法上的@Transactional 注解去掉。</p><p>优化后如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token class-name">MediaFiles</span> <span class="token function">addMediaFilesToDb</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span><span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">,</span><span class="token class-name">String</span> bucket<span class="token punctuation">,</span><span class="token class-name">String</span> objectName<span class="token punctuation">)</span><span class="token punctuation">{</span>

   <span class="token comment">//从数据库查询文件</span>
<span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>mediaFiles <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mediaFiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//拷贝基本信息</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>uploadFileParamsDto<span class="token punctuation">,</span> mediaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaFiles<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaFiles<span class="token punctuation">.</span><span class="token function">setFileId</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaFiles<span class="token punctuation">.</span><span class="token function">setCompanyId</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaFiles<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> bucket <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaFiles<span class="token punctuation">.</span><span class="token function">setBucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaFiles<span class="token punctuation">.</span><span class="token function">setFilePath</span><span class="token punctuation">(</span>objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaFiles<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaFiles<span class="token punctuation">.</span><span class="token function">setAuditStatus</span><span class="token punctuation">(</span><span class="token string">&quot;002003&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaFiles<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//保存文件信息到文件表</span>
    <span class="token keyword">int</span> insert <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>insert <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;保存文件信息到数据库失败,{}&quot;</span><span class="token punctuation">,</span>mediaFiles<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;保存文件信息失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;保存文件信息到数据库成功,{}&quot;</span><span class="token punctuation">,</span>mediaFiles<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
<span class="token keyword">return</span> mediaFiles<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们人为在 int insert = mediaFilesMapper.insert(mediaFiles);下边添加一个异常代码 int a=1/0;</p><p>测试是否事务控制。<code>很遗憾，事务控制失败</code>。</p><p>方法上已经添加了@Transactional 注解为什么该方法不能被事务控制呢？</p><p>如果是在 uploadFile 方法上添加@Transactional 注解就可以控制事务，去掉则不行。</p><blockquote><p>现在的问题其实是一个非事务方法调同类一个事务方法，事务无法控制，这是为什么？</p></blockquote><p>下边分析原因：</p><p>如果在 uploadFile 方法上添加@Transactional 注解，代理对象执行此方法前会开启事务，如下图：</p><p><img src="/MyBlog/assets/image-20230521175414648-70d575d5.png" alt="image-20230521175414648"></p><p>如果在 uploadFile 方法上没有@Transactional 注解，代理对象执行此方法前不进行事务控制，如下图：</p><p><img src="/MyBlog/assets/image-20230521175420395-2598ad20.png" alt="image-20230521175420395"></p><blockquote><p>所以判断该方法是否可以事务控制必须保证是通过代理对象调用此方法，且此方法上添加了@Transactional 注解。</p></blockquote><p>现在在 addMediaFilesToDb 方法上添加@Transactional 注解，也不会进行事务控制是因为并不是通过代理对象执行的 addMediaFilesToDb 方法。为了判断在 uploadFile 方法中去调用 addMediaFilesToDb 方法是否是通过代理对象去调用，我们可以打断点跟踪。</p><p><img src="/MyBlog/assets/image-20230521175426352-a8d24717.png" alt="image-20230521175426352"></p><p>我们发现在 uploadFile 方法中去调用 addMediaFilesToDb 方法不是通过代理对象去调用。</p><p>如何解决呢？通过代理对象去调用 addMediaFilesToDb 方法即可解决。</p><p>在 MediaFileService 的实现类中注入 MediaFileService 的代理对象，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">MediaFileService</span> currentProxy<span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将 addMediaFilesToDb 方法提成接口。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 将文件信息添加到文件表
 * <span class="token keyword">@param</span> <span class="token parameter">companyId</span>  机构id
 * <span class="token keyword">@param</span> <span class="token parameter">fileMd5</span>  文件md5值
 * <span class="token keyword">@param</span> <span class="token parameter">uploadFileParamsDto</span>  上传文件的信息
 * <span class="token keyword">@param</span> <span class="token parameter">bucket</span>  桶
 * <span class="token keyword">@param</span> <span class="token parameter">objectName</span> 对象名称
 * <span class="token keyword">@return</span> com.xuecheng.media.model.po.MediaFiles
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/10/12 21:22
 */</span>

<span class="token keyword">public</span> <span class="token class-name">MediaFiles</span> <span class="token function">addMediaFilesToDb</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span><span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">,</span><span class="token class-name">String</span> bucket<span class="token punctuation">,</span><span class="token class-name">String</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>调用 addMediaFilesToDb 方法的代码处改为如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">//写入文件表</span>
<span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> currentProxy<span class="token punctuation">.</span><span class="token function">addMediaFilesToDb</span><span class="token punctuation">(</span>companyId<span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> uploadFileParamsDto<span class="token punctuation">,</span> bucket_files<span class="token punctuation">,</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再次测试事务是否可以正常控制。</p><h2 id="_5-上传视频" tabindex="-1"><a class="header-anchor" href="#_5-上传视频" aria-hidden="true">#</a> <strong>5 上传视频</strong></h2><h3 id="_5-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_5-1-需求分析" aria-hidden="true">#</a> <strong>5.1 需求分析</strong></h3><p>1、教学机构人员进入媒资管理列表查询自己上传的媒资文件。</p><p>点击“媒资管理”</p><p><img src="/MyBlog/assets/image-20230521172741680-7b3acbdf.png" alt="image-20230521175523775"></p><p>进入媒资管理列表页面查询本机构上传的媒资文件。</p><p><img src="/MyBlog/assets/image-20230521172746056-a676d7de.png" alt="image-20230521175528444"></p><p>2、教育机构用户在&quot;媒资管理&quot;页面中点击 &quot;上传视频&quot; 按钮。</p><p><img src="/MyBlog/assets/image-20230521172754168-1b28ee58.png" alt="image-20230521175534003"></p><p>点击“上传视频”打开上传页面</p><p><img src="/MyBlog/assets/image-20230521172759310-c7af05fe.png" alt="image-20230521175539244"></p><p>3、选择要上传的文件，自动执行文件上传。</p><p><img src="/MyBlog/assets/image-20230521172807448-1b4d28cf.png" alt="image-20230521175544353"></p><p>4、视频上传成功会自动处理，处理完成可以预览视频。</p><p><img src="/MyBlog/assets/image-20230521175550024-a4fbd7fe.png" alt="image-20230521175550024"></p><h3 id="_5-2-断点续传技术" tabindex="-1"><a class="header-anchor" href="#_5-2-断点续传技术" aria-hidden="true">#</a> <strong>5.2 断点续传技术</strong></h3><h4 id="_5-2-1-什么是断点续传" tabindex="-1"><a class="header-anchor" href="#_5-2-1-什么是断点续传" aria-hidden="true">#</a> <strong>5.2.1 什么是断点续传</strong></h4><p>通常视频文件都比较大，所以对于媒资系统上传文件的需求要满足大文件的上传要求。http 协议本身对上传文件大小没有限制，但是客户的网络环境质量、电脑硬件环境等参差不齐，如果一个大文件快上传完了网断了没有上传完成，需要客户重新上传，用户体验非常差，所以对于大文件上传的要求最基本的是断点续传。</p><p>什么是断点续传：</p><p>引用百度百科：断点续传指的是在下载或上传时，将下载或上传任务（一个文件或一个压缩包）人为的划分为几个部分，每一个部分采用一个线程进行上传或下载，如果碰到网络故障，可以从已经上传或下载的部分开始继续上传下载未完成的部分，而没有必要从头开始上传下载，断点续传可以提高节省操作时间，提高用户体验性。</p><p>断点续传流程如下图：</p><p><img src="/MyBlog/assets/image-20230521175557288-d81e1e20.png" alt="image-20230521175557288"></p><p>流程如下：</p><p>1、前端上传前先把文件分成块</p><p>2、一块一块的上传，上传中断后重新上传，已上传的分块则不用再上传</p><p>3、各分块上传完成最后在服务端合并文件</p><h4 id="_5-2-2-分块与合并测试" tabindex="-1"><a class="header-anchor" href="#_5-2-2-分块与合并测试" aria-hidden="true">#</a> <strong>5.2.2 分块与合并测试</strong></h4><p>为了更好的理解文件分块上传的原理，下边用 java 代码测试文件的分块与合并。</p><p>文件分块的流程如下：</p><p>1、获取源文件长度</p><p>2、根据设定的分块文件的大小计算出块数</p><p>3、从源文件读数据依次向每一个块文件写数据。</p><p>测试代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>codec<span class="token punctuation">.</span>digest<span class="token punctuation">.</span></span><span class="token class-name">DigestUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">RandomAccessFile</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> 大文件处理测试
 * <span class="token keyword">@date</span> 2022/9/13 9:21
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BigFileTest</span> <span class="token punctuation">{</span>


    <span class="token comment">//测试文件分块方法</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testChunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">File</span> sourceFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;d:/develop/bigfile_test/nacos.mp4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> chunkPath <span class="token operator">=</span> <span class="token string">&quot;d:/develop/bigfile_test/chunk/&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">File</span> chunkFolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>chunkPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>chunkFolder<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            chunkFolder<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//分块大小</span>
        <span class="token keyword">long</span> chunkSize <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">//分块数量</span>
        <span class="token keyword">long</span> chunkNum <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>sourceFile<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;分块总数：&quot;</span><span class="token operator">+</span>chunkNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//缓冲区大小</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//使用RandomAccessFile访问文件</span>
        <span class="token class-name">RandomAccessFile</span> raf_read <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>sourceFile<span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//分块</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunkNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//创建分块文件</span>
            <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>chunkPath <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                file<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">boolean</span> newFile <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">createNewFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>newFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//向分块文件中写数据</span>
                <span class="token class-name">RandomAccessFile</span> raf_write <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token string">&quot;rw&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> raf_read<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    raf_write<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> chunkSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                raf_write<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;完成分块&quot;</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
        raf_read<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>文件合并流程：</p><p>1、找到要合并的文件并按文件合并的先后进行排序。</p><p>2、创建合并文件</p><p>3、依次从合并的文件中读取数据向合并文件写入数</p><p>文件合并的测试代码 ：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//测试文件合并方法</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMerge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//块文件目录</span>
        <span class="token class-name">File</span> chunkFolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;d:/develop/bigfile_test/chunk/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//原始文件</span>
        <span class="token class-name">File</span> originalFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;d:/develop/bigfile_test/nacos.mp4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//合并文件</span>
        <span class="token class-name">File</span> mergeFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;d:/develop/bigfile_test/nacos01.mp4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mergeFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mergeFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//创建新的合并文件</span>
        mergeFile<span class="token punctuation">.</span><span class="token function">createNewFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//用于写文件</span>
        <span class="token class-name">RandomAccessFile</span> raf_write <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>mergeFile<span class="token punctuation">,</span> <span class="token string">&quot;rw&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//指针指向文件顶端</span>
        raf_write<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//缓冲区</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//分块列表</span>
        <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fileArray <span class="token operator">=</span> chunkFolder<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 转成集合，便于排序</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> fileList <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>fileArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 从小到大排序</span>
        <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>fileList<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compare</span><span class="token punctuation">(</span><span class="token class-name">File</span> o1<span class="token punctuation">,</span> <span class="token class-name">File</span> o2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>o1<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>o2<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//合并文件</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">File</span> chunkFile <span class="token operator">:</span> fileList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">RandomAccessFile</span> raf_read <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>chunkFile<span class="token punctuation">,</span> <span class="token string">&quot;rw&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> raf_read<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                raf_write<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
            raf_read<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        raf_write<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//校验文件</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span>

                <span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>originalFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">FileInputStream</span> mergeFileStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>mergeFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//取出原始文件的md5</span>
            <span class="token class-name">String</span> originalMd5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//取出合并文件的md5进行比较</span>
            <span class="token class-name">String</span> mergeFileMd5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>mergeFileStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>originalMd5<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mergeFileMd5<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;合并文件成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;合并文件失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>


    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2-3-视频上传流程" tabindex="-1"><a class="header-anchor" href="#_5-2-3-视频上传流程" aria-hidden="true">#</a> <strong>5.2.3 视频上传流程</strong></h4><p>下图是上传视频的整体流程：</p><p><img src="/MyBlog/assets/image-20230521175658020-01a4dd98.png" alt="image-20230521175658020"></p><p>1、前端对文件进行分块。</p><p>2、前端上传分块文件前请求媒资服务检查文件是否存在，如果已经存在则不再上传。</p><p>3、如果分块文件不存在则前端开始上传</p><p>4、前端请求媒资服务上传分块。</p><p>5、媒资服务将分块上传至 MinIO。</p><p>6、前端将分块上传完毕请求媒资服务合并分块。</p><p>7、媒资服务判断分块上传完成则请求 MinIO 合并文件。</p><p>8、合并完成校验合并后的文件是否完整，如果不完整则删除文件。</p><h4 id="_5-2-4-minio-合并文件测试" tabindex="-1"><a class="header-anchor" href="#_5-2-4-minio-合并文件测试" aria-hidden="true">#</a> <strong>5.2.4 minio 合并文件测试</strong></h4><p>1、将分块文件上传至 minio</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//将分块文件上传至minio</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uploadChunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> chunkFolderPath <span class="token operator">=</span> <span class="token string">&quot;D:\\develop\\upload\\chunk\\&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">File</span> chunkFolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>chunkFolderPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//分块文件</span>
    <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> chunkFolder<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将分块文件上传至minio</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> files<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
           <span class="token class-name">UploadObjectArgs</span> uploadObjectArgs <span class="token operator">=</span> <span class="token class-name">UploadObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">&quot;testbucket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">&quot;chunk/&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filename</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            minioClient<span class="token punctuation">.</span><span class="token function">uploadObject</span><span class="token punctuation">(</span>uploadObjectArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;上传分块成功&quot;</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、通过 minio 的合并文件</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//合并文件，要求分块文件最小5M</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_merge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComposeSource</span><span class="token punctuation">&gt;</span></span> sources <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">iterate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">-&gt;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token class-name">ComposeSource</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">&quot;testbucket&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">&quot;chunk/&quot;</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ComposeObjectArgs</span> composeObjectArgs <span class="token operator">=</span> <span class="token class-name">ComposeObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">&quot;testbucket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">&quot;merge01.mp4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sources</span><span class="token punctuation">(</span>sources<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    minioClient<span class="token punctuation">.</span><span class="token function">composeObject</span><span class="token punctuation">(</span>composeObjectArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
<span class="token comment">//清除分块文件</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_removeObjects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//合并分块完成将分块文件清除</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DeleteObject</span><span class="token punctuation">&gt;</span></span> deleteObjects <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">iterate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">-&gt;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">DeleteObject</span><span class="token punctuation">(</span><span class="token string">&quot;chunk/&quot;</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">RemoveObjectsArgs</span> removeObjectsArgs <span class="token operator">=</span> <span class="token class-name">RemoveObjectsArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">&quot;testbucket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">objects</span><span class="token punctuation">(</span>deleteObjects<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Result</span><span class="token punctuation">&lt;</span><span class="token class-name">DeleteError</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">removeObjects</span><span class="token punctuation">(</span>removeObjectsArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    results<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>r<span class="token operator">-&gt;</span><span class="token punctuation">{</span>
        <span class="token class-name">DeleteError</span> deleteError <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            deleteError <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用 minio 合并文件报错：java.lang.IllegalArgumentException: source testbucket/chunk/0: size 1048576 must be greater than 5242880</p><p>minio 合并文件默认分块最小 5M，我们将分块改为 5M 再次测试。</p><h3 id="_5-3-接口定义" tabindex="-1"><a class="header-anchor" href="#_5-3-接口定义" aria-hidden="true">#</a> <strong>5.3 接口定义</strong></h3><p>根据上传视频流程，定义接口，与前端的约定是操作成功返回{code:0}否则返回{code:-1}</p><p>从课程资料中拷贝 RestResponse.java 类到 base 工程下的 model 包下。</p><p>定义接口如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>api</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>j256<span class="token punctuation">.</span>simplemagic<span class="token punctuation">.</span></span><span class="token class-name">ContentInfo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>j256<span class="token punctuation">.</span>simplemagic<span class="token punctuation">.</span></span><span class="token class-name">ContentInfoUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">RestResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">UploadFileParamsDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">MediaFileService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Api</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiOperation</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>multipart<span class="token punctuation">.</span></span><span class="token class-name">MultipartFile</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> 大文件上传接口
 * <span class="token keyword">@date</span> 2022/9/6 11:29
 */</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;大文件上传接口&quot;</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">&quot;大文件上传接口&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BigFilesController</span> <span class="token punctuation">{</span>



    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;文件上传前检查文件&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload/checkfile&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">checkfile</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileMd5&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5
    <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;分块文件上传前的检测&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload/checkchunk&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">checkchunk</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileMd5&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span>
                                            <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;chunk&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> chunk<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;上传分块文件&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload/uploadchunk&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">uploadchunk</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> file<span class="token punctuation">,</span>
                                    <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileMd5&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span>
                                    <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;chunk&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> chunk<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;合并文件&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload/mergechunks&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">mergechunks</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileMd5&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span>
                                    <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileName&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileName<span class="token punctuation">,</span>
                                    <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;chunkTotal&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> chunkTotal<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-上传分块开发" tabindex="-1"><a class="header-anchor" href="#_5-4-上传分块开发" aria-hidden="true">#</a> <strong>5.4 上传分块开发</strong></h3><h4 id="_5-4-1-dao-开发" tabindex="-1"><a class="header-anchor" href="#_5-4-1-dao-开发" aria-hidden="true">#</a> <strong>5.4.1 DAO 开发</strong></h4><p>向媒资数据库的文件表插入记录，使用自动生成的 Mapper 接口即可满足要求。</p><h4 id="_5-4-2-service-开发" tabindex="-1"><a class="header-anchor" href="#_5-4-2-service-开发" aria-hidden="true">#</a> <strong>5.4.2 Service 开发</strong></h4><h5 id="_5-4-2-1-检查文件和分块" tabindex="-1"><a class="header-anchor" href="#_5-4-2-1-检查文件和分块" aria-hidden="true">#</a> <strong>5.4.2.1 检查文件和分块</strong></h5><p>接口完成进行接口实现，首先实现检查文件方法和检查分块方法。</p><p>在 MediaFileService 中定义 service 接口如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 检查文件是否存在
 * <span class="token keyword">@param</span> <span class="token parameter">fileMd5</span> 文件的md5
 * <span class="token keyword">@return</span> com.xuecheng.base.model.RestResponse<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.lang.Boolean</span><span class="token punctuation">&gt;</span></span> false不存在，true存在
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/13 15:38
*/</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">checkFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 检查分块是否存在
 * <span class="token keyword">@param</span> <span class="token parameter">fileMd5</span>  文件的md5
 * <span class="token keyword">@param</span> <span class="token parameter">chunkIndex</span>  分块序号
 * <span class="token keyword">@return</span> com.xuecheng.base.model.RestResponse<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.lang.Boolean</span><span class="token punctuation">&gt;</span></span> false不存在，true存在
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/13 15:39
*/</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">checkChunk</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>service 接口实现方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">checkFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//查询文件信息</span>
    <span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mediaFiles <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//桶</span>
        <span class="token class-name">String</span> bucket <span class="token operator">=</span> mediaFiles<span class="token punctuation">.</span><span class="token function">getBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//存储目录</span>
        <span class="token class-name">String</span> filePath <span class="token operator">=</span> mediaFiles<span class="token punctuation">.</span><span class="token function">getFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//文件流</span>
        <span class="token class-name">InputStream</span> stream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            stream <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>
                    <span class="token class-name">GetObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>stream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//文件已存在</span>
                <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//文件不存在</span>
    <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">checkChunk</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//得到分块文件目录</span>
    <span class="token class-name">String</span> chunkFileFolderPath <span class="token operator">=</span> <span class="token function">getChunkFileFolderPath</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//得到分块文件的路径</span>
    <span class="token class-name">String</span> chunkFilePath <span class="token operator">=</span> chunkFileFolderPath <span class="token operator">+</span> chunkIndex<span class="token punctuation">;</span>

    <span class="token comment">//文件流</span>
    <span class="token class-name">InputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        fileInputStream <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>
                <span class="token class-name">GetObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>bucket_videoFiles<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>chunkFilePath<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>fileInputStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//分块已存在</span>
            <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
    <span class="token comment">//分块未存在</span>
    <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//得到分块文件的目录</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getChunkFileFolderPath</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fileMd5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> fileMd5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> fileMd5 <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;chunk&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>



</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-4-2-2-上传分块" tabindex="-1"><a class="header-anchor" href="#_5-4-2-2-上传分块" aria-hidden="true">#</a> <strong>5.4.2.2 上传分块</strong></h5><p>定义 service 接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 上传分块
 * <span class="token keyword">@param</span> <span class="token parameter">fileMd5</span>  文件md5
 * <span class="token keyword">@param</span> <span class="token parameter">chunk</span>  分块序号
 * <span class="token keyword">@param</span> <span class="token parameter">bytes</span>  文件字节
 * <span class="token keyword">@return</span> com.xuecheng.base.model.RestResponse
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/13 15:50
*/</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">uploadChunk</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span><span class="token keyword">int</span> chunk<span class="token punctuation">,</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接口实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">uploadChunk</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunk<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>


    <span class="token comment">//得到分块文件的目录路径</span>
    <span class="token class-name">String</span> chunkFileFolderPath <span class="token operator">=</span> <span class="token function">getChunkFileFolderPath</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//得到分块文件的路径</span>
    <span class="token class-name">String</span> chunkFilePath <span class="token operator">=</span> chunkFileFolderPath <span class="token operator">+</span> chunk<span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">//将文件存储至minIO</span>
    <span class="token function">addMediaFilesToMinIO</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> bucket_videoFiles<span class="token punctuation">,</span>chunkFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;上传分块文件:{},失败:{}&quot;</span><span class="token punctuation">,</span>chunkFilePath<span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">validfail</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token string">&quot;上传分块失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-4-2-3-上传分块测试" tabindex="-1"><a class="header-anchor" href="#_5-4-2-3-上传分块测试" aria-hidden="true">#</a> <strong>5.4.2.3 上传分块测试</strong></h5><p>完善接口层：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;文件上传前检查文件&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload/checkfile&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">checkfile</span><span class="token punctuation">(</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileMd5&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5
<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> mediaFileService<span class="token punctuation">.</span><span class="token function">checkFile</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;分块文件上传前的检测&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload/checkchunk&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">checkchunk</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileMd5&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span>
                                        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;chunk&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> chunk<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> mediaFileService<span class="token punctuation">.</span><span class="token function">checkChunk</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;上传分块文件&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload/uploadchunk&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">uploadchunk</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> file<span class="token punctuation">,</span>
                                <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileMd5&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span>
                                <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;chunk&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> chunk<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

    <span class="token comment">//创建临时文件</span>
    <span class="token class-name">File</span> tempFile <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">.</span><span class="token function">createTempFile</span><span class="token punctuation">(</span><span class="token string">&quot;minio&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;temp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//上传的文件拷贝到临时文件</span>
    file<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span>tempFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件路径</span>
    <span class="token class-name">String</span> absolutePath <span class="token operator">=</span> tempFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> mediaFileService<span class="token punctuation">.</span><span class="token function">uploadChunk</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span>chunk<span class="token punctuation">,</span>absolutePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动前端工程，进入上传视频界面进行前后端联调测试。</p><p>前端对文件分块的大小为 5MB，SpringBoot web 默认上传文件的大小限制为 1MB，这里需要在 media-api 工程修改配置如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>
    <span class="token key atrule">multipart</span><span class="token punctuation">:</span>
      <span class="token key atrule">max-file-size</span><span class="token punctuation">:</span> 50MB
      <span class="token key atrule">max-request-size</span><span class="token punctuation">:</span> 50MB
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>max-file-size：单个文件的大小限制</p><p>Max-request-size: 单次请求的大小限制</p><h3 id="_5-5-合并分块开发" tabindex="-1"><a class="header-anchor" href="#_5-5-合并分块开发" aria-hidden="true">#</a> <strong>5.5 合并分块开发</strong></h3><h4 id="_5-5-1-service-开发" tabindex="-1"><a class="header-anchor" href="#_5-5-1-service-开发" aria-hidden="true">#</a> <strong>5.5.1 service 开发</strong></h4><p>定义 service 接口：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 合并分块
 * <span class="token keyword">@param</span> <span class="token parameter">companyId</span>  机构id
 * <span class="token keyword">@param</span> <span class="token parameter">fileMd5</span>  文件md5
 * <span class="token keyword">@param</span> <span class="token parameter">chunkTotal</span> 分块总和
 * <span class="token keyword">@param</span> <span class="token parameter">uploadFileParamsDto</span> 文件信息
 * <span class="token keyword">@return</span> com.xuecheng.base.model.RestResponse
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/13 15:56
 */</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">mergechunks</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span><span class="token keyword">int</span> chunkTotal<span class="token punctuation">,</span><span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>service 实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">mergechunks</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkTotal<span class="token punctuation">,</span> <span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//=====获取分块文件路径=====</span>
    <span class="token class-name">String</span> chunkFileFolderPath <span class="token operator">=</span> <span class="token function">getChunkFileFolderPath</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//组成将分块文件路径组成 List&lt;ComposeSource&gt;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComposeSource</span><span class="token punctuation">&gt;</span></span> sourceObjectList <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">iterate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">-&gt;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>chunkTotal<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token class-name">ComposeSource</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>bucket_videoFiles<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>chunkFileFolderPath<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//=====合并=====</span>
    <span class="token comment">//文件名称</span>
    <span class="token class-name">String</span> fileName <span class="token operator">=</span> uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件扩展名</span>
    <span class="token class-name">String</span> extName <span class="token operator">=</span> fileName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>fileName<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//合并文件路径</span>
    <span class="token class-name">String</span> mergeFilePath <span class="token operator">=</span> <span class="token function">getFilePathByMd5</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> extName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//合并文件</span>
        <span class="token class-name">ObjectWriteResponse</span> response <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">composeObject</span><span class="token punctuation">(</span>
                <span class="token class-name">ComposeObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>bucket_videoFiles<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>mergeFilePath<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">sources</span><span class="token punctuation">(</span>sourceObjectList<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;合并文件成功:{}&quot;</span><span class="token punctuation">,</span>mergeFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;合并文件失败,fileMd5:{},异常:{}&quot;</span><span class="token punctuation">,</span>fileMd5<span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">validfail</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">&quot;合并文件失败。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ====验证md5====</span>
    <span class="token class-name">File</span> minioFile <span class="token operator">=</span> <span class="token function">downloadFileFromMinIO</span><span class="token punctuation">(</span>bucket_videoFiles<span class="token punctuation">,</span>mergeFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>minioFile <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;下载合并后文件失败,mergeFilePath:{}&quot;</span><span class="token punctuation">,</span>mergeFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">validfail</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">&quot;下载合并后文件失败。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> newFileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>minioFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//minio上文件的md5值</span>
        <span class="token class-name">String</span> md5Hex <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>newFileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//比较md5值，不一致则说明文件不完整</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>fileMd5<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>md5Hex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">validfail</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">&quot;文件合并校验失败，最终上传失败。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//文件大小</span>
        uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFileSize</span><span class="token punctuation">(</span>minioFile<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;校验文件失败,fileMd5:{},异常:{}&quot;</span><span class="token punctuation">,</span>fileMd5<span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">validfail</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">&quot;文件合并校验失败，最终上传失败。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>minioFile<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           minioFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//文件入库</span>
    currentProxy<span class="token punctuation">.</span><span class="token function">addMediaFilesToDb</span><span class="token punctuation">(</span>companyId<span class="token punctuation">,</span>fileMd5<span class="token punctuation">,</span>uploadFileParamsDto<span class="token punctuation">,</span>bucket_videoFiles<span class="token punctuation">,</span>mergeFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//=====清除分块文件=====</span>
    <span class="token function">clearChunkFiles</span><span class="token punctuation">(</span>chunkFileFolderPath<span class="token punctuation">,</span>chunkTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 从minio下载文件
 * <span class="token keyword">@param</span> <span class="token parameter">bucket</span> 桶
 * <span class="token keyword">@param</span> <span class="token parameter">objectName</span> 对象名称
 * <span class="token keyword">@return</span> 下载后的文件
 */</span>
<span class="token keyword">public</span> <span class="token class-name">File</span> <span class="token function">downloadFileFromMinIO</span><span class="token punctuation">(</span><span class="token class-name">String</span> bucket<span class="token punctuation">,</span><span class="token class-name">String</span> objectName<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//临时文件</span>
    <span class="token class-name">File</span> minioFile <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">FileOutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token class-name">InputStream</span> stream <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token class-name">GetObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>objectName<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建临时文件</span>
        minioFile<span class="token operator">=</span><span class="token class-name">File</span><span class="token punctuation">.</span><span class="token function">createTempFile</span><span class="token punctuation">(</span><span class="token string">&quot;minio&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.merge&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>minioFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span>outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> minioFile<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>outputStream<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                outputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * 得到合并后的文件的地址
 * <span class="token keyword">@param</span> <span class="token parameter">fileMd5</span> 文件id即md5值
 * <span class="token keyword">@param</span> <span class="token parameter">fileExt</span> 文件扩展名
 * <span class="token keyword">@return</span>
 */</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getFilePathByMd5</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span><span class="token class-name">String</span> fileExt<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span>   fileMd5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> fileMd5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> fileMd5 <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span>fileMd5 <span class="token operator">+</span>fileExt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 清除分块文件
 * <span class="token keyword">@param</span> <span class="token parameter">chunkFileFolderPath</span> 分块文件路径
 * <span class="token keyword">@param</span> <span class="token parameter">chunkTotal</span> 分块文件总数
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">clearChunkFiles</span><span class="token punctuation">(</span><span class="token class-name">String</span> chunkFileFolderPath<span class="token punctuation">,</span><span class="token keyword">int</span> chunkTotal<span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DeleteObject</span><span class="token punctuation">&gt;</span></span> deleteObjects <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">iterate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">-&gt;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>chunkTotal<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">DeleteObject</span><span class="token punctuation">(</span>chunkFileFolderPath<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">RemoveObjectsArgs</span> removeObjectsArgs <span class="token operator">=</span> <span class="token class-name">RemoveObjectsArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">&quot;video&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">objects</span><span class="token punctuation">(</span>deleteObjects<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Result</span><span class="token punctuation">&lt;</span><span class="token class-name">DeleteError</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">removeObjects</span><span class="token punctuation">(</span>removeObjectsArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        results<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>r<span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token class-name">DeleteError</span> deleteError <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                deleteError <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;清楚分块文件失败,objectname:{}&quot;</span><span class="token punctuation">,</span>deleteError<span class="token punctuation">.</span><span class="token function">objectName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;清楚分块文件失败,chunkFileFolderPath:{}&quot;</span><span class="token punctuation">,</span>chunkFileFolderPath<span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>5.4.3 接口层完善</p><p>下边完善接口层</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;文件上传前检查文件&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload/checkfile&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">checkfile</span><span class="token punctuation">(</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileMd5&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5
<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> mediaFileService<span class="token punctuation">.</span><span class="token function">checkFile</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;分块文件上传前的检测&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload/checkchunk&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">checkchunk</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileMd5&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span>
                                        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;chunk&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> chunk<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> mediaFileService<span class="token punctuation">.</span><span class="token function">checkChunk</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;上传分块文件&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload/uploadchunk&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">uploadchunk</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> file<span class="token punctuation">,</span>
                                <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileMd5&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span>
                                <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;chunk&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> chunk<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

    <span class="token keyword">return</span> mediaFileService<span class="token punctuation">.</span><span class="token function">uploadChunk</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span>chunk<span class="token punctuation">,</span>file<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;合并文件&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload/mergechunks&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">mergechunks</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileMd5&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span>
                                <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileName&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileName<span class="token punctuation">,</span>
                                <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;chunkTotal&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> chunkTotal<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Long</span> companyId <span class="token operator">=</span> <span class="token number">1232141425L</span><span class="token punctuation">;</span>

    <span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UploadFileParamsDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFileType</span><span class="token punctuation">(</span><span class="token string">&quot;001002&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setTags</span><span class="token punctuation">(</span><span class="token string">&quot;课程视频&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFilename</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> mediaFileService<span class="token punctuation">.</span><span class="token function">mergechunks</span><span class="token punctuation">(</span>companyId<span class="token punctuation">,</span>fileMd5<span class="token punctuation">,</span>chunkTotal<span class="token punctuation">,</span>uploadFileParamsDto<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-5-2-合并分块测试" tabindex="-1"><a class="header-anchor" href="#_5-5-2-合并分块测试" aria-hidden="true">#</a> <strong>5.5.2 合并分块测试</strong></h4><p>下边进行前后端联调：</p><p>1、上传一个视频测试合并分块的执行逻辑</p><p>进入 service 方法逐行跟踪。</p><p>2、断点续传测试</p><p>上传一部分后，停止刷新浏览器再重新上传，通过浏览器日志发现已经上传过的分块不再重新上传</p><p><img src="/MyBlog/assets/image-20230521180052105-4469312c.png" alt="image-20230521180052105"></p><h3 id="_5-6-其它问题" tabindex="-1"><a class="header-anchor" href="#_5-6-其它问题" aria-hidden="true">#</a> <strong>5.6 其它问题</strong></h3><h4 id="_5-6-1-分块文件清理问题" tabindex="-1"><a class="header-anchor" href="#_5-6-1-分块文件清理问题" aria-hidden="true">#</a> <strong>5.6.1 分块文件清理问题</strong></h4><p>上传一个文件进行分块上传，上传一半不传了，之前上传到 minio 的分块文件要清理吗？怎么做的？</p><p>1、在数据库中有一张文件表记录 minio 中存储的文件信息。</p><p>2、文件开始上传时会写入文件表，状态为上传中，上传完成会更新状态为上传完成。</p><p>3、当一个文件传了一半不再上传了说明该文件没有上传完成，会有定时任务去查询文件表中的记录，如果文件未上传完成则删除 minio 中没有上传成功的文件目录。</p><h2 id="_7-视频处理" tabindex="-1"><a class="header-anchor" href="#_7-视频处理" aria-hidden="true">#</a> <strong>7 视频处理</strong></h2><h3 id="_7-1-需求" tabindex="-1"><a class="header-anchor" href="#_7-1-需求" aria-hidden="true">#</a> <strong>7.1 需求</strong></h3><h4 id="_7-1-1-总体需求" tabindex="-1"><a class="header-anchor" href="#_7-1-1-总体需求" aria-hidden="true">#</a> <strong>7.1.1 总体需求</strong></h4><p>视频上传成功需要对视频的格式进行转码处理，比如：avi 转成 mp4。如何用 Java 程序对视频进行处理呢？当视频比较多的时候我们如何可以高效处理。</p><p>在一些云平台上对象存储产品就具有文件处理的功能，如下图：</p><p><img src="/MyBlog/assets/image-20230521180100640-0632437c.png" alt="image-20230521180100640"></p><p><img src="/MyBlog/assets/image-20230521180105909-e9016b77.png" alt="image-20230521180105909"></p><p>所以一般做文件存储的服务都需要对文件进行处理，例如对视频进行转码处理，可能由于文件量较大需要使用多线程等技术进行高效处理。</p><h4 id="_7-7-2-什么是视频编码" tabindex="-1"><a class="header-anchor" href="#_7-7-2-什么是视频编码" aria-hidden="true">#</a> <strong>7.7.2 什么是视频编码</strong></h4><p>视频上传成功后需要对视频进行转码处理。</p><p>什么是视频编码？查阅百度百科如下：</p><p><img src="/MyBlog/assets/image-20230521180115190-70c7ca06.png" alt="image-20230521180115190"></p><p>详情参考 ：<a href="https://baike.baidu.com/item/%E8%A7%86%E9%A2%91%E7%BC%96%E7%A0%81/839038" target="_blank" rel="noopener noreferrer">https://baike.baidu.com/item/视频编码/839038<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>首先我们要分清文件格式和编码格式：</p><p>文件格式：是指.mp4、.avi、.rmvb 等 这些不同扩展名的视频文件的文件格式 ，视频文件的内容主要包括视频和音频，其文件格式是按照一 定的编码格式去编码，并且按照该文件所规定的封装格式将视频、音频、字幕等信息封装在一起，播放器会根据它们的封装格式去提取出编码，然后由播放器解码，最终播放音视频。</p><p>音视频编码格式：通过音视频的压缩技术，将视频格式转换成另一种视频格式，通过视频编码实现流媒体的传输。比如：一个.avi 的视频文件原来的编码是 a，通过编码后编码格式变为 b，音频原来为 c，通过编码后变为 d。</p><p>音视频编码格式各类繁多，主要有几下几类：</p><p>MPEG 系列</p><p>（由 ISO[国际标准组织机构]下属的 MPEG[运动图象专家组]开发 ）视频编码方面主要是 Mpeg1（vcd 用的就是它）、Mpeg2（DVD 使用）、Mpeg4（的 DVDRIP 使用的都是它的变种，如：divx，xvid 等）、Mpeg4 AVC（正热门）；音频编码方面主要是 MPEG Audio Layer 1/2、MPEG Audio Layer 3（大名鼎鼎的 mp3）、MPEG-2 AAC 、MPEG-4 AAC 等等。注意：DVD 音频没有采用 Mpeg 的。</p><p>H.26X 系列</p><p>（由 ITU[国际电传视讯联盟]主导，侧重网络传输，注意：只是视频编码）</p><p>包括 H.261、H.262、H.263、H.263+、H.263++、H.264（就是 MPEG4 AVC-合作的结晶）</p><p>目前最常用的编码标准是视频 H.264，音频 AAC。</p><p>提问：</p><p>H.264 是编码格式还是文件格式？</p><p>mp4 是编码格式还是文件格式？</p><h4 id="_7-7-3-ffmpeg-的基本使用" tabindex="-1"><a class="header-anchor" href="#_7-7-3-ffmpeg-的基本使用" aria-hidden="true">#</a> <strong>7.7.3 FFmpeg 的基本使用</strong></h4><p><strong>流媒体程序员</strong></p><p>我们将视频录制完成后，使用视频编码软件对视频进行编码，本项目 使用 FFmpeg 对视频进行编码 。</p><p><img src="/MyBlog/assets/image-20230521180125862-2b50e3ec.png" alt="image-20230521180125862"></p><p>FFmpeg 被许多开源项目采用，QQ 影音、暴风影音、VLC 等。</p><p>下载：FFmpeg <a href="https://www.ffmpeg.org/download.html#build-windows" target="_blank" rel="noopener noreferrer">https://www.ffmpeg.org/download.html#build-windows<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>请从课程资料目录解压 ffmpeg.zip,并将解压得到的 exe 文件加入环境变量。</p><p>测试是否正常：cmd 运行 ffmpeg -v</p><p><img src="/MyBlog/assets/image-20230521180131520-020c8b94.png" alt="image-20230521180131520"></p><p>安装成功，作下简单测试</p><p>将一个.avi 文件转成 mp4、mp3、gif 等。</p><p>比如我们将 nacos.avi 文件转成 mp4，运行如下命令：</p><p>D:\soft\ffmpeg\ffmpeg.exe -i 1.avi 1.mp4</p><p>可以将 ffmpeg.exe 配置到环境变量 path 中，进入视频目录直接运行：ffmpeg.exe -i 1.avi 1.mp4</p><p>转成 mp3：ffmpeg -i nacos.avi nacos.mp3</p><p>转成 gif：ffmpeg -i nacos.avi nacos.gif</p><p>官方文档（英文）：<a href="http://ffmpeg.org/ffmpeg.html" target="_blank" rel="noopener noreferrer">http://ffmpeg.org/ffmpeg.html<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h4 id="_7-7-4-视频处理工具类" tabindex="-1"><a class="header-anchor" href="#_7-7-4-视频处理工具类" aria-hidden="true">#</a> <strong>7.7.4 视频处理工具类</strong></h4><p>将课程资料目录中的 util.zip 解压，将解压出的工具类拷贝至 base 工程。</p><p><img src="/MyBlog/assets/image-20230521180142400-4e12ad4c.png" alt="image-20230521180142400"></p><p>其中 Mp4VideoUtil 类是用于将视频转为 mp4 格式，是我们项目要使用的工具类。</p><p>下边看下这个类的代码，并进行测试。</p><p>我们要通过 ffmpeg 对视频转码，Java 程序调用 ffmpeg，使用 java.lang.ProcessBuilder 去完成，具体在 Mp4VideoUtil 类的 63 行，下边进行简单的测试，下边的代码运行本机安装的 QQ 软件。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ProcessBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProcessBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">&quot;C:\\Program Files (x86)\\Tencent\\QQ\\Bin\\QQScLauncher.exe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//将标准输入流和错误输入流合并，通过标准输入流程读取信息</span>
builder<span class="token punctuation">.</span><span class="token function">redirectErrorStream</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Process</span> p <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对 Mp4VideoUtil 类需要学习使用方法，下边代码将一个 avi 视频转为 mp4 视频，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//ffmpeg的路径</span>
    <span class="token class-name">String</span> ffmpeg_path <span class="token operator">=</span> <span class="token string">&quot;D:\\soft\\ffmpeg\\ffmpeg.exe&quot;</span><span class="token punctuation">;</span><span class="token comment">//ffmpeg的安装位置</span>
    <span class="token comment">//源avi视频的路径</span>
    <span class="token class-name">String</span> video_path <span class="token operator">=</span> <span class="token string">&quot;D:\\develop\\bigfile_test\\nacos01.avi&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//转换后mp4文件的名称</span>
    <span class="token class-name">String</span> mp4_name <span class="token operator">=</span> <span class="token string">&quot;nacos01.mp4&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//转换后mp4文件的路径</span>
    <span class="token class-name">String</span> mp4_path <span class="token operator">=</span> <span class="token string">&quot;D:\\develop\\bigfile_test\\nacos01.mp4&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//创建工具类对象</span>
    <span class="token class-name">Mp4VideoUtil</span> videoUtil <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mp4VideoUtil</span><span class="token punctuation">(</span>ffmpeg_path<span class="token punctuation">,</span>video_path<span class="token punctuation">,</span>mp4_name<span class="token punctuation">,</span>mp4_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//开始视频转换，成功将返回success</span>
    <span class="token class-name">String</span> s <span class="token operator">=</span> videoUtil<span class="token punctuation">.</span><span class="token function">generateMp4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行 main 方法，最终在控制台输出 success 表示执行成功。</p><h3 id="_7-2-分布式任务处理" tabindex="-1"><a class="header-anchor" href="#_7-2-分布式任务处理" aria-hidden="true">#</a> <strong>7.2 分布式任务处理</strong></h3><h4 id="_7-2-1-什么是分布式任务调度" tabindex="-1"><a class="header-anchor" href="#_7-2-1-什么是分布式任务调度" aria-hidden="true">#</a> <strong>7.2.1 什么是分布式任务调度</strong></h4><p>如何去高效处理一批任务呢？</p><p>1、多线程</p><p>多线程是充分利用单机的资源。</p><p>2、分布式加多线程</p><p>充分利用多台计算机，每台计算机使用多线程处理。</p><p>方案 2 可扩展性更强。</p><p>方案 2 是一种分布式任务调度的处理方案。</p><p>什么是分布式任务调度？</p><p>我们可以先思考一下下面业务场景的解决方案：</p><p>每隔 24 小时执行数据备份任务。</p><p>12306 网站会根据车次不同，设置几个时间点分批次放票。</p><p>某财务系统需要在每天上午 10 点前结算前一天的账单数据，统计汇总。</p><p>商品成功发货后，需要向客户发送短信提醒。</p><p>类似的场景还有很多，我们该如何实现？</p><p><strong>多线程方式实现：</strong></p><p>学过多线程的同学，可能会想到，我们可以开启一个线程，每 sleep 一段时间，就去检查是否已到预期执行时间。</p><p>以下代码简单实现了任务调度的功能：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//任务执行间隔时间</span>
    <span class="token keyword">final</span> <span class="token keyword">long</span> timeInterval <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token class-name">Runnable</span> runnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//TODO：something</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>timeInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>runnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的代码实现了按一定的间隔时间执行任务调度的功能。</p><p>Jdk 也为我们提供了相关支持，如 Timer、ScheduledExecutor，下边我们了解下。</p><p><strong>Timer 方式实现</strong>：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Timer</span> timer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    timer<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimerTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">//TODO：something</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//1秒后开始调度，每2秒执行一次</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Timer 的优点在于简单易用，每个 Timer 对应一个线程，因此可以同时启动多个 Timer 并行执行多个任务，同一个 Timer 中的任务是串行执行。</p><p><strong>ScheduledExecutor 方式实现</strong>：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> agrs<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">ScheduledExecutorService</span> service <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    service<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//TODO：something</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;todo something&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Java 5 推出了基于线程池设计的 ScheduledExecutor，其设计思想是，每一个被调度的任务都会由线程池中一个线程去执行，因此任务是并发执行的，相互之间不会受到干扰。</p><p>Timer 和 ScheduledExecutor 都仅能提供基于开始时间与重复间隔的任务调度，不能胜任更加复杂的调度需求。比如，设置每月第一天凌晨 1 点执行任务、复杂调度任务的管理、任务间传递数据等等。</p><p><strong>第三方 Quartz 方式实现，项目地址：https://github.com/quartz-scheduler/quartz</strong></p><p>Quartz 是一个功能强大的任务调度框架，它可以满足更多更复杂的调度需求，Quartz 设计的核心类包括 Scheduler, Job 以及 Trigger。其中，Job 负责定义需要执行的任务，Trigger 负责设置调度策略，Scheduler 将二者组装在一起，并触发任务开始执行。Quartz 支持简单的按时间间隔调度、还支持按日历调度方式，通过设置 CronTrigger 表达式（包括：秒、分、时、日、月、周、年）进行任务调度。</p><p>下边是一个例子代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> agrs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SchedulerException</span> <span class="token punctuation">{</span>
    <span class="token comment">//创建一个Scheduler</span>
    <span class="token class-name">SchedulerFactory</span> schedulerFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StdSchedulerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Scheduler</span> scheduler <span class="token operator">=</span> schedulerFactory<span class="token punctuation">.</span><span class="token function">getScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建JobDetail</span>
    <span class="token class-name">JobBuilder</span> jobDetailBuilder <span class="token operator">=</span> <span class="token class-name">JobBuilder</span><span class="token punctuation">.</span><span class="token function">newJob</span><span class="token punctuation">(</span><span class="token class-name">MyJob</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jobDetailBuilder<span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token string">&quot;jobName&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;jobGroupName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JobDetail</span> jobDetail <span class="token operator">=</span> jobDetailBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建触发的CronTrigger 支持按日历调度</span>
        <span class="token class-name">CronTrigger</span> trigger <span class="token operator">=</span> <span class="token class-name">TriggerBuilder</span><span class="token punctuation">.</span><span class="token function">newTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token string">&quot;triggerName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;triggerGroupName&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">startNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withSchedule</span><span class="token punctuation">(</span><span class="token class-name">CronScheduleBuilder</span><span class="token punctuation">.</span><span class="token function">cronSchedule</span><span class="token punctuation">(</span><span class="token string">&quot;0/2 * * * * ?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    scheduler<span class="token punctuation">.</span><span class="token function">scheduleJob</span><span class="token punctuation">(</span>jobDetail<span class="token punctuation">,</span>trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>
    scheduler<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyJob</span> <span class="token keyword">implements</span> <span class="token class-name">Job</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">JobExecutionContext</span> jobExecutionContext<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;todo something&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过以上内容我们学习了什么是任务调度，任务调度所解决的问题，以及任务调度的多种实现方式。</p><p><strong>任务调度顾名思义，就是对任务的调度，它是指系统为了完成特定业务，基于给定时间点，给定时间间隔或者给定执行次数自动执行任务。</strong></p><p><strong>什么是分布式任务调度？</strong></p><p>通常任务调度的程序是集成在应用中的，比如：优惠卷服务中包括了定时发放优惠卷的的调度程序，结算服务中包括了定期生成报表的任务调度程序，由于采用分布式架构，一个服务往往会部署多个冗余实例来运行我们的业务，在这种分布式系统环境下运行任务调度，我们称之为<strong>分布式任务调度</strong>，如下图：</p><p><img src="/MyBlog/assets/image-20230521180334738-fe4d68f3.png" alt="image-20230521180334738"></p><p><strong>分布式调度要实现的目标：</strong></p><p>不管是任务调度程序集成在应用程序中，还是单独构建的任务调度系统，如果采用分布式调度任务的方式就相当于将任务调度程序分布式构建，这样就可以具有分布式系统的特点，并且提高任务的调度处理能力：</p><p>1、并行任务调度</p><p>并行任务调度实现靠多线程，如果有大量任务需要调度，此时光靠多线程就会有瓶颈了，因为一台计算机 CPU 的处理能力是有限的。</p><p>如果将任务调度程序分布式部署，每个结点还可以部署为集群，这样就可以让多台计算机共同去完成任务调度，我们可以将任务分割为若干个分片，由不同的实例并行执行，来提高任务调度的处理效率。</p><p>2、高可用</p><p>若某一个实例宕机，不影响其他实例来执行任务。</p><p>3、弹性扩容</p><p>当集群中增加实例就可以提高并执行任务的处理效率。</p><p>4、任务管理与监测</p><p>对系统中存在的所有定时任务进行统一的管理及监测。让开发人员及运维人员能够时刻了解任务执行情况，从而做出快速的应急处理响应。</p><p>5、避免任务重复执行</p><p>当任务调度以集群方式部署，同一个任务调度可能会执行多次，比如在上面提到的电商系统中到点发优惠券的例子，就会发放多次优惠券，对公司造成很多损失，所以我们需要控制相同的任务在多个运行实例上只执行一次。</p><h4 id="_7-2-2-xxl-job-介绍" tabindex="-1"><a class="header-anchor" href="#_7-2-2-xxl-job-介绍" aria-hidden="true">#</a> <strong>7.2.2 XXL-JOB 介绍</strong></h4><p>XXL-JOB 是一个轻量级分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。</p><p>官网：https://www.xuxueli.com/xxl-job/</p><p>文档：https://www.xuxueli.com/xxl-job/#%E3%80%8A%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E5%B9%B3%E5%8F%B0XXL-JOB%E3%80%8B</p><p>XXL-JOB 主要有调度中心、执行器、任务：</p><p><img src="/MyBlog/assets/image-20230521180414046-6ef55d05.png" alt="image-20230521180414046"></p><p><strong>调度中心：</strong></p><p>负责管理调度信息，按照调度配置发出调度请求，自身不承担业务代码；</p><p>主要职责为执行器管理、任务管理、监控运维、日志管理等</p><p><strong>任务执行器：</strong></p><p>负责接收调度请求并执行任务逻辑；</p><p>只要职责是注册服务、任务执行服务（接收到任务后会放入线程池中的任务队列）、执行结果上报、日志服务等</p><p>**任务：**负责执行具体的业务处理。</p><p>调度中心与执行器之间的工作流程如下：</p><p><img src="/MyBlog/assets/image-20230521180423515-b74dc916.png" alt="image-20230521180423515"></p><p><strong>执行流程：</strong></p><p>1.任务执行器根据配置的调度中心的地址，自动注册到调度中心</p><p>2.达到任务触发条件，调度中心下发任务</p><p>3.执行器基于线程池执行任务，并把执行结果放入内存队列中、把执行日志写入日志文件中</p><p>4.执行器消费内存队列中的执行结果，主动上报给调度中心</p><p>5.当用户在调度中心查看任务日志，调度中心请求任务执行器，任务执行器读取任务日志文件并返回日志详情</p><h4 id="_7-2-3-搭建-xxl-job" tabindex="-1"><a class="header-anchor" href="#_7-2-3-搭建-xxl-job" aria-hidden="true">#</a> <strong>7.2.3 搭建 XXL-JOB</strong></h4><h5 id="_7-2-3-1-调度中心" tabindex="-1"><a class="header-anchor" href="#_7-2-3-1-调度中心" aria-hidden="true">#</a> <strong>7.2.3.1 调度中心</strong></h5><p>首先下载 XXL-JOB</p><p>GitHub：<a href="https://github.com/xuxueli/xxl-job" target="_blank" rel="noopener noreferrer">https://github.com/xuxueli/xxl-job<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>码云：<a href="https://gitee.com/xuxueli0323/xxl-job" target="_blank" rel="noopener noreferrer">https://gitee.com/xuxueli0323/xxl-job<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>项目使用 2.3.1 版本： https://github.com/xuxueli/xxl-job/releases/tag/2.3.1</p><p>也可从课程资料目录获取，解压 xxl-job-2.3.1.zip</p><p>使用 IDEA 打开解压后的目录</p><p><img src="/MyBlog/assets/image-20230521180432547-fb29d6e3.png" alt="image-20230521180432547"></p><p>xxl-job-admin：调度中心</p><p>xxl-job-core：公共依赖</p><p>xxl-job-executor-samples：执行器 Sample 示例（选择合适的版本执行器，可直接使用）</p><p>：xxl-job-executor-sample-springboot：Springboot 版本，通过 Springboot 管理执行器，推荐这种方式；</p><p>：xxl-job-executor-sample-frameless：无框架版本；</p><p>doc :文档资料，包含数据库脚本</p><p>在下发的虚拟机的 MySQL 中已经创建了 xxl_job_2.3.1 数据库</p><p><img src="/MyBlog/assets/image-20230521180442150-58eb8986.png" alt="image-20230521180442150"></p><p>如下图：</p><p><img src="/MyBlog/assets/image-20230521180447626-91858f05.png" alt="image-20230521180447626"></p><p>执行 sh /data/soft/restart.sh 自动启动 xxl-job 调度中心</p><p>访问：http://192.168.101.65:8088/xxl-job-admin/</p><p>账号和密码：admin/123456</p><p>如果无法使用虚拟机运行 xxl-job 可以在本机 idea 运行 xxl-job 调度中心。</p><h5 id="_7-2-3-2-执行器" tabindex="-1"><a class="header-anchor" href="#_7-2-3-2-执行器" aria-hidden="true">#</a> <strong>7.2.3.2 执行器</strong></h5><p>下边配置执行器，执行器负责与调度中心通信接收调度中心发起的任务调度请求。</p><p>1、下边进入调度中心添加执行器</p><p><img src="/MyBlog/assets/image-20230521180502712-fef8d0be.png" alt="image-20230521180502712"></p><p>点击新增，填写执行器信息，appname 是前边在 nacos 中配置 xxl 信息时指定的执行器的应用名。</p><p><img src="/MyBlog/assets/image-20230521180513326-0c3ad23c.png" alt="image-20230521180513326"></p><p>添加成功：</p><p><img src="/MyBlog/assets/image-20230521180518819-735c19a2.png" alt="image-20230521180518819"></p><p>2、首先在媒资管理模块的 service 工程添加依赖，在项目的父工程已约定了版本 2.3.1</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>com<span class="token punctuation">.</span>xuxueli<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>xxl<span class="token operator">-</span>job<span class="token operator">-</span>core<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3、在 nacos 下的 media-service-dev.yaml 下配置 xxl-job</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">xxl</span><span class="token punctuation">:</span>
  <span class="token key atrule">job</span><span class="token punctuation">:</span>
    <span class="token key atrule">admin</span><span class="token punctuation">:</span>
      <span class="token key atrule">addresses</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.101.65<span class="token punctuation">:</span>8088/xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin
    <span class="token key atrule">executor</span><span class="token punctuation">:</span>
      <span class="token key atrule">appname</span><span class="token punctuation">:</span> media<span class="token punctuation">-</span>process<span class="token punctuation">-</span>service
      <span class="token key atrule">address</span><span class="token punctuation">:</span>
      <span class="token key atrule">ip</span><span class="token punctuation">:</span>
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9999</span>
      <span class="token key atrule">logpath</span><span class="token punctuation">:</span> /data/applogs/xxl<span class="token punctuation">-</span>job/jobhandler
      <span class="token key atrule">logretentiondays</span><span class="token punctuation">:</span> <span class="token number">30</span>
    <span class="token key atrule">accessToken</span><span class="token punctuation">:</span> default_token
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意配置中的 appname 这是执行器的应用名，port 是执行器启动的端口，如果本地启动多个执行器注意端口不能重复。</p><p>4、配置 xxl-job 的执行器</p><p>将 xxl-job 示例工程下配置类拷贝到媒资管理的 service 工程下</p><p><img src="/MyBlog/assets/image-20230521180556533-55b8c901.png" alt="image-20230521180556533"></p><p>拷贝至：</p><p><img src="/MyBlog/assets/image-20230521180603161-804afa21.png" alt="image-20230521180603161"></p><p>到此完成媒资管理模块 service 工程配置 xxl-job 执行器，在 xxl-job 调度中心添加执行器，下边准备测试执行器与调度中心是否正常通信，因为接口工程依赖了 service 工程，所以启动媒资管理模块的接口工程。</p><p>启动后观察日志，出现下边的日志表示执行器在调度中心注册成功</p><p><img src="/MyBlog/assets/image-20230521180613249-0b480a2a.png" alt="image-20230521180613249"></p><p>同时观察调度中心中的执行器界面</p><p><img src="/MyBlog/assets/image-20230521180617606-6f9c1b6b.png" alt="image-20230521180617606"></p><p>在线机器地址处已显示 1 个执行器。</p><h5 id="_7-2-3-3-执行任务" tabindex="-1"><a class="header-anchor" href="#_7-2-3-3-执行任务" aria-hidden="true">#</a> <strong>7.2.3.3 执行任务</strong></h5><p>下边编写任务，参考示例工程中任务类的编写方法，如下图：</p><p><img src="/MyBlog/assets/image-20230521180640610-29370503.png" alt="image-20230521180640610"></p><p>在媒资服务 service 包下新建 jobhandler 存放任务类，下边参考示例工程编写一个任务类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>service<span class="token punctuation">.</span>jobhandler</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xxl<span class="token punctuation">.</span>job<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">XxlJobHelper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xxl<span class="token punctuation">.</span>job<span class="token punctuation">.</span>core<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">XxlJob</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 测试执行器
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/13 20:32
 * <span class="token keyword">@version</span> 1.0
 */</span>
 <span class="token annotation punctuation">@Component</span>
 <span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SampleJob</span> <span class="token punctuation">{</span>

 <span class="token doc-comment comment">/**
  * 1、简单任务示例（Bean模式）
  */</span>
 <span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">&quot;testJob&quot;</span><span class="token punctuation">)</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testJob</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;开始执行.....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下边在调度中心添加任务，进入任务管理</p><p><img src="/MyBlog/assets/image-20230521180658297-1cdfb7e1.png" alt="image-20230521180658297"></p><p>点击新增，填写任务信息</p><p><img src="/MyBlog/assets/image-20230521180703948-cbd4ee8a.png" alt="image-20230521180703948"></p><p>注意红色标记处：</p><p><strong>调度类型：</strong></p><p>固定速度指按固定的间隔定时调度。</p><p>Cron，通过 Cron 表达式实现更丰富的定时调度策略。</p><p>Cron 表达式是一个字符串，通过它可以定义调度策略，格式如下：</p><p>{秒数} {分钟} {小时} {日期} {月份} {星期} {年份(可为空)}</p><p>xxl-job 提供图形界面去配置：</p><p><img src="/MyBlog/assets/image-20230521180714771-c05bfa36.png" alt="image-20230521180714771"></p><p>一些例子如下：</p><p>30 10 1 * * ? 每天 1 点 10 分 30 秒触发</p><p>0/30 * * * * ? 每 30 秒触发一次</p><p>* 0/10 * * * ? 每 10 分钟触发一次</p><p><strong>运行模式</strong>有 BEAN 和 GLUE，bean 模式较常用就是在项目工程中编写执行器的任务代码，GLUE 是将任务代码编写在调度中心。</p><p><strong>JobHandler</strong>即任务方法名，填写任务方法上边@XxlJob 注解中的名称。</p><p>**路由策略：**当执行器集群部署时，调度中心向哪个执行器下发任务，这里选择第一个表示只向第一个执行器下发任务，路由策略的其它选项稍后在分片广播章节详细解释。</p><p>高级配置的其它配置项稍后在分片广播章节详细解释。</p><p>添加成功，启动任务</p><p><img src="/MyBlog/assets/image-20230521180724944-9c8aa830.png" alt="image-20230521180724944"></p><p>通过调度日志查看任务执行情况</p><p><img src="/MyBlog/assets/image-20230521180729915-cf953a62.png" alt="image-20230521180729915"></p><p>下边启动媒资管理的 service 工程，启动执行器。</p><p>观察执行器方法的执行。</p><p><img src="/MyBlog/assets/image-20230521180735194-5eed5427.png" alt="image-20230521180735194"></p><p>如果要停止任务需要在调度中心操作</p><p><img src="/MyBlog/assets/image-20230521180741294-fb016b36.png" alt="image-20230521180741294"></p><p>任务跑一段时间注意清理日志</p><p><img src="/MyBlog/assets/image-20230521180747339-525f2b58.png" alt="image-20230521180747339"></p><h4 id="_7-2-4-分片广播" tabindex="-1"><a class="header-anchor" href="#_7-2-4-分片广播" aria-hidden="true">#</a> <strong>7.2.4 分片广播</strong></h4><p>掌握了 xxl-job 的基本使用，下边思考如何进行分布式任务处理呢？如下图，我们会启动多个执行器组成一个集群，去执行任务。</p><p><img src="/MyBlog/assets/image-20230521180752964-b6e2dee0.png" alt="image-20230521180752964"></p><blockquote><p>执行器在集群部署下调度中心有哪些调度策略呢？</p></blockquote><p>查看 xxl-job 官方文档，阅读高级配置相关的内容：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>高级配置：
    <span class="token operator">-</span> 路由策略：当执行器集群部署时，提供丰富的路由策略，包括；
        <span class="token keyword">FIRST</span>（第一个）：固定选择第一个机器；
        <span class="token keyword">LAST</span>（最后一个）：固定选择最后一个机器；
        ROUND（轮询）：；
        RANDOM（随机）：随机选择在线的机器；
        CONSISTENT_HASH（一致性<span class="token keyword">HASH</span>）：每个任务按照<span class="token keyword">Hash</span>算法固定选择某一台机器，且所有任务均匀散列在不同机器上。
        LEAST_FREQUENTLY_USED（最不经常使用）：使用频率最低的机器优先被选举；
        LEAST_RECENTLY_USED（最近最久未使用）：最久未使用的机器优先被选举；
        FAILOVER（故障转移）：按照顺序依次进行心跳检测，第一个心跳检测成功的机器选定为目标执行器并发起调度；
        BUSYOVER（忙碌转移）：按照顺序依次进行空闲检测，第一个空闲检测成功的机器选定为目标执行器并发起调度；
        SHARDING_BROADCAST<span class="token punctuation">(</span>分片广播<span class="token punctuation">)</span>：广播触发对应集群中所有机器执行一次任务，同时系统自动传递分片参数；可根据分片参数开发分片任务；

    <span class="token operator">-</span> 子任务：每个任务都拥有一个唯一的任务ID<span class="token punctuation">(</span>任务ID可以从任务列表获取<span class="token punctuation">)</span>，当本任务执行结束并且执行成功时，将会触发子任务ID所对应的任务的一次主动调度，通过子任务可以实现一个任务执行完成去执行另一个任务。
    <span class="token operator">-</span> 调度过期策略：
        <span class="token operator">-</span> 忽略：调度过期后，忽略过期的任务，从当前时间开始重新计算下次触发时间；
        <span class="token operator">-</span> 立即执行一次：调度过期后，立即执行一次，并从当前时间开始重新计算下次触发时间；
    <span class="token operator">-</span> 阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；
        单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；
        丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；
        覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；
    <span class="token operator">-</span> 任务超时时间：支持自定义任务超时时间，任务运行超时将会主动中断任务；
    <span class="token operator">-</span> 失败重试次数；支持自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下边要重点说的是分片广播策略，分片是指是调度中心以执行器为维度进行分片，将集群中的执行器标上序号：0，1，2，3...，广播是指每次调度会向集群中的所有执行器发送任务调度，请求中携带分片参数。</p><p>如下图：</p><p><img src="/MyBlog/assets/image-20230521180836425-a5bf9698.png" alt="image-20230521180836425"></p><p>每个执行器收到调度请求同时接收分片参数。</p><p>xxl-job 支持动态扩容执行器集群从而动态增加分片数量，当有任务量增加可以部署更多的执行器到集群中，调度中心会动态修改分片的数量。</p><p><strong>作业分片适用哪些场景呢？</strong></p><p>分片任务场景：10 个执行器的集群来处理 10w 条数据，每台机器只需要处理 1w 条数据，耗时降低 10 倍；</p><p>广播任务场景：广播执行器同时运行 shell 脚本、广播集群节点进行缓存更新等。</p><p>所以，广播分片方式不仅可以充分发挥每个执行器的能力，并且根据分片参数可以控制任务是否执行，最终灵活控制了执行器集群分布式处理任务。</p><p><strong>使用说明：</strong></p><p>&quot;分片广播&quot; 和普通任务开发流程一致，不同之处在于可以获取分片参数进行分片业务处理。</p><p>Java 语言任务获取分片参数方式：</p><p>BEAN、GLUE 模式(Java)，可参考 Sample 示例执行器中的示例任务&quot;ShardingJobHandler&quot;：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 2、分片广播任务
 */</span>
<span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">&quot;shardingJobHandler&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shardingJobHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 分片序号，从0开始</span>
    <span class="token keyword">int</span> shardIndex <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 分片总数</span>
    <span class="token keyword">int</span> shardTotal <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下边测试作业分片：</p><p>1、定义作业分片的任务方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
  * 2、分片广播任务
  */</span>
 <span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">&quot;shardingJobHandler&quot;</span><span class="token punctuation">)</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shardingJobHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

  <span class="token comment">// 分片参数</span>
  <span class="token keyword">int</span> shardIndex <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> shardTotal <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;分片参数：当前分片序号 = {}, 总分片数 = {}&quot;</span><span class="token punctuation">,</span> shardIndex<span class="token punctuation">,</span> shardTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;开始执行第&quot;</span><span class="token operator">+</span>shardIndex<span class="token operator">+</span><span class="token string">&quot;批任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、在调度中心添加任务</p><p><img src="/MyBlog/assets/image-20230521180911147-fc0848c4.png" alt="image-20230521180911147"></p><p>添加成功：</p><p><img src="/MyBlog/assets/image-20230521180917665-d5c50d46.png" alt="image-20230521180917665"></p><p>启动任务，观察日志</p><p><img src="/MyBlog/assets/image-20230521180922827-14a20037.png" alt="image-20230521180922827"></p><p>下边启动两个执行器实例，观察每个实例的执行情况</p><p>首先在 nacos 中配置 media-service 的本地优先配置：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>##配置本地优先
spring<span class="token operator">:</span>
 cloud<span class="token operator">:</span>
  config<span class="token operator">:</span>
    override<span class="token operator">-</span>none<span class="token operator">:</span> <span class="token boolean">true</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将 media-service 启动两个实例</p><p>两个实例的在启动时注意端口不能冲突：</p><p>实例 1 在 VM options 处添加：-Dserver.port=63051 -Dxxl.job.executor.port=9998</p><p>实例 2 在 VM options 处添加：-Dserver.port=63050 -Dxxl.job.executor.port=9999</p><p>例如：</p><p><img src="/MyBlog/assets/image-20230521180941555-60c9539b.png" alt="image-20230521180941555"></p><p>启动两个实例</p><p>观察任务调度中心，稍等片刻执行器有两个</p><p><img src="/MyBlog/assets/image-20230521180947517-0d06d6b8.png" alt="image-20230521180947517"></p><p>观察两个执行实例的日志：</p><p><img src="/MyBlog/assets/image-20230521180953607-264038fe.png" alt="image-20230521180953607"></p><p>另一实例的日志如下：</p><p><img src="/MyBlog/assets/image-20230521180957825-5f900b41.png" alt="image-20230521180957825"></p><p>从日志可以看每个实例的分片序号不同。</p><p>如果其中一个执行器挂掉，只剩下一个执行器在工作，稍等片刻调用中心发现少了一个执行器将动态调整总分片数为 1。</p><p>到此作业分片任务调试完成，此时我们可以思考：</p><blockquote><p>当一次分片广播到来，各执行器如何根据分片参数去分布式执行任务，保证执行器之间执行的任务不重复呢？</p></blockquote><h3 id="_7-3-技术方案" tabindex="-1"><a class="header-anchor" href="#_7-3-技术方案" aria-hidden="true">#</a> <strong>7.3 技术方案</strong></h3><h4 id="_7-3-1-作业分片方案" tabindex="-1"><a class="header-anchor" href="#_7-3-1-作业分片方案" aria-hidden="true">#</a> <strong>7.3.1 作业分片方案</strong></h4><p>掌握了 xxl-job 的分片广播调度方式，下边思考如何分布式去执行学成在线平台中的视频处理任务。</p><p>任务添加成功后，对于要处理的任务会添加到待处理任务表中，现在启动多个执行器实例去查询这些待处理任务，<strong>此时如何保证多个执行器不会查询到重复的任务呢？</strong></p><p>XXL-JOB 并不直接提供数据处理的功能，它只会给执行器分配好分片序号，在向执行器任务调度的同时下发分片总数以及分片序号等参数，执行器收到这些参数根据自己的业务需求去利用这些参数。</p><p>下图表示了多个执行器获取视频处理任务的结构：</p><p><img src="/MyBlog/assets/image-20230521181030647-2759cf7e.png" alt="image-20230521181030647"></p><p>每个执行器收到广播任务有两个参数：分片总数、分片序号。每个执行从数据表取任务时可以让任务 id 模上 分片总数，如果等于分片序号则执行此任务。</p><p>上边两个执行器实例那么分片总数为 2，序号为 0、1，从任务 1 开始，如下：</p><p>1 % 2 = 1 执行器 2 执行</p><p>2 % 2 = 0 执行器 1 执行</p><p>3 % 2 = 1 执行器 2 执行</p><p>以此类推.</p><h4 id="_7-3-2-保证任务不重复执行" tabindex="-1"><a class="header-anchor" href="#_7-3-2-保证任务不重复执行" aria-hidden="true">#</a> <strong>7.3.2 保证任务不重复执行</strong></h4><blockquote><p>通过作业分片方案保证了执行器之间查询到不重复的任务，如果一个执行器在处理一个视频还没有完成，此时调度中心又一次请求调度，为了不重复处理同一个视频该怎么办？</p></blockquote><p>首先配置调度过期策略：</p><p>查看文档如下：</p><p>- 调度过期策略：调度中心错过调度时间的补偿处理策略，包括：忽略、立即补偿触发一次等；</p><ul><li>忽略：调度过期后，忽略过期的任务，从当前时间开始重新计算下次触发时间；</li><li>立即执行一次：调度过期后，立即执行一次，并从当前时间开始重新计算下次触发时间；</li><li>阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；</li></ul><p>这里我们选择忽略，如果立即执行一次就可能重复执行相同的任务。</p><p><img src="/MyBlog/assets/image-20230521181043641-46b1afcf.png" alt="image-20230521181043641"></p><p>其次，再看阻塞处理策略，阻塞处理策略就是当前执行器正在执行任务还没有结束时调度中心进行任务调度，此时该如何处理。</p><p>查看文档如下： 单机串行（默认）：调度请求进入单机执行器后，调度请求进入 FIFO 队列并以串行方式运行； 丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败； 覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；</p><p>这里如果选择覆盖之前调度则可能重复执行任务，这里选择 丢弃后续调度或单机串行方式来避免任务重复执行。</p><p>只做这些配置可以保证任务不会重复执行吗？</p><p>做不到，还需要保证任务处理的幂等性，**什么是任务的幂等性？**任务的幂等性是指：对于数据的操作不论多少次，操作的结果始终是一致的。在本项目中要实现的是不论多少次任务调度同一个视频只执行一次成功的转码。</p><p><strong>什么是幂等性？</strong></p><p>它描述了一次和多次请求某一个资源对于资源本身应该具有同样的结果。</p><p>幂等性是为了解决重复提交问题，比如：恶意刷单，重复支付等。</p><p>解决幂等性常用的方案：</p><p>1）数据库约束，比如：唯一索引，主键。</p><p>2）乐观锁，常用于数据库，更新数据时根据乐观锁状态去更新。</p><p>3）唯一序列号，操作传递一个唯一序列号，操作时判断与该序列号相等则执行。</p><p>基于以上分析，在执行器接收调度请求去执行视频处理任务时要实现视频处理的幂等性，要有办法去判断该视频是否处理完成，如果正在处理中或处理完则不再处理。这里我们在数据库视频处理表中添加处理状态字段，视频处理完成更新状态为完成，执行视频处理前判断状态是否完成，如果完成则不再处理。</p><h4 id="_7-3-3-视频处理方案" tabindex="-1"><a class="header-anchor" href="#_7-3-3-视频处理方案" aria-hidden="true">#</a> <strong>7.3.3 视频处理方案</strong></h4><p>确定了分片方案，下边梳理整个视频上传及处理的业务流程。</p><p><img src="/MyBlog/assets/image-20230521181122420-af5ad695.png" alt="image-20230521181122420"></p><p>上传视频成功向视频处理待处理表添加记录。</p><p>视频处理的详细流程如下：</p><p><img src="/MyBlog/assets/image-20230521181128453-03bf1276.png" alt="image-20230521181128453"></p><p>1、任务调度中心广播作业分片。</p><p>2、执行器收到广播作业分片，从数据库读取待处理任务，读取未处理及处理失败的任务。</p><p>3、执行器更新任务为处理中，根据任务内容从 MinIO 下载要处理的文件。</p><p>4、执行器启动多线程去处理任务。</p><p>5、任务处理完成，上传处理后的视频到 MinIO。</p><p>6、将更新任务处理结果，如果视频处理完成除了更新任务处理结果以外还要将文件的访问地址更新至任务处理表及文件表中，最后将任务完成记录写入历史表。</p><h3 id="_7-4-查询待处理任务" tabindex="-1"><a class="header-anchor" href="#_7-4-查询待处理任务" aria-hidden="true">#</a> <strong>7.4 查询待处理任务</strong></h3><h4 id="_7-4-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_7-4-1-需求分析" aria-hidden="true">#</a> <strong>7.4.1 需求分析</strong></h4><p>查询待处理任务只处理未提交及处理失败的任务，任务处理失败后进行重试，最多重试 3 次。</p><p>任务处理成功将待处理记录移动到历史任务表。</p><p>下图是待处理任务表：</p><p><img src="/MyBlog/assets/image-20230521181136042-a8c5c24c.png" alt="image-20230521181136042"></p><p>历史任务表与待处理任务表的结构相同。</p><h4 id="_7-4-2-添加待处理任务" tabindex="-1"><a class="header-anchor" href="#_7-4-2-添加待处理任务" aria-hidden="true">#</a> <strong>7.4.2 添加待处理任务</strong></h4><p>上传视频成功向视频处理待处理表添加记录，暂时只添加对 avi 视频的处理记录。</p><p>根据 MIME Type 去判断是否是 avi 视频，下边列出部分 MIME Type</p><p><img src="/MyBlog/assets/image-20230521181143845-c0c5766f.png" alt="image-20230521181143845"></p><p>avi 视频的 MIME Type 是 video/x-msvideo</p><p>修改文件信息入库方法，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token class-name">MediaFiles</span> <span class="token function">addMediaFilesToDb</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">,</span> <span class="token class-name">String</span> bucket<span class="token punctuation">,</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//从数据库查询文件</span>
    <span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mediaFiles <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mediaFiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//拷贝基本信息</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>uploadFileParamsDto<span class="token punctuation">,</span> mediaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setFileId</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setCompanyId</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//媒体类型</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> bucket <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setBucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setFilePath</span><span class="token punctuation">(</span>objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setAuditStatus</span><span class="token punctuation">(</span><span class="token string">&quot;002003&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//保存文件信息到文件表</span>
        <span class="token keyword">int</span> insert <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>insert <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;保存文件信息到数据库失败,{}&quot;</span><span class="token punctuation">,</span> mediaFiles<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;保存文件信息失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//添加到待处理任务表</span>
        <span class="token function">addWaitingTask</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;保存文件信息到数据库成功,{}&quot;</span><span class="token punctuation">,</span> mediaFiles<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> mediaFiles<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 添加待处理任务
 * <span class="token keyword">@param</span> <span class="token parameter">mediaFiles</span> 媒资文件信息
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addWaitingTask</span><span class="token punctuation">(</span><span class="token class-name">MediaFiles</span> mediaFiles<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//文件名称</span>
    <span class="token class-name">String</span> filename <span class="token operator">=</span> mediaFiles<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件扩展名</span>
    <span class="token class-name">String</span> exension <span class="token operator">=</span> filename<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>filename<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件mimeType</span>
    <span class="token class-name">String</span> mimeType <span class="token operator">=</span> <span class="token function">getMimeType</span><span class="token punctuation">(</span>exension<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果是avi视频添加到视频待处理表</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>mimeType<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;video/x-msvideo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">MediaProcess</span> mediaProcess <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">,</span>mediaProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaProcess<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//未处理</span>
        mediaProcess<span class="token punctuation">.</span><span class="token function">setFailCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//失败次数默认为0</span>
        mediaProcessMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>进行前后端测试，上传 4 个 avi 视频，观察待处理任务表是否存在记录，记录是否完成</p><h4 id="_7-4-3-查询待处理任务" tabindex="-1"><a class="header-anchor" href="#_7-4-3-查询待处理任务" aria-hidden="true">#</a> <strong>7.4.3 查询待处理任务</strong></h4><p><strong>如何保证查询到的待处理视频记录不重复？</strong></p><p>编写根据分片参数获取待处理任务的 DAO 方法，定义 DAO 接口如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MediaProcessMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * <span class="token keyword">@description</span> 根据分片参数获取待处理任务
     * <span class="token keyword">@param</span> <span class="token parameter">shardTotal</span>  分片总数
     * <span class="token keyword">@param</span> <span class="token parameter">shardindex</span>  分片序号
     * <span class="token keyword">@param</span> <span class="token parameter">count</span> 任务数
     * <span class="token keyword">@return</span> java.util.List<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>com.xuecheng.media.model.po.MediaProcess</span><span class="token punctuation">&gt;</span></span>
     * <span class="token keyword">@author</span> Mr.M
     * <span class="token keyword">@date</span> 2022/9/14 8:54
    */</span>
    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;select * from media_process t where t.id % #{shardTotal} = #{shardIndex} and (t.status = &#39;1&#39; or t.status = &#39;3&#39;) and t.fail_count &lt; 3 limit #{count}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectListByShardIndex</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;shardTotal&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> shardTotal<span class="token punctuation">,</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;shardIndex&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> shardIndex<span class="token punctuation">,</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>定义 Service 接口，查询待处理</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">PageParams</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">PageResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">RestResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">QueryMediaParamsDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">UploadFileParamsDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">UploadFileResultDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MediaFiles</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MediaProcess</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Transactional</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> 媒资文件处理业务方法
 * <span class="token keyword">@date</span> 2022/9/10 8:55
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MediaFileProcessService</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * <span class="token keyword">@description</span> 获取待处理任务
     * <span class="token keyword">@param</span> <span class="token parameter">shardIndex</span> 分片序号
     * <span class="token keyword">@param</span> <span class="token parameter">shardTotal</span> 分片总数
     * <span class="token keyword">@param</span> <span class="token parameter">count</span> 获取记录数
     * <span class="token keyword">@return</span> java.util.List<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>com.xuecheng.media.model.po.MediaProcess</span><span class="token punctuation">&gt;</span></span>
     * <span class="token keyword">@author</span> Mr.M
     * <span class="token keyword">@date</span> 2022/9/14 14:49
    */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">&gt;</span></span> <span class="token function">getMediaProcessList</span><span class="token punctuation">(</span><span class="token keyword">int</span> shardTotal<span class="token punctuation">,</span><span class="token keyword">int</span> shardIndex<span class="token punctuation">,</span><span class="token keyword">int</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">}</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>service 接口实现</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">LambdaQueryWrapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">MediaFilesMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">MediaProcessHistoryMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">MediaProcessMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MediaFiles</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MediaProcess</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MediaProcessHistory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">MediaFileProcessService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">BeanUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">AutoConfigureOrder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Transactional</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> TODO
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/14 14:41
 * <span class="token keyword">@version</span> 1.0
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MediaFileProcessServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">MediaFileProcessService</span> <span class="token punctuation">{</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">MediaFilesMapper</span> mediaFilesMapper<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">MediaProcessMapper</span> mediaProcessMapper<span class="token punctuation">;</span>


 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">&gt;</span></span> <span class="token function">getMediaProcessList</span><span class="token punctuation">(</span><span class="token keyword">int</span> shardIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> shardTotal<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">&gt;</span></span> mediaProcesses <span class="token operator">=</span> mediaProcessMapper<span class="token punctuation">.</span><span class="token function">selectListByShardIndex</span><span class="token punctuation">(</span>shardTotal<span class="token punctuation">,</span> shardIndex<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> mediaProcesses<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-5-开始执行任务" tabindex="-1"><a class="header-anchor" href="#_7-5-开始执行任务" aria-hidden="true">#</a> <strong>7.5 开始执行任务</strong></h3><h4 id="_7-5-1-分布式锁" tabindex="-1"><a class="header-anchor" href="#_7-5-1-分布式锁" aria-hidden="true">#</a> <strong>7.5.1 分布式锁</strong></h4><p>为了避免多线程去争抢同一个任务可以使用 synchronized 同步锁去解决，如下代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">synchronized</span><span class="token punctuation">(</span>锁对象<span class="token punctuation">)</span><span class="token punctuation">{</span>
   执行任务<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>synchronized 只能保证同一个虚拟机中多个线程去争抢锁。</p><p><img src="/MyBlog/assets/image-20230521181420329-40a32fea.png" alt="image-20230521181420329"></p><p>如果是多个执行器分布式部署，并不能保证同一个视频只有一个执行器去处理。</p><p>现在要实现分布式环境下所有虚拟机中的线程去同步执行就需要让多个虚拟机去共用一个锁，虚拟机可以分布式部署，锁也可以分布式部署，如下图：</p><p><img src="/MyBlog/assets/image-20230521181425785-ee889a1c.png" alt="image-20230521181425785"></p><p>虚拟机都去抢占同一个锁，锁是一个单独的程序提供加锁、解锁服务。</p><p>该锁已不属于某个虚拟机，而是分布式部署，由多个虚拟机所共享，这种锁叫<strong>分布式锁</strong>。</p><p>实现分布式锁的方案有很多，常用的如下：</p><p>1、基于数据库实现分布锁</p><p>利用数据库主键唯一性的特点，或利用数据库唯一索引、行级锁的特点，多个线程同时去更新相同的记录，谁更新成功谁就抢到锁。</p><p>2、基于 redis 实现锁</p><p>redis 提供了分布式锁的实现方案，比如：SETNX、set nx、redisson 等。</p><p>拿 SETNX 举例说明，SETNX 命令的工作过程是去 set 一个不存在的 key，多个线程去设置同一个 key 只会有一个线程设置成功，设置成功的的线程拿到锁。</p><p>3、使用 zookeeper 实现</p><p>zookeeper 是一个分布式协调服务，主要解决分布式程序之间的同步的问题。zookeeper 的结构类似的文件目录，多线程向 zookeeper 创建一个子目录(节点)只会有一个创建成功，利用此特点可以实现分布式锁，谁创建该结点成功谁就获得锁。</p><h4 id="_7-5-2-开启任务" tabindex="-1"><a class="header-anchor" href="#_7-5-2-开启任务" aria-hidden="true">#</a> <strong>7.5.2 开启任务</strong></h4><p>下边基于数据库方式实现分布锁，开始执行任务将任务执行状态更新为 4 表示任务执行中。</p><p>下边的 sql 语句可以实现更新操作：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">update</span> media_process m <span class="token keyword">set</span> m<span class="token punctuation">.</span><span class="token keyword">status</span><span class="token operator">=</span><span class="token string">&#39;4&#39;</span> <span class="token keyword">where</span>  m<span class="token punctuation">.</span>id<span class="token operator">=</span>?

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>如果是多个线程去执行该 sql 都将会执行成功，但需求是只能有一个线程抢到锁，所以此 sql 无法满足需求。</p><p>下边使用乐观锁的方式实现更新操作：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">update</span> media_process m <span class="token keyword">set</span> m<span class="token punctuation">.</span><span class="token keyword">status</span><span class="token operator">=</span><span class="token string">&#39;4&#39;</span> <span class="token keyword">where</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token keyword">status</span><span class="token operator">=</span><span class="token string">&#39;1&#39;</span> <span class="token operator">or</span> m<span class="token punctuation">.</span><span class="token keyword">status</span><span class="token operator">=</span><span class="token string">&#39;3&#39;</span><span class="token punctuation">)</span> <span class="token operator">and</span> m<span class="token punctuation">.</span>fail_count <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token operator">and</span> m<span class="token punctuation">.</span>id<span class="token operator">=</span>?

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>多个线程同时执行上边的 sql 只会有一个线程执行成功。</p><p><strong>什么是乐观锁、悲观锁？</strong></p><p>synchronized 是一种悲观锁，在执行被 synchronized 包裹的代码时需要首先获取锁，没有拿到锁则无法执行，是总悲观的认为别的线程会去抢，所以叫悲观锁。</p><p>乐观锁的思想是它不认为会有线程去争抢，尽管去执行，如果没有执行成功就再去重试。</p><p>实现如下：</p><p>1、定义 mapper</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MediaProcessMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 开启一个任务
     * <span class="token keyword">@param</span> <span class="token parameter">id</span> 任务id
     * <span class="token keyword">@return</span> 更新记录数
     */</span>
    <span class="token annotation punctuation">@Update</span><span class="token punctuation">(</span><span class="token string">&quot;update media_process m set m.status=&#39;4&#39; where (m.status=&#39;1&#39; or m.status=&#39;3&#39;) and m.fail_count&lt;3 and m.id=#{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">startTask</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、service 方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 *  开启一个任务
 * <span class="token keyword">@param</span> <span class="token parameter">id</span> 任务id
 * <span class="token keyword">@return</span> true开启任务成功，false开启任务失败
 */</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">startTask</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//实现如下</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">startTask</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> result <span class="token operator">=</span> mediaProcessMapper<span class="token punctuation">.</span><span class="token function">startTask</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token operator">?</span><span class="token boolean">false</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-6-更新任务状态" tabindex="-1"><a class="header-anchor" href="#_7-6-更新任务状态" aria-hidden="true">#</a> <strong>7.6 更新任务状态</strong></h3><p>任务处理完成需要更新任务处理结果，任务执行成功更新视频的 URL、及任务处理结果，将待处理任务记录删除，同时向历史任务表添加记录。</p><p>在 MediaFileProcessService 接口添加方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 保存任务结果
 * <span class="token keyword">@param</span> <span class="token parameter">taskId</span>  任务id
 * <span class="token keyword">@param</span> <span class="token parameter">status</span> 任务状态
 * <span class="token keyword">@param</span> <span class="token parameter">fileId</span>  文件id
 * <span class="token keyword">@param</span> <span class="token parameter">url</span> url
 * <span class="token keyword">@param</span> <span class="token parameter">errorMsg</span> 错误信息
 * <span class="token keyword">@return</span> void
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/10/15 11:29
 */</span>
<span class="token keyword">void</span> <span class="token function">saveProcessFinishStatus</span><span class="token punctuation">(</span><span class="token class-name">Long</span> taskId<span class="token punctuation">,</span><span class="token class-name">String</span> status<span class="token punctuation">,</span><span class="token class-name">String</span> fileId<span class="token punctuation">,</span><span class="token class-name">String</span> url<span class="token punctuation">,</span><span class="token class-name">String</span> errorMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>service 接口方法实现如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">LambdaQueryWrapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">MediaFilesMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">MediaProcessHistoryMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">MediaProcessMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MediaFiles</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MediaProcess</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MediaProcessHistory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">MediaFileProcessService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">BeanUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">AutoConfigureOrder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Transactional</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> TODO
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/14 14:41
 * <span class="token keyword">@version</span> 1.0
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MediaFileProcessServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">MediaFileProcessService</span> <span class="token punctuation">{</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">MediaFilesMapper</span> mediaFilesMapper<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">MediaProcessMapper</span> mediaProcessMapper<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">MediaProcessHistoryMapper</span> mediaProcessHistoryMapper<span class="token punctuation">;</span>



<span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveProcessFinishStatus</span><span class="token punctuation">(</span><span class="token class-name">Long</span> taskId<span class="token punctuation">,</span> <span class="token class-name">String</span> status<span class="token punctuation">,</span> <span class="token class-name">String</span> fileId<span class="token punctuation">,</span> <span class="token class-name">String</span> url<span class="token punctuation">,</span> <span class="token class-name">String</span> errorMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//查出任务，如果不存在则直接返回</span>
    <span class="token class-name">MediaProcess</span> mediaProcess <span class="token operator">=</span> mediaProcessMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>mediaProcess <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//处理失败，更新任务处理结果</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">&gt;</span></span> queryWrapperById <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">MediaProcess</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">,</span> taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//处理失败</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">MediaProcess</span> mediaProcess_u <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaProcess_u<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaProcess_u<span class="token punctuation">.</span><span class="token function">setErrormsg</span><span class="token punctuation">(</span>errorMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaProcess_u<span class="token punctuation">.</span><span class="token function">setFailCount</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">.</span><span class="token function">getFailCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaProcessMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>mediaProcess_u<span class="token punctuation">,</span>queryWrapperById<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;更新任务处理状态为失败，任务信息:{}&quot;</span><span class="token punctuation">,</span>mediaProcess_u<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//任务处理成功</span>
    <span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>fileId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>mediaFiles<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//更新媒资文件中的访问url</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFilesMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//处理成功，更新url和状态</span>
    mediaProcess<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaProcess<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaProcess<span class="token punctuation">.</span><span class="token function">setFinishDate</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaProcessMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//添加到历史记录</span>
    <span class="token class-name">MediaProcessHistory</span> mediaProcessHistory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaProcessHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">,</span> mediaProcessHistory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaProcessHistoryMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>mediaProcessHistory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//删除mediaProcess</span>
    mediaProcessMapper<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">&gt;</span></span> <span class="token function">getMediaProcessList</span><span class="token punctuation">(</span><span class="token keyword">int</span> shardIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> shardTotal<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">&gt;</span></span> mediaProcesses <span class="token operator">=</span> mediaProcessMapper<span class="token punctuation">.</span><span class="token function">selectListByShardIndex</span><span class="token punctuation">(</span>shardTotal<span class="token punctuation">,</span> shardIndex<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> mediaProcesses<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-7-视频处理" tabindex="-1"><a class="header-anchor" href="#_7-7-视频处理" aria-hidden="true">#</a> <strong>7.7 视频处理</strong></h3><p>视频采用并发处理，每个视频使用一个线程去处理，每次处理的视频数量不要超过 cpu 核心数。</p><p>所有视频处理完成结束本次执行，为防止代码异常出现无限期等待则添加超时设置，到达超时时间还没有处理完成仍结束任务。</p><p>定义任务类 VideoTask 如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>service<span class="token punctuation">.</span>jobhander</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">Mp4VideoUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MediaProcess</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">MediaFileProcessService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">MediaFileService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xxl<span class="token punctuation">.</span>job<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">XxlJobHelper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xxl<span class="token punctuation">.</span>job<span class="token punctuation">.</span>core<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">XxlJob</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> TODO
 * <span class="token keyword">@date</span> 2022/10/15 11:58
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VideoTask</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MediaFileService</span> mediaFileService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MediaFileProcessService</span> mediaFileProcessService<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${videoprocess.ffmpegpath}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> ffmpegpath<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">&quot;videoJobHandler&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">videoJobHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token comment">// 分片参数</span>
    <span class="token keyword">int</span> shardIndex <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> shardTotal <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">&gt;</span></span> mediaProcessList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//取出cpu核心数作为一次处理数据的条数</span>
        <span class="token keyword">int</span> processors <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//一次处理视频数量不要超过cpu核心数</span>
        mediaProcessList <span class="token operator">=</span> mediaFileProcessService<span class="token punctuation">.</span><span class="token function">getMediaProcessList</span><span class="token punctuation">(</span>shardIndex<span class="token punctuation">,</span> shardTotal<span class="token punctuation">,</span> processors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        size <span class="token operator">=</span> mediaProcessList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;取出待处理视频任务{}条&quot;</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//启动size个线程的线程池</span>
    <span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//计数器</span>
    <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将处理任务加入线程池</span>
    mediaProcessList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>mediaProcess <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//任务id</span>
                <span class="token class-name">Long</span> taskId <span class="token operator">=</span> mediaProcess<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//抢占任务</span>
                <span class="token keyword">boolean</span> b <span class="token operator">=</span> mediaFileProcessService<span class="token punctuation">.</span><span class="token function">startTask</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;开始执行任务:{}&quot;</span><span class="token punctuation">,</span> mediaProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//下边是处理逻辑</span>
                <span class="token comment">//桶</span>
                <span class="token class-name">String</span> bucket <span class="token operator">=</span> mediaProcess<span class="token punctuation">.</span><span class="token function">getBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//存储路径</span>
                <span class="token class-name">String</span> filePath <span class="token operator">=</span> mediaProcess<span class="token punctuation">.</span><span class="token function">getFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//原始视频的md5值</span>
                <span class="token class-name">String</span> fileId <span class="token operator">=</span> mediaProcess<span class="token punctuation">.</span><span class="token function">getFileId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//原始文件名称</span>
                <span class="token class-name">String</span> filename <span class="token operator">=</span> mediaProcess<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//将要处理的文件下载到服务器上</span>
                 <span class="token class-name">File</span> originalFile <span class="token operator">=</span> mediaFileService<span class="token punctuation">.</span><span class="token function">downloadFileFromMinIO</span><span class="token punctuation">(</span>bucket<span class="token punctuation">,</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>originalFile <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;下载待处理文件失败,originalFile:{}&quot;</span><span class="token punctuation">,</span> mediaProcess<span class="token punctuation">.</span><span class="token function">getBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">.</span><span class="token function">getFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mediaFileProcessService<span class="token punctuation">.</span><span class="token function">saveProcessFinishStatus</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> fileId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;下载待处理文件失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//处理结束的视频文件</span>
                <span class="token class-name">File</span> mp4File <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    mp4File <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">.</span><span class="token function">createTempFile</span><span class="token punctuation">(</span><span class="token string">&quot;mp4&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.mp4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;创建mp4临时文件失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mediaFileProcessService<span class="token punctuation">.</span><span class="token function">saveProcessFinishStatus</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> fileId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;创建mp4临时文件失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//视频处理结果</span>
                <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">//开始处理视频</span>
                    <span class="token class-name">Mp4VideoUtil</span> videoUtil <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mp4VideoUtil</span><span class="token punctuation">(</span>ffmpegpath<span class="token punctuation">,</span> originalFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mp4File<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mp4File<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//开始视频转换，成功将返回success</span>
                    result <span class="token operator">=</span> videoUtil<span class="token punctuation">.</span><span class="token function">generateMp4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;处理视频文件:{},出错:{}&quot;</span><span class="token punctuation">,</span> mediaProcess<span class="token punctuation">.</span><span class="token function">getFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//记录错误信息</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;处理视频失败,视频地址:{},错误信息:{}&quot;</span><span class="token punctuation">,</span> bucket <span class="token operator">+</span> filePath<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mediaFileProcessService<span class="token punctuation">.</span><span class="token function">saveProcessFinishStatus</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> fileId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//将mp4上传至minio</span>
                <span class="token comment">//mp4在minio的存储路径</span>
                <span class="token class-name">String</span> objectName <span class="token operator">=</span> <span class="token function">getFilePath</span><span class="token punctuation">(</span>fileId<span class="token punctuation">,</span> <span class="token string">&quot;.mp4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//访问url</span>
                <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> bucket <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> objectName<span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    mediaFileService<span class="token punctuation">.</span><span class="token function">addMediaFilesToMinIO</span><span class="token punctuation">(</span>mp4File<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;video/mp4&quot;</span><span class="token punctuation">,</span> bucket<span class="token punctuation">,</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//将url存储至数据，并更新状态为成功，并将待处理视频记录删除存入历史</span>
                    mediaFileProcessService<span class="token punctuation">.</span><span class="token function">saveProcessFinishStatus</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> fileId<span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;上传视频失败或入库失败,视频地址:{},错误信息:{}&quot;</span><span class="token punctuation">,</span> bucket <span class="token operator">+</span> objectName<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//最终还是失败了</span>
                    mediaFileProcessService<span class="token punctuation">.</span><span class="token function">saveProcessFinishStatus</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> fileId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;处理后视频上传或入库失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
                countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//等待,给一个充裕的超时时间,防止无限等待，到达超时时间还没有处理完成则结束任务</span>
    countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getFilePath</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span><span class="token class-name">String</span> fileExt<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span>   fileMd5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> fileMd5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> fileMd5 <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span>fileMd5 <span class="token operator">+</span>fileExt<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-8-测试" tabindex="-1"><a class="header-anchor" href="#_7-8-测试" aria-hidden="true">#</a> <strong>7.8 测试</strong></h3><h4 id="_7-8-1-基本测试" tabindex="-1"><a class="header-anchor" href="#_7-8-1-基本测试" aria-hidden="true">#</a> <strong>7.8.1 基本测试</strong></h4><p>进入 xxl-job 调度中心添加执行器和视频处理任务</p><p>在 xxl-job 配置任务调度策略：</p><p>1）配置阻塞处理策略为：丢弃后续调度。</p><p>2）配置视频处理调度时间间隔不用根据视频处理时间去确定，可以配置的小一些，如：5 分钟，即使到达调度时间如果视频没有处理完会丢弃调度请求。</p><p>配置完成开始测试视频处理：</p><p>1、首先上传至少 4 个视频，非 mp4 格式。</p><p>2、在 xxl-job 启动视频处理任务</p><p>3、观察媒资管理服务后台日志</p><h4 id="_7-8-2-失败测试" tabindex="-1"><a class="header-anchor" href="#_7-8-2-失败测试" aria-hidden="true">#</a> <strong>7.8.2 失败测试</strong></h4><p>1、先停止调度中心的视频处理任务。</p><p>2、上传视频，手动修改待处理任务表中 file_path 字段为一个不存在的文件地址</p><p>3、启动任务</p><p>观察任务处理失败后是否会重试，并记录失败次数。</p><h4 id="_7-8-3-抢占任务测试" tabindex="-1"><a class="header-anchor" href="#_7-8-3-抢占任务测试" aria-hidden="true">#</a> <strong>7.8.3 抢占任务测试</strong></h4><p>1、修改调度中心中视频处理任务的阻塞处理策略为“覆盖之间的调度”</p><p><img src="/MyBlog/assets/image-20230521181651102-595ab0a4.png" alt="image-20230521181651102"></p><p>2、在抢占任务代码处打断点并选择支持多线程方式</p><p><img src="/MyBlog/assets/image-20230521181657594-ecf40b44.png" alt="image-20230521181657594"></p><p>3、在抢占任务代码处的下边两行代码分别打上断点，避免观察时代码继续执行。</p><p>4、启动任务</p><p>此时多个线程执行都停留在断点处</p><p><img src="/MyBlog/assets/image-20230521181704394-9e47af61.png" alt="image-20230521181704394"></p><p>依次放行，观察同一个任务只会被一个线程抢占成功。</p><p><img src="/MyBlog/assets/image-20230521181709767-ae65f5ae.png" alt="image-20230521181709767"></p><p><img src="/MyBlog/assets/image-20230521181714516-606befb7.png" alt="image-20230521181714516"></p><h3 id="_7-9-其它问题" tabindex="-1"><a class="header-anchor" href="#_7-9-其它问题" aria-hidden="true">#</a> <strong>7.9 其它问题</strong></h3><h4 id="_7-9-1-任务补偿机制" tabindex="-1"><a class="header-anchor" href="#_7-9-1-任务补偿机制" aria-hidden="true">#</a> <strong>7.9.1 任务补偿机制</strong></h4><p>如果有线程抢占了某个视频的处理任务，如果线程处理过程中挂掉了，该视频的状态将会一直是处理中，其它线程将无法处理，这个问题需要用补偿机制。</p><p>单独启动一个任务找到待处理任务表中超过执行期限但仍在处理中的任务，将任务的状态改为执行失败。</p><p>任务执行期限是处理一个视频的最大时间，比如定为 30 分钟，通过任务的启动时间去判断任务是否超过执行期限。</p><p>大家思考这个 sql 该如何实现？</p><p>大家尝试自己实现此任务补偿机制。</p><h4 id="_7-9-2-达到最大失败次数" tabindex="-1"><a class="header-anchor" href="#_7-9-2-达到最大失败次数" aria-hidden="true">#</a> <strong>7.9.2 达到最大失败次数</strong></h4><p>当任务达到最大失败次数时一般就说明程序处理此视频存在问题，这种情况就需要人工处理，在页面上会提示失败的信息，人工可手动执行该视频进行处理，或通过其它转码工具进行视频转码，转码后直接上传 mp4 视频。</p><h2 id="_8-绑定媒资" tabindex="-1"><a class="header-anchor" href="#_8-绑定媒资" aria-hidden="true">#</a> <strong>8 绑定媒资</strong></h2><h3 id="_8-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_8-1-需求分析" aria-hidden="true">#</a> <strong>8.1 需求分析</strong></h3><h4 id="_8-1-1-业务流程" tabindex="-1"><a class="header-anchor" href="#_8-1-1-业务流程" aria-hidden="true">#</a> <strong>8.1.1 业务流程</strong></h4><p>到目前为止，媒资管理已完成文件上传、视频处理、我的媒资功能等基本功能，其它模块可以使用媒资文件，本节要讲解课程计划绑定媒资文件。</p><p>如何将课程计划绑定媒资呢？</p><p>首先进入课程计划界面，然后选择要绑定的视频进行绑定即可。</p><p>具体的业务流程如下：</p><p>1.教育机构用户进入课程管理页面并编辑某一个课程，在&quot;课程大纲&quot;标签页的某一小节后可点击”添加视频“。</p><p><img src="/MyBlog/assets/image-20230521172936979-a0af02f0.png" alt="image-20230521181734951"></p><p>2.弹出添加视频对话框，可通过视频关键字搜索已审核通过的视频媒资。</p><p><img src="/MyBlog/assets/image-20230521172943466-f5fa9803.png" alt="image-20230521181740422"></p><p>3.选择视频媒资，点击提交按钮，完成课程计划绑定媒资流程。</p><p><img src="/MyBlog/assets/image-20230521172953841-176a63dd.png" alt="image-20230521181746130"></p><p>课程计划关联视频后如下图：</p><p><img src="/MyBlog/assets/image-20230521172959743-85b2922d.png" alt="image-20230521181753498"></p><p>点击已经绑定的视频名称即可解除绑定。</p><p><img src="/MyBlog/assets/image-20230521181759166-42c56aa5.png" alt="image-20230521181759166"></p><h4 id="_8-1-2-数据模型" tabindex="-1"><a class="header-anchor" href="#_8-1-2-数据模型" aria-hidden="true">#</a> <strong>8.1.2 数据模型</strong></h4><p>课程计划绑定媒资文件后存储至课程计划绑定媒资表</p><p><img src="/MyBlog/assets/image-20230521181804767-6d4de7a1.png" alt="image-20230521181804767"></p><h3 id="_8-2-接口定义" tabindex="-1"><a class="header-anchor" href="#_8-2-接口定义" aria-hidden="true">#</a> <strong>8.2 接口定义</strong></h3><p>根据业务流程，用户进入课程计划列表，首先确定向哪个课程计划添加视频，点击”添加视频“后用户选择视频，选择视频，点击提交，前端以 json 格式请求以下参数：</p><p>提交媒资文件 id、文件名称、教学计划 id</p><p>示例如下：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;mediaId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;70a98b4a2fffc89e50b101f959cc33ca&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;fileName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;22-Hmily实现TCC事务-开发bank2的confirm方法.avi&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;teachplanId&quot;</span><span class="token operator">:</span> <span class="token number">257</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此接口在内容管理模块提供。</p><p>在内容管理模块定义请求参数模型类型：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ApiModel</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">&quot;BindTeachplanMediaDto&quot;</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">&quot;教学计划-媒资绑定提交数据&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BindTeachplanMediaDto</span> <span class="token punctuation">{</span>

<span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;媒资文件id&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> mediaId<span class="token punctuation">;</span>

<span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;媒资文件名称&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> fileName<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;课程计划标识&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
 <span class="token keyword">private</span> <span class="token class-name">Long</span> teachplanId<span class="token punctuation">;</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 TeachplanController 类中定义接口如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;课程计划和媒资信息绑定&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/teachplan/association/media&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">associationMedia</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">BindTeachplanMediaDto</span> bindTeachplanMediaDto<span class="token punctuation">)</span><span class="token punctuation">{</span>

<span class="token punctuation">}</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-3-接口开发" tabindex="-1"><a class="header-anchor" href="#_8-3-接口开发" aria-hidden="true">#</a> <strong>8.3 接口开发</strong></h3><h4 id="_8-3-1-dao-开发" tabindex="-1"><a class="header-anchor" href="#_8-3-1-dao-开发" aria-hidden="true">#</a> <strong>8.3.1 DAO 开发</strong></h4><p>对 teachplanMedia 表自动生成 Mapper。</p><h4 id="_8-3-2-service-开发" tabindex="-1"><a class="header-anchor" href="#_8-3-2-service-开发" aria-hidden="true">#</a> <strong>8.3.2 Service 开发</strong></h4><p>根据需求定义 service 接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 教学计划绑定媒资
 * <span class="token keyword">@param</span> <span class="token parameter">bindTeachplanMediaDto</span>
 * <span class="token keyword">@return</span> com.xuecheng.content.model.po.TeachplanMedia
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/14 22:20
*/</span>
<span class="token keyword">public</span> <span class="token class-name">TeachplanMedia</span> <span class="token function">associationMedia</span><span class="token punctuation">(</span><span class="token class-name">BindTeachplanMediaDto</span> bindTeachplanMediaDto<span class="token punctuation">)</span><span class="token punctuation">;</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>定义接口实现</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token annotation punctuation">@Transactional</span>
 <span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">TeachplanMedia</span> <span class="token function">associationMedia</span><span class="token punctuation">(</span><span class="token class-name">BindTeachplanMediaDto</span> bindTeachplanMediaDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">//教学计划id</span>
 <span class="token class-name">Long</span> teachplanId <span class="token operator">=</span> bindTeachplanMediaDto<span class="token punctuation">.</span><span class="token function">getTeachplanId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">Teachplan</span> teachplan <span class="token operator">=</span> teachplanMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>teachplanId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>teachplan<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;教学计划不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token class-name">Integer</span> grade <span class="token operator">=</span> teachplan<span class="token punctuation">.</span><span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>grade<span class="token operator">!=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;只允许第二级教学计划绑定媒资文件&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">//课程id</span>
 <span class="token class-name">Long</span> courseId <span class="token operator">=</span> teachplan<span class="token punctuation">.</span><span class="token function">getCourseId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">//先删除原来该教学计划绑定的媒资</span>
 teachplanMediaMapper<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TeachplanMedia</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">TeachplanMedia</span><span class="token operator">::</span><span class="token function">getTeachplanId</span><span class="token punctuation">,</span>teachplanId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">//再添加教学计划与媒资的绑定关系</span>
 <span class="token class-name">TeachplanMedia</span> teachplanMedia <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TeachplanMedia</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 teachplanMedia<span class="token punctuation">.</span><span class="token function">setCourseId</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 teachplanMedia<span class="token punctuation">.</span><span class="token function">setTeachplanId</span><span class="token punctuation">(</span>teachplanId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 teachplanMedia<span class="token punctuation">.</span><span class="token function">setMediaFilename</span><span class="token punctuation">(</span>bindTeachplanMediaDto<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 teachplanMedia<span class="token punctuation">.</span><span class="token function">setMediaId</span><span class="token punctuation">(</span>bindTeachplanMediaDto<span class="token punctuation">.</span><span class="token function">getMediaId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 teachplanMedia<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 teachplanMediaMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>teachplanMedia<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> teachplanMedia<span class="token punctuation">;</span>
<span class="token punctuation">}</span>



</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-3-3-接口层完善" tabindex="-1"><a class="header-anchor" href="#_8-3-3-接口层完善" aria-hidden="true">#</a> <strong>8.3.3 接口层完善</strong></h4><p>完善接口层调用 Service 层的代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;课程计划和媒资信息绑定&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/teachplan/association/media&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">associationMedia</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">BindTeachplanMediaDto</span> bindTeachplanMediaDto<span class="token punctuation">)</span><span class="token punctuation">{</span>
    teachplanService<span class="token punctuation">.</span><span class="token function">associationMedia</span><span class="token punctuation">(</span>bindTeachplanMediaDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-3-4-接口测试" tabindex="-1"><a class="header-anchor" href="#_8-3-4-接口测试" aria-hidden="true">#</a> <strong>8.3.4 接口测试</strong></h4><p>1、使用 httpclient 测试</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>#### 课程计划绑定视频
POST <span class="token punctuation">{</span><span class="token punctuation">{</span>media_host<span class="token punctuation">}</span><span class="token punctuation">}</span>/media/teachplan/association/media
Content-Type<span class="token operator">:</span> application/json

<span class="token punctuation">{</span>
  <span class="token property">&quot;mediaId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;fileName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;teachplanId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>
<span class="token punctuation">}</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、前后端联调</p><p>此功能较为简单推荐直接前后端联调</p><p>向指定课程计划添加视频</p><h3 id="_8-4-实战-前端代码有问题" tabindex="-1"><a class="header-anchor" href="#_8-4-实战-前端代码有问题" aria-hidden="true">#</a> <strong>8.4 实战（前端代码有问题）</strong></h3><p>根据接口定义实现解除绑定功能。</p><p>点击已经绑定的视频名称即可解除绑定。</p><p><img src="/MyBlog/assets/image-20230521181759166-42c56aa5.png" alt="image-20230521182028374"></p><p>接口定义如下：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>delete /teachplan/association/media/<span class="token punctuation">{</span>teachPlanId<span class="token punctuation">}</span>/<span class="token punctuation">{</span>mediaId<span class="token punctuation">}</span>

返回<span class="token number">200</span>状态码表示成功。


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>开发完成使用 httpclient 测试、前后端联调</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>#### 课程计划接触视频绑定
DELETE <span class="token punctuation">{</span><span class="token punctuation">{</span>media_host<span class="token punctuation">}</span><span class="token punctuation">}</span>/media/teachplan/association/media/<span class="token punctuation">{</span>teachPlanId<span class="token punctuation">}</span>/<span class="token punctuation">{</span>mediaId<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/ZyKunn/edit/main/notes/project/02/第3章-媒资管理模块v3.1/README.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--]--> Edit this page <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">贡献者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 814342838@qq.com">ZyKun</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/MyBlog/notes/project/02/%E7%AC%AC2%E7%AB%A0-%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/" class="" aria-label="第 2 章 内容管理模块 v3.1"><!--[--><!--]--> 第 2 章 内容管理模块 v3.1 <!--[--><!--]--></a></span><span class="next"><a href="/MyBlog/notes/project/02/%E7%AC%AC4%E7%AB%A0-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83v3.1/" class="" aria-label="第 4 章 课程发布 v3.1"><!--[--><!--]--> 第 4 章 课程发布 v3.1 <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/MyBlog/assets/app-a153c100.js" defer></script>
  </body>
</html>
