<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.63">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="./img/logo.png"><title>第 5 章 认证授权 v3.1 | ZyKunのBlog</title><meta name="description" content="">
    <link rel="preload" href="/MyBlog/assets/style-57272a59.css" as="style"><link rel="stylesheet" href="/MyBlog/assets/style-57272a59.css">
    <link rel="modulepreload" href="/MyBlog/assets/app-a153c100.js"><link rel="modulepreload" href="/MyBlog/assets/index.html-cdce2101.js"><link rel="modulepreload" href="/MyBlog/assets/index.html-85181f96.js"><link rel="prefetch" href="/MyBlog/assets/index.html-ab0151fa.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1249ab5a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4d02565e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1c68c797.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-93acf26d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2bc953d6.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0c526d7c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-636c9f52.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d4177c6b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7624decc.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d0b4a798.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-aa378d7b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ddd44d65.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-adbb7f41.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-34576599.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1079a374.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-88d4ebe7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5e927142.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9a6f13b8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4c85da23.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-69e813d7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-545062a2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-bd7a4fcb.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-910949e0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-459b0c71.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9a036060.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f62ffe74.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-841a86c0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b31c8bb6.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-85bae056.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-73555735.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6d5456cd.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d2dfbeec.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-746091c2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9cc627ff.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d411448a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4454f425.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-57aa84f4.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2ce52087.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-76657200.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-90d9409e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4d6ba5e7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-41bc7856.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6140daf4.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ea30461d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-00114784.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f3fa86cb.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-386f0bd2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b46ac77e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-256a258e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4ebf55b3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7268161e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5a8852c0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-19373782.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4e33bb6b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-de5ff178.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fd5da14a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-dbee5a73.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-64025c89.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9bd15ac7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4812edff.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1f3f5c2b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-3f85e131.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1d66d048.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-67b1b38e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-17f10f72.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ad1b5dc8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b14e7669.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fa35810b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-acb9b7bf.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f2ba9a88.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-abdb28e5.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b3cc33e9.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ef13eee8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-73fa0dcc.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6f7449c7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-3857ef8d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e5af1d8f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d5d14c1f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-94a8b9a2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-3931e4d3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0978879b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-617bd5bf.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4fe008c8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0e33aa95.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-00725025.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8e05ec6e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-72ca6b4c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-427c5181.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-3b3baf42.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-40a790c3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9709e7c9.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8eb00d02.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0c849262.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-eda16f63.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-81242655.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2c9f6820.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-79188b74.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5775eee0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-eff0510c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-305de307.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e83a5de7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-761a9548.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-c12ae66e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-87a73e5c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d720473a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b960b5b6.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-bbd98f93.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-76195dca.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-3bd0cfa7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8c87d147.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-bac2e853.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1ee6bc34.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ab7381d6.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5b97f6b8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fd33ca6f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-684189de.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-63731ad7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-895bfca1.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6d1ff4c2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b71bf26f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ce6f983b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-c185f9a2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-29c62d64.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-52c91de2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-55aa1c06.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-c87ef63a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ff1d9f51.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-a12aedeb.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-298f19f2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f881f599.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2c32406a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d4217479.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7edb7ce1.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8671126f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-da565d04.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f9deb3ec.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ee7cf1b5.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-270d6327.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ec786b75.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e98adf02.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7233a0e2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-79c193cf.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9714081e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d5dea51d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-a235e4bb.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e3209a23.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-389e66df.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-652ee4f6.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-025e6f4e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-60711e70.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6edc93de.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-11bd39b1.js" as="script"><link rel="prefetch" href="/MyBlog/assets/404.html-60b35caa.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-53015219.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-74dcd8ae.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2dd727db.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-11b329fb.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-3b6f3614.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-70ce719f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f6ca4d92.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5a6833de.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-bf03220c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-a2edab58.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f1e5cf7a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-21d4e18d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5235fca9.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2dc704c0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-57630906.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ff165209.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6ec253a3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f9e4f0c3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-664b232d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-adf015a3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4667c0e6.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-cc407710.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1752d212.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9b5d99c4.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-43c48ae2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e8a616b7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-93e7405b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-22a72a56.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-42ce3023.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f8eeab22.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-dd50991a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-af520db8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5ab2bfac.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-965bc04f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-81ebef01.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-79d19f4d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9600bdfb.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-560df48d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4fb22a4f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-bd4caa82.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-370323f9.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f673ebfa.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-78d88460.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8b54347c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d30f0340.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e26bc4de.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7d37b036.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-3aa565ce.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4c69f238.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-76d60030.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7116a5e4.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d8f649cc.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-adbbb7c9.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-90bb86fd.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e23936a3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-19ad952b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-07245162.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-038b3afd.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-084fe5c1.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-098421fe.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7baefce4.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fffdfb9c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d8c9612c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-05c42fda.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-e1615934.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-da824146.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fa2d32f0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-545dbea7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f3ca58cb.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b9e2188a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4fc5f1f7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1ec5c70d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-cbf2aa55.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8beb0c08.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ee54da9f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fd28b91d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-98aa51a1.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-03f9381a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2c9009c5.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-71b7cfbe.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1759170e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-aa84186f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-53160af7.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-51b685b4.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ecb8e229.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-9c507901.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-c6362722.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-faf67dd8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d7f20950.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-a088985c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-93b7982c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b76e6179.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d976d39c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b16efd78.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-1301757e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-c3240cbe.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-a2ddd21c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-74fb5e20.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-128f5026.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8fd9f38a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-82e84e23.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-007ef014.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f3dd860c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-382a2bae.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7b6beaec.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-2eb17cfa.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-c6f50213.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0c8aef39.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-133f4d38.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-cffd2be1.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-a798219d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6b5fde77.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-13275b71.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-4b6a02c3.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7f179a12.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f45bc33f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0574e5e5.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0921816f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-631fbc02.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8586017d.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-c4dbf09b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-967486c0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-aad17dde.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-ff644d77.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-78a4df64.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8d2180e8.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-53fbcd20.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-a3387e5e.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-979f5ac4.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-0938c506.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-51707e22.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b1e917a0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-6b56a071.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-d15eb498.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7b0a97c0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fda196b5.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-bcc5faac.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-490c208f.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-dce28479.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-62825d3c.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b5a4af15.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-eb40da96.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-8d6d1c61.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-618cf3f0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-f2a35430.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-64f564d2.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-bca2187b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-7f689b28.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-62aa623a.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-b0c39cc5.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-73b8fff0.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-5466ae58.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index.html-fbd0bcfa.js" as="script"><link rel="prefetch" href="/MyBlog/assets/404.html-5f041a2b.js" as="script"><link rel="prefetch" href="/MyBlog/assets/style-e9220a04.js" as="script"><link rel="prefetch" href="/MyBlog/assets/docsearch-1d421ddb.js" as="script"><link rel="prefetch" href="/MyBlog/assets/index-5161ad19.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/MyBlog/" class=""><!----><span class="site-name can-hide">ZyKunのBlog</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/MyBlog/" class="" aria-label="🌱Home"><!--[--><!--]--> 🌱Home <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🥝Java"><span class="title">🥝Java</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🥝Java"><span class="title">🥝Java</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/01/" class="" aria-label="基础语法"><!--[--><!--]--> 基础语法 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/02/" class="" aria-label="面向对象编程"><!--[--><!--]--> 面向对象编程 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/03/" class="" aria-label="常用类&amp;集合框架"><!--[--><!--]--> 常用类&amp;集合框架 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/04/" class="" aria-label="JDBC"><!--[--><!--]--> JDBC <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/05/" class="" aria-label="Java高级"><!--[--><!--]--> Java高级 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/06/" class="" aria-label="JavaWeb"><!--[--><!--]--> JavaWeb <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🐍Python"><span class="title">🐍Python</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🐍Python"><span class="title">🐍Python</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/python/01/" class="" aria-label="Python入门"><!--[--><!--]--> Python入门 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🌋微服务"><span class="title">🌋微服务</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🌋微服务"><span class="title">🌋微服务</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/microservices/01/" class="" aria-label="实用篇"><!--[--><!--]--> 实用篇 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/microservices/02/" class="" aria-label="高级篇"><!--[--><!--]--> 高级篇 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/MyBlog/notes/mysql/" class="" aria-label="🍓Mysql"><!--[--><!--]--> 🍓Mysql <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🍤前端"><span class="title">🍤前端</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🍤前端"><span class="title">🍤前端</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/01/" class="" aria-label="HTML&amp;CSS"><!--[--><!--]--> HTML&amp;CSS <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/02/" class="" aria-label="JavaScript"><!--[--><!--]--> JavaScript <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/03/" class="" aria-label="JQuery"><!--[--><!--]--> JQuery <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/04/" class="" aria-label="Layui"><!--[--><!--]--> Layui <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/05/" class="" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🎢Project"><span class="title">🎢Project</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🎢Project"><span class="title">🎢Project</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/project/01/" class="" aria-label="Reggie"><!--[--><!--]--> Reggie <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/project/02/" class="router-link-active" aria-label="51XueCheng"><!--[--><!--]--> 51XueCheng <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/MyBlog/notes/record/" class="" aria-label="🍍随笔"><!--[--><!--]--> 🍍随笔 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/ZyKunn" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!--[--><div id="docsearch-container" style="display:none;"></div><div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"><svg width="15" height="15" class="DocSearch-Control-Key-Icon"><path d="M4.505 4.496h2M5.505 5.496v5M8.216 4.496l.055 5.993M10 7.5c.333.333.5.667.5 1v2M12.326 4.5v5.996M8.384 4.496c1.674 0 2.116 0 2.116 1.5s-.442 1.5-2.116 1.5M3.205 9.303c-.09.448-.277 1.21-1.241 1.203C1 10.5.5 9.513.5 8V7c0-1.57.5-2.5 1.464-2.494.964.006 1.134.598 1.24 1.342M12.553 10.5h1.953" stroke-width="1.2" stroke="currentColor" fill="none" stroke-linecap="square"></path></svg></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/MyBlog/" class="" aria-label="🌱Home"><!--[--><!--]--> 🌱Home <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🥝Java"><span class="title">🥝Java</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🥝Java"><span class="title">🥝Java</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/01/" class="" aria-label="基础语法"><!--[--><!--]--> 基础语法 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/02/" class="" aria-label="面向对象编程"><!--[--><!--]--> 面向对象编程 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/03/" class="" aria-label="常用类&amp;集合框架"><!--[--><!--]--> 常用类&amp;集合框架 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/04/" class="" aria-label="JDBC"><!--[--><!--]--> JDBC <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/05/" class="" aria-label="Java高级"><!--[--><!--]--> Java高级 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/java/06/" class="" aria-label="JavaWeb"><!--[--><!--]--> JavaWeb <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🐍Python"><span class="title">🐍Python</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🐍Python"><span class="title">🐍Python</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/python/01/" class="" aria-label="Python入门"><!--[--><!--]--> Python入门 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🌋微服务"><span class="title">🌋微服务</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🌋微服务"><span class="title">🌋微服务</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/microservices/01/" class="" aria-label="实用篇"><!--[--><!--]--> 实用篇 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/microservices/02/" class="" aria-label="高级篇"><!--[--><!--]--> 高级篇 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/MyBlog/notes/mysql/" class="" aria-label="🍓Mysql"><!--[--><!--]--> 🍓Mysql <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🍤前端"><span class="title">🍤前端</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🍤前端"><span class="title">🍤前端</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/01/" class="" aria-label="HTML&amp;CSS"><!--[--><!--]--> HTML&amp;CSS <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/02/" class="" aria-label="JavaScript"><!--[--><!--]--> JavaScript <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/03/" class="" aria-label="JQuery"><!--[--><!--]--> JQuery <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/04/" class="" aria-label="Layui"><!--[--><!--]--> Layui <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/front-end/05/" class="" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🎢Project"><span class="title">🎢Project</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🎢Project"><span class="title">🎢Project</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/MyBlog/notes/project/01/" class="" aria-label="Reggie"><!--[--><!--]--> Reggie <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/MyBlog/notes/project/02/" class="router-link-active" aria-label="51XueCheng"><!--[--><!--]--> 51XueCheng <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/MyBlog/notes/record/" class="" aria-label="🍍随笔"><!--[--><!--]--> 🍍随笔 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/ZyKunn" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/MyBlog/notes/project/02/" class="router-link-active sidebar-item sidebar-heading active" aria-label="51XueCheng"><!--[--><!--]--> 51XueCheng <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a href="/MyBlog/notes/project/02/%E7%AC%AC1%E7%AB%A0-%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D_%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BAv3.1/" class="sidebar-item" aria-label="第 1 章 项目介绍&amp;环境搭建 v3.1"><!--[--><!--]--> 第 1 章 项目介绍&amp;环境搭建 v3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E7%AC%AC2%E7%AB%A0-%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/" class="sidebar-item" aria-label="第 2 章 内容管理模块 v3.1"><!--[--><!--]--> 第 2 章 内容管理模块 v3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E7%AC%AC3%E7%AB%A0-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97v3.1/" class="sidebar-item" aria-label="第 3 章媒资管理模块 v3.1"><!--[--><!--]--> 第 3 章媒资管理模块 v3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E7%AC%AC4%E7%AB%A0-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83v3.1/" class="sidebar-item" aria-label="第 4 章 课程发布 v3.1"><!--[--><!--]--> 第 4 章 课程发布 v3.1 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="第 5 章 认证授权 v3.1"><!--[--><!--]--> 第 5 章 认证授权 v3.1 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_1-模块需求分析" class="router-link-active router-link-exact-active sidebar-item" aria-label="1 模块需求分析"><!--[--><!--]--> 1 模块需求分析 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_1-1-什么是认证授权" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.1 什么是认证授权"><!--[--><!--]--> 1.1 什么是认证授权 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_1-2-业务流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.2 业务流程"><!--[--><!--]--> 1.2 业务流程 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_1-2-1-统一认证" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.2.1 统一认证"><!--[--><!--]--> 1.2.1 统一认证 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_1-2-2-单点登录" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.2.2 单点登录"><!--[--><!--]--> 1.2.2 单点登录 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_1-2-3-第三方认证" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.2.3 第三方认证"><!--[--><!--]--> 1.2.3 第三方认证 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-spring-security-认证研究" class="router-link-active router-link-exact-active sidebar-item" aria-label="2 Spring Security 认证研究"><!--[--><!--]--> 2 Spring Security 认证研究 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-1-spring-security-介绍" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.1 Spring Security 介绍"><!--[--><!--]--> 2.1 Spring Security 介绍 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-2-认证授权入门" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2 认证授权入门"><!--[--><!--]--> 2.2 认证授权入门 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-2-1-创建认证服务工程" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.1 创建认证服务工程"><!--[--><!--]--> 2.2.1 创建认证服务工程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-2-2-认证测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.2 认证测试"><!--[--><!--]--> 2.2.2 认证测试 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-2-3-授权测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.3 授权测试"><!--[--><!--]--> 2.2.3 授权测试 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-2-4-工作原理" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.2.4 工作原理"><!--[--><!--]--> 2.2.4 工作原理 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-3-什么是-oauth2" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.3 什么是 OAuth2"><!--[--><!--]--> 2.3 什么是 OAuth2 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-3-1-oauth2-认证流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.3.1 OAuth2 认证流程"><!--[--><!--]--> 2.3.1 OAuth2 认证流程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-3-2-oauth2-在本项目的应用" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.3.2 OAuth2 在本项目的应用"><!--[--><!--]--> 2.3.2 OAuth2 在本项目的应用 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-3-3-oauth2-的授权模式" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.3.3 OAuth2 的授权模式"><!--[--><!--]--> 2.3.3 OAuth2 的授权模式 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-3-3-1-授权码模式" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.3.3.1 授权码模式"><!--[--><!--]--> 2.3.3.1 授权码模式 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-3-3-2-授权码模式测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.3.3.2 授权码模式测试"><!--[--><!--]--> 2.3.3.2 授权码模式测试 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-3-3-3-密码模式" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.3.3.3 密码模式"><!--[--><!--]--> 2.3.3.3 密码模式 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-3-3-4-本项目的应用方式" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.3.3.4 本项目的应用方式"><!--[--><!--]--> 2.3.3.4 本项目的应用方式 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-4-jwt" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.4 JWT"><!--[--><!--]--> 2.4 JWT <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-4-1-普通令牌的问题" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.4.1 普通令牌的问题"><!--[--><!--]--> 2.4.1 普通令牌的问题 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-4-2-什么是-jwt" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.4.2 什么是 JWT"><!--[--><!--]--> 2.4.2 什么是 JWT <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-4-3-测试生成-jwt-令牌" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.4.3 测试生成 JWT 令牌"><!--[--><!--]--> 2.4.3 测试生成 JWT 令牌 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-4-4-携带令牌访问资源服务" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.4.4 携带令牌访问资源服务"><!--[--><!--]--> 2.4.4 携带令牌访问资源服务 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-4-5-测试获取用户身份" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.4.5 测试获取用户身份"><!--[--><!--]--> 2.4.5 测试获取用户身份 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-5-网关认证" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.5 网关认证"><!--[--><!--]--> 2.5 网关认证 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-5-1-技术方案" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.5.1 技术方案"><!--[--><!--]--> 2.5.1 技术方案 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-5-2-实现网关认证" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.5.2 实现网关认证"><!--[--><!--]--> 2.5.2 实现网关认证 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_3-用户认证" class="router-link-active router-link-exact-active sidebar-item" aria-label="3 用户认证"><!--[--><!--]--> 3 用户认证 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_3-1-需求分析" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.1 需求分析"><!--[--><!--]--> 3.1 需求分析 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_3-2-连接用户中心数据库" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.2 连接用户中心数据库"><!--[--><!--]--> 3.2 连接用户中心数据库 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_3-2-1-连接数据库认证" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.2.1 连接数据库认证"><!--[--><!--]--> 3.2.1 连接数据库认证 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_3-2-2-扩展用户身份信息" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.2.2 扩展用户身份信息"><!--[--><!--]--> 3.2.2 扩展用户身份信息 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_3-2-3-资源服务获取用户身份" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.2.3 资源服务获取用户身份"><!--[--><!--]--> 3.2.3 资源服务获取用户身份 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_3-3-支持认证方式多样" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.3 支持认证方式多样"><!--[--><!--]--> 3.3 支持认证方式多样 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_3-3-1-统一认证入口" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.3.1 统一认证入口"><!--[--><!--]--> 3.3.1 统一认证入口 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_3-3-2-实现账号密码认证" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.3.2 实现账号密码认证"><!--[--><!--]--> 3.3.2 实现账号密码认证 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_3-4-验证码服务" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.4 验证码服务"><!--[--><!--]--> 3.4 验证码服务 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_3-4-1-部署验证码服务工程" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.4.1 部署验证码服务工程"><!--[--><!--]--> 3.4.1 部署验证码服务工程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_3-4-2-验证码接口测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.4.2 验证码接口测试"><!--[--><!--]--> 3.4.2 验证码接口测试 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_3-5-账号密码认证" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.5 账号密码认证"><!--[--><!--]--> 3.5 账号密码认证 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_3-5-1-需求分析" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.5.1 需求分析"><!--[--><!--]--> 3.5.1 需求分析 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_3-5-2-账号密码认证开发" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.5.2 账号密码认证开发"><!--[--><!--]--> 3.5.2 账号密码认证开发 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_3-5-3-账号密码认证测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.5.3 账号密码认证测试"><!--[--><!--]--> 3.5.3 账号密码认证测试 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_4-微信扫码登录" class="router-link-active router-link-exact-active sidebar-item" aria-label="4 微信扫码登录"><!--[--><!--]--> 4 微信扫码登录 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_4-1-接入规范" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.1 接入规范"><!--[--><!--]--> 4.1 接入规范 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_4-1-1-接入流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.1.1 接入流程"><!--[--><!--]--> 4.1.1 接入流程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_4-1-2-请求获取授权码" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.1.2 请求获取授权码"><!--[--><!--]--> 4.1.2 请求获取授权码 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_4-1-3-通过-code-获取-access-token" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.1.3 通过 code 获取 access_token"><!--[--><!--]--> 4.1.3 通过 code 获取 access_token <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_4-1-4-通过-access-token-调用接口" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.1.4 通过 access_token 调用接口"><!--[--><!--]--> 4.1.4 通过 access_token 调用接口 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_4-2-准备开发环境" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.2 准备开发环境"><!--[--><!--]--> 4.2 准备开发环境 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_4-2-1-添加应用" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.2.1 添加应用"><!--[--><!--]--> 4.2.1 添加应用 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_4-2-2-内网穿透" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.2.2 内网穿透"><!--[--><!--]--> 4.2.2 内网穿透 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_4-3-接入微信登录" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.3 接入微信登录"><!--[--><!--]--> 4.3 接入微信登录 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_4-3-1-接入分析" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.3.1 接入分析"><!--[--><!--]--> 4.3.1 接入分析 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_4-3-2-定义接口" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.3.2 定义接口"><!--[--><!--]--> 4.3.2 定义接口 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_4-3-3-接口环境测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.3.3 接口环境测试"><!--[--><!--]--> 4.3.3 接口环境测试 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_4-3-4-接入微信认证" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.3.4 接入微信认证"><!--[--><!--]--> 4.3.4 接入微信认证 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_4-3-5-保存用户信息" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.3.5 保存用户信息"><!--[--><!--]--> 4.3.5 保存用户信息 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_5-用户授权" class="router-link-active router-link-exact-active sidebar-item" aria-label="5 用户授权"><!--[--><!--]--> 5 用户授权 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_5-1-rbac" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.1 RBAC"><!--[--><!--]--> 5.1 RBAC <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_5-2-资源服务授权流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.2 资源服务授权流程"><!--[--><!--]--> 5.2 资源服务授权流程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_5-3-授权相关的数据模型" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.3 授权相关的数据模型"><!--[--><!--]--> 5.3 授权相关的数据模型 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_5-4-查询用户权限" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.4 查询用户权限"><!--[--><!--]--> 5.4 查询用户权限 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_5-5-授权测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.5 授权测试"><!--[--><!--]--> 5.5 授权测试 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_5-6-细粒度授权" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.6 细粒度授权"><!--[--><!--]--> 5.6 细粒度授权 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_5-6-1-什么是细粒度授权" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.6.1 什么是细粒度授权"><!--[--><!--]--> 5.6.1 什么是细粒度授权 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_5-6-2-教学机构细粒度授权" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.6.2 教学机构细粒度授权"><!--[--><!--]--> 5.6.2 教学机构细粒度授权 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_5-6-3-教学机构细粒度授权测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.6.3 教学机构细粒度授权测试"><!--[--><!--]--> 5.6.3 教学机构细粒度授权测试 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_6-实战" class="router-link-active router-link-exact-active sidebar-item" aria-label="6 实战"><!--[--><!--]--> 6 实战 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_6-1-找回密码-实战" class="router-link-active router-link-exact-active sidebar-item" aria-label="6.1 找回密码(实战)"><!--[--><!--]--> 6.1 找回密码(实战) <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_6-2-注册-实战" class="router-link-active router-link-exact-active sidebar-item" aria-label="6.2 注册(实战)"><!--[--><!--]--> 6.2 注册(实战) <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/" class="sidebar-item" aria-label="第 6 章 选课学习 v3.1"><!--[--><!--]--> 第 6 章 选课学习 v3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E7%AC%AC7%E7%AB%A0-%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2v3.1/" class="sidebar-item" aria-label="第 7 章 项目部署 v3.1"><!--[--><!--]--> 第 7 章 项目部署 v3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E7%AC%AC8%E7%AB%A0-%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%963.1/" class="sidebar-item" aria-label="第 8 章 项目优化 3.1"><!--[--><!--]--> 第 8 章 项目优化 3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83-%E9%83%A8%E7%BD%B2%E9%97%A8%E6%88%B7%E6%96%87%E6%A1%A3/" class="sidebar-item" aria-label="课程发布-部署门户文档 v3.1"><!--[--><!--]--> 课程发布-部署门户文档 v3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E5%BE%AE%E4%BF%A1%E6%89%AB%E7%A0%81%E7%99%BB%E5%BD%95%E9%85%8D%E7%BD%AE/" class="sidebar-item" aria-label="微信扫码登录配置"><!--[--><!--]--> 微信扫码登录配置 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AEv3.1/" class="sidebar-item" aria-label="学成在线项目开发环境配置 v3.1"><!--[--><!--]--> 学成在线项目开发环境配置 v3.1 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E6%94%AF%E4%BB%98%E5%AE%9D%E6%B2%99%E7%AE%B1%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" class="sidebar-item" aria-label="支付宝沙箱环境"><!--[--><!--]--> 支付宝沙箱环境 <!--[--><!--]--></a><!----></li><li><a href="/MyBlog/notes/project/02/%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93/" class="sidebar-item" aria-label="项目总结"><!--[--><!--]--> 项目总结 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="第-5-章-认证授权-v3-1" tabindex="-1"><a class="header-anchor" href="#第-5-章-认证授权-v3-1" aria-hidden="true">#</a> <strong>第 5 章 认证授权 v3.1</strong></h1><nav class="table-of-contents"><ul><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_1-模块需求分析" class="router-link-active router-link-exact-active">1 模块需求分析</a><ul><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_1-1-什么是认证授权" class="router-link-active router-link-exact-active">1.1 什么是认证授权</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_1-2-业务流程" class="router-link-active router-link-exact-active">1.2 业务流程</a></li></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-spring-security-认证研究" class="router-link-active router-link-exact-active">2 Spring Security 认证研究</a><ul><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-1-spring-security-介绍" class="router-link-active router-link-exact-active">2.1 Spring Security 介绍</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-2-认证授权入门" class="router-link-active router-link-exact-active">2.2 认证授权入门</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-3-什么是-oauth2" class="router-link-active router-link-exact-active">2.3 什么是 OAuth2</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-4-jwt" class="router-link-active router-link-exact-active">2.4 JWT</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_2-5-网关认证" class="router-link-active router-link-exact-active">2.5 网关认证</a></li></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_3-用户认证" class="router-link-active router-link-exact-active">3 用户认证</a><ul><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_3-1-需求分析" class="router-link-active router-link-exact-active">3.1 需求分析</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_3-2-连接用户中心数据库" class="router-link-active router-link-exact-active">3.2 连接用户中心数据库</a></li></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_3-3-支持认证方式多样" class="router-link-active router-link-exact-active">3.3 支持认证方式多样</a><ul><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_3-4-验证码服务" class="router-link-active router-link-exact-active">3.4 验证码服务</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_3-5-账号密码认证" class="router-link-active router-link-exact-active">3.5 账号密码认证</a></li></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_4-微信扫码登录" class="router-link-active router-link-exact-active">4 微信扫码登录</a><ul><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_4-1-接入规范" class="router-link-active router-link-exact-active">4.1 接入规范</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_4-2-准备开发环境" class="router-link-active router-link-exact-active">4.2 准备开发环境</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_4-3-接入微信登录" class="router-link-active router-link-exact-active">4.3 接入微信登录</a></li></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_5-用户授权" class="router-link-active router-link-exact-active">5 用户授权</a><ul><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_5-1-rbac" class="router-link-active router-link-exact-active">5.1 RBAC</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_5-2-资源服务授权流程" class="router-link-active router-link-exact-active">5.2 资源服务授权流程</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_5-3-授权相关的数据模型" class="router-link-active router-link-exact-active">5.3 授权相关的数据模型</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_5-4-查询用户权限" class="router-link-active router-link-exact-active">5.4 查询用户权限</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_5-5-授权测试" class="router-link-active router-link-exact-active">5.5 授权测试</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_5-6-细粒度授权" class="router-link-active router-link-exact-active">5.6 细粒度授权</a></li></ul></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_6-实战" class="router-link-active router-link-exact-active">6 实战</a><ul><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_6-1-找回密码-实战" class="router-link-active router-link-exact-active">6.1 找回密码(实战)</a></li><li><a aria-current="page" href="/MyBlog/notes/project/02/%E7%AC%AC5%E7%AB%A0-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83v3.1/#_6-2-注册-实战" class="router-link-active router-link-exact-active">6.2 注册(实战)</a></li></ul></li></ul></nav><h2 id="_1-模块需求分析" tabindex="-1"><a class="header-anchor" href="#_1-模块需求分析" aria-hidden="true">#</a> <strong>1 模块需求分析</strong></h2><h3 id="_1-1-什么是认证授权" tabindex="-1"><a class="header-anchor" href="#_1-1-什么是认证授权" aria-hidden="true">#</a> <strong>1.1 什么是认证授权</strong></h3><p>截至目前，项目已经完成了课程发布功能，课程发布后用户通过在线学习页面点播视频进行学习。如何去记录学生的学习过程呢？要想掌握学生的学习情况就需要知道用户的身份信息，记录哪个用户在什么时间学习什么课程，如果用户要购买课程也需要知道用户的身份信息。所以，去管理学生的学习过程最基本的要实现用户的身份认证。</p><p>认证授权模块实现平台所有用户的身份认证与用户授权功能。</p><blockquote><p>什么是用户身份认证？</p></blockquote><p>用户身份认证即用户去访问系统资源时系统要求验证用户的身份信息，身份合法方可继续访问。常见的用户身份认证的表现形式有：用户名密码登录，微信扫码等方式。</p><p>项目包括学生、学习机构的老师、平台运营人员三类用户，不管哪一类用户在访问项目受保护资源时都需要进行身份认证。比如：发布课程操作，需要学习机构的老师首先登录系统成功，然后再执行发布课程操作。创建订单，需要学生用户首先登录系统，才可以创建订单。如下图：</p><p><img src="/MyBlog/assets/image-20230604180213876-f793b9ca.png" alt="image-20230604180213876"></p><blockquote><p>什么是用户授权？</p></blockquote><p>用户认证通过后去访问系统的资源，系统会判断用户是否拥有访问资源的权限，只允许访问有权限的系统资源，没有权限的资源将无法访问，这个过程叫用户授权。比如：用户去发布课程，系统首先进行用户身份认证，认证通过后继续判断用户是否有发布课程的权限，如果没有权限则拒绝继续访问系统，如果有权限则继续发布课程。如下图：</p><p><img src="/MyBlog/assets/image-20230604180228222-76e5f6ab.png" alt="image-20230604180228222"></p><h3 id="_1-2-业务流程" tabindex="-1"><a class="header-anchor" href="#_1-2-业务流程" aria-hidden="true">#</a> <strong>1.2 业务流程</strong></h3><h4 id="_1-2-1-统一认证" tabindex="-1"><a class="header-anchor" href="#_1-2-1-统一认证" aria-hidden="true">#</a> <strong>1.2.1 统一认证</strong></h4><p>项目包括学生、学习机构的老师、平台运营人员三类用户，三类用户将使用统一的认证入口，如下图：</p><p><img src="/MyBlog/assets/image-20230604180233705-7f1683c2.png" alt="image-20230604180233705"></p><p>用户输入账号和密码提交认证，认证通过则继续操作。</p><p>项目由统一认证服务受理用户的认证请求，如下图：</p><p><img src="/MyBlog/assets/image-20230604180239882-0cdc767b.png" alt="image-20230604180239882"></p><p>认证通过由认证服务向给用户颁发令牌，相当于访问系统的通行证，用户拿着令牌去访问系统的资源。</p><h4 id="_1-2-2-单点登录" tabindex="-1"><a class="header-anchor" href="#_1-2-2-单点登录" aria-hidden="true">#</a> <strong>1.2.2 单点登录</strong></h4><p>本项目基于微服务架构构建，微服务包括：内容管理服务、媒资管理服务、学习中心服务、系统管理服务等，为了提高用户体验性，用户只需要认证一次便可以在多个拥有访问权限的系统中访问，这个功能叫做单点登录。</p><p>引用百度百科：单点登录（Single Sign On），简称为 SSO，是目前比较流行的企业业务整合的解决方案之一。SSO 的定义是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统。</p><p>如下图，用户只需要认证一次，便可以在多个拥有访问权限的系统中访问。</p><p><img src="/MyBlog/assets/image-20230604180246419-a19e5cac.png" alt="image-20230604180246419"></p><h4 id="_1-2-3-第三方认证" tabindex="-1"><a class="header-anchor" href="#_1-2-3-第三方认证" aria-hidden="true">#</a> <strong>1.2.3 第三方认证</strong></h4><p>为了提高用户体验，很多网站有扫码登录的功能，如：微信扫码登录、QQ 扫码登录等。扫码登录的好处是用户不用输入账号和密码，操作简便，另外一个好处就是有利于用户信息的共享，互联网的优势就是资源共享，用户也是一种资源，对于一个新网站如果让用户去注册是很困难的，如果提供了微信扫码登录将省去用户注册的成本，是一种非常有效的推广手段。</p><p>微信扫码登录其中的原理正是使用了第三方认证，如下图：</p><p><img src="/MyBlog/assets/image-20230604180252345-284d646e.png" alt="image-20230604180252345"></p><h2 id="_2-spring-security-认证研究" tabindex="-1"><a class="header-anchor" href="#_2-spring-security-认证研究" aria-hidden="true">#</a> <strong>2 Spring Security 认证研究</strong></h2><h3 id="_2-1-spring-security-介绍" tabindex="-1"><a class="header-anchor" href="#_2-1-spring-security-介绍" aria-hidden="true">#</a> <strong>2.1 Spring Security 介绍</strong></h3><p>认证功能几乎是每个项目都要具备的功能，并且它与业务无关，市面上有很多认证框架，如：Apache Shiro、CAS、Spring Security 等。由于本项目基于 Spring Cloud 技术构建，Spring Security 是 spring 家族的一份子且和 Spring Cloud 集成的很好，所以本项目选用 Spring Security 作为认证服务的技术框架。</p><p>Spring Security 是一个功能强大且高度可定制的身份验证和访问控制框架，它是一个专注于为 Java 应用程序提供身份验证和授权的框架。</p><p>项目主页：https://spring.io/projects/spring-security</p><p>Spring cloud Security： https://spring.io/projects/spring-cloud-security</p><h3 id="_2-2-认证授权入门" tabindex="-1"><a class="header-anchor" href="#_2-2-认证授权入门" aria-hidden="true">#</a> <strong>2.2 认证授权入门</strong></h3><h4 id="_2-2-1-创建认证服务工程" tabindex="-1"><a class="header-anchor" href="#_2-2-1-创建认证服务工程" aria-hidden="true">#</a> <strong>2.2.1 创建认证服务工程</strong></h4><p>下边我们使用 Spring Security 框架快速构建认证授权功能体系。</p><p>1、部署认证服务工程</p><p>从课程资料中拷贝 xuecheng-plus-auth 工程到自己的工程目录下。</p><p>此工程是一个普通的 spring boot 工程，可以连接数据库。</p><p>此工程不具备认证授权的功能。</p><p>2、创建数据库</p><p>创建 xc_users 数据库</p><p>导入课程资料中的 xcplus_users.sql 脚本。</p><p><img src="/MyBlog/assets/image-20230604180303618-3c9d3f04.png" alt="image-20230604180303618"></p><p>在 nacos 中新增 auth-service-dev.yaml：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>
    <span class="token key atrule">context-path</span><span class="token punctuation">:</span> /auth
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">63070</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//.168.101.65<span class="token punctuation">:</span>3306/xc1010_users<span class="token punctuation">?</span>serverTimezone=UTC<span class="token important">&amp;userUnicode=true&amp;useSSL=false&amp;</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> mysql
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>初始工程自带了一个 Controller 类，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>


<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> 测试controller
 * <span class="token keyword">@date</span> 2022/9/27 17:25
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginController</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@Autowired</span>
  <span class="token class-name">XcUserMapper</span> userMapper<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/login-success&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">loginSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

      <span class="token keyword">return</span> <span class="token string">&quot;登录成功&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/user/{id}&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">XcUser</span> <span class="token function">getuser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> xcUser<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/r/r1&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">r1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;访问r1资源&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/r/r2&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">r2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;访问r2资源&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>



<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动工程，尝试访问 http://localhost:63070/auth/r/r1 :</p><p><img src="/MyBlog/assets/image-20230604180335576-e05577f6.png" alt="image-20230604180335576"></p><p>访问用户信息：http://localhost:63070/auth/user/52</p><p><img src="/MyBlog/assets/image-20230604180339915-f2aec087.png" alt="image-20230604180339915"></p><p>以上测试一切正常说明此工程部署成功。</p><h4 id="_2-2-2-认证测试" tabindex="-1"><a class="header-anchor" href="#_2-2-2-认证测试" aria-hidden="true">#</a> <strong>2.2.2 认证测试</strong></h4><p>下边向 auth 认证工程集成 Spring security，向 pom.xml 加入 Spring Security 所需要的依赖</p><blockquote><p>只要一加上依赖 系统就会被 Springsecurity 所管控</p></blockquote><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-oauth2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启工程，访问 http://localhost:63070/auth/r/r1</p><p>自动进入/login 登录页面，/login 是 spring security 提供的,此页面有几个 css 样式加载会稍微慢点，如下图：</p><p><img src="/MyBlog/assets/image-20230604180359263-0c60e8e2.png" alt="image-20230604180359263"></p><p>账号和密码是多少呢？下一步需要进行安全配置。</p><p>拷贝课程资料下的 WebSecurityConfig.java 到 config 下需要三部分内容：</p><p>1、用户信息</p><p>在内存配置两个用户：zhangsan、lisi</p><p>zhangsan 用户拥有的权限为 p1</p><p>lisi 用户拥有的权限为 p2</p><p>2、密码方式</p><p>暂时采用明文方式</p><p>3、安全拦截机制</p><p>/r/**开头的请求需要认证</p><p>登录成功到成功页面</p><p>代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//配置用户信息服务</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">UserDetailsService</span> <span class="token function">userDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//这里配置用户信息,这里暂时使用这种方式将用户存储在内存中</span>
    <span class="token class-name">InMemoryUserDetailsManager</span> manager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryUserDetailsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            manager<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">&quot;zhangsan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">&quot;123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">&quot;p1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    manager<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">&quot;lisi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">&quot;456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">&quot;p2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> manager<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//密码为明文方式</span>
        <span class="token keyword">return</span> <span class="token class-name">NoOpPasswordEncoder</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//配置安全拦截机制</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        http
                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/r/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//访问/r开始的请求需要认证通过</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//其它请求全部放行</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">successForwardUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/login-success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//登录成功跳转到/login-success</span>
                http<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logoutUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/logout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//退出地址</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启工程</p><p>1、访问 http://localhost:63070/auth/user/52 可以正常访问</p><p>2、访问 http://localhost:63070/auth/r/r1 显示登录页面</p><p>账号 zhangsan，密码为 123，如果输入的密码不正确会认证失败，输入正确显示登录成功。</p><blockquote><p>为什么 http://localhost:63070/auth/user/52 可以正常访问，访问 http://localhost:63070/auth/r/r1 显示登录页面？</p></blockquote><p>http.logout().logoutUrl(&quot;/logout&quot;);配置了退出页面，认证成功后访问/logout 可退出登录。</p><h4 id="_2-2-3-授权测试" tabindex="-1"><a class="header-anchor" href="#_2-2-3-授权测试" aria-hidden="true">#</a> <strong>2.2.3 授权测试</strong></h4><p>用户认证通过去访问系统资源时 spring security 进行授权控制，判断用户是否有该资源的访问权限，如果有则继续访问，如果没有则拒绝访问。</p><p>下边测试授权功能：</p><p>1、配置用户拥有哪些权限。</p><p>在 WebSecurityConfig 类配置 zhangsan 拥有 p1 权限，lisi 拥有 p2 权限。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetailsService</span> <span class="token function">userDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//这里配置用户信息,这里暂时使用这种方式将用户存储在内存中</span>
        <span class="token class-name">InMemoryUserDetailsManager</span> manager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryUserDetailsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        manager<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">&quot;zhangsan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">&quot;123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">&quot;p1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        manager<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">&quot;lisi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">&quot;456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">&quot;p2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> manager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、指定资源与权限的关系。</p><p>什么是系统的资源？</p><p>比如：查询一个用户的信息，用户信息就是系统的资源，要访问资源需要通过 URL，所以我们在 controller 中定义的每个 http 的接口就是访问资源的接口。</p><p>下边在 controller 中配置/r/r1 需要 p1 权限，/r/r2 需要 p2 权限。</p><p>hasAuthority(&#39;p1&#39;)表示拥有 p1 权限方可访问。</p><p>代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginController</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/r/r1&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;hasAuthority(&#39;p1&#39;)&quot;</span><span class="token punctuation">)</span><span class="token comment">//拥有p1权限方可访问</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">r1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token string">&quot;访问r1资源&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/r/r2&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;hasAuthority(&#39;p2&#39;)&quot;</span><span class="token punctuation">)</span><span class="token comment">//拥有p2权限方可访问</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">r2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token string">&quot;访问r2资源&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在重启工程。</p><p>当访问以/r/开头的 url 时会判断用户是否认证，如果没有认证则跳转到登录页面，如果已经认证则判断用户是否具有该 URL 的访问权限，如果具有该 URL 的访问权限则继续，否则拒绝访问。</p><p>例如：</p><p>访问/r/r1，使用 zhangsan 登录可以正常访问，因为在/r/r1 的方法上指定了权限 p1，zhangsan 用户拥有权限 p1,所以可以正常访问。</p><p>访问/r/r1，使用 lisi 登录则拒绝访问，由于 lisi 用户不具有权限 p1 需要拒绝访问</p><p>注意：如果访问上不加@PreAuthorize，此方法没有授权控制。</p><p>整理授权的过程见下图所示：</p><p><img src="/MyBlog/assets/image-20230604180455661-fab9254e.png" alt="image-20230604180455661"></p><h4 id="_2-2-4-工作原理" tabindex="-1"><a class="header-anchor" href="#_2-2-4-工作原理" aria-hidden="true">#</a> <strong>2.2.4 工作原理</strong></h4><p>通过测试认证和授权两个功能，我们了解了 Spring Security 的基本使用方法，下边了解它的工作流程。</p><p>Spring Security 所解决的问题就是<strong>安全访问控制</strong>，而安全访问控制功能其实就是对所有进入系统的请求进行拦截，校验每个请求是否能够访问它所期望的资源。根据前边知识的学习，可以通过 Filter 或 AOP 等技术来实现，Spring Security 对 Web 资源的保护是靠 Filter 实现的，所以从这个 Filter 来入手，逐步深入 Spring Security 原理。</p><p>当初始化 Spring Security 时，会创建一个名为 SpringSecurityFilterChain 的 Servlet 过滤器，类型为 org.springframework.security.web.FilterChainProxy，它实现了 javax.servlet.Filter，因此外部的请求会经过此类，下图是 Spring Security 过虑器链结构图：</p><p><img src="/MyBlog/assets/image-20230604180502578-98f612f5.png" alt="image-20230604180502578"></p><p>FilterChainProxy 是一个代理，真正起作用的是 FilterChainProxy 中 SecurityFilterChain 所包含的各个 Filter，同时这些 Filter 作为 Bean 被 Spring 管理，它们是 Spring Security 核心，各有各的职责，但他们并不直接处理用户的<strong>认证</strong>，也不直接处理用户的<strong>授权</strong>，而是把它们交给了认证管理器（AuthenticationManager）和决策管理器（AccessDecisionManager）进行处理。</p><p>spring Security 功能的实现主要是由一系列过滤器链相互配合完成。</p><p><img src="/MyBlog/assets/image-20230604180509698-9f02dd04.png" alt="image-20230604180509698"></p><p>下面介绍过滤器链中主要的几个过滤器及其作用：</p><p><strong>SecurityContextPersistenceFilter</strong> 这个 Filter 是整个拦截过程的入口和出口（也就是第一个和最后一个拦截器），会在请求开始时从配置好的 SecurityContextRepository 中获取 SecurityContext，然后把它设置给 SecurityContextHolder。在请求完成后将 SecurityContextHolder 持有的 SecurityContext 再保存到配置好的 SecurityContextRepository，同时清除 securityContextHolder 所持有的 SecurityContext；</p><p><strong>UsernamePasswordAuthenticationFilter</strong> 用于处理来自表单提交的认证。该表单必须提供对应的用户名和密码，其内部还有登录成功或失败后进行处理的 AuthenticationSuccessHandler 和 AuthenticationFailureHandler，这些都可以根据需求做相关改变；</p><p><strong>FilterSecurityInterceptor</strong> 是用于保护 web 资源的，使用 AccessDecisionManager 对当前用户进行授权访问，前面已经详细介绍过了；</p><p><strong>ExceptionTranslationFilter</strong> 能够捕获来自 FilterChain 所有的异常，并进行处理。但是它只会处理两类异常：AuthenticationException 和 AccessDeniedException，其它的异常它会继续抛出。</p><p>Spring Security 的执行流程如下：</p><p><img src="/MyBlog/assets/image-20230604180517699-2ce2e59f.png" alt="image-20230604180517699"></p><p>用户提交用户名、密码被 SecurityFilterChain 中的 UsernamePasswordAuthenticationFilter 过滤器获取到，封装为请求 Authentication，通常情况下是 UsernamePasswordAuthenticationToken 这个实现类。</p><p>然后过滤器将 Authentication 提交至认证管理器（AuthenticationManager）进行认证</p><p>认证成功后，AuthenticationManager 身份管理器返回一个被填充满了信息的（包括上面提到的权限信息，身份信息，细节信息，但密码通常会被移除）Authentication 实例。</p><p>SecurityContextHolder 安全上下文容器将第 3 步填充了信息的 Authentication，通过 SecurityContextHolder.getContext().setAuthentication(…)方法，设置到其中。</p><p>可以看出 AuthenticationManager 接口（认证管理器）是认证相关的核心接口，也是发起认证的出发点，它的实现类为 ProviderManager。而 Spring Security 支持多种认证方式，因此 ProviderManager 维护着一个 List&lt;AuthenticationProvider&gt;列表，存放多种认证方式，最终实际的认证工作是由 AuthenticationProvider 完成的。咱们知道 web 表单的对应的 AuthenticationProvider 实现类为 DaoAuthenticationProvider，它的内部又维护着一个 UserDetailsService 负责 UserDetails 的获取。最终 AuthenticationProvider 将 UserDetails 填充至 Authentication。</p><h3 id="_2-3-什么是-oauth2" tabindex="-1"><a class="header-anchor" href="#_2-3-什么是-oauth2" aria-hidden="true">#</a> <strong>2.3 什么是 OAuth2</strong></h3><h4 id="_2-3-1-oauth2-认证流程" tabindex="-1"><a class="header-anchor" href="#_2-3-1-oauth2-认证流程" aria-hidden="true">#</a> <strong>2.3.1 OAuth2 认证流程</strong></h4><p>在前边我们提到微信扫码认证，这是一种第三方认证的方式，这种认证方式是基于 OAuth2 协议实现，</p><p>OAUTH 协议为用户资源的授权提供了一个安全的、开放而又简易的标准。同时，任何第三方都可以使用 OAUTH 认证服务，任何服务提供商都可以实现自身的 OAUTH 认证服务，因而 OAUTH 是开放的。业界提供了 OAUTH 的多种实现如 PHP、JavaScript，Java，Ruby 等各种语言开发包，大大节约了程序员的时间，因而 OAUTH 是简易的。互联网很多服务如 Open API，很多大公司如 Google，Yahoo，Microsoft 等都提供了 OAUTH 认证服务，这些都足以说明 OAUTH 标准逐渐成为开放资源授权的标准。</p><p>Oauth 协议目前发展到 2.0 版本，1.0 版本过于复杂，2.0 版本已得到广泛应用。</p><p>参考：<a href="https://baike.baidu.com/item/oAuth/7153134?fr=aladdin" target="_blank" rel="noopener noreferrer">https://baike.baidu.com/item/oAuth/7153134?fr=aladdin<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>Oauth 协议：<a href="https://tools.ietf.org/html/rfc6749" target="_blank" rel="noopener noreferrer">https://tools.ietf.org/html/rfc6749<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>下边分析一个 Oauth2 认证的例子，黑马程序员网站使用微信认证扫码登录的过程：</p><p><img src="/MyBlog/assets/image-20230604180528863-b5c2b918.png" alt="image-20230604180528863"></p><p>具体流程如下：</p><p>1、用户点击微信扫码</p><p>用户进入黑马程序的登录页面，点击微信的图标开打微信扫码界面。</p><p><img src="/MyBlog/assets/image-20230604180535057-1534abc3.png" alt="image-20230604180535057"></p><p><img src="/MyBlog/assets/image-20230604180541510-7e351d1a.png" alt="image-20230604180541510"></p><p>微信扫码的目的是通过微信认证登录黑马程序员官网，黑马程序员网站需要从微信获取当前用户的身份信息才会让当前用户在黑马网站登录成功。</p><p>现在搞清楚几个概念：</p><p>资源：用户信息，在微信中存储。</p><p>资源拥有者：用户是用户信息资源的拥有者。</p><p>认证服务：微信负责认证当前用户的身份，负责为客户端颁发令牌。</p><p>客户端：客户端会携带令牌请求微信获取用户信息，黑马程序员网站即客户端，黑马网站需要在浏览器打开。</p><p>2、用户授权黑马网站访问用户信息</p><p>资源拥有者扫描二维码表示资源拥有者请求微信进行认证，微信认证通过向用户手机返回授权页面，如下图：</p><p><img src="/MyBlog/assets/image-20230604180551007-875f9228.png" alt="image-20230604180551007"></p><p>询问用户是否授权黑马程序员访问自己在微信的用户信息，用户点击“确认登录”表示同意授权，微信认证服务器会颁发一个授权码给黑马程序员的网站。</p><p>只有资源拥有者同意微信才允许黑马网站访问资源。</p><p>3、黑马程序员的网站获取到授权码</p><p>4、携带授权码请求微信认证服务器申请令牌</p><p>此交互过程用户看不到。</p><p>5、微信认证服务器向黑马程序员的网站响应令牌</p><p>此交互过程用户看不到。</p><p>6、黑马程序员网站请求微信资源服务器获取资源即用户信息。</p><p>黑马程序员网站携带令牌请求访问微信服务器获取用户的基本信息。</p><p>7、资源服务器返回受保护资源即用户信息</p><p>8、黑马网站接收到用户信息，此时用户在黑马网站登录成功。</p><p>理解了微信扫码登录黑马网站的流程，接下来认识 Oauth2.0 的认证流程，如下：</p><p>引自 Oauth2.0 协议 rfc6749 <a href="https://tools.ietf.org/html/rfc6749" target="_blank" rel="noopener noreferrer">https://tools.ietf.org/html/rfc6749<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><img src="/MyBlog/assets/image-20230604180558722-9816be29.png" alt="image-20230604180558722"></p><p>Oauth2 包括以下角色：</p><p>1、客户端</p><p>本身不存储资源，需要通过资源拥有者的授权去请求资源服务器的资源，比如：手机客户端、浏览器等。</p><p>上边示例中黑马网站即为客户端，它需要通过浏览器打开。</p><p>2、资源拥有者</p><p>通常为用户，也可以是应用程序，即该资源的拥有者。</p><p>A 表示 客户端请求资源拥有者授权。</p><p>B 表示 资源拥有者授权客户端即黑马网站访问自己的用户信息。</p><p>3、授权服务器（也称认证服务器）</p><p>认证服务器对资源拥有者进行认证，还会对客户端进行认证并颁发令牌。</p><p>C 客户端即黑马网站携带授权码请求认证。</p><p>D 认证通过颁发令牌。</p><p>4、资源服务器</p><p>存储资源的服务器。</p><p>E 表示客户端即黑马网站携带令牌请求资源服务器获取资源。</p><p>F 表示资源服务器校验令牌通过后提供受保护资源。</p><h4 id="_2-3-2-oauth2-在本项目的应用" tabindex="-1"><a class="header-anchor" href="#_2-3-2-oauth2-在本项目的应用" aria-hidden="true">#</a> <strong>2.3.2 OAuth2 在本项目的应用</strong></h4><p>Oauth2 是一个标准的开放的授权协议，应用程序可以根据自己的要求去使用 Oauth2，本项目使用 Oauth2 实现如下目标：</p><p>1、学成在线访问第三方系统的资源。</p><p>本项目要接入微信扫码登录所以本项目要使用 OAuth2 协议访问微信中的用户信息。</p><p>2、外部系统访问学成在线的资源 。</p><p>同样当第三方系统想要访问学成在线网站的资源也可以基于 OAuth2 协议。</p><p>3、学成在线前端（客户端） 访问学成在线微服务的资源。</p><p>本项目是前后端分离架构，前端访问微服务资源也可以基于 OAuth2 协议进行认证。</p><h4 id="_2-3-3-oauth2-的授权模式" tabindex="-1"><a class="header-anchor" href="#_2-3-3-oauth2-的授权模式" aria-hidden="true">#</a> <strong>2.3.3 OAuth2 的授权模式</strong></h4><p>Spring Security 支持 OAuth2 认证，OAuth2 提供授权码模式、密码模式、简化模式、客户端模式等四种授权模式，前边举的微信扫码登录的例子就是基于授权码模式，这四种模式中授权码模式和密码模式应用较多，本节使用 Spring Security 演示授权码模式、密码模式，其余两种请自行查阅相关资料。</p><h5 id="_2-3-3-1-授权码模式" tabindex="-1"><a class="header-anchor" href="#_2-3-3-1-授权码模式" aria-hidden="true">#</a> <strong>2.3.3.1 授权码模式</strong></h5><p>OAuth2 的几个授权模式是根据不同的应用场景以不同的方式去获取令牌，最终目的是要获取认证服务颁发的令牌，最终通过令牌去获取资源。</p><p>授权码模式简单理解是使用授权码去获取令牌，要想获取令牌先要获取授权码，授权码的获取需要资源拥有者亲自授权同意才可以获取。</p><p>下图是授权码模式的交互图：</p><p><img src="/MyBlog/assets/image-20230604180611293-9693c8bd.png" alt="image-20230604180611293"></p><p>还以黑马网站微信扫码登录为例进行说明：</p><p>1、用户打开浏览器。</p><p>2、通过浏览器访问客户端即黑马网站。</p><p>3、用户通过浏览器向认证服务请求授权，请求授权时会携带客户端的 URL，此 URL 为下发授权码的重定向地址。</p><p>4、认证服务向资源拥有者返回授权页面。</p><p>5、资源拥有者亲自授权同意。</p><p>6、通过浏览器向认证服务发送授权同意。</p><p>7、认证服务向客户端地址重定向并携带授权码。</p><p>8、客户端即黑马网站收到授权码。</p><p>9、客户端携带授权码向认证服务申请令牌。</p><p>10、认证服务向客户端颁发令牌。</p><h5 id="_2-3-3-2-授权码模式测试" tabindex="-1"><a class="header-anchor" href="#_2-3-3-2-授权码模式测试" aria-hidden="true">#</a> <strong>2.3.3.2 授权码模式测试</strong></h5><p>要想测试授权模式首先要配置授权服务器即上图中的认证服务器，需要配置授权服务及令牌策略。</p><p>1、从课程资料中拷贝 AuthorizationServer.java、TokenConfig.java 到认证服务的 config 包下。</p><p>说明：AuthorizationServer 用 @EnableAuthorizationServer 注解标识并继承 AuthorizationServerConfigurerAdapter 来配置 OAuth2.0 授权服务器。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>
<span class="token operator">*</span><span class="token operator">/</span>
 <span class="token annotation punctuation">@Configuration</span>
 <span class="token annotation punctuation">@EnableAuthorizationServer</span>
 <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationServer</span> <span class="token keyword">extends</span> <span class="token class-name">AuthorizationServerConfigurerAdapter</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AuthorizationServerConfigurerAdapter 要求配置以下几个类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationServerConfigurerAdapter</span> <span class="token keyword">implements</span> <span class="token class-name">AuthorizationServerConfigurer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthorizationServerConfigurerAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerSecurityConfigurer</span> security<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ClientDetailsServiceConfigurer</span> clients<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerEndpointsConfigurer</span> endpoints<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>1）ClientDetailsServiceConfigurer</strong>：用来配置客户端详情服务（ClientDetailsService），</p><p>随便一个客户端都可以随便接入到它的认证服务吗？答案是否定的，服务提供商会给批准接入的客户端一个身份，用于接入时的凭据，有客户端标识和客户端秘钥，在这里配置批准接入的客户端的详细信息。</p><p><strong>2）AuthorizationServerEndpointsConfigurer</strong>：用来配置令牌（token）的访问端点和令牌服务(token services)。</p><p><strong>3）AuthorizationServerSecurityConfigurer</strong>：用来配置令牌端点的安全约束.</p><p>2、TokenConfig 为令牌策略配置类</p><p>暂时先使用 InMemoryTokenStore 在内存存储令牌，令牌的有效期等信息配置如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token comment">//令牌管理服务</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;authorizationServerTokenServicesCustom&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthorizationServerTokenServices</span> <span class="token function">tokenService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DefaultTokenServices</span> service<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">DefaultTokenServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        service<span class="token punctuation">.</span><span class="token function">setSupportRefreshToken</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//支持刷新令牌</span>
        service<span class="token punctuation">.</span><span class="token function">setTokenStore</span><span class="token punctuation">(</span>tokenStore<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//令牌存储策略</span>
        service<span class="token punctuation">.</span><span class="token function">setAccessTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">7200</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 令牌默认有效期2小时</span>
        service<span class="token punctuation">.</span><span class="token function">setRefreshTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">259200</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 刷新令牌默认有效期3天</span>
        <span class="token keyword">return</span> service<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3、配置认证管理 bean</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthenticationManager</span> <span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启认证服务</p><p>1、get 请求获取授权码</p><p>地址: http://localhost:63070/auth/oauth/authorize?client_id=XcWebApp&amp;response_type=code&amp;scope=all&amp;redirect_uri=http://www.51xuecheng.cn</p><p>参数列表如下：</p><p>client_id：客户端准入标识。</p><p>response_type：授权码模式固定为 code。</p><p>scope：客户端权限。</p><p>redirect_uri：跳转 uri，当授权码申请成功后会跳转到此地址，并在后边带上 code 参数（授权码）。</p><blockquote><p>输入账号 zhangsan、密码 123 登录成功，输入/oauth/authorize?client_id=XcWebApp&amp;response_type=code&amp;scope=all&amp;redirect_uri=http://www.51xuecheng.cn</p></blockquote><p>显示授权页面</p><p><img src="/MyBlog/assets/image-20230604180703888-00157902.png" alt="image-20230604180703888"></p><p>授权“XcWebApp”访问自己的受保护资源?</p><p>选择同意。</p><p>2、请求成功，重定向至http://www.51xuecheng.cn/?code=授权码，比如：http://www.51xuecheng.cn/?code=Wqjb5H</p><p>3、使用 httpclient 工具 post 申请令牌</p><blockquote><p>/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=authorization_code&amp;code=授权码&amp;redirect_uri=http://www.51xuecheng.cn/</p></blockquote><p>参数列表如下</p><p>client_id：客户端准入标识。</p><p>client_secret：客户端秘钥。</p><p>grant_type：授权类型，填写 authorization_code，表示授权码模式</p><p>code：授权码，就是刚刚获取的授权码，注意：授权码只使用一次就无效了，需要重新申请。</p><p>redirect_uri：申请授权码时的跳转 url，一定和申请授权码时用的 redirect_uri 一致。</p><p>httpclient 脚本如下：</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>#### 授权码模式
#### 第一步申请授权码(浏览器请求)/oauth/authorize?client_id=c1&amp;response_type=code&amp;scope=all&amp;redirect_uri=http://www.51xuecheng.cn
#### 第二步申请令牌
POST {{auth_host}}/auth/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=authorization_code&amp;code=CTvCrB&amp;redirect_uri=http://www.51xuecheng.cn

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>申请令牌成功如下所示：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;access_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;368b1ee7-a9ee-4e9a-aae6-0fcab243aad2&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;token_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bearer&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;refresh_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3d56e139-0ee6-4ace-8cbe-1311dfaa991f&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;expires_in&quot;</span><span class="token operator">:</span> <span class="token number">7199</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scope&quot;</span><span class="token operator">:</span> <span class="token string">&quot;all&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明：</p><p>1、access_token，访问令牌，用于访问资源使用。</p><p>2、token_type，bearer 是在 RFC6750 中定义的一种 token 类型，在携带令牌访问资源时需要在 head 中加入 bearer 空格 令牌内容</p><p>3、refresh_token，当令牌快过期时使用刷新令牌可以再次生成令牌。</p><p>4、expires_in：过期时间（秒）</p><p>5、scope，令牌的权限范围，服务端可以根据令牌的权限范围去对令牌授权。</p><h5 id="_2-3-3-3-密码模式" tabindex="-1"><a class="header-anchor" href="#_2-3-3-3-密码模式" aria-hidden="true">#</a> <strong>2.3.3.3 密码模式</strong></h5><p>密码模式相对授权码模式简单，授权码模式需要借助浏览器供用户亲自授权，密码模式不用借助浏览器，如下图：</p><p><img src="/MyBlog/assets/image-20230604180746941-0d2dc6fd.png" alt="image-20230604180746941"></p><p>1、资源拥有者提供账号和密码</p><p>2、客户端向认证服务申请令牌，请求中携带账号和密码</p><p>3、认证服务校验账号和密码正确颁发令牌。</p><p>开始测试：</p><p>1、POST 请求获取令牌</p><p>/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=shangsan&amp;password=123</p><p>参数列表如下：</p><p>client_id：客户端准入标识。</p><p>client_secret：客户端秘钥。</p><p>grant_type：授权类型，填写 password 表示密码模式</p><p>username：资源拥有者用户名。</p><p>password：资源拥有者密码。</p><p>2、授权服务器将令牌（access_token）发送给 client</p><p>使用 httpclient 进行测试</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>#### 密码模式
POST {{auth_host}}/auth/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=zhangsan&amp;password=123

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>返回示例：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;access_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;368b1ee7-a9ee-4e9a-aae6-0fcab243aad2&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;token_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bearer&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;refresh_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3d56e139-0ee6-4ace-8cbe-1311dfaa991f&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;expires_in&quot;</span><span class="token operator">:</span> <span class="token number">6806</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scope&quot;</span><span class="token operator">:</span> <span class="token string">&quot;all&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这种模式十分简单，但是却意味着直接将用户敏感信息泄漏给了 client，因此这就说明这种模式只能用于 client 是我们自己开发的情况下。</p><h5 id="_2-3-3-4-本项目的应用方式" tabindex="-1"><a class="header-anchor" href="#_2-3-3-4-本项目的应用方式" aria-hidden="true">#</a> <strong>2.3.3.4 本项目的应用方式</strong></h5><p>通过演示授权码模式和密码模式，授权码模式适合客户端和认证服务非同一个系统的情况，所以本项目使用授权码模式完成微信扫码认证。本项目采用密码模式作为前端请求微服务的认证方式。</p><h3 id="_2-4-jwt" tabindex="-1"><a class="header-anchor" href="#_2-4-jwt" aria-hidden="true">#</a> <strong>2.4 JWT</strong></h3><h4 id="_2-4-1-普通令牌的问题" tabindex="-1"><a class="header-anchor" href="#_2-4-1-普通令牌的问题" aria-hidden="true">#</a> <strong>2.4.1 普通令牌的问题</strong></h4><p>客户端申请到令牌，接下来客户端携带令牌去访问资源，到资源服务器将会校验令牌的合法性。</p><p>资源服务器如何校验令牌的合法性？</p><p>我们以 OAuth2 的密码模式为例进行说明：</p><p><img src="/MyBlog/assets/image-20230604180830380-13a0a576.png" alt="image-20230604180830380"></p><p>从第 4 步开始说明：</p><p>1、客户端携带令牌访问资源服务获取资源。</p><p>2、资源服务远程请求认证服务校验令牌的合法性</p><p>3、如果令牌合法资源服务向客户端返回资源。</p><p>这里存在一个问题：</p><p>就是校验令牌需要远程请求认证服务，客户端的每次访问都会远程校验，执行性能低。</p><p>如果能够让资源服务自己校验令牌的合法性将省去远程请求认证服务的成本，提高了性能。如下图：</p><p><img src="/MyBlog/assets/image-20230604180837219-8a7ce0ff.png" alt="image-20230604180837219"></p><blockquote><p>如何解决上边的问题，实现资源服务自行校验令牌。</p></blockquote><p>令牌采用 JWT 格式即可解决上边的问题，用户认证通过后会得到一个 JWT 令牌，JWT 令牌中已经包括了用户相关的信息，客户端只需要携带 JWT 访问资源服务，资源服务根据事先约定的算法自行完成令牌校验，无需每次都请求认证服务完成授权。</p><h4 id="_2-4-2-什么是-jwt" tabindex="-1"><a class="header-anchor" href="#_2-4-2-什么是-jwt" aria-hidden="true">#</a> <strong>2.4.2 什么是 JWT</strong></h4><p>什么是 JWT？</p><p>JSON Web Token（JWT）是一种使用 JSON 格式传递数据的网络令牌技术，它是一个开放的行业标准（RFC 7519），它定义了一种简洁的、自包含的协议格式，用于在通信双方传递 json 对象，传递的信息经过数字签名可以被验证和信任，它可以使用 HMAC 算法或使用 RSA 的公钥/私钥对来签名，防止内容篡改。官网：<a href="https://jwt.io/" target="_blank" rel="noopener noreferrer">https://jwt.io/<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>使用 JWT 可以实现无状态认证，<code>什么是无状态认证？</code></p><p>传统的基于 session 的方式是有状态认证，用户登录成功将用户的身份信息存储在服务端，这样加大了服务端的存储压力，并且这种方式不适合在分布式系统中应用。</p><p>如下图，当用户访问应用服务，每个应用服务都会去服务器查看 session 信息，如果 session 中没有该用户则说明用户没有登录，此时就会重新认证，而解决这个问题的方法是 Session 复制、Session 黏贴。</p><p><img src="/MyBlog/assets/image-20230604180906559-83538ea5.png" alt="image-20230604180906559"></p><p>如果是基于令牌技术在分布式系统中实现认证则服务端不用存储 session，可以将用户身份信息存储在令牌中，用户认证通过后认证服务颁发令牌给用户，用户将令牌存储在客户端，去访问应用服务时携带令牌去访问，服务端从 jwt 解析出用户信息。这个过程就是无状态认证。</p><p><img src="/MyBlog/assets/image-20230604180911465-411ddfe2.png" alt="image-20230604180911465"></p><p>JWT 令牌的优点：</p><p>1、jwt 基于 json，非常方便解析。</p><p>2、可以在令牌中自定义丰富的内容，易扩展。</p><p>3、通过非对称加密算法及数字签名技术，JWT 防止篡改，安全性高。</p><p>4、资源服务使用 JWT 可不依赖认证服务即可完成授权。</p><p>缺点：</p><p>１、JWT 令牌较长，占存储空间比较大。</p><p>下边是一个 JWT 令牌的示例：</p><div class="language-tex line-numbers-mode" data-ext="tex"><pre class="language-tex"><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE2NjQyNTQ2NzIsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6Ijg4OTEyYjJkLTVkMDUtNGMxNC1iYmMzLWZkZTk5NzdmZWJjNiIsImNsaWVudF9pZCI6ImMxIn0.wkDBL7roLrvdBG2oGnXeoXq-zZRgE9IVV2nxd-ez_oA

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>JWT 令牌由三部分组成，每部分中间使用点（.）分隔，比如：xxxxx.yyyyy.zzzzz</p><p>Header</p><p>头部包括令牌的类型（即 JWT）及使用的哈希算法（如 HMAC SHA256 或 RSA）</p><p>一个例子如下：</p><p>下边是 Header 部分的内容</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;alg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HS256&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;typ&quot;</span><span class="token operator">:</span> <span class="token string">&quot;JWT&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将上边的内容使用 Base64Url 编码，得到一个字符串就是 JWT 令牌的第一部分。</p><p>Payload</p><p>第二部分是负载，内容也是一个 json 对象，它是存放有效信息的地方，它可以存放 jwt 提供的信息字段，比如：iss（签发者）,exp（过期时间戳）, sub（面向的用户）等，也可自定义字段。</p><p>此部分不建议存放敏感信息，因为此部分可以解码还原原始内容。</p><p>最后将第二部分负载使用 Base64Url 编码，得到一个字符串就是 JWT 令牌的第二部分。</p><p>一个例子：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;sub&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1234567890&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;456&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;admin&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Signature</p><p>第三部分是签名，此部分用于防止 jwt 内容被篡改。</p><p>这个部分使用 base64url 将前两部分进行编码，编码后使用点（.）连接组成字符串，最后使用 header 中声明的签名算法进行签名。</p><p>一个例子：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>  HMACSHA256(
    base64UrlEncode(header) + <span class="token string">&quot;.&quot;</span> +
    base64UrlEncode(payload)<span class="token punctuation">,</span>
    secret)

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>base64UrlEncode(header)：jwt 令牌的第一部分。</p><p>base64UrlEncode(payload)：jwt 令牌的第二部分。</p><p>secret：签名所使用的密钥。</p><blockquote><p>为什么 JWT 可以防止篡改？</p></blockquote><p>第三部分使用签名算法对第一部分和第二部分的内容进行签名，常用的签名算法是 HS256，常见的还有 md5,sha 等，签名算法需要使用密钥进行签名，密钥不对外公开，并且签名是不可逆的，如果第三方更改了内容那么服务器验证签名就会失败，要想保证验证签名正确必须保证内容、密钥与签名前一致。</p><p><img src="/MyBlog/assets/image-20230604181025173-557d683a.png" alt="image-20230604181025173"></p><p>从上图可以看出认证服务和资源服务使用相同的密钥，这叫对称加密，对称加密效率高，如果一旦密钥泄露可以伪造 jwt 令牌。</p><p>JWT 还可以使用非对称加密，认证服务自己保留私钥，将公钥下发给受信任的客户端、资源服务，公钥和私钥是配对的，成对的公钥和私钥才可以正常加密和解密，非对称加密效率低但相比对称加密非对称加密更安全一些。</p><h4 id="_2-4-3-测试生成-jwt-令牌" tabindex="-1"><a class="header-anchor" href="#_2-4-3-测试生成-jwt-令牌" aria-hidden="true">#</a> <strong>2.4.3 测试生成 JWT 令牌</strong></h4><p>在认证服务中配置 jwt 令牌服务，即可实现生成 jwt 格式的令牌,</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span></span><span class="token class-name">AuthorizationServerTokenServices</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span></span><span class="token class-name">DefaultTokenServices</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span></span><span class="token class-name">TokenEnhancerChain</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span></span><span class="token class-name">TokenStore</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span>store<span class="token punctuation">.</span></span><span class="token class-name">InMemoryTokenStore</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span>store<span class="token punctuation">.</span></span><span class="token class-name">JwtAccessTokenConverter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span>store<span class="token punctuation">.</span></span><span class="token class-name">JwtTokenStore</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Administrator
 * <span class="token keyword">@version</span> 1.0
 **/</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenConfig</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token constant">SIGNING_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;mq123&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">TokenStore</span> tokenStore<span class="token punctuation">;</span>

<span class="token comment">//    @Bean</span>
<span class="token comment">//    public TokenStore tokenStore() {</span>
<span class="token comment">//        //使用内存存储令牌（普通令牌）</span>
<span class="token comment">//        return new InMemoryTokenStore();</span>
<span class="token comment">//    }</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JwtAccessTokenConverter</span> accessTokenConverter<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TokenStore</span> <span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JwtTokenStore</span><span class="token punctuation">(</span><span class="token function">accessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">JwtAccessTokenConverter</span> <span class="token function">accessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">JwtAccessTokenConverter</span> converter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        converter<span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span><span class="token constant">SIGNING_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> converter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//令牌管理服务</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;authorizationServerTokenServicesCustom&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthorizationServerTokenServices</span> <span class="token function">tokenService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DefaultTokenServices</span> service<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">DefaultTokenServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        service<span class="token punctuation">.</span><span class="token function">setSupportRefreshToken</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//支持刷新令牌</span>
        service<span class="token punctuation">.</span><span class="token function">setTokenStore</span><span class="token punctuation">(</span>tokenStore<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//令牌存储策略</span>

        <span class="token class-name">TokenEnhancerChain</span> tokenEnhancerChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TokenEnhancerChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokenEnhancerChain<span class="token punctuation">.</span><span class="token function">setTokenEnhancers</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>accessTokenConverter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        service<span class="token punctuation">.</span><span class="token function">setTokenEnhancer</span><span class="token punctuation">(</span>tokenEnhancerChain<span class="token punctuation">)</span><span class="token punctuation">;</span>

        service<span class="token punctuation">.</span><span class="token function">setAccessTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">7200</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 令牌默认有效期2小时</span>
        service<span class="token punctuation">.</span><span class="token function">setRefreshTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">259200</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 刷新令牌默认有效期3天</span>
        <span class="token keyword">return</span> service<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启认证服务。</p><p>使用 httpclient 通过密码模式申请令牌</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>#### 密码模式
POST {{auth_host}}/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=zhangsan&amp;password=123

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>生成 jwt 的示例如下：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;access_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE2NjQzMzE2OTUsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6ImU5ZDNkMGZkLTI0Y2ItNDRjOC04YzEwLTI1NmIzNGY4ZGZjYyIsImNsaWVudF9pZCI6ImMxIn0.-9SKI-qUqKhKcs8Gb80Rascx-JxqsNZxxXoPo82d8SM&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;token_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bearer&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;refresh_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJhdGkiOiJlOWQzZDBmZC0yNGNiLTQ0YzgtOGMxMC0yNTZiMzRmOGRmY2MiLCJleHAiOjE2NjQ1ODM2OTUsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6ImRjNTRjNTRkLTA0YTMtNDIzNS04MmY3LTFkOWZkMmFjM2VmNSIsImNsaWVudF9pZCI6ImMxIn0.Wsw1Jc-Kd_GFqEugzdfoSsMY6inC8OQsraA21WjWtT8&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;expires_in&quot;</span><span class="token operator">:</span> <span class="token number">7199</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scope&quot;</span><span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;jti&quot;</span><span class="token operator">:</span> <span class="token string">&quot;e9d3d0fd-24cb-44c8-8c10-256b34f8dfcc&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1、access_token，生成的 jwt 令牌，用于访问资源使用。</p><p>2、token_type，bearer 是在 RFC6750 中定义的一种 token 类型，在携带 jwt 访问资源时需要在 head 中加入 bearer jwt 令牌内容</p><p>3、refresh_token，当 jwt 令牌快过期时使用刷新令牌可以再次生成 jwt 令牌。</p><p>4、expires_in：过期时间（秒）</p><p>5、scope，令牌的权限范围，服务端可以根据令牌的权限范围去对令牌授权。</p><p>6、jti：令牌的唯一标识。</p><p>我们可以通过 check_token 接口校验 jwt 令牌</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>####校验jwt令牌
POST {{auth_host}}/oauth/check_token?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJzdHUxIiwic2NvcGUiOlsiYWxsIl0sImV4cCI6MTY2NDM3MTc4MCwiYXV0aG9yaXRpZXMiOlsicDEiXSwianRpIjoiZjBhM2NkZWItMzk5ZC00OGYwLTg4MDQtZWNhNjM4YWQ4ODU3IiwiY2xpZW50X2lkIjoiYzEifQ.qy46CSCJsH3eXWTHgdcntZhzcSzfRQlBU0dxAjZcsUw

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>响应示例如下：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;aud&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;res1&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;user_name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;zhangsan&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scope&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;all&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;active&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;exp&quot;</span><span class="token operator">:</span> <span class="token number">1664371780</span><span class="token punctuation">,</span>
  <span class="token property">&quot;authorities&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;p1&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;jti&quot;</span><span class="token operator">:</span> <span class="token string">&quot;f0a3cdeb-399d-48f0-8804-eca638ad8857&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;client_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;c1&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-4-4-携带令牌访问资源服务" tabindex="-1"><a class="header-anchor" href="#_2-4-4-携带令牌访问资源服务" aria-hidden="true">#</a> <strong>2.4.4 携带令牌访问资源服务</strong></h4><p>拿到了 jwt 令牌下一步就要携带令牌去访问资源服务中的资源，本项目各个微服务就是资源服务，比如：内容管理服务，客户端申请到 jwt 令牌，携带 jwt 去内容管理服务查询课程信息，此时内容管理服务要对 jwt 进行校验，只有 jwt 合法才可以继续访问。如下图：</p><p><img src="/MyBlog/assets/image-20230604181145053-f16844f4.png" alt="image-20230604181145053"></p><p>1、在内容管理服务的 content-api 工程中添加依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--认证相关--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-oauth2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、从资料中拷贝 资源服务配置类 中的 TokenConfig 和 ResouceServerConfig 到内容管理的 api 工程的 config 包下。</p><p>可以在 ResouceServerConfig 类中配置需要认证的 url。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
 http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/r/**&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/course/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//所有/r/**的请求必须认证通过</span>
         <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启内容管理服务</p><p>使用 httpclient 测试：</p><p>1、访问根据课程 id 查询课程接口</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>#### 查询课程信息
GET http://localhost:63040/content/course/2

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>返回：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;error&quot;</span><span class="token operator">:</span> <span class="token string">&quot;unauthorized&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;error_description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Full authentication is required to access this resource&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从返回信息可知当前没有认证。</p><p>下边携带 JWT 令牌访问接口：</p><p>1、申请 jwt 令牌</p><p>采用密码模式申请令牌。</p><p>2、携带 jwt 令牌访问资源服务地址</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>#### 携带token访问资源服务
GET http://localhost:63040/content/course/2
<span class="token header"><span class="token header-name keyword">Authorization</span><span class="token punctuation">:</span> <span class="token header-value">Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE2NjQzMzM0OTgsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6IjhhM2M2OTk1LWU1ZGEtNDQ1Yy05ZDAyLTEwNDFlYzk3NTkwOSIsImNsaWVudF9pZCI6ImMxIn0.73eNDxTX5ifttGCjwc7xrd-Sbp_mCfcIerI3lGetZto</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在请求头中添加 Authorization，内容为 Bearer 令牌，Bearer 用于通过 oauth2.0 协议访问资源。</p><p>如果携带 jwt 令牌且 jwt 正确则正常访问资源服务的内容。</p><p>如果不正确则报令牌无效的错误：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;error&quot;</span><span class="token operator">:</span> <span class="token string">&quot;invalid_token&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;error_description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Cannot convert access token to JSON&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-4-5-测试获取用户身份" tabindex="-1"><a class="header-anchor" href="#_2-4-5-测试获取用户身份" aria-hidden="true">#</a> <strong>2.4.5 测试获取用户身份</strong></h4><p>jwt 令牌中记录了用户身份信息，当客户端携带 jwt 访问资源服务，资源服务验签通过后将前两部分的内容还原即可取出用户的身份信息，并将用户身份信息放在了 SecurityContextHolder 上下文，SecurityContext 与当前线程进行绑定，方便获取用户身份。</p><p>还以查询课程接口为例，进入查询课程接口的代码中，添加获取用户身份的代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;根据课程id查询课程基础信息&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/course/{courseId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">CourseBaseInfoDto</span> <span class="token function">getCourseBaseById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;courseId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//取出当前用户身份</span>
    <span class="token class-name">Object</span> principal <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>principal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> courseBaseInfoService<span class="token punctuation">.</span><span class="token function">getCourseBaseInfo</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试时需要注意：</p><p>1、首先在资源服务配置中指定安全拦截机制 /course/开头的请求需要认证，即请求/course/{courseId}接口需要携带 jwt 令牌且签证通过。</p><p>2、认证服务生成 jwt 令牌将用户身份信息写入令牌，目前还是将用户信息硬编码并暂放在内存中。</p><p>如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">UserDetailsService</span> <span class="token function">userDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//这里配置用户信息,这里暂时使用这种方式将用户存储在内存中</span>
    <span class="token class-name">InMemoryUserDetailsManager</span> manager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryUserDetailsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    manager<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">&quot;zhangsan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">&quot;123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">&quot;p1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    manager<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">&quot;lisi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">&quot;456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">&quot;p2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> manager<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3、我们在使用密码模式生成 jwt 令牌时用的是 zhangsan 的信息，所以 jwt 令牌中存储了 zhangsan 的信息，那么在资源服务中应该取出 zhangsan 的信息才对。</p><p>清楚了以上内容，下边重启内容管理服务，跟踪取到的用户身份是否正确。</p><h3 id="_2-5-网关认证" tabindex="-1"><a class="header-anchor" href="#_2-5-网关认证" aria-hidden="true">#</a> <strong>2.5 网关认证</strong></h3><h4 id="_2-5-1-技术方案" tabindex="-1"><a class="header-anchor" href="#_2-5-1-技术方案" aria-hidden="true">#</a> <strong>2.5.1 技术方案</strong></h4><p>到目前为止，测试通过了认证服务颁发 jwt 令牌，客户端携带 jwt 访问资源服务，资源服务对 jwt 的合法性进行验证。如下图：</p><p><img src="/MyBlog/assets/image-20230604181331767-61286564.png" alt="image-20230604181331767"></p><p>仔细观察此图，遗漏了本项目架构中非常重要的组件：网关，加上网关并完善后如下图所示：</p><p><img src="/MyBlog/assets/image-20230604181336604-65d280ad.png" alt="image-20230604181336604"></p><blockquote><p>所有访问微服务的请求都要经过网关，在网关进行用户身份的认证可以将很多非法的请求拦截到微服务以外，这叫做网关认证。</p></blockquote><p>下边需要明确网关的职责：</p><p>1、网站白名单维护</p><p>针对不用认证的 URL 全部放行。</p><p>2、校验 jwt 的合法性。</p><p>除了白名单剩下的就是需要认证的请求，网关需要验证 jwt 的合法性，jwt 合法则说明用户身份合法，否则说明身份不合法则拒绝继续访问。</p><blockquote><p>网关负责授权吗？</p></blockquote><p>网关不负责授权，对请求的授权操作在各个微服务进行，因为微服务最清楚用户有哪些权限访问哪些接口。</p><h4 id="_2-5-2-实现网关认证" tabindex="-1"><a class="header-anchor" href="#_2-5-2-实现网关认证" aria-hidden="true">#</a> <strong>2.5.2 实现网关认证</strong></h4><p>下边实现网关认证，实现以下职责：</p><p>1、网站白名单维护</p><p>针对不用认证的 URL 全部放行。</p><p>2、校验 jwt 的合法性。</p><p>除了白名单剩下的就是需要认证的请求，网关需要验证 jwt 的合法性，jwt 合法则说明用户身份合法，否则说明身份不合法则拒绝继续访问。</p><p>1、在网关工程添加依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-oauth2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、拷贝课程资料下网关认证配置类到网关工程的 config 包下。</p><p>3、配置白名单文件 security-whitelist.properties</p><p>内容如下（持续补充）</p><div class="language-tex line-numbers-mode" data-ext="tex"><pre class="language-tex"><code>/auth/**=认证地址
/content/open/**=内容管理公开访问接口
/media/open/**=媒资管理公开访问接口

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启网关工程，进行测试</p><p>1、申请令牌</p><p>2、通过网关访问资源服务</p><p>这里访问内容管理服务</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>#### 通过网关访问资源服务
GET http://localhost:63010/content/course/2
<span class="token header"><span class="token header-name keyword">Authorization</span><span class="token punctuation">:</span> <span class="token header-value">Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE2NjQzNjIzMTAsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6Ijc2OTkwMGNiLWM1ZjItNGRiNC1hZWJmLWY1MzgxZDQxZWMyZCIsImNsaWVudF9pZCI6ImMxIn0.lOITjUgYg2HCh5mDPK9EvJJqz-tIupKVfmP8yWJQIKs</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当 token 正确时可以正常访问资源服务，token 验证失败返回 token 无效：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;errMessage&quot;</span><span class="token operator">:</span> <span class="token string">&quot;认证令牌无效&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意：网关鉴权功能调试通过后，由于目前还没有开发认证功能，前端请求网关的 URL 不在白名单中间时会“没有认证”的错误，暂时在白名单中添加 全部放行配置，待认证功能开发完成再屏蔽全部放行配置，</p><p><img src="/MyBlog/assets/image-20230604181442674-ac74b82a.png" alt="image-20230604181442674"></p><p>由于是在网关处进行令牌校验，所以在微服务处不再校验令牌的合法性，修改内容管理服务的 ResouceServerConfig 类，屏蔽 authenticated()。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
  http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//          .antMatchers(&quot;/r/**&quot;,&quot;/course/**&quot;).authenticated()//所有/r/**的请求必须认证通过</span>
          <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-用户认证" tabindex="-1"><a class="header-anchor" href="#_3-用户认证" aria-hidden="true">#</a> <strong>3 用户认证</strong></h2><h3 id="_3-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_3-1-需求分析" aria-hidden="true">#</a> <strong>3.1 需求分析</strong></h3><p>至此我们了解了使用 Spring Security 进行认证授权的过程，本节实现用户认证功能。</p><p>目前各大网站的认证方式非常丰富：账号密码认证、手机验证码认证、扫码登录等。</p><p>本项目也要支持多种认证试。</p><h3 id="_3-2-连接用户中心数据库" tabindex="-1"><a class="header-anchor" href="#_3-2-连接用户中心数据库" aria-hidden="true">#</a> <strong>3.2 连接用户中心数据库</strong></h3><h4 id="_3-2-1-连接数据库认证" tabindex="-1"><a class="header-anchor" href="#_3-2-1-连接数据库认证" aria-hidden="true">#</a> <strong>3.2.1 连接数据库认证</strong></h4><p>基于的认证流程在研究 Spring Security 过程中已经测试通过，到目前为止用户认证流程如下：</p><p><img src="/MyBlog/assets/image-20230604181459231-287c7ae3.png" alt="image-20230604181459231"></p><p>认证所需要的用户信息存储在用户中心数据库，现在需要将认证服务连接数据库查询用户信息。</p><p>在研究 Spring Security 的过程中是将用户信息硬编码，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">UserDetailsService</span> <span class="token function">userDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//这里配置用户信息,这里暂时使用这种方式将用户存储在内存中</span>
    <span class="token class-name">InMemoryUserDetailsManager</span> manager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryUserDetailsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    manager<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">&quot;zhangsan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">&quot;123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">&quot;p1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    manager<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">&quot;lisi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">&quot;456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">&quot;p2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> manager<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们要认证服务中连接用户中心数据库查询用户信息。</p><p>如何使用 Spring Security 连接数据库进行认证？</p><p>前边学习 Spring Security 工作原理时有一张执行流程图，如下图：</p><p><img src="/MyBlog/assets/image-20230604180517699-2ce2e59f.png" alt="image-20230604181515219"></p><p>用户提交账号和密码由 DaoAuthenticationProvider 调用 UserDetailsService 的 loadUserByUsername()方法获取 UserDetails 用户信息。</p><p>查询 DaoAuthenticationProvider 的源代码如下：</p><p><img src="/MyBlog/assets/image-20230604181519705-6524decc.png" alt="image-20230604181519705"></p><p>UserDetailsService 是一个接口，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{</span>
    <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> var1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>UserDetails 是用户信息接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserDetails</span> <span class="token keyword">extends</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">isAccountNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">isAccountNonLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">isCredentialsNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们只要实现 UserDetailsService 接口查询数据库得到用户信息返回 UserDetails 类型的用户信息即可,框架调用 loadUserByUsername()方法拿到用户信息之后是如何执行的，见下图：</p><p><img src="/MyBlog/assets/image-20230604181543300-886ee27b.png" alt="image-20230604181543300"></p><p>首先屏蔽原来定义的 UserDetailsService。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token comment">//配置用户信息服务</span>
<span class="token comment">//    @Bean</span>
<span class="token comment">//    public UserDetailsService userDetailsService() {</span>
<span class="token comment">//        //这里配置用户信息,这里暂时使用这种方式将用户存储在内存中</span>
<span class="token comment">//        InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();</span>
<span class="token comment">//        manager.createUser(User.withUsername(&quot;zhangsan&quot;).password(&quot;123&quot;).authorities(&quot;p1&quot;).build());</span>
<span class="token comment">//        manager.createUser(User.withUsername(&quot;lisi&quot;).password(&quot;456&quot;).authorities(&quot;p2&quot;).build());</span>
<span class="token comment">//        return manager;</span>
<span class="token comment">//    }</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下边自定义 UserDetailsService</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">LambdaQueryWrapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">XcUserMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">XcUser</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetails</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetailsService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UsernameNotFoundException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> TODO
 * <span class="token keyword">@date</span> 2022/9/28 18:09
 */</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserMapper</span> xcUserMapper<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * <span class="token keyword">@description</span> 根据账号查询用户信息
     * <span class="token keyword">@param</span> <span class="token parameter">s</span>  账号
     * <span class="token keyword">@return</span> org.springframework.security.core.userdetails.UserDetails
     * <span class="token keyword">@author</span> Mr.M
     * <span class="token keyword">@date</span> 2022/9/28 18:30
    */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{</span>

        <span class="token class-name">XcUser</span> user <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>user<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//返回空表示用户不存在</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//取出数据库存储的正确密码</span>
        <span class="token class-name">String</span> password  <span class="token operator">=</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//用户权限,如果不加报Cannot pass a null GrantedAuthority collection</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> authorities<span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">//创建UserDetails对象,权限信息待实现授权功能时再向UserDetail中加入</span>
        <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> userDetails<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>数据库中的密码加过密的，用户输入的密码是明文，我们需要修改密码<code>格式器PasswordEncoder</code>，原来使用的是 NoOpPasswordEncoder，它是通过明文方式比较密码，现在我们修改为 BCryptPasswordEncoder，它是将用户输入的密码编码为 BCrypt 格式与数据库中的密码进行比对。</p><p>如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//        //密码为明文方式</span>
<span class="token comment">//        return NoOpPasswordEncoder.getInstance();</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们通过测试代码测试 BCryptPasswordEncoder，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token string">&quot;111111&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">PasswordEncoder</span> passwordEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//每个计算出的Hash值都不一样</span>
        <span class="token class-name">String</span> hashPass <span class="token operator">=</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hashPass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//虽然每次计算的密码Hash值不一样但是校验是通过的</span>
        <span class="token keyword">boolean</span> f <span class="token operator">=</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> hashPass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改数据库中的密码为 Bcrypt 格式，并且记录明文密码，稍后申请令牌时需要。</p><p>由于修改密码编码方式还需要将客户端的密钥更改为 Bcrypt 格式.</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ClientDetailsServiceConfigurer</span> clients<span class="token punctuation">)</span>
          <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        clients<span class="token punctuation">.</span><span class="token function">inMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 使用in-memory存储</span>
                <span class="token punctuation">.</span><span class="token function">withClient</span><span class="token punctuation">(</span><span class="token string">&quot;XcWebApp&quot;</span><span class="token punctuation">)</span><span class="token comment">// client_id</span>
<span class="token comment">//                .secret(&quot;secret&quot;)//客户端密钥</span>
                <span class="token punctuation">.</span><span class="token function">secret</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;XcWebApp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//客户端密钥</span>
                <span class="token punctuation">.</span><span class="token function">resourceIds</span><span class="token punctuation">(</span><span class="token string">&quot;xuecheng-plus&quot;</span><span class="token punctuation">)</span><span class="token comment">//资源列表</span>
                <span class="token punctuation">.</span><span class="token function">authorizedGrantTypes</span><span class="token punctuation">(</span><span class="token string">&quot;authorization_code&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;client_credentials&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;implicit&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;refresh_token&quot;</span><span class="token punctuation">)</span><span class="token comment">// 该client允许的授权类型authorization_code,password,refresh_token,implicit,client_credentials</span>
                <span class="token punctuation">.</span><span class="token function">scopes</span><span class="token punctuation">(</span><span class="token string">&quot;all&quot;</span><span class="token punctuation">)</span><span class="token comment">// 允许的授权范围</span>
                <span class="token punctuation">.</span><span class="token function">autoApprove</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token comment">//false跳转到授权页面</span>
                <span class="token comment">//客户端接收授权码的重定向地址</span>
                <span class="token punctuation">.</span><span class="token function">redirectUris</span><span class="token punctuation">(</span><span class="token string">&quot;http://www.51xuecheng.cn&quot;</span><span class="token punctuation">)</span>
   <span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在重启认证服务。</p><p>下边使用 httpclient 进行测试：</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>#### 密码模式
POST {{auth_host}}/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=stu1&amp;password=111111

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输入正确的账号和密码，申请令牌成功。</p><p>输入错误的密码，报错：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;error&quot;</span><span class="token operator">:</span> <span class="token string">&quot;invalid_grant&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;error_description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;用户名或密码错误&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输入错误的账号，报错：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;error&quot;</span><span class="token operator">:</span> <span class="token string">&quot;unauthorized&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;error_description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;UserDetailsService returned null, which is an interface contract violation&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-2-2-扩展用户身份信息" tabindex="-1"><a class="header-anchor" href="#_3-2-2-扩展用户身份信息" aria-hidden="true">#</a> <strong>3.2.2 扩展用户身份信息</strong></h4><p>用户表中存储了用户的账号、手机号、email，昵称、qq 等信息，UserDetails 接口只返回了 username、密码等信息，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Java</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserDetails</span> <span class="token keyword">extends</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">isAccountNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">isAccountNonLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">isCredentialsNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们需要扩展用户身份的信息，在 jwt 令牌中存储用户的昵称、头像、qq 等信息。</p><blockquote><p>如何扩展 Spring Security 的用户身份信息呢？</p></blockquote><p>在认证阶段 DaoAuthenticationProvider 会调用 UserDetailService 查询用户的信息，这里是可以获取到齐全的用户信息的。由于 JWT 令牌中用户身份信息来源于 UserDetails，UserDetails 中仅定义了 username 为用户的身份信息，这里有两个思路：第一是可以扩展 UserDetails，使之包括更多的自定义属性，第二也可以扩展 username 的内容 ，比如存入 json 数据内容作为 username 的内容。相比较而言，方案二比较简单还不用破坏 UserDetails 的结构，我们采用方案二。</p><p>修改 UserServiceImpl 如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">LambdaQueryWrapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">XcUserMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">XcUser</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetails</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetailsService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UsernameNotFoundException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> TODO
 * <span class="token keyword">@date</span> 2022/9/28 18:09
 */</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserMapper</span> xcUserMapper<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * <span class="token keyword">@description</span> 根据账号查询用户信息
     * <span class="token keyword">@param</span> <span class="token parameter">s</span>  账号
     * <span class="token keyword">@return</span> org.springframework.security.core.userdetails.UserDetails
     * <span class="token keyword">@author</span> Mr.M
     * <span class="token keyword">@date</span> 2022/9/28 18:30
    */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{</span>

        <span class="token class-name">XcUser</span> user <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>user<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//返回空表示用户不存在</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//取出数据库存储的正确密码</span>
        <span class="token class-name">String</span> password  <span class="token operator">=</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//用户权限,如果不加报Cannot pass a null GrantedAuthority collection</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> authorities <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;p1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
       <span class="token comment">//为了安全在令牌中不放密码</span>
        user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将user对象转json</span>
        <span class="token class-name">String</span> userString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建UserDetails对象</span>
        <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span>userString<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> userDetails<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启认证服务，重新生成令牌，生成成功。</p><p>我们可以使用 check_token 查询 jwt 的内容</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>####校验jwt令牌
POST {{auth_host}}/oauth/check_token?token=

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>响应示例如下，</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;aud&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;res1&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;user_name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{\&quot;birthday\&quot;:\&quot;2022-09-28T19:28:46\&quot;,\&quot;createTime\&quot;:\&quot;2022-09-28T08:32:03\&quot;,\&quot;id\&quot;:\&quot;50\&quot;,\&quot;name\&quot;:\&quot;学生1\&quot;,\&quot;nickname\&quot;:\&quot;大水牛\&quot;,\&quot;password\&quot;:\&quot;$2a$10$0pt7WlfTbnPDTcWtp/.2Mu5CTXvohnNQhR628qq4RoKSc0dGAdEgm\&quot;,\&quot;sex\&quot;:\&quot;1\&quot;,\&quot;status\&quot;:\&quot;1\&quot;,\&quot;username\&quot;:\&quot;stu1\&quot;,\&quot;userpic\&quot;:\&quot;http://file.51xuecheng.cn/dddf\&quot;,\&quot;utype\&quot;:\&quot;101001\&quot;}&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scope&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;all&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;active&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;exp&quot;</span><span class="token operator">:</span> <span class="token number">1664372184</span><span class="token punctuation">,</span>
  <span class="token property">&quot;authorities&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;p1&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;jti&quot;</span><span class="token operator">:</span> <span class="token string">&quot;73da9f7b-bd8c-45ac-9add-46b711d11fb8&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;client_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;c1&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>user_name 存储了用户信息的 json 格式，在资源服务中就可以取出该 json 格式的内容转为用户对象去使用。</p><h4 id="_3-2-3-资源服务获取用户身份" tabindex="-1"><a class="header-anchor" href="#_3-2-3-资源服务获取用户身份" aria-hidden="true">#</a> <strong>3.2.3 资源服务获取用户身份</strong></h4><p>下边编写一个工具类在各个微服务中去使用，获取当前登录用户的对象。</p><p>在 content-api 中定义此类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>util</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SecurityContextHolder</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> 获取当前用户身份工具类
 * <span class="token keyword">@date</span> 2022/10/18 18:02
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityUtil</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">XcUser</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> principalObj <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>principalObj <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//取出用户身份信息</span>
                <span class="token class-name">String</span> principal <span class="token operator">=</span> principalObj<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//将json转成对象</span>
                <span class="token class-name">XcUser</span> user <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>principal<span class="token punctuation">,</span> <span class="token class-name">XcUser</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> user<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;获取当前登录用户身份出错:{}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Data</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">XcUser</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> salt<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> nickname<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> wxUnionid<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> companyId<span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * 头像
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> userpic<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> utype<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> birthday<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> sex<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> cellphone<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> qq<span class="token punctuation">;</span>

        <span class="token doc-comment comment">/**
         * 用户状态
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> status<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> createTime<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> updateTime<span class="token punctuation">;</span>


    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下边在内容管理服务中测试此工具类，以查询课程信息接口为例：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;根据课程id查询课程基础信息&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/course/{courseId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">CourseBaseInfoDto</span> <span class="token function">getCourseBaseById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;courseId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//取出当前用户身份</span>
<span class="token comment">//    Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span>
   <span class="token class-name">SecurityUtil<span class="token punctuation">.</span>XcUser</span> user <span class="token operator">=</span> <span class="token class-name">SecurityUtil</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> courseBaseInfoService<span class="token punctuation">.</span><span class="token function">getCourseBaseInfo</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启内容管理服务：</p><p>1、启动认证服务、网关、内容管理服务</p><p>2、生成新的令牌</p><p>3、携带令牌访问内容管理服务的查询课程接口</p><p><img src="/MyBlog/assets/image-20230604181846179-f4b8a587.png" alt="image-20230604181846179"></p><h2 id="_3-3-支持认证方式多样" tabindex="-1"><a class="header-anchor" href="#_3-3-支持认证方式多样" aria-hidden="true">#</a> <strong>3.3 支持认证方式多样</strong></h2><h4 id="_3-3-1-统一认证入口" tabindex="-1"><a class="header-anchor" href="#_3-3-1-统一认证入口" aria-hidden="true">#</a> <strong>3.3.1 统一认证入口</strong></h4><p>目前各大网站的认证方式非常丰富：账号密码认证、手机验证码认证、扫码登录等。<code>基于当前研究的Spring Security认证流程如何支持多样化的认证方式呢？</code></p><p>1、支持账号和密码认证</p><p>采用 OAuth2 协议的密码模式即可实现。</p><p>2、支持手机号加验证码认证</p><p>用户认证提交的是手机号和验证码，并不是账号和密码。</p><p>3、微信扫码认证</p><p>基于 OAuth2 协议与微信交互，学成在线网站向微信服务器申请到一个令牌，然后携带令牌去微信查询用户信息，查询成功则用户在学成在线项目认证通过。</p><p>目前我们测试通过 OAuth2 的密码模式，用户认证会提交账号和密码，由 DaoAuthenticationProvider 调用 UserDetailsService 的 loadUserByUsername()方法获取 UserDetails 用户信息。</p><p>在前边我们自定义了 UserDetailsService 接口实现类，通过 loadUserByUsername()方法根据账号查询用户信息。</p><p>而不同的认证方式提交的数据不一样，比如：手机加验证码方式会提交手机号和验证码，账号密码方式会提交账号、密码、验证码。</p><p>我们可以在 loadUserByUsername()方法上作文章，将用户原来提交的账号数据改为提交 json 数据，json 数据可以扩展不同认证方式所提交的各种参数。</p><p>首先创建一个 DTO 类表示认证的参数：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> 认证用户请求参数
 * <span class="token keyword">@date</span> 2022/9/29 10:56
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthParamsDto</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span> <span class="token comment">//用户名</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span> <span class="token comment">//域  用于扩展</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> cellphone<span class="token punctuation">;</span><span class="token comment">//手机号</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> checkcode<span class="token punctuation">;</span><span class="token comment">//验证码</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> checkcodekey<span class="token punctuation">;</span><span class="token comment">//验证码key</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> authType<span class="token punctuation">;</span> <span class="token comment">// 认证的类型   password:用户名密码模式类型    sms:短信模式类型</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> payload <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//附加数据，作为扩展，不同认证类型可拥有不同的附加数据。如认证类型为短信时包含smsKey : sms:3d21042d054548b08477142bbca95cfa; 所有情况下都包含clientId</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此时 loadUserByUsername()方法可以修改如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">LambdaQueryWrapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">XcUserMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">AuthParamsDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">XcUser</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetails</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetailsService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UsernameNotFoundException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> 自定义UserDetailsService用来对接Spring Security
 * <span class="token keyword">@date</span> 2022/9/28 18:09
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserMapper</span> xcUserMapper<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * <span class="token keyword">@description</span> 查询用户信息组成用户身份信息
     * <span class="token keyword">@param</span> <span class="token parameter">s</span>  AuthParamsDto类型的json数据
     * <span class="token keyword">@return</span> org.springframework.security.core.userdetails.UserDetails
     * <span class="token keyword">@author</span> Mr.M
     * <span class="token keyword">@date</span> 2022/9/28 18:30
    */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{</span>

        <span class="token class-name">AuthParamsDto</span> authParamsDto <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//将认证参数转为AuthParamsDto类型</span>
            authParamsDto <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token class-name">AuthParamsDto</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;认证请求不符合项目要求:{}&quot;</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;认证请求数据格式不对&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//账号</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XcUser</span> user <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>user<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//返回空表示用户不存在</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//取出数据库存储的正确密码</span>
        <span class="token class-name">String</span> password  <span class="token operator">=</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//用户权限,如果不加报Cannot pass a null GrantedAuthority collection</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> authorities <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;p1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">//将user对象转json</span>
        <span class="token class-name">String</span> userString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建UserDetails对象</span>
        <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span>userString<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> userDetails<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>原来的 DaoAuthenticationProvider 会进行密码校验，现在重新定义 DaoAuthenticationProviders 类，重写类的 additionalAuthenticationChecks 方法。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">BadCredentialsException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">UsernamePasswordAuthenticationToken</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span>dao<span class="token punctuation">.</span></span><span class="token class-name">DaoAuthenticationProvider</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetails</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetailsService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 自定义DaoAuthenticationProvider
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/29 10:31
 * <span class="token keyword">@version</span> 1.0
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DaoAuthenticationProviderCustom</span> <span class="token keyword">extends</span> <span class="token class-name">DaoAuthenticationProvider</span> <span class="token punctuation">{</span>


 <span class="token annotation punctuation">@Autowired</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserDetailsService</span><span class="token punctuation">(</span><span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setUserDetailsService</span><span class="token punctuation">(</span>userDetailsService<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>


 <span class="token comment">//屏蔽密码对比</span>
 <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">additionalAuthenticationChecks</span><span class="token punctuation">(</span><span class="token class-name">UserDetails</span> userDetails<span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>


 <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改 WebSecurityConfig 类指定 daoAuthenticationProviderCustom</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">DaoAuthenticationProviderCustom</span> daoAuthenticationProviderCustom<span class="token punctuation">;</span>


<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    auth<span class="token punctuation">.</span><span class="token function">authenticationProvider</span><span class="token punctuation">(</span>daoAuthenticationProviderCustom<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此时可以重启认证服务，测试申请令牌接口，传入的账号信息改为 json 数据，如下：</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>#################扩展认证请求参数后######################
####密码模式
POST {{auth_host}}/auth/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username={&quot;username&quot;:&quot;stu1&quot;,&quot;authType&quot;:&quot;password&quot;,&quot;password&quot;:&quot;111111&quot;}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>经过测试发现 loadUserByUsername()方法可以正常接收到认证请求中的 json 数据。</p><p>有了这些认证参数我们可以定义一个认证 Service 接口去进行各种方式的认证。</p><p>定义用户信息，为了扩展性让它继承 XcUser</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XcUserExt</span> <span class="token keyword">extends</span> <span class="token class-name">XcUser</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>定义认证 Service 接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">AuthParamsDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">XcUser</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 认证service
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/29 12:10
 * <span class="token keyword">@version</span> 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{</span>

   <span class="token doc-comment comment">/**
    * <span class="token keyword">@description</span> 认证方法
    * <span class="token keyword">@param</span> <span class="token parameter">authParamsDto</span> 认证参数
    * <span class="token keyword">@return</span> com.xuecheng.ucenter.model.po.XcUser 用户信息
    * <span class="token keyword">@author</span> Mr.M
    * <span class="token keyword">@date</span> 2022/9/29 12:11
   */</span>
   <span class="token class-name">XcUserExt</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AuthParamsDto</span> authParamsDto<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>loadUserByUsername()修改如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserMapper</span> xcUserMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">;</span>


    <span class="token doc-comment comment">/**
     * <span class="token keyword">@description</span> 查询用户信息组成用户身份信息
     * <span class="token keyword">@param</span> <span class="token parameter">s</span>  AuthParamsDto类型的json数据
     * <span class="token keyword">@return</span> org.springframework.security.core.userdetails.UserDetails
     * <span class="token keyword">@author</span> Mr.M
     * <span class="token keyword">@date</span> 2022/9/28 18:30
    */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{</span>

        <span class="token class-name">AuthParamsDto</span> authParamsDto <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//将认证参数转为AuthParamsDto类型</span>
            authParamsDto <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token class-name">AuthParamsDto</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;认证请求不符合项目要求:{}&quot;</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;认证请求数据格式不对&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//开始认证</span>
        authService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>authParamsDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>到此我们基于 Spring Security 认证流程修改为如下：</p><p><img src="/MyBlog/assets/image-20230604182038468-dd0bd473.png" alt="image-20230604182038468"></p><h4 id="_3-3-2-实现账号密码认证" tabindex="-1"><a class="header-anchor" href="#_3-3-2-实现账号密码认证" aria-hidden="true">#</a> <strong>3.3.2 实现账号密码认证</strong></h4><p>上节定义了 AuthService 认证接口，下边实现该接口实现账号密码认证</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">LambdaQueryWrapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">XcUserMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">AuthParamsDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">XcUser</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">AuthService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>bcrypt<span class="token punctuation">.</span></span><span class="token class-name">BCryptPasswordEncoder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>password<span class="token punctuation">.</span></span><span class="token class-name">PasswordEncoder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 账号密码认证
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/29 12:12
 * <span class="token keyword">@version</span> 1.0
 */</span>
 <span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">&quot;password_authservice&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PasswordAuthServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">XcUserMapper</span> xcUserMapper<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">PasswordEncoder</span> passwordEncoder<span class="token punctuation">;</span>


 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">XcUserExt</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AuthParamsDto</span> authParamsDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">//账号</span>
  <span class="token class-name">String</span> username <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">XcUser</span> user <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>user<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token comment">//返回空表示用户不存在</span>
   <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;账号不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token class-name">XcUserExt</span> xcUserExt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUserExt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span>xcUserExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//校验密码</span>
  <span class="token comment">//取出数据库存储的正确密码</span>
  <span class="token class-name">String</span> passwordDb  <span class="token operator">=</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">String</span> passwordForm <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">boolean</span> matches <span class="token operator">=</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>passwordForm<span class="token punctuation">,</span> passwordDb<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>matches<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;账号或密码错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> xcUserExt<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改 UserServiceImpl 类，根据认证方式使用不同的认证 bean</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">LambdaQueryWrapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">XcUserMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">AuthParamsDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">XcUser</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">AuthService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ApplicationContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetails</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetailsService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UsernameNotFoundException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> 自定义UserDetailsService用来对接Spring Security
 * <span class="token keyword">@date</span> 2022/9/28 18:09
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserMapper</span> xcUserMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">;</span>

<span class="token comment">//    @Autowired</span>
<span class="token comment">//    AuthService authService;</span>

    <span class="token doc-comment comment">/**
     * <span class="token keyword">@description</span> 查询用户信息组成用户身份信息
     * <span class="token keyword">@param</span> <span class="token parameter">s</span>  AuthParamsDto类型的json数据
     * <span class="token keyword">@return</span> org.springframework.security.core.userdetails.UserDetails
     * <span class="token keyword">@author</span> Mr.M
     * <span class="token keyword">@date</span> 2022/9/28 18:30
    */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{</span>

        <span class="token class-name">AuthParamsDto</span> authParamsDto <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//将认证参数转为AuthParamsDto类型</span>
            authParamsDto <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token class-name">AuthParamsDto</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;认证请求不符合项目要求:{}&quot;</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;认证请求数据格式不对&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//认证方法</span>
        <span class="token class-name">String</span> authType <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getAuthType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AuthService</span> authService <span class="token operator">=</span>  applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>authType <span class="token operator">+</span> <span class="token string">&quot;_authservice&quot;</span><span class="token punctuation">,</span><span class="token class-name">AuthService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XcUserExt</span> user <span class="token operator">=</span> authService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>authParamsDto<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">getUserPrincipal</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token doc-comment comment">/**
     * <span class="token keyword">@description</span> 查询用户信息
     * <span class="token keyword">@param</span> <span class="token parameter">user</span>  用户id，主键
     * <span class="token keyword">@return</span> com.xuecheng.ucenter.model.po.XcUser 用户信息
     * <span class="token keyword">@author</span> Mr.M
     * <span class="token keyword">@date</span> 2022/9/29 12:19
    */</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">getUserPrincipal</span><span class="token punctuation">(</span><span class="token class-name">XcUserExt</span> user<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//用户权限,如果不加报Cannot pass a null GrantedAuthority collection</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> authorities <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;p1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> password <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//为了安全在令牌中不放密码</span>
        user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将user对象转json</span>
        <span class="token class-name">String</span> userString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建UserDetails对象</span>
        <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span>userString<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span>password <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> userDetails<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启认证服务，测试申请令牌接口。</p><p>1、测试账号和密码都正确的情况是否可以申请令牌成功。</p><p>2、测试密码错误的情况。</p><p>3、测试账号不存在情况。</p><h3 id="_3-4-验证码服务" tabindex="-1"><a class="header-anchor" href="#_3-4-验证码服务" aria-hidden="true">#</a> <strong>3.4 验证码服务</strong></h3><h4 id="_3-4-1-部署验证码服务工程" tabindex="-1"><a class="header-anchor" href="#_3-4-1-部署验证码服务工程" aria-hidden="true">#</a> <strong>3.4.1 部署验证码服务工程</strong></h4><p>在认证时一般都需要输入验证码，<code>验证码有什么用？</code></p><p>验证码可以防止恶性攻击，比如：XSS 跨站脚本攻击、CSRF 跨站请求伪造攻击，一些比较复杂的图形验证码可以有效的防止恶性攻击。</p><p>为了保护系统的安全在一些比较重要的操作都需要验证码。</p><p><img src="/MyBlog/assets/image-20230604182128014-143b0b55.png" alt="image-20230604182128014"></p><p>验证码的类型也有很多：图片、语音、手机短信验证码等。</p><p>本项目创建单独的验证码服务为各业务提供验证码的生成、校验等服务。</p><p>拷贝课程资料目录 xuecheng-plus-checkcode 验证码服务工程到自己的工程目录。</p><p><img src="/MyBlog/assets/image-20230604182133296-f7a21e39.png" alt="image-20230604182133296"></p><p>定义 nacos 配置文件</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>
    <span class="token key atrule">context-path</span><span class="token punctuation">:</span> /checkcode
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">63075</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意修改 bootstrap.yml 中的命名空间为自己定义的命名空间。</p><p>配置 redis-dev.yaml，保存 redis 服务启动</p><p><img src="/MyBlog/assets/image-20230604182151328-3a1049f2.png" alt="image-20230604182151328"></p><p>内容如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.101.65
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> redis
    <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">lettuce</span><span class="token punctuation">:</span>
      <span class="token key atrule">pool</span><span class="token punctuation">:</span>
        <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">20</span>
        <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">10</span>
        <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">10000</span>
    <span class="token comment">#redisson:</span>
    <span class="token comment">#配置文件目录</span>
    <span class="token comment">#config: classpath:singleServerConfig.yaml</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-4-2-验证码接口测试" tabindex="-1"><a class="header-anchor" href="#_3-4-2-验证码接口测试" aria-hidden="true">#</a> <strong>3.4.2 验证码接口测试</strong></h4><p>验证码服务对外提供的接口有：</p><p>1、生成验证码</p><p>2、校验验证码。</p><p>如下：</p><p><img src="/MyBlog/assets/image-20230604182209500-8174fa3f.png" alt="image-20230604182209500"></p><blockquote><p>验证码服务如何生成并校验验证码？</p></blockquote><p>拿图片验证码举例：</p><p>1、先生成一个指定位数的验证码，根据需要可能是数字、数字字母组合或文字。</p><p>2、根据生成的验证码生成一个图片并返回给页面</p><p>3、给生成的验证码分配一个 key，将 key 和验证码一同存入缓存。这个 key 和图片一同返回给页面。</p><p>4、用户输入验证码，连同 key 一同提交至认证服务。</p><p>5、认证服务拿 key 和输入的验证码请求验证码服务去校验</p><p>6、验证码服务根据 key 从缓存取出正确的验证码和用户输入的验证码进行比对，如果相同则校验通过，否则不通过。</p><p><img src="/MyBlog/assets/image-20230604182219723-56f9a38b.png" alt="image-20230604182219723"></p><p>根据接口分析，验证码服务接口如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>checkcode<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">RestResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>checkcode<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">CheckCodeParamsDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>checkcode<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">CheckCodeResultDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>checkcode<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">CheckCodeService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Api</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiImplicitParam</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiImplicitParams</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiOperation</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> 验证码服务接口
 * <span class="token keyword">@date</span> 2022/9/29 18:39
 */</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;验证码服务接口&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CheckCodeController</span> <span class="token punctuation">{</span>


    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">&quot;生成验证信息&quot;</span><span class="token punctuation">,</span> notes<span class="token operator">=</span><span class="token string">&quot;生成验证信息&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/pic&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CheckCodeResultDto</span> <span class="token function">generatePicCheckCode</span><span class="token punctuation">(</span><span class="token class-name">CheckCodeParamsDto</span> checkCodeParamsDto<span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">&quot;校验&quot;</span><span class="token punctuation">,</span> notes<span class="token operator">=</span><span class="token string">&quot;校验&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiImplicitParams</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;业务名称&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataType <span class="token operator">=</span> <span class="token string">&quot;String&quot;</span><span class="token punctuation">,</span> paramType<span class="token operator">=</span><span class="token string">&quot;query&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;验证key&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataType <span class="token operator">=</span> <span class="token string">&quot;String&quot;</span><span class="token punctuation">,</span> paramType<span class="token operator">=</span><span class="token string">&quot;query&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;验证码&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataType <span class="token operator">=</span> <span class="token string">&quot;String&quot;</span><span class="token punctuation">,</span> paramType<span class="token operator">=</span><span class="token string">&quot;query&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/verify&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1、生成验证码接口</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>#### 申请验证码
POST {{checkcode_host}}/checkcode/pic

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、校验验证码接口</p><p>根据生成验证码返回的 key 以及日志中输出正确的验证码去测试。</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>#### 校验验证码
POST {{checkcode_host}}/checkcode/verify?key=checkcode4506b95bddbe46cdb0d56810b747db1b&amp;code=70dl

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-5-账号密码认证" tabindex="-1"><a class="header-anchor" href="#_3-5-账号密码认证" aria-hidden="true">#</a> <strong>3.5 账号密码认证</strong></h3><h4 id="_3-5-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_3-5-1-需求分析" aria-hidden="true">#</a> <strong>3.5.1 需求分析</strong></h4><p>到目前为止账号和密码认证所需要的技术、组件都已开发完毕，下边实现账号密码认证，输出如下图：</p><p><img src="/MyBlog/assets/image-20230604182307943-c773f12f.png" alt="image-20230604182307943"></p><p>执行流程如下：</p><p><img src="/MyBlog/assets/image-20230604182312498-a88e30c7.png" alt="image-20230604182312498"></p><h4 id="_3-5-2-账号密码认证开发" tabindex="-1"><a class="header-anchor" href="#_3-5-2-账号密码认证开发" aria-hidden="true">#</a> <strong>3.5.2 账号密码认证开发</strong></h4><p>1、在认证服务定义远程调用验证码服务的接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>feignclient</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span>
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/20 20:29
 * <span class="token keyword">@version</span> 1.0
 */</span>
 <span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;checkcode&quot;</span><span class="token punctuation">,</span>fallbackFactory <span class="token operator">=</span> <span class="token class-name">CheckCodeClientFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
 <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/checkcode&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CheckCodeClient</span> <span class="token punctuation">{</span>

 <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/verify&quot;</span><span class="token punctuation">)</span>
 <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>CheckCodeClientFactory:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CheckCodeClientFactory</span> <span class="token keyword">implements</span> <span class="token class-name">FallbackFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CheckCodeClient</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">CheckCodeClient</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CheckCodeClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;调用验证码服务熔断异常:{}&quot;</span><span class="token punctuation">,</span> throwable<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动类添加：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;com.xuecheng.*.feignclient&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>配置文件引入 feign-dev.yaml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> feign<span class="token punctuation">-</span>$<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>.yaml
  <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
  <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、完善 PasswordAuthServiceImpl</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">LambdaQueryWrapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>feignclient<span class="token punctuation">.</span></span><span class="token class-name">CheckCodeClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">XcUserMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">AuthParamsDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">XcUser</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">AuthService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>bcrypt<span class="token punctuation">.</span></span><span class="token class-name">BCryptPasswordEncoder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>password<span class="token punctuation">.</span></span><span class="token class-name">PasswordEncoder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 账号密码认证
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/29 12:12
 * <span class="token keyword">@version</span> 1.0
 */</span>
 <span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">&quot;password_authservice&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PasswordAuthServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">XcUserMapper</span> xcUserMapper<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">PasswordEncoder</span> passwordEncoder<span class="token punctuation">;</span>
 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">CheckCodeClient</span> checkCodeClient<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">XcUser</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AuthParamsDto</span> authParamsDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">//校验验证码</span>
  <span class="token class-name">String</span> checkcode <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getCheckcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">String</span> checkcodekey <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getCheckcodekey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>checkcodekey<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>checkcode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;验证码为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span>
  <span class="token class-name">Boolean</span> verify <span class="token operator">=</span> checkCodeClient<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>checkcodekey<span class="token punctuation">,</span> checkcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>verify<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;验证码输入错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//账号</span>
  <span class="token class-name">String</span> username <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">XcUser</span> user <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>user<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token comment">//返回空表示用户不存在</span>
   <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;账号不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//校验密码</span>
  <span class="token comment">//取出数据库存储的正确密码</span>
  <span class="token class-name">String</span> passwordDb  <span class="token operator">=</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">String</span> passwordForm <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">boolean</span> matches <span class="token operator">=</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>passwordForm<span class="token punctuation">,</span> passwordDb<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>matches<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;账号或密码错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> user<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>小技巧：目前账号密码方式添加了验证码校验，为了后期获取令牌方便可以重新定义一个不需要验证码校验的认证类 AuthService ，AuthService 中去掉验证码的校验，方便生成令牌。</p><h4 id="_3-5-3-账号密码认证测试" tabindex="-1"><a class="header-anchor" href="#_3-5-3-账号密码认证测试" aria-hidden="true">#</a> <strong>3.5.3 账号密码认证测试</strong></h4><p>1、使用浏览器访问 http://www.51xuecheng.cn/sign.html</p><p><img src="/MyBlog/assets/image-20230604182430644-cd873d6b.png" alt="image-20230604182430644"></p><p>2、首先测试验证码，分别输入正确的验证码和错误的验证码进行测试</p><p>3、输入正确的账号密码和错误的账号密码进行测试</p><p>登录成功将 jwt 令牌存储 cookie.</p><p>4、测试自动登录</p><p>勾选自动登录 cookie 生成时间为 30 天，不勾选自动登录关闭浏览器窗口后自动删除 cookie。</p><h2 id="_4-微信扫码登录" tabindex="-1"><a class="header-anchor" href="#_4-微信扫码登录" aria-hidden="true">#</a> <strong>4 微信扫码登录</strong></h2><h3 id="_4-1-接入规范" tabindex="-1"><a class="header-anchor" href="#_4-1-接入规范" aria-hidden="true">#</a> <strong>4.1 接入规范</strong></h3><h4 id="_4-1-1-接入流程" tabindex="-1"><a class="header-anchor" href="#_4-1-1-接入流程" aria-hidden="true">#</a> <strong>4.1.1 接入流程</strong></h4><p>微信扫码登录基于 OAuth2 协议的授权码模式，</p><p>接口文档：</p><p>https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html</p><p>流程如下：</p><p><img src="/MyBlog/assets/image-20230604182439594-3a6603ff.png" alt="image-20230604182439594"></p><p>第三方应用获取 access_token 令牌后即可请求微信获取用户的信息，成功获取到用户的信息表示用户在第三方应用认证成功。</p><h4 id="_4-1-2-请求获取授权码" tabindex="-1"><a class="header-anchor" href="#_4-1-2-请求获取授权码" aria-hidden="true">#</a> <strong>4.1.2 请求获取授权码</strong></h4><p>第三方使用网站应用授权登录前请注意已获取相应网页授权作用域（scope=snsapi_login），则可以通过在 PC 端打开以下链接： https://open.weixin.qq.com/connect/qrconnect?appid=APPID&amp;redirect_uri=REDIRECT_URI&amp;response_type=code&amp;scope=SCOPE&amp;state=STATE#wechat_redirect 若提示“该链接无法访问”，请检查参数是否填写错误，如 redirect_uri 的域名与审核时填写的授权域名不一致或 scope 不为 snsapi_login。</p><p><strong>参数说明</strong></p><p><img src="/MyBlog/assets/image-20230604182444308-55d5941e.png" alt="image-20230604182444308"></p><p><strong>返回说明</strong></p><p>用户允许授权后，将会重定向到 redirect_uri 的网址上，并且带上 code 和 state 参数</p><div class="language-tex line-numbers-mode" data-ext="tex"><pre class="language-tex"><code>redirect_uri?code=CODE<span class="token punctuation">&amp;</span>state=STATE

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>若用户禁止授权，则不会发生重定向。</p><p>登录一号店网站应用 https://test.yhd.com/wechat/login.do 打开后，一号店会生成 state 参数，跳转到https://open.weixin.qq.com/connect/qrconnect?appid=wxbdc5610cc59c1631&amp;redirect_uri=https%3A%2F%2Fpassport.yhd.com%2Fwechat%2Fcallback.do&amp;response_type=code&amp;scope=snsapi_login&amp;state=3d6be0a4035d839573b04816624a415e#wechat_redirect微信用户使用微信扫描二维码并且确认登录后，PC端会跳转到https://test.yhd.com/wechat/callback.do?code=CODE&amp;state=3d6be0a40sssssxxxxx6624a415e为了满足网站更定制化的需求，我们还提供了第二种获取 code 的方式，支持网站将微信登录二维码内嵌到自己页面中，用户使用微信扫码授权后通过 JS 将 code 返回给网站。 JS 微信登录主要用途：网站希望用户在网站内就能完成登录，无需跳转到微信域下登录后再返回，提升微信登录的流畅性与成功率。 网站内嵌二维码微信登录 JS 实现办法：</p><p>步骤 1：在页面中先引入如下 JS 文件（支持 https）：</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//res.wx.qq.com/connect/zh_CN/htmledition/js/wxLogin.js</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>步骤 2：在需要使用微信登录的地方实例以下 JS 对象：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WxLogin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">self_redirect</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&#39;login_container&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">appid</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">scope</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">redirect_uri</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">style</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">href</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="/MyBlog/assets/image-20230604182545966-83a300ba.png" alt="image-20230604182545966"></p><p><img src="/MyBlog/assets/image-20230604182549928-5f501d7d.png" alt="image-20230604182549928"></p><h4 id="_4-1-3-通过-code-获取-access-token" tabindex="-1"><a class="header-anchor" href="#_4-1-3-通过-code-获取-access-token" aria-hidden="true">#</a> <strong>4.1.3 通过 code 获取 access_token</strong></h4><p>通过 code 获取 access_token</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code><span class="token header"><span class="token header-name keyword">https</span><span class="token punctuation">:</span><span class="token header-value">//api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&amp;secret=SECRET&amp;code=CODE&amp;grant_type=authorization_code</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="/MyBlog/assets/image-20230604182621304-848d24e6.png" alt="image-20230604182621304"></p><p><strong>返回说明</strong></p><p>正确的返回：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;access_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ACCESS_TOKEN&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;expires_in&quot;</span><span class="token operator">:</span> <span class="token number">7200</span><span class="token punctuation">,</span>
  <span class="token property">&quot;refresh_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;REFRESH_TOKEN&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;openid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;OPENID&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scope&quot;</span><span class="token operator">:</span> <span class="token string">&quot;SCOPE&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;unionid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;o6_bmasdasdsad6_2sgVt7hMZOPfL&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>参数说明</strong></p><p><img src="/MyBlog/assets/image-20230604182646345-c8866982.png" alt="image-20230604182646345"></p><p>错误返回样例：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span> <span class="token property">&quot;errcode&quot;</span><span class="token operator">:</span> <span class="token number">40029</span><span class="token punctuation">,</span> <span class="token property">&quot;errmsg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;invalid code&quot;</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="_4-1-4-通过-access-token-调用接口" tabindex="-1"><a class="header-anchor" href="#_4-1-4-通过-access-token-调用接口" aria-hidden="true">#</a> <strong>4.1.4 通过 access_token 调用接口</strong></h4><p>获取 access_token 后，进行接口调用，有以下前提：</p><div class="language-tex line-numbers-mode" data-ext="tex"><pre class="language-tex"><code>access_token有效且未超时；
微信用户已授权给第三方应用帐号相应接口作用域（scope）。

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于接口作用域（scope），能调用的接口有以下：</p><p><img src="/MyBlog/assets/image-20230604182722906-50824e4d.png" alt="image-20230604182722906"></p><p>其中 snsapi_base 属于基础接口，若应用已拥有其它 scope 权限，则默认拥有 snsapi_base 的权限。使用 snsapi_base 可以让移动端网页授权绕过跳转授权登录页请求用户授权的动作，直接跳转第三方网页带上授权临时票据（code），但会使得用户已授权作用域（scope）仅为 snsapi_base，从而导致无法获取到需要用户授权才允许获得的数据和基础功能。 接口调用方法可查阅<a href="https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Authorized_Interface_Calling_UnionID.html" target="_blank" rel="noopener noreferrer">《微信授权关系接口调用指南》<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>获取用户信息接口文档：https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Authorized_Interface_Calling_UnionID.html</p><p>接口地址</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>http请求方式: GET
<span class="token header"><span class="token header-name keyword">https</span><span class="token punctuation">:</span><span class="token header-value">//api.weixin.qq.com/sns/userinfo?access_token=ACCESS_TOKEN&amp;openid=OPENID</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如下：</p><p><img src="/MyBlog/assets/image-20230604182747702-88e26e49.png" alt="image-20230604182747702"></p><p>响应：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;openid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;OPENID&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;nickname&quot;</span><span class="token operator">:</span> <span class="token string">&quot;NICKNAME&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sex&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;province&quot;</span><span class="token operator">:</span> <span class="token string">&quot;PROVINCE&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;city&quot;</span><span class="token operator">:</span> <span class="token string">&quot;CITY&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;country&quot;</span><span class="token operator">:</span> <span class="token string">&quot;COUNTRY&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;headimgurl&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://thirdwx.qlogo.cn/mmopen/g3MonUZtNHkdmzicIlibx6iaFqAc56vxLSUfpb6n5WKSYVY0ChQKkiaJSgQ1dZuTOgvLLrhJbERQQ4eMsv84eavHiaiceqxibJxCfHe/0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;privilege&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;PRIVILEGE1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;PRIVILEGE2&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;unionid&quot;</span><span class="token operator">:</span> <span class="token string">&quot; o6_bmasdasdsad6_2sgVt7hMZOPfL&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明如下：</p><div class="language-tex line-numbers-mode" data-ext="tex"><pre class="language-tex"><code>
参数            说明
openid        普通用户的标识，对当前开发者帐号唯一
nickname        普通用户昵称
sex            普通用户性别，1为男性，2为女性
province        普通用户个人资料填写的省份
city            普通用户个人资料填写的城市
country        国家，如中国为CN
headimgurl        用户头像，最后一个数值代表正方形头像大小（有0、46、64、96、132数值可选，0代表640*640正方形头像），用户没有头像时该项为空
privilege        用户特权信息，json数组，如微信沃卡用户为（chinaunicom）
unionid          用户统一标识。针对一个微信开放平台帐号下的应用，同一用户的 unionid 是唯一的。

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-准备开发环境" tabindex="-1"><a class="header-anchor" href="#_4-2-准备开发环境" aria-hidden="true">#</a> <strong>4.2 准备开发环境</strong></h3><h4 id="_4-2-1-添加应用" tabindex="-1"><a class="header-anchor" href="#_4-2-1-添加应用" aria-hidden="true">#</a> <strong>4.2.1 添加应用</strong></h4><p>1、注册微信开放平台</p><p>https://open.weixin.qq.com/</p><p>2、添加应用</p><p>进入网站应用，添加应用</p><p><img src="/MyBlog/assets/image-20230604182816152-e136a2b4.png" alt="image-20230604182816152"></p><p>3、添加应用需要指定一个外网域名作为微信回调域名</p><p>审核通过后，生成 app 密钥。</p><p>最终获取 appID 和 AppSecret</p><h4 id="_4-2-2-内网穿透" tabindex="-1"><a class="header-anchor" href="#_4-2-2-内网穿透" aria-hidden="true">#</a> <strong>4.2.2 内网穿透</strong></h4><p>我们的开发环境在局域网，微信回调指向一个公网域名。</p><blockquote><p>如何让微信回调请求至我们的开发计算机上呢？</p></blockquote><p>可以使用内网穿透技术，<code>什么是内网穿透？</code></p><p>内网穿透简单来说就是将内网外网通过隧道打通,让内网的数据让外网可以获取。比如常用的办公室软件等，一般在办公室或家里，通过拨号上网，这样办公软件只有在本地的局域网之内才能访问，那么问题来了，如果是手机上，或者公司外地的办公人员，如何访问到办公软件呢？这就需要内网穿透工具了。开启隧道之后，网穿透工具会分配一个专属域名/端口,办公软件就已经在公网上了,在外地的办公人员可以在任何地方愉快的访问办公软件了~~</p><p><img src="/MyBlog/assets/image-20230604182827483-3d64a7c8.png" alt="image-20230604182827483"></p><p>1、在内网穿透服务器上开通隧道，配置外网域名，配置穿透内网的端口即本地电脑上的端口。</p><p><img src="/MyBlog/assets/image-20230604182831376-9990bb86.png" alt="image-20230604182831376"></p><p>这里我们配置认证服务端口，最终实现通过外网域名访问本地认证服务。</p><p>2、在本地电脑上安装内网穿透的工具，工具上配置内网穿透服务器隧道 token。</p><p>市面上做内网穿透的商家很多，需要时可以查阅资料了解下。</p><h3 id="_4-3-接入微信登录" tabindex="-1"><a class="header-anchor" href="#_4-3-接入微信登录" aria-hidden="true">#</a> <strong>4.3 接入微信登录</strong></h3><h4 id="_4-3-1-接入分析" tabindex="-1"><a class="header-anchor" href="#_4-3-1-接入分析" aria-hidden="true">#</a> <strong>4.3.1 接入分析</strong></h4><p>根据 OAuth2 协议授权码流程，结合本项目自身特点，分析接入微信扫码登录的流程如下：</p><p><img src="/MyBlog/assets/image-20230604182837011-01e03588.png" alt="image-20230604182837011"></p><p>本项目认证服务需要做哪些事？</p><p>1、需要定义接口接收微信下发的授权码。</p><p>2、收到授权码调用微信接口申请令牌。</p><p>3、申请到令牌调用微信获取用户信息</p><p>4、获取用户信息成功将其写入本项目用户中心数据库。</p><p>5、最后重定向到浏览器自动登录。</p><h4 id="_4-3-2-定义接口" tabindex="-1"><a class="header-anchor" href="#_4-3-2-定义接口" aria-hidden="true">#</a> <strong>4.3.2 定义接口</strong></h4><p>参考接口规范中“请求获取授权码” 定义接收微信下发的授权码接口，</p><p>定义 WxLoginController 类，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxLoginController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/wxLogin&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">wxLogin</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> state<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;微信扫码回调,code:{},state:{}&quot;</span><span class="token punctuation">,</span>code<span class="token punctuation">,</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//请求微信申请令牌，拿到令牌查询用户信息，将用户信息写入本项目数据库</span>
        <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//暂时硬编写，目的是调试环境</span>
        xcUser<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>xcUser<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://www.51xuecheng.cn/error.html&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> xcUser<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://www.51xuecheng.cn/sign.html?username=&quot;</span><span class="token operator">+</span>username<span class="token operator">+</span><span class="token string">&quot;&amp;authType=wx&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>定义微信认证的 service</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">UUID</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> 微信扫码认证
 * <span class="token keyword">@date</span> 2022/9/29 12:12
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">&quot;wx_authservice&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxAuthServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserMapper</span> xcUserMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">XcUserExt</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AuthParamsDto</span> authParamsDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">//账号</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XcUser</span> user <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>user<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//返回空表示用户不存在</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;账号不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">XcUserExt</span> xcUserExt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUserExt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span>xcUserExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> xcUserExt<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-3-3-接口环境测试" tabindex="-1"><a class="header-anchor" href="#_4-3-3-接口环境测试" aria-hidden="true">#</a> <strong>4.3.3 接口环境测试</strong></h4><p>接口定义好下边进行测试下，主要目的是测试接口调度的环境。</p><p>1、启动内网穿透工具</p><p>2、在/wxLogin 接口中打断点</p><p>3、打开前端微信扫码页面</p><p><img src="/MyBlog/assets/image-20230604182911877-6b809596.png" alt="image-20230604182911877"></p><p>点击微信图标打开二维码</p><p><img src="/MyBlog/assets/image-20230604182917079-8d0dc706.png" alt="image-20230604182917079"></p><p>用户扫码，确认授权</p><p>此时正常进入 /wxLogin 方法，最后跳转到http://www.51xuecheng.cn/sign.html?username=t1&amp;authType=wx。</p><h4 id="_4-3-4-接入微信认证" tabindex="-1"><a class="header-anchor" href="#_4-3-4-接入微信认证" aria-hidden="true">#</a> <strong>4.3.4 接入微信认证</strong></h4><p>接下来请求微信申请令牌。</p><p>1、使用 restTemplate 请求微信，配置 RestTemplate bean</p><p>在启动类配置 restTemplate</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">RestTemplate</span> restTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OkHttp3ClientHttpRequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span>  restTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、定义与微信认证的 service 接口：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> 微信认证接口
 * <span class="token keyword">@date</span> 2023/2/21 22:15
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">WxAuthService</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">XcUser</span> <span class="token function">wxAuth</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3、下边在 controller 中调用 wxAuth 接口：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxLoginController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">WxAuthService</span> wxAuthService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/wxLogin&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">wxLogin</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> state<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;微信扫码回调,code:{},state:{}&quot;</span><span class="token punctuation">,</span>code<span class="token punctuation">,</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//请求微信申请令牌，拿到令牌查询用户信息，将用户信息写入本项目数据库</span>
        <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> wxAuthService<span class="token punctuation">.</span><span class="token function">wxAuth</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>xcUser<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://www.51xuecheng.cn/error.html&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> xcUser<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://www.51xuecheng.cn/sign.html?username=&quot;</span><span class="token operator">+</span>username<span class="token operator">+</span><span class="token string">&quot;&amp;authType=wx&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="/MyBlog/assets/image-20230608211738183-098a5993.png" alt="image-20230608211738183"></p><p>配置 appid 和 秘钥</p><p>4、在 WxAuthService 的 wxAuth 方法中实现申请令牌、查询用户信息等内容。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">&quot;wx_authservice&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxAuthServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthService</span><span class="token punctuation">,</span> <span class="token class-name">WxAuthService</span> <span class="token punctuation">{</span>


<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${weixin.appid}&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">String</span> appid<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${weixin.secret}&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">String</span> secret<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">XcUser</span> <span class="token function">wxAuth</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token comment">//收到code调用微信接口申请access_token</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> access_token_map <span class="token operator">=</span> <span class="token function">getAccess_token</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>access_token_map<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>access_token_map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> openid <span class="token operator">=</span> access_token_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;openid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> access_token <span class="token operator">=</span> access_token_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;access_token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//拿access_token查询用户信息</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> userinfo <span class="token operator">=</span> <span class="token function">getUserinfo</span><span class="token punctuation">(</span>access_token<span class="token punctuation">,</span> openid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>userinfo<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//添加用户到数据库</span>
    <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> xcUser<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 申请访问令牌,响应示例
 <span class="token punctuation">{</span>
 &quot;access_token&quot;:&quot;ACCESS_TOKEN&quot;,
 &quot;expires_in&quot;:7200,
 &quot;refresh_token&quot;:&quot;REFRESH_TOKEN&quot;,
 &quot;openid&quot;:&quot;OPENID&quot;,
 &quot;scope&quot;:&quot;SCOPE&quot;,
 &quot;unionid&quot;: &quot;o6_bmasdasdsad6_2sgVt7hMZOPfL&quot;
 <span class="token punctuation">}</span>
*/</span>
<span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAccess_token</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">String</span> wxUrl_template <span class="token operator">=</span> <span class="token string">&quot;https://api.weixin.qq.com/sns/oauth2/access_token?appid=%s&amp;secret=%s&amp;code=%s&amp;grant_type=authorization_code&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//请求微信地址</span>
    <span class="token class-name">String</span> wxUrl <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>wxUrl_template<span class="token punctuation">,</span> appid<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>

    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;调用微信接口申请access_token, url:{}&quot;</span><span class="token punctuation">,</span> wxUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> exchange <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>wxUrl<span class="token punctuation">,</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> result <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;调用微信接口申请access_token: 返回值:{}&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> resultMap <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> resultMap<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**获取用户信息，示例如下：
 <span class="token punctuation">{</span>
 &quot;openid&quot;:&quot;OPENID&quot;,
 &quot;nickname&quot;:&quot;NICKNAME&quot;,
 &quot;sex&quot;:1,
 &quot;province&quot;:&quot;PROVINCE&quot;,
 &quot;city&quot;:&quot;CITY&quot;,
 &quot;country&quot;:&quot;COUNTRY&quot;,
 &quot;headimgurl&quot;: &quot;https://thirdwx.qlogo.cn/mmopen/g3MonUZtNHkdmzicIlibx6iaFqAc56vxLSUfpb6n5WKSYVY0ChQKkiaJSgQ1dZuTOgvLLrhJbERQQ4eMsv84eavHiaiceqxibJxCfHe/0&quot;,
 &quot;privilege&quot;:[
 &quot;PRIVILEGE1&quot;,
 &quot;PRIVILEGE2&quot;
 ],
 &quot;unionid&quot;: &quot; o6_bmasdasdsad6_2sgVt7hMZOPfL&quot;
 <span class="token punctuation">}</span>
*/</span>
<span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUserinfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> access_token<span class="token punctuation">,</span><span class="token class-name">String</span> openid<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">String</span> wxUrl_template <span class="token operator">=</span> <span class="token string">&quot;https://api.weixin.qq.com/sns/userinfo?access_token=%s&amp;openid=%s&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//请求微信地址</span>
    <span class="token class-name">String</span> wxUrl <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>wxUrl_template<span class="token punctuation">,</span> access_token<span class="token punctuation">,</span>openid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;调用微信接口申请access_token, url:{}&quot;</span><span class="token punctuation">,</span> wxUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> exchange <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>wxUrl<span class="token punctuation">,</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//防止乱码进行转码</span>
    <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token keyword">new</span>     <span class="token class-name">String</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">ISO_8859_1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;调用微信接口申请access_token: 返回值:{}&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> resultMap <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> resultMap<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试获取用户信息</p><p>1、在获取用户信息处打断点</p><p>2、进入http://www.51xuecheng.cn/wxsign.html</p><p>3、手机扫码授权</p><h4 id="_4-3-5-保存用户信息" tabindex="-1"><a class="header-anchor" href="#_4-3-5-保存用户信息" aria-hidden="true">#</a> <strong>4.3.5 保存用户信息</strong></h4><p>向数据库保存用户信息，如果用户不存在将其保存在数据库。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">XcUserRoleMapper</span> xcUserRoleMapper<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token class-name">XcUser</span> <span class="token function">addWxUser</span><span class="token punctuation">(</span><span class="token class-name">Map</span> userInfo_map<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> unionid <span class="token operator">=</span> userInfo_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;unionid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//根据unionid查询数据库</span>
    <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getWxUnionid</span><span class="token punctuation">,</span> unionid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>xcUser<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> xcUser<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> userId <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setWxUnionid</span><span class="token punctuation">(</span>unionid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//记录从微信得到的昵称</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span>userInfo_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;nickname&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setUserpic</span><span class="token punctuation">(</span>userInfo_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;headimgurl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>userInfo_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;nickname&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>unionid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>unionid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setUtype</span><span class="token punctuation">(</span><span class="token string">&quot;101001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//学生类型</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//用户状态</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUserMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>xcUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">XcUserRole</span> xcUserRole <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUserRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUserRole<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUserRole<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUserRole<span class="token punctuation">.</span><span class="token function">setRoleId</span><span class="token punctuation">(</span><span class="token string">&quot;17&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//学生角色</span>
    xcUserRoleMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>xcUserRole<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> xcUser<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>调用保存用户信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">WxAuthServiceImpl</span> currentProxy<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">XcUser</span> <span class="token function">wxAuth</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token comment">//收到code调用微信接口申请access_token</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> access_token_map <span class="token operator">=</span> <span class="token function">getAccess_token</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>access_token_map<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>access_token_map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> openid <span class="token operator">=</span> access_token_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;openid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> access_token <span class="token operator">=</span> access_token_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;access_token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//拿access_token查询用户信息</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> userinfo <span class="token operator">=</span> <span class="token function">getUserinfo</span><span class="token punctuation">(</span>access_token<span class="token punctuation">,</span> openid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>userinfo<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//将用户信息保存到数据库</span>
    <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> currentProxy<span class="token punctuation">.</span><span class="token function">addWxUser</span><span class="token punctuation">(</span>userinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> xcUser<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试保存用户信息</p><p>1、在保存用户信息处打断点</p><p>2、进入http://www.51xuecheng.cn/wxsign.html</p><p>3、手机扫码授权</p><p>4、自动跳转到登录页面，提交认证成功。</p><h2 id="_5-用户授权" tabindex="-1"><a class="header-anchor" href="#_5-用户授权" aria-hidden="true">#</a> <strong>5 用户授权</strong></h2><h3 id="_5-1-rbac" tabindex="-1"><a class="header-anchor" href="#_5-1-rbac" aria-hidden="true">#</a> <strong>5.1 RBAC</strong></h3><p>如何实现授权？业界通常基于 RBAC 实现授权。</p><p>RBAC 分为两种方式：</p><p>基于角色的访问控制（Role-Based Access Control）</p><p>基于资源的访问控制（Resource-Based Access Control）</p><p>角色的访问控制（Role-Based Access Control）是按角色进行授权，比如：主体的角色为总经理可以查询企业运营报表，查询员工工资信息等，访问控制流程如下：</p><p><img src="/MyBlog/assets/image-20230604183050092-53b2c84e.png" alt="image-20230604183050092"></p><p>根据上图中的判断逻辑，授权代码可表示如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">if</span><span class="token punctuation">(</span>主体<span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">&quot;总经理角色id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
查询工资
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果上图中查询工资所需要的角色变化为总经理和部门经理，此时就需要修改判断逻辑为“判断用户的角色是否是总经理或部门经理”，修改代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">if</span><span class="token punctuation">(</span>主体<span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">&quot;总经理角色id&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span>  主体<span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">&quot;部门经理角色id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    查询工资
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>根据上边的例子发现，当需要修改角色的权限时就需要修改授权的相关代码，系统可扩展性差。</p><p>基于资源的访问控制（Resource-Based Access</p><p>Control）是按资源（或权限）进行授权，比如：用户必须具有查询工资权限才可以查询员工工资信息等，访问控制流程如下：</p><p><img src="/MyBlog/assets/image-20230604183118856-8efaa20f.png" alt="image-20230604183118856"></p><p>根据上图中的判断，授权代码可以表示为：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">if</span><span class="token punctuation">(</span>主体<span class="token punctuation">.</span><span class="token function">hasPermission</span><span class="token punctuation">(</span><span class="token string">&quot;查询工资权限标识&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    查询工资
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>优点：系统设计时定义好查询工资的权限标识，即使查询工资所需要的角色变化为总经理和部门经理也不需要修改授权代码，系统可扩展性强。</p><h3 id="_5-2-资源服务授权流程" tabindex="-1"><a class="header-anchor" href="#_5-2-资源服务授权流程" aria-hidden="true">#</a> <strong>5.2 资源服务授权流程</strong></h3><p>本项目在资源服务内部进行授权，基于资源的授权模式，因为接口在资源服务，通过在接口处添加授权注解实现授权。</p><p>1、首先配置 nginx 代理</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>   http <span class="token punctuation">{</span>
    server_names_hash_bucket_size <span class="token number">64</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

   #前端开发服务
  upstream uidevserver<span class="token punctuation">{</span>
    server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8601</span> weight<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
   server <span class="token punctuation">{</span>
        listen       <span class="token number">80</span><span class="token punctuation">;</span>
        server_name  teacher<span class="token punctuation">.</span><span class="token number">51</span>xuecheng<span class="token punctuation">.</span>cn<span class="token punctuation">;</span>
        #charset koi8<span class="token operator">-</span>r<span class="token punctuation">;</span>
        ssi on<span class="token punctuation">;</span>
        ssi_silent_errors on<span class="token punctuation">;</span>
        #access_log  logs<span class="token operator">/</span>host<span class="token punctuation">.</span>access<span class="token punctuation">.</span>log  main<span class="token punctuation">;</span>
        #location <span class="token operator">/</span> <span class="token punctuation">{</span>
         #   alias   <span class="token class-name">D</span><span class="token operator">:</span><span class="token operator">/</span>itcast2022<span class="token operator">/</span>xc_edu3<span class="token punctuation">.</span><span class="token number">0</span><span class="token operator">/</span>code_1<span class="token operator">/</span>dist<span class="token operator">/</span><span class="token punctuation">;</span>
         #   index  index<span class="token punctuation">.</span>html index<span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
        #<span class="token punctuation">}</span>
        location <span class="token operator">/</span> <span class="token punctuation">{</span>
            proxy_pass   http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>uidevserver<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        location <span class="token operator">/</span>api<span class="token operator">/</span> <span class="token punctuation">{</span>
            proxy_pass http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>gatewayserver<span class="token operator">/</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


   <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>加载 nginx 配置。</p><p>2、在资源服务集成 Spring Security</p><p>在需要授权的接口处使用<code>@PreAuthorize(&quot;hasAuthority(&#39;权限标识符&#39;)&quot;)</code>进行控制</p><p>下边代码指定/course/list 接口需要拥有 xc_teachmanager_course_list 权限。</p><p><img src="/MyBlog/assets/image-20230604183146449-1b0bc60c.png" alt="image-20230604183146449"></p><p>设置了@PreAuthorize 表示执行此方法需要授权，如果当前用户请求接口没有权限则抛出异常</p><p>org.springframework.security.access.AccessDeniedException: 不允许访问</p><p>3、在统一异常处理处解析此异常信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseStatus</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RestErrorResponse</span> <span class="token function">exception</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

   log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;【系统异常】{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
   e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;不允许访问&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestErrorResponse</span><span class="token punctuation">(</span><span class="token string">&quot;没有操作此功能的权限&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestErrorResponse</span><span class="token punctuation">(</span><span class="token class-name">CommonError</span><span class="token punctuation">.</span><span class="token constant">UNKOWN_ERROR</span><span class="token punctuation">.</span><span class="token function">getErrMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4、重启资源服务进行测试</p><p>使用教学机构用户登录系统</p><p>这里使用 t1 用户登录，账号:t1、密码：111111</p><p>登录成功，点击“教学机构”</p><p><img src="/MyBlog/assets/image-20230604183204291-7dbd299b.png" alt="image-20230604183204291"></p><p>当用户没有权限时页面提示：没有操作此功能的权限。</p><p><img src="/MyBlog/assets/image-20230604183207873-5a3a243a.png" alt="image-20230604183207873"></p><h3 id="_5-3-授权相关的数据模型" tabindex="-1"><a class="header-anchor" href="#_5-3-授权相关的数据模型" aria-hidden="true">#</a> <strong>5.3 授权相关的数据模型</strong></h3><blockquote><p>如何给用户分配权限呢？</p></blockquote><p>首先要学习数据模型，本项目授权相关的数据表如下：</p><p><img src="/MyBlog/assets/image-20230604183218592-e5db4b3e.png" alt="image-20230604183218592"></p><p>说明如下：</p><p>xc_user：用户表，存储了系统用户信息，用户类型包括：学生、老师、管理员等</p><p>xc_role：角色表，存储了系统的角色信息，学生、老师、教学管理员、系统管理员等。</p><p>xc_user_role：用户角色表，一个用户可拥有多个角色，一个角色可被多个用户所拥有</p><p>xc_menu:模块表，记录了菜单及菜单下的权限</p><p>xc_permission:角色权限表，一个角色可拥有多个权限，一个权限可被多个角色所拥有</p><p>本项目教学阶段不再实现权限定义及用户权限分配的功能，权限分配的界面原型如下图所示：</p><p><img src="/MyBlog/assets/image-20230604183224065-c9f0dce9.png" alt="image-20230604183224065"></p><p>本项目要求掌握基于权限数据模型（5 张数据表），要求在数据库中操作完成给用户分配权限、查询用户权限等需求。</p><p>1、查询用户所拥有的权限</p><p>步骤：</p><p>查询用户的 id</p><p>查询用户所拥有的角色</p><p>查询用户所拥有的权限</p><p>例子：</p><p>SELECT * FROM xc_menu WHERE id IN(<br> SELECT menu_id FROM xc_permission WHERE role_id IN(<br> SELECT role_id FROM xc_user_role WHERE user_id = &#39;52&#39;<br> )<br> )</p><p>2、给用户分配权限</p><p>1）添加权限</p><p>查询用户的 id</p><p>查询权限的 id</p><p>查询用户的角色，如果没有角色需要先给用户指定角色</p><p>向角色权限表添加记录</p><p>2）删除用户权限</p><p>本项目是基于角色分配权限，如果要删除用户的权限可以给用户换角色，那么新角色下的权限就是用户的权限；如果不换用户的角色可以删除角色下的权限即删除角色权限关系表相应记录，这样操作是将角色下的权限删除，属于该角色的用户都将删除此权限。</p><h3 id="_5-4-查询用户权限" tabindex="-1"><a class="header-anchor" href="#_5-4-查询用户权限" aria-hidden="true">#</a> <strong>5.4 查询用户权限</strong></h3><p>使用 Spring Security 进行授权，首先在生成 jwt 前会查询用户的权限，如下图：</p><p><img src="/MyBlog/assets/image-20230604183238823-7900ac85.png" alt="image-20230604183238823"></p><p>接下来需要修改 UserServiceImpl 和 PasswordAuthServiceImpl 从数据库查询用户的权限。</p><p>1、定义 mapper 接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">XcMenuMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcMenu</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT    * FROM xc_menu WHERE id IN (SELECT menu_id FROM xc_permission WHERE role_id IN ( SELECT role_id FROM xc_user_role WHERE user_id = #{userId} ))&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcMenu</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectPermissionByUserId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、修改 PasswordAuthServiceImpl</p><p>修改 UserServiceImpl 类的 getUserPrincipal 方法，查询权限信息</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//查询用户身份</span>
<span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">getUserPrincipal</span><span class="token punctuation">(</span><span class="token class-name">XcUserExt</span> user<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> password <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//查询用户权限</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcMenu</span><span class="token punctuation">&gt;</span></span> xcMenus <span class="token operator">=</span> menuMapper<span class="token punctuation">.</span><span class="token function">selectPermissionByUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> permissions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>xcMenus<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//用户权限,如果不加则报Cannot pass a null GrantedAuthority collection</span>
        permissions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;p1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        xcMenus<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>menu<span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            permissions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>menu<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//将用户权限放在XcUserExt中</span>
    user<span class="token punctuation">.</span><span class="token function">setPermissions</span><span class="token punctuation">(</span>permissions<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//为了安全在令牌中不放密码</span>
    user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将user对象转json</span>
    <span class="token class-name">String</span> userString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> authorities <span class="token operator">=</span> permissions<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span>userString<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> userDetails<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-5-授权测试" tabindex="-1"><a class="header-anchor" href="#_5-5-授权测试" aria-hidden="true">#</a> <strong>5.5 授权测试</strong></h3><p>以上实现了认证时从数据库查询用户的权限，下边进行用户授权测试。</p><p>重启认证服务，使用内容管理课程列表查询为例，代码如下：</p><p><img src="/MyBlog/assets/image-20230604183306637-52d29130.png" alt="image-20230604183306637"></p><p>用户拥有 xc_teachmanager_course_list 权限方可访问课程查询接口。</p><p>以用户 stu1 为例，当它没有此权限时页面报“没有此操作的权限”错误</p><p><img src="/MyBlog/assets/image-20230604183309879-169eefa4.png" alt="image-20230604183309879"></p><p>将 xc_teachmanager_course_list 权限分配给用户。</p><p>1）首先找到当前用户的角色</p><p>2）找到 xc_teachmanager_course_list 权限的主键</p><p>3）在角色权限关系表中添加记录</p><p>分配完权限需要重新登录</p><p>由于用户分配了 xc_teachmanager_course_list 权限，用户具有访问课程查询接口的权限。</p><h3 id="_5-6-细粒度授权" tabindex="-1"><a class="header-anchor" href="#_5-6-细粒度授权" aria-hidden="true">#</a> <strong>5.6 细粒度授权</strong></h3><h4 id="_5-6-1-什么是细粒度授权" tabindex="-1"><a class="header-anchor" href="#_5-6-1-什么是细粒度授权" aria-hidden="true">#</a> <strong>5.6.1 什么是细粒度授权</strong></h4><blockquote><p>什么是细粒度授权？</p></blockquote><p>细粒度授权也叫数据范围授权，即不同的用户所拥有的操作权限相同，但是能够操作的数据范围是不一样的。一个例子：用户 A 和用户 B 都是教学机构，他们都拥有“我的课程”权限，但是两个用户所查询到的数据是不一样的。</p><p>本项目有哪些细粒度授权？</p><p>比如：</p><p>我的课程，教学机构只允许查询本教学机构下的课程信息。</p><p>我的选课，学生只允许查询自己所选课。</p><p>如何实现细粒度授权？</p><p>细粒度授权涉及到不同的业务逻辑，通常在 service 层实现，根据不同的用户进行校验，根据不同的参数查询不同的数据或操作不同的数据。</p><h4 id="_5-6-2-教学机构细粒度授权" tabindex="-1"><a class="header-anchor" href="#_5-6-2-教学机构细粒度授权" aria-hidden="true">#</a> <strong>5.6.2 教学机构细粒度授权</strong></h4><p>教学机构在维护课程时只允许维护本机构的课程，教学机构细粒度授权过程如下：</p><p>1）获取当前登录的用户身份</p><p>2）得到用户所属教育机构的 Id</p><p>3）查询该教学机构下的课程信息</p><p>最终实现了用户只允许查询自己机构的课程信息。</p><p>根据公司 Id 查询课程，流程如下：</p><p>1）教学机构用户登录系统，从用户身份中取出所属机构的 id</p><p>在用户表中设计了 company_id 字段存储该用户所属的机构 id.</p><p>2）接口层取出当前登录用户的身份，取出机构 id</p><p>3) 将机构 id 传入 service 方法。</p><p>4) service 方法将机构 id 传入 Dao 方法，最终查询出本机构的课程信息。</p><p>代码实现如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;课程查询接口&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;hasAuthority(&#39;xc_teachmanager_course_list&#39;)&quot;</span><span class="token punctuation">)</span><span class="token comment">//拥有课程列表查询的权限方可访问</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/course/list&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">PageResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseBase</span><span class="token punctuation">&gt;</span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">PageParams</span> pageParams<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">QueryCourseParamsDto</span> queryCourseParams<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//取出用户身份</span>
    <span class="token class-name">XcUser</span> user <span class="token operator">=</span> <span class="token class-name">SecurityUtil</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//机构id</span>
    <span class="token class-name">String</span> companyId <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getCompanyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> courseBaseInfoService<span class="token punctuation">.</span><span class="token function">queryCourseBaseList</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">,</span>pageParams<span class="token punctuation">,</span>queryCourseParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Service 方法如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">PageResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseBase</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryCourseBaseList</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span><span class="token class-name">PageParams</span> pageParams<span class="token punctuation">,</span> <span class="token class-name">QueryCourseParamsDto</span> queryCourseParamsDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>

 <span class="token comment">//构建查询条件对象</span>
 <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseBase</span><span class="token punctuation">&gt;</span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//机构id</span>
 queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">CourseBase</span><span class="token operator">::</span><span class="token function">getCompanyId</span><span class="token punctuation">,</span>companyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-6-3-教学机构细粒度授权测试" tabindex="-1"><a class="header-anchor" href="#_5-6-3-教学机构细粒度授权测试" aria-hidden="true">#</a> <strong>5.6.3 教学机构细粒度授权测试</strong></h4><p>使用一个教学机构的用户登录项目，并且此用户具有查询课程的权限。</p><p>手机修改数据库指定用户归属到一个机构中，涉及以下数据表：</p><p>xc_company 为机构表</p><p>xc_company_user 为机构用户关系表</p><p>xc_user 表中有 company_id 字段。</p><p>我们准备了 t1 用户作为此次测试的用户，使用此用户登录系统：</p><p>提前在查询课程列表接口处打上断点。</p><p>经过测试可以正常取出用户所属的机构 id</p><p><img src="/MyBlog/assets/image-20230604183347236-6f134fd4.png" alt="image-20230604183347236"></p><p>跟踪持久层日志发现已将机构 id 传入 dao 方法，拼装 sql 语句，查询本机构的课程信息</p><p><img src="/MyBlog/assets/image-20230604183417411-8056ab9f.png" alt="image-20230604183417411"></p><h2 id="_6-实战" tabindex="-1"><a class="header-anchor" href="#_6-实战" aria-hidden="true">#</a> <strong>6 实战</strong></h2><h3 id="_6-1-找回密码-实战" tabindex="-1"><a class="header-anchor" href="#_6-1-找回密码-实战" aria-hidden="true">#</a> <strong>6.1 找回密码(实战)</strong></h3><p>需求：忘记密码需要找回，可以通过手机号找回密码，通过邮箱找回密码以及人工通道。</p><p>界面访问地址：http://www.51xuecheng.cn/findpassword.html</p><p><img src="/MyBlog/assets/image-20230604183353300-9a63564b.png" alt="image-20230604183353300"></p><blockquote><p>由于邮件发送比手机验证码要方便的多，所以这里就只做邮件注册、找回密码了</p></blockquote><p>接口：</p><p>手机验证码：/api/checkcode/phone?param1=手机号</p><p>邮箱验证码：/api/checkcode/phone?param1=电子邮箱地址</p><p>找回密码：/api/auth/findpassword</p><p>请求：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;cellphone&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;email&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;checkcodekey&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;checkcode&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;confirmpwd&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>响应：</p><p>200: 找回成功</p><p>其它：找回失败，失败原因使用统一异常处理返回的信息格式</p><p>执行流程<br> 1、校验验证码，不一致则抛出异常</p><p>2、判断两次密码是否一致，不一致则抛出异常</p><p>3、根据手机号和邮箱查询用户</p><p>4、如果找到用户更新为新密码</p><h3 id="_6-2-注册-实战" tabindex="-1"><a class="header-anchor" href="#_6-2-注册-实战" aria-hidden="true">#</a> <strong>6.2 注册(实战)</strong></h3><p>需求：为学生提供注册入口，通过此入口注册的用户为学生用户。</p><p>界面访问地址：http://www.51xuecheng.cn/register.html</p><p><img src="/MyBlog/assets/image-20230604183444148-b9f138f9.png" alt="image-20230604183444148"></p><p>接口：</p><p>手机验证码：/api/checkcode/phone?param1=手机号</p><p>注册：/api/auth/register</p><p>请求：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;cellphone&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;email&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;nickname&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;confirmpwd&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;checkcodekey&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;checkcode&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>响应：</p><p>200: 注册成功</p><p>其它：注册失败，失败原因使用统一异常处理返回的信息格式</p><p>执行流程：</p><p>1、校验验证码，如果不一致则抛出异常</p><p>2、校验两次密码是否一致，如果不一致则抛出异常</p><p>3、校验用户是否存在，如果存在则抛出异常</p><p>4、向用户表、用户角色关系表添加数据。角色为学生角色。</p></div><!--[--><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/ZyKunn/edit/main/notes/project/02/第5章-认证授权v3.1/README.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--]--> Edit this page <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">贡献者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 814342838@qq.com">ZyKun</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/MyBlog/notes/project/02/%E7%AC%AC4%E7%AB%A0-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83v3.1/" class="" aria-label="第 4 章 课程发布 v3.1"><!--[--><!--]--> 第 4 章 课程发布 v3.1 <!--[--><!--]--></a></span><span class="next"><a href="/MyBlog/notes/project/02/%E7%AC%AC6%E7%AB%A0-%E9%80%89%E8%AF%BE%E5%AD%A6%E4%B9%A0v3.1/" class="" aria-label="第 6 章 选课学习 v3.1"><!--[--><!--]--> 第 6 章 选课学习 v3.1 <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/MyBlog/assets/app-a153c100.js" defer></script>
  </body>
</html>
