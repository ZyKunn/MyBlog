import{_ as i,r as c,o as l,c as u,a as n,e as a,w as t,b as s,d as e}from"./app-a153c100.js";const r="/MyBlog/assets/image-20230531092042421-67b247f3.png",k="/MyBlog/assets/image-20230531093114433-7fd8c6f5.png",d="/MyBlog/assets/image-20230531093123955-743106dd.png",m="/MyBlog/assets/image-20230531093129385-b0bb49f4.png",v="/MyBlog/assets/image-20230531093136457-5f8bb616.png",b="/MyBlog/assets/image-20230531093141485-d3efa63a.png",g="/MyBlog/assets/image-20230531093151238-c5b2503b.png",h="/MyBlog/assets/image-20230531093200128-d61f29b2.png",y="/MyBlog/assets/image-20230531093205346-748af5cf.png",w="/MyBlog/assets/image-20230531093212678-25785b42.png",q="/MyBlog/assets/image-20230531093129385-b0bb49f4.png",f="/MyBlog/assets/image-20230531093129385-b0bb49f4.png",x="/MyBlog/assets/image-20230531093229934-ee1e0f00.png",_="/MyBlog/assets/image-20230531093235535-66d3ad77.png",S="/MyBlog/assets/image-20230531093240482-b5230709.png",M="/MyBlog/assets/image-20230531093248127-8bb2435d.png",P="/MyBlog/assets/image-20230531093313544-11969728.png",I="/MyBlog/assets/image-20230531093337119-02954b67.png",C="/MyBlog/assets/image-20230531093415392-840a7212.png",B="/MyBlog/assets/image-20230526163032509-2bed204f.png",j="/MyBlog/assets/image-20230531093433064-9ebbe6bc.png",A="/MyBlog/assets/image-20230531093438346-b2dda57f.png",T="/MyBlog/assets/image-20230531093528410-d9f9b205.png",R="/MyBlog/assets/image-20230526163213795-e088d241.png",D="/MyBlog/assets/image-20230531093539844-61ba7699.png",F="/MyBlog/assets/image-20230526163230151-daff61cc.png",L="/MyBlog/assets/image-20230531093552400-e3d4d8a8.png",O="/MyBlog/assets/image-20230526163246021-443e036e.png",E="/MyBlog/assets/image-20230531093705972-9186d1c6.png",N="/MyBlog/assets/image-20230531093235535-66d3ad77.png",H="/MyBlog/assets/image-20230531093742648-f3ec5046.png",Q="/MyBlog/assets/image-20230531093746645-0e87e903.png",U="/MyBlog/assets/image-20230531093756845-200020f7.png",z="/MyBlog/assets/image-20230531093828831-e1164a73.png",V="/MyBlog/assets/image-20230531093835233-59072ab8.png",J="/MyBlog/assets/image-20230531093913269-235bc31c.png",X="/MyBlog/assets/image-20230531093918596-1b12c2bb.png",K="/MyBlog/assets/image-20230531093229934-ee1e0f00.png",G="/MyBlog/assets/image-20230531094037507-a4f2454f.png",$="/MyBlog/assets/image-20230531093123955-743106dd.png",W="/MyBlog/assets/image-20230531094049746-15c56bf5.png",Y="/MyBlog/assets/image-20230531094056262-11011fc7.png",Z="/MyBlog/assets/image-20230531094101708-68a251be.png",nn="/MyBlog/assets/image-20230531093151238-c5b2503b.png",sn="/MyBlog/assets/image-20230531094310426-03b918d7.png",an="/MyBlog/assets/image-20230531094336815-94280840.png",pn="/MyBlog/assets/image-20230531094342527-e0c0ab7c.png",tn="/MyBlog/assets/image-20230531094352574-7b91efc1.png",en="/MyBlog/assets/image-20230531094358070-8c8a2cb9.png",on="/MyBlog/assets/image-20230531094402682-aa00f62f.png",cn="/MyBlog/assets/image-20230531094526637-b3386484.png",ln="/MyBlog/assets/image-20230531094533703-178204e1.png",un="/MyBlog/assets/image-20230531094635959-fea07663.png",rn="/MyBlog/assets/image-20230531094640206-29770306.png",kn="/MyBlog/assets/image-20230531094645288-5fbab71c.png",dn="/MyBlog/assets/image-20230531094700210-35cf6eb7.png",mn="/MyBlog/assets/image-20230531094711411-316e3a84.png",vn="/MyBlog/assets/image-20230531094744663-bc7ec7c1.png",bn="/MyBlog/assets/image-20230531094752141-89013dbf.png",gn="/MyBlog/assets/image-20230531094820514-96725b15.png",hn="/MyBlog/assets/image-20230531094825180-75f6db90.png",yn="/MyBlog/assets/image-20230531094943236-adf2127e.png",wn="/MyBlog/assets/image-20230531094950223-9c6b6347.png",qn="/MyBlog/assets/image-20230531095001971-0616cb07.png",fn="/MyBlog/assets/image-20230531095023051-1e0d2b41.png",xn="/MyBlog/assets/image-20230531095112695-639ee39c.png",_n="/MyBlog/assets/image-20230531095112695-639ee39c.png",Sn="/MyBlog/assets/image-20230531095400772-b6fd48c5.png",Mn="/MyBlog/assets/image-20230531095419302-9b340b8b.png",Pn="/MyBlog/assets/image-20230531095422599-63a10e3d.png",In="/MyBlog/assets/image-20230531095526797-404ef62d.png",Cn="/MyBlog/assets/image-20230531094752141-89013dbf.png",Bn="/MyBlog/assets/image-20230531095749816-02baf242.png",jn="/MyBlog/assets/image-20230531095756887-7bfe01ab.png",An="/MyBlog/assets/image-20230531095803107-a6f22ab3.png",Tn="/MyBlog/assets/image-20230531095809466-9b74a196.png",Rn="/MyBlog/assets/image-20230531100057397-e479bae7.png",Dn="/MyBlog/assets/image-20230531100101680-f032cae5.png",Fn="/MyBlog/assets/image-20230531100108692-eb9afe7d.png",Ln="/MyBlog/assets/image-20230531100148575-fd76fa81.png",On="/MyBlog/assets/image-20230531100152847-dd867122.png",En="/MyBlog/assets/image-20230531100158031-665b45eb.png",Nn="/MyBlog/assets/image-20230531100204973-50b21bbf.png",Hn="/MyBlog/assets/image-20230531100209431-8190f7f3.png",Qn="/MyBlog/assets/image-20230531100215209-ca32fd0e.png",Un="/MyBlog/assets/image-20230531100240725-041820cf.png",zn="/MyBlog/assets/image-20230531100245698-2f6488e8.png",Vn="/MyBlog/assets/image-20230531100332701-8b6ce9b4.png",Jn="/MyBlog/assets/image-20230531100405411-dd4f643d.png",Xn="/MyBlog/assets/image-20230531100837646-915cf25d.png",Kn="/MyBlog/assets/image-20230531101012368-7fc2aa0f.png",Gn="/MyBlog/assets/image-20230531101017200-68b62597.png",$n="/MyBlog/assets/image-20230531101151392-8e9ec088.png",Wn="/MyBlog/assets/image-20230531101158112-ff7e84c8.png",Yn="/MyBlog/assets/image-20230531101205123-572da1c2.png",Zn={},ns=n("h1",{id:"第-4-章-课程发布-v3-1",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#第-4-章-课程发布-v3-1","aria-hidden":"true"},"#"),s(),n("strong",null,"第 4 章 课程发布 v3.1")],-1),ss={class:"table-of-contents"},as=e('<h2 id="_1-模块需求分析" tabindex="-1"><a class="header-anchor" href="#_1-模块需求分析" aria-hidden="true">#</a> <strong>1 模块需求分析</strong></h2><h3 id="_1-1-模块介绍" tabindex="-1"><a class="header-anchor" href="#_1-1-模块介绍" aria-hidden="true">#</a> <strong>1.1 模块介绍</strong></h3><p>课程信息编辑完毕即可发布课程，发布课程相当于一个确认操作，课程发布后学习者在网站可以搜索到课程，然后查看课程的详细信息，进一步选课、支付、在线学习。</p><p>下边是课程编辑与发布的整体流程：</p><p><img src="'+r+'" alt="image-20230531092042421"></p><p>为了课程内容没有违规信息、课程内容安排合理，在课程发布之前运营方会进行课程审核，审核通过后课程方可发布。</p><p>作为课程制作方即教学机构，在课程发布前通过课程预览功能可以看到课程发布后的效果，哪里的课程信息存在问题方便查看，及时修改。</p><p>下图是课程预览的效果图，也是课程正式发布后的课程详情界面：</p><p><img src="'+k+'" alt="image-20230531093114433"></p><p>教学机构确认课程内容无误，提交审核，平台运营人员对课程内容审核，审核通过后教学机构人员发布课程成功。</p><p>课程发布模块共包括三块功能：</p><p>1、课程预览</p><p>2、课程审核</p><p>3、课程发布</p><h3 id="_1-2-业务流程" tabindex="-1"><a class="header-anchor" href="#_1-2-业务流程" aria-hidden="true">#</a> <strong>1.2 业务流程</strong></h3><h4 id="_1-2-1-课程预览" tabindex="-1"><a class="header-anchor" href="#_1-2-1-课程预览" aria-hidden="true">#</a> <strong>1.2.1 课程预览</strong></h4><p>1.<strong>教育机构用户</strong>在课程管理中可对该机构内所管理的课程进行检索。</p><p><img src="'+d+'" alt="image-20230531093123955"></p><p>2.点击某课程数据后的预览链接，即可对该课程进行预览，可以看到发布后的详情页面效果。</p><p>下图是课程详情首页，显示了课程的基本信息。</p><p><img src="'+m+'" alt="image-20230531093129385"></p><p>点击课程目录，显示课程计划，通过此界面去核实课程计划的信息是否存在问题。</p><p><img src="'+v+'" alt="image-20230531093136457"></p><p>点击课程目录中的具体章节，查看视频播放是否正常</p><p><img src="'+b+'" alt="image-20230531093141485"></p><h4 id="_1-2-2-课程审核" tabindex="-1"><a class="header-anchor" href="#_1-2-2-课程审核" aria-hidden="true">#</a> <strong>1.2.2 课程审核</strong></h4><p>教学机构提交课程审核后，平台运营人员登录运营平台进行课程审核，课程审核包括程序自动审核和人工审核，程序会审核内容的完整性，人员通过课程预览进行审核。</p><p>流程如下：</p><p><img src="'+g+'" alt="image-20230531093151238"></p><p>1、首先查询待审核的记录。</p><p>2、课程审核</p><p>具体审核的过程与课程预览的过程类似，运营人员查看课程信息、课程视频等内容。</p><p>如果存在问题则审核不通过，并附上审核不通过的原因供教学机构人员查看。</p><p>如果课程内容没有违规信息且课程内容全面则审核通过。</p><p>课程审核通过后教学机构发布课程成功。</p><h4 id="_1-2-3-课程发布" tabindex="-1"><a class="header-anchor" href="#_1-2-3-课程发布" aria-hidden="true">#</a> <strong>1.2.3 课程发布</strong></h4><p>1.<strong>教育机构用户</strong>在课程管理中可对机构内课程进行检索。</p><p><img src="'+h+'" alt="image-20230531093200128"></p><p>2.点击某课程数据后的 发布 链接（审核状态为通过），即可对该课程进行发布。</p><p><img src="'+y+'" alt="image-20230531093205346"></p><p>3、课程发布后可通过课程搜索查询到课程信息，并查看课程的详细信息。</p><p><img src="'+w+'" alt="image-20230531093212678"></p><p>4 点击课程搜索页中课程列表的某个课程，可进入课程详情页。</p><p><img src="'+q+'" alt="image-20230531093217867"></p><h2 id="_2-课程预览" tabindex="-1"><a class="header-anchor" href="#_2-课程预览" aria-hidden="true">#</a> <strong>2 课程预览</strong></h2><h3 id="_2-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_2-1-需求分析" aria-hidden="true">#</a> <strong>2.1 需求分析</strong></h3><p>课程预览就是把课程的相关信息进行整合，在课程详情界面进行展示，通过课程预览页面查看信息是否存在问题。</p><p><img src="'+f+'" alt="image-20230531093225116"></p><p>下图是课程预览的数据来源：</p><p><img src="'+x+'" alt="image-20230531093229934"></p><p>在课程预览页面点击&quot;视频播放图片&quot;打开视频播放页面，通过视频播放页面查看课程计划对应的视频是否存在问题。</p><p><img src="'+_+'" alt="image-20230531093235535"></p><p>课程预览的效果与最终课程发布后查看到的效果是一致的，所以课程预览时会通过网站门户域名地址进行预览，下图显示了整个课程预览的流程图：</p><p><img src="'+S+'" alt="image-20230531093240482"></p><p>说明如下：</p><p>1、点击课程预览，通过 Nginx、后台服务网关请求内容管理服务进行课程预览。</p><p>2、内容管理服务查询课程相关信息进行整合，并通过模板引擎技术在服务端渲染生成页面，返回给浏览器。</p><p>3、通过课程预览页面点击”马上学习“打开视频播放页面。</p><p>4、视频播放页面通过 Nginx 请求后台服务网关，查询课程信息展示课程计划目录，请求媒资服务查询课程计划绑定的视频文件地址，在线浏览播放视频。</p><h3 id="_2-2-模板引擎" tabindex="-1"><a class="header-anchor" href="#_2-2-模板引擎" aria-hidden="true">#</a> <strong>2.2 模板引擎</strong></h3><h4 id="_2-2-1-什么是模板引擎" tabindex="-1"><a class="header-anchor" href="#_2-2-1-什么是模板引擎" aria-hidden="true">#</a> <strong>2.2.1 什么是模板引擎</strong></h4><p>根据前边的数据模型分析，课程预览就是把课程的相关信息进行整合，在课程预览界面进行展示，课程预览界面与课程发布的课程详情界面一致。</p><p>项目采用模板引擎技术实现课程预览界面。什么是模板引擎？</p><p>早期我们采用的 jsp 技术就是一种模板引擎技术，如下图：</p><p><img src="'+M+'" alt="image-20230531093248127"></p><p>1、浏览器请求 web 服务器</p><p>2、服务器渲染页面，渲染的过程就是向 jsp 页面(模板)内填充数据(模型)。</p><p>3、服务器将渲染生成的页面返回给浏览器。</p><p>所以模板引擎就是：模板+数据=输出，Jsp 页面就是模板，页面中嵌入的 jsp 标签就是数据，两者相结合输出 html 网页。</p><p>常用的 java 模板引擎还有哪些？</p><p>Jsp、Freemarker、Thymeleaf 、Velocity 等。</p><p>本项目采用 Freemarker 作为模板引擎技术。</p><p>Freemarker 官方地址：http://freemarker.foofun.cn/</p>',73),ps=n("em",null,"模板引擎",-1),ts={href:"http://www.fsf.org/philosophy/free-sw.html",target:"_blank",rel:"noopener noreferrer"},es=e(`<h4 id="_2-2-2-freemarker-快速入门" tabindex="-1"><a class="header-anchor" href="#_2-2-2-freemarker-快速入门" aria-hidden="true">#</a> <strong>2.2.2 Freemarker 快速入门</strong></h4><p>下边在内容管理接口层搭建 Freemarker 的运行环境并进行测试。</p><p>在内容管理接口工层 添加 Freemarker 与 SpringBoot 的整合包</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- Spring Boot 对结果视图 Freemarker 集成 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-freemarker<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 nacos 为内容管理接口层配置 freemarker，公用配置组新加一个 freemarker-config-dev.yaml</p><p><img src="`+P+`" alt="image-20230531093313544"></p><p>配置信息如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">freemarker</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">cache</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment">#关闭模板缓存，方便测试</span>
    <span class="token key atrule">settings</span><span class="token punctuation">:</span>
      <span class="token key atrule">template_update_delay</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">suffix</span><span class="token punctuation">:</span> .ftl <span class="token comment">#页面模板后缀名</span>
    <span class="token key atrule">charset</span><span class="token punctuation">:</span> UTF<span class="token punctuation">-</span><span class="token number">8</span>
    <span class="token key atrule">template-loader-path</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>/templates/ <span class="token comment">#页面模板位置(默认为 classpath:/templates/)</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">add-mappings</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment">#关闭项目中的静态资源映射(static、resources文件夹下的资源)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在内容管理接口工程添加 freemarker-config-dev.yaml</p><p><img src="`+I+`" alt="image-20230531093337119"></p><p>添加模板，在 resources 下创建 templates 目录，添加 test.ftl 模板文件</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>utf-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Hello World!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    Hello \${name}!
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编写 controller 方法，准备模型数据</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>api</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>bouncycastle<span class="token punctuation">.</span>math<span class="token punctuation">.</span>raw<span class="token punctuation">.</span></span><span class="token class-name">Mod</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ModelAndView</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> freemarker测试
 * <span class="token keyword">@date</span> 2022/9/15 19:20
 */</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FreemarkerController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/testfreemarker&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">ModelAndView</span> modelAndView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置模型数据</span>
        modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;小明&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置模板名称</span>
        modelAndView<span class="token punctuation">.</span><span class="token function">setViewName</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> modelAndView<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动内容管理接口工程，访问 http://localhost:63040/content/testfreemarker</p><p>屏幕输出：Hello 小明！</p><p><img src="`+C+'" alt="image-20230531093415392"></p><p>freemarker 提供很多指令用于解析各种类型的数据模型，参考地址：http://freemarker.foofun.cn/ref_directives.html</p><h3 id="_2-3-测试静态页面" tabindex="-1"><a class="header-anchor" href="#_2-3-测试静态页面" aria-hidden="true">#</a> <strong>2.3 测试静态页面</strong></h3><h4 id="_2-3-1-部署网站门户" tabindex="-1"><a class="header-anchor" href="#_2-3-1-部署网站门户" aria-hidden="true">#</a> <strong>2.3.1 部署网站门户</strong></h4><p>在课程预览界面上要加载 css、js、图片等内容，这里部署 nginx 来访问这些静态资源，对于 SpringBoot 服务的动态资源由 Nginx 去代理请求，如下图：</p><p><img src="'+B+'" alt="image-20230531093426687"></p><p>1、在本机安装 Nginx ，从课程资料目录获取 nginx-1.23.1.zip 并解压。</p><p>2、运行 nginx-1.23.1 目录下的 nginx.exe。</p><p>默认端口为 80，如果本机 80 端口被占用，则需要杀掉占用进程后再启动 nginx。</p><p>如果无法杀掉 80 端口占用进程则需要修改 nginx-1.23.1 目录下 conf/nginx.conf 配置文件</p><p><img src="'+j+'" alt="image-20230531093433064"></p><p>将 80 端口修改为空闲端口。</p><p>启动 nginx，访问 http://localhost 出现下边的网页表示启动成功</p><p><img src="'+A+`" alt="image-20230531093438346"></p><p>下边开始部署前端工程：</p><p>1、从课程资料目录获取 xc-ui-pc-static-portal.zip 并解压。</p><p>2、修改本机 hosts 文件，加入 127.0.0.1 www.51xuecheng.cn 51xuecheng.cn ucenter.51xuecheng.cn teacher.51xuecheng.cn file.51xuecheng.cn。</p><p>window10 操作系统 hosts 文件在 C:\\Windows\\System32\\drivers\\etc 下</p><p>Centos7 操作系统的 hosts 文件在/etc 目录下。</p><p>在 hosts 文件加入如下配置</p><div class="language-tex line-numbers-mode" data-ext="tex"><pre class="language-tex"><code>127.0.0.1 www.51xuecheng.cn 51xuecheng.cn ucenter.51xuecheng.cn teacher.51xuecheng.cn file.51xuecheng.cn

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>3、在 nginx-1.23.1 目录中找到 conf 目录，配置目录下的 nginx.conf 文件。</p><p>配置内容如下，注意更改 xc-ui-pc-static-portal 目录的路径：</p><div class="language-tex line-numbers-mode" data-ext="tex"><pre class="language-tex"><code>server <span class="token punctuation">{</span>
        listen       80;
        server_name  www.51xuecheng.cn localhost;
        #rewrite ^(.*) https://<span class="token equation string">$server_name$</span>1 permanent;
        #charset koi8-r;
        ssi on;
        ssi_silent_errors on;
        #access_log  logs/host.access.log  main;

        location / <span class="token punctuation">{</span>
            alias   D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal/;
            index  index.html index.htm;
        <span class="token punctuation">}</span>
        #静态资源
        location /static/img/ <span class="token punctuation">{</span>
                alias  D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal/img/;
        <span class="token punctuation">}</span>
        location /static/css/ <span class="token punctuation">{</span>
                alias   D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal/css/;
        <span class="token punctuation">}</span>
        location /static/js/ <span class="token punctuation">{</span>
                alias   D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal/js/;
        <span class="token punctuation">}</span>
        location /static/plugins/ <span class="token punctuation">{</span>
                alias   D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal/plugins/;
                add_header Access-Control-Allow-Origin http://ucenter.51xuecheng.cn;
                add_header Access-Control-Allow-Credentials true;
                add_header Access-Control-Allow-Methods GET;
        <span class="token punctuation">}</span>
        location /plugins/ <span class="token punctuation">{</span>
                alias   D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal/plugins/;
        <span class="token punctuation">}</span>



        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html <span class="token punctuation">{</span>
            root   html;
        <span class="token punctuation">}</span>

        # proxy the PHP scripts to Apache listening on 127.0.0.1:80
        #
        #location ~ <span class="token function selector">\\.</span>php<span class="token equation string">$ {
        #    proxy_pass   http://127.0.0.1;
        #}

        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
        #
        #location ~ <span class="token equation-command regex">\\.</span>php$</span> <span class="token punctuation">{</span>
        #    root           html;
        #    fastcgi_pass   127.0.0.1:9000;
        #    fastcgi_index  index.php;
        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
        #    include        fastcgi_params;
        #<span class="token punctuation">}</span>

        # deny access to .htaccess files, if Apache&#39;s document root
        # concurs with nginx&#39;s one
        #
        #location ~ /<span class="token function selector">\\.</span>ht <span class="token punctuation">{</span>
        #    deny  all;
        #<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动 nginx:</p><p>进入任务管理器，杀死 nginx 的两个进程</p><p><img src="`+T+'" alt="image-20230531093528410"></p><p>杀死后再次双击 nginx.exe。</p><p>启动成功在任务管理器会出现 nginx 的进程。</p><p>日志文件在 nginx 安装目录下的 logs 目录：</p><p><img src="'+R+'" alt="image-20230531093533633"></p><p>启动成功访问http://www.51xuecheng.cn</p><p><img src="'+D+'" alt="image-20230531093539844"></p><h4 id="_2-3-2-课程详情页面" tabindex="-1"><a class="header-anchor" href="#_2-3-2-课程详情页面" aria-hidden="true">#</a> <strong>2.3.2 课程详情页面</strong></h4><p>course_template.html 是一个静态 html 页面，里边还没有添加 freemarker 标签，如果要预览该页面需要借助 Nginx 进行预览，因为页面需要加载一些 css 样式表、图片等内容。</p><p>course_template.html 文件在 xc-ui-pc-static-portal\\course 目录下</p><p><img src="'+F+'" alt="image-20230531093545789"></p><p>通过浏览器访问：http://www.51xuecheng.cn/course/course_template.html</p><p>效果如下：</p><p><img src="'+L+'" alt="image-20230531093552400"></p><p>出现这个画面说明模板文件正常浏览是没有问题的。</p><h4 id="_2-3-3-文件服务器" tabindex="-1"><a class="header-anchor" href="#_2-3-3-文件服务器" aria-hidden="true">#</a> <strong>2.3.3 文件服务器</strong></h4><p>在进行课程预览时需要展示课程的图片，在线插放课程视频，课程图片、视频这些都在 MinIO 文件系统存储，下边统一由 Nginx 代理，通过文件服务域名统一访问。如下图：</p><p><img src="'+O+`" alt="image-20230531093558595"></p><p>在 hosts 文件配置如下内容，如果已存在不要重复配置。</p><div class="language-tex line-numbers-mode" data-ext="tex"><pre class="language-tex"><code>127.0.0.1 www.51xuecheng.cn file.51xuecheng.cn

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>在 nginx.conf 中配置文件服务器的代理地址</p><div class="language-tex line-numbers-mode" data-ext="tex"><pre class="language-tex"><code>   #文件服务
  upstream fileserver<span class="token punctuation">{</span>
    server 192.168.101.65:9000 weight=10;
  <span class="token punctuation">}</span>
   server <span class="token punctuation">{</span>
        listen       80;
        server_name  file.51xuecheng.cn;
        #charset koi8-r;
        ssi on;
        ssi_silent_errors on;
        #access_log  logs/host.access.log  main;
        location /video <span class="token punctuation">{</span>
            proxy_pass   http://fileserver;
        <span class="token punctuation">}</span>

        location /mediafiles <span class="token punctuation">{</span>
            proxy_pass   http://fileserver;
        <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置完毕，重新加载 nginx 配置文件。</p><p>通过 cmd 进入 nginx.exe 所在目录,运行如下命令</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>nginx.exe <span class="token parameter variable">-s</span> reload
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>通过http://file.51xuecheng.cn/mediafiles/图片文件地址 访问图片</p><p>在媒资数据库的文件表中找一个图片的地址进行测试。</p><h4 id="_2-3-4-视频播放页面" tabindex="-1"><a class="header-anchor" href="#_2-3-4-视频播放页面" aria-hidden="true">#</a> <strong>2.3.4 视频播放页面</strong></h4><p>进入课程详情页面，点击马上学习或课程目录下的小节的名称将打开视频播放页面。</p><p><img src="`+E+`" alt="image-20230531093705972"></p><p>首先在 nginx.conf 中配置视频播放页面的地址</p><div class="language-tex line-numbers-mode" data-ext="tex"><pre class="language-tex"><code>        location /course/preview/learning.html <span class="token punctuation">{</span>
                alias D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal/course/learning.html;
        <span class="token punctuation">}</span>
        location /course/search.html <span class="token punctuation">{</span>
                root   D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal;
        <span class="token punctuation">}</span>
        location /course/learning.html <span class="token punctuation">{</span>
                root   D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal;
        <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>加载 nginx 配置文件</p><p>点击课程详情页面上的视频播放链接，打开视频播放页面，如下图：</p><p><img src="`+N+'" alt="image-20230531093737055"></p><p>下边需要配置 learning.html 页面的视频播放路径来测试视频播放页面，找到 learning.html 页面中 videoObject 对象的定义处，配置视频的播放地址。</p><p><img src="'+H+'" alt="image-20230531093742648"></p><p>配置完成，刷新页面，观察视频是否可以正常播放。</p><p><img src="'+Q+'" alt="image-20230531093746645"></p><p>注意：此页面会去请求后台接口获取课程计划，这里暂时不处理，稍后在接口开发处进行处理。只要页面可以正常打开，可以播放视频就测试通过了。</p><h3 id="_2-4-接口定义" tabindex="-1"><a class="header-anchor" href="#_2-4-接口定义" aria-hidden="true">#</a> <strong>2.4 接口定义</strong></h3><h4 id="_2-4-1-定义课程预览接口" tabindex="-1"><a class="header-anchor" href="#_2-4-1-定义课程预览接口" aria-hidden="true">#</a> <strong>2.4.1 定义课程预览接口</strong></h4><p>课程预览接口要将课程信息进行整合，在服务端渲染页面后返回浏览器。</p><p>下边对课程预览接口进行分析：</p><p>1、请求参数</p><p>传入课程 id，表示要预览哪一门课程。</p><p>2、响应结果</p><p>输出课程详情页面到浏览器。</p><p>响应页面到浏览器使用 freemarker 模板引擎技术实现，首先从课程资料目录下获取课程预览页面 course_template.html，拷贝至内容管理的接口工程的 resources/templates 下，并将其在本目录复制一份命名为 course_template.ftl</p><p><img src="'+U+`" alt="image-20230531093756845"></p><p>下边开始定义接口：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>api</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">CoursePreviewDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">CoursePublishService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ModelAndView</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 课程预览，发布
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/16 14:48
 * <span class="token keyword">@version</span> 1.0
 */</span>
 <span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CoursePublishController</span> <span class="token punctuation">{</span>


 <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/coursepreview/{courseId}&quot;</span><span class="token punctuation">)</span>
 <span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">preview</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;courseId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>

      <span class="token class-name">ModelAndView</span> modelAndView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">&quot;model&quot;</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      modelAndView<span class="token punctuation">.</span><span class="token function">setViewName</span><span class="token punctuation">(</span><span class="token string">&quot;course_template&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> modelAndView<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启内容管理接口工程，访问 http://localhost:63040/content/coursepreview/74</p><p>如下图：</p><p><img src="`+z+'" alt="image-20230531093828831"></p><p>课程预览页面内容没有样式，稍后解决这个问题。</p><h4 id="_2-4-2-配置反向代理" tabindex="-1"><a class="header-anchor" href="#_2-4-2-配置反向代理" aria-hidden="true">#</a> <strong>2.4.2 配置反向代理</strong></h4><p>课程预览接口虽然可以正常访问，但是页面没有样式，查看浏览器请求记录，发现图片、样式无法正常访问。</p><p><img src="'+V+`" alt="image-20230531093835233"></p><p>这些静态资源全在门户下，我们需要由 Nginx 反向代理访问课程预览接口，通过门户的 URL 去访问课程预览。</p><p>1、在 Nginx 下配置：</p><div class="language-tex line-numbers-mode" data-ext="tex"><pre class="language-tex"><code>   #后台网关
  upstream gatewayserver<span class="token punctuation">{</span>
    server 127.0.0.1:63010 weight=10;
  <span class="token punctuation">}</span>
  server <span class="token punctuation">{</span>
        listen       80;
        server_name  www.51xuecheng.cn localhost;
        ....
        #api
        location /api/ <span class="token punctuation">{</span>
                proxy_pass http://gatewayserver/;
        <span class="token punctuation">}</span>
        ....

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、重新加载 Nginx 配置文件：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>nginx.exe <span class="token parameter variable">-s</span> reload
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>3、启动微服务网关</p><p>4、此时访问新地址： http://www.51xuecheng.cn/api/content/coursepreview/74</p><p>输出如下，页面样式正常。</p><p><img src="`+J+'" alt="image-20230531093913269"></p><p>页面虽然正常，但是里边的内容都是静态内容，稍后接口层调用 service 方式获取模型数据并进行页面渲染。</p><p>目前的方式是通过 Nginx 访问网关，由网关再将请求转发到微服务，Nginx 是整个的项目最前方的代理服务器，如下图：</p><p><img src="'+X+'" alt="image-20230531093918596"></p><h3 id="_2-5-接口开发" tabindex="-1"><a class="header-anchor" href="#_2-5-接口开发" aria-hidden="true">#</a> <strong>2.5 接口开发</strong></h3><h4 id="_2-5-1-数据模型" tabindex="-1"><a class="header-anchor" href="#_2-5-1-数据模型" aria-hidden="true">#</a> <strong>2.5.1 数据模型</strong></h4><p>课程预览就是把课程基本信息、营销信息、课程计划、师资等课程的相关信息进行整合，在预览页面进行展示。如下图：</p><p><img src="'+K+`" alt="image-20230531093925185"></p><p>在使用 freemarker 渲染生成视图时需要数据模型，此数据模型包括了基本信息、营销信息、课程计划、师资等信息。</p><p>所以首先定义一个数据模型类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">ToString</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 课程预览数据模型
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/16 15:03
 * <span class="token keyword">@version</span> 1.0
 */</span>
 <span class="token annotation punctuation">@Data</span>
 <span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CoursePreviewDto</span> <span class="token punctuation">{</span>

    <span class="token comment">//课程基本信息,课程营销信息</span>
    <span class="token class-name">CourseBaseInfoDto</span> courseBase<span class="token punctuation">;</span>


    <span class="token comment">//课程计划信息</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TeachplanDto</span><span class="token punctuation">&gt;</span></span> teachplans<span class="token punctuation">;</span>

    <span class="token comment">//师资信息暂时不加...</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>CourseBaseInfoDto：包括了课程基本信息、营销信息。</p><p>List&lt;TeachplanDto&gt; ：包括了课程计划列表。</p><h4 id="_2-5-2-service-接口" tabindex="-1"><a class="header-anchor" href="#_2-5-2-service-接口" aria-hidden="true">#</a> <strong>2.5.2 Service 接口</strong></h4><p>Service 负责从数据库查询基本信息、营销信息、课程计划等课程相关信息，组成 CoursePreviewDto 对象。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">CoursePreviewDto</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 课程预览、发布接口
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/16 14:59
 * <span class="token keyword">@version</span> 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CoursePublishService</span> <span class="token punctuation">{</span>


 <span class="token doc-comment comment">/**
  * <span class="token keyword">@description</span> 获取课程预览信息
  * <span class="token keyword">@param</span> <span class="token parameter">courseId</span> 课程id
  * <span class="token keyword">@return</span> com.xuecheng.content.model.dto.CoursePreviewDto
  * <span class="token keyword">@author</span> Mr.M
  * <span class="token keyword">@date</span> 2022/9/16 15:36
 */</span>
   <span class="token keyword">public</span> <span class="token class-name">CoursePreviewDto</span> <span class="token function">getCoursePreviewInfo</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接口实现如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">CourseBaseInfoDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">CoursePreviewDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">TeachplanTreeDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">CourseBaseInfoService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">CoursePublishService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">TeachplanService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> TODO
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/16 15:37
 * <span class="token keyword">@version</span> 1.0
 */</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CoursePublishServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">CoursePublishService</span> <span class="token punctuation">{</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">CourseBaseInfoService</span> courseBaseInfoService<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">TeachplanService</span> teachplanService<span class="token punctuation">;</span>


 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">CoursePreviewDto</span> <span class="token function">getCoursePreviewInfo</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">//课程基本信息、营销信息</span>
  <span class="token class-name">CourseBaseInfoDto</span> courseBaseInfo <span class="token operator">=</span> courseBaseInfoService<span class="token punctuation">.</span><span class="token function">getCourseBaseInfo</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//课程计划信息</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TeachplanDto</span><span class="token punctuation">&gt;</span></span> teachplanTree<span class="token operator">=</span> teachplanService<span class="token punctuation">.</span><span class="token function">findTeachplanTree</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">CoursePreviewDto</span> coursePreviewDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CoursePreviewDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  coursePreviewDto<span class="token punctuation">.</span><span class="token function">setCourseBase</span><span class="token punctuation">(</span>courseBaseInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  coursePreviewDto<span class="token punctuation">.</span><span class="token function">setTeachplans</span><span class="token punctuation">(</span>teachplanTree<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> coursePreviewDto<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-5-3-接口层完善" tabindex="-1"><a class="header-anchor" href="#_2-5-3-接口层完善" aria-hidden="true">#</a> <strong>2.5.3 接口层完善</strong></h4><p>接口层 Controller 调用 Service 方法获取模板引擎需要的模型数据</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">CoursePublishService</span> coursePublishService<span class="token punctuation">;</span>


<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/coursepreview/{courseId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">preview</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;courseId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>

     <span class="token comment">//获取课程预览信息</span>
     <span class="token class-name">CoursePreviewDto</span> coursePreviewInfo <span class="token operator">=</span> coursePublishService<span class="token punctuation">.</span><span class="token function">getCoursePreviewInfo</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token class-name">ModelAndView</span> modelAndView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">&quot;model&quot;</span><span class="token punctuation">,</span>coursePreviewInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
     modelAndView<span class="token punctuation">.</span><span class="token function">setViewName</span><span class="token punctuation">(</span><span class="token string">&quot;course_template&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> modelAndView<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-5-4-前后端联调" tabindex="-1"><a class="header-anchor" href="#_2-5-4-前后端联调" aria-hidden="true">#</a> <strong>2.5.4 前后端联调</strong></h4><p>原来前端直接指向后台网关地址，现在要更改为 Nginx 的地址，如下：</p><p><img src="`+G+'" alt="image-20230531094037507"></p><p>重启前端工程，进入课程列表点击&quot;预览&quot;按钮，正常打开课程预览页面http://www.51xuecheng.cn/api/content/coursepreview/2</p><p><img src="'+$+'" alt="image-20230531094041676"></p><h4 id="_2-5-5-编写模板" tabindex="-1"><a class="header-anchor" href="#_2-5-5-编写模板" aria-hidden="true">#</a> <strong>2.5.5 编写模板</strong></h4><p>模型数据准备好后下一步将模型数据填充到 course_template.ftl 上，填充时注意不要一次填充太多，一边填充一边刷新调试。</p><p>freemarker 提供很多指令用于解析各种类型的数据模型，参考地址：http://freemarker.foofun.cn/ref_directives.html</p><p>修改模板后需要编译，如下图：</p><p><img src="'+W+'" alt="image-20230531094049746"></p><p>在调试模板时，可以看出哪些信息有缺少，在课程管理处进行补充，比如下图显示课程计划信息不完整，需要进入课程计划界面添加课程计划。</p><p><img src="'+Y+'" alt="image-20230531094056262"></p><p>完整的 course_template.ftl 模板在课程资料目录下，差不多学会了 freemarker 标签的使用方法，将课程资料下的 course_template.ftl 覆盖自己的工程下的 course_template.ftl。</p><h4 id="_2-5-6-视频播放页面接口" tabindex="-1"><a class="header-anchor" href="#_2-5-6-视频播放页面接口" aria-hidden="true">#</a> <strong>2.5.6 视频播放页面接口</strong></h4><p>从课程详情页面进入视频播放页面，如下图：</p><p><img src="'+Z+`" alt="image-20230531094101708"></p><p>在此页面需要从后台获取课程信息、根据课程计划获取对应的视频地址，下边编写这两个接口：</p><p>获取课程信息接口：/open/content/course/whole/{courseId}</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>/open/content/course/whole/课程id

响应：同课程预览service接口返回数据

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>根据课程计划获取视频地址接口：/open/media/preview/{mediaId}</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>Java
/open/media/preview/课程计划id

响应：
{&quot;code&quot;:0,&quot;msg&quot;:&quot;success&quot;,&quot;result&quot;:&quot;视频的url&quot;,&quot;successful&quot;:true}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1、在 nginx 配置如下地址</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment">##openapi</span>
location /open/content/ <span class="token punctuation">{</span>
        proxy_pass http://gatewayserver/content/open/<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
location /open/media/ <span class="token punctuation">{</span>
        proxy_pass http://gatewayserver/media/open/<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置运行 nginx.exe -s reload 加载 nginx 的配置文件</p><p>2、在内容管理接口层定义 CourseOpenController 类，并定义接口：获取课程信息接口：/open/content/course/whole/{courseId}</p><p>代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;课程公开查询接口&quot;</span><span class="token punctuation">,</span>tags <span class="token operator">=</span> <span class="token string">&quot;课程公开查询接口&quot;</span><span class="token punctuation">)</span>
 <span class="token annotation punctuation">@RestController</span>
 <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/open&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CourseOpenController</span> <span class="token punctuation">{</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token keyword">private</span> <span class="token class-name">CourseBaseInfoService</span> courseBaseInfoService<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token keyword">private</span> <span class="token class-name">CoursePublishService</span> coursePublishService<span class="token punctuation">;</span>


<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/course/whole/{courseId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">CoursePreviewDto</span> <span class="token function">getPreviewInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;courseId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取课程预览信息</span>
    <span class="token class-name">CoursePreviewDto</span> coursePreviewInfo <span class="token operator">=</span> coursePublishService<span class="token punctuation">.</span><span class="token function">getCoursePreviewInfo</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> coursePreviewInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3、在媒资管理服务 media-api 工程定义 MediaOpenController 类，并定义接口/open/media/preview/</p><p>代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;媒资文件管理接口&quot;</span><span class="token punctuation">,</span>tags <span class="token operator">=</span> <span class="token string">&quot;媒资文件管理接口&quot;</span><span class="token punctuation">)</span>
 <span class="token annotation punctuation">@RestController</span>
 <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/open&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MediaOpenController</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@Autowired</span>
  <span class="token class-name">MediaFileService</span> mediaFileService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;预览文件&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/preview/{mediaId}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPlayUrlByMediaId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> mediaId<span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> mediaFileService<span class="token punctuation">.</span><span class="token function">getFileById</span><span class="token punctuation">(</span>mediaId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>mediaFiles <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;视频还没有转码处理&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>5、测试</p><p>定义好后，启动内容管理、媒资管理、后台服务网关服务，测试视频播放页面是否可以正常获取课程计划，点击具体的课程计划是否正常可以播放视频。</p><h2 id="_3-课程审核" tabindex="-1"><a class="header-anchor" href="#_3-课程审核" aria-hidden="true">#</a> <strong>3 课程审核</strong></h2><h3 id="_3-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_3-1-需求分析" aria-hidden="true">#</a> <strong>3.1 需求分析</strong></h3><h4 id="_3-1-1-业务流程" tabindex="-1"><a class="header-anchor" href="#_3-1-1-业务流程" aria-hidden="true">#</a> <strong>3.1.1 业务流程</strong></h4><p>根据模块需求分析，课程发布前要先审核，审核通过方可发布。下图是课程审核及发布的流程图：</p><p><img src="`+nn+'" alt="image-20230531094239325"></p><blockquote><p>为什么课程审核通过才可以发布呢？</p></blockquote><p>这样做为了防止课程信息有违规情况，课程信息不完善对网站用户体验也不好，课程审核不仅起到监督作用，也是帮助教学机构规范使用平台的手段。</p><blockquote><p>如何控制课程审核通过才可以发布课程呢？</p></blockquote><p>在课程基本表 course_base 表设置课程审核状态字段，包括：未提交、已提交(未审核)、审核通过、审核不通过。</p><p>下边是课程状态的转化关系：</p><p><img src="'+sn+'" alt="image-20230531094310426"></p><p>说明如下：</p><p>1、一门课程新增后它的审核状为”未提交“，发布状态为”未发布“。</p><p>2、课程信息编辑完成，教学机构人员执行”提交审核“操作。此时课程的审核状态为”已提交“。</p><p>3、当课程状态为已提交时运营平台人员对课程进行审核。</p><p>4、运营平台人员审核课程，结果有两个：审核通过、审核不通过。</p><p>5、课程审核过后不管状态是通过还是不通过，教学机构可以再次修改课程并提交审核，此时课程状态为”已提交“。此时运营平台人员再次审核课程。</p><p>6、课程审核通过，教学机构人员可以发布课程，发布成功后课程的发布状态为”已发布“。</p><p>7、课程发布后通过”下架“操作可以更改课程发布状态为”下架“</p><p>8、课程下架后通过”上架“操作可以再次发布课程，上架后课程发布状态为“发布”。</p><h4 id="_3-1-2-数据模型" tabindex="-1"><a class="header-anchor" href="#_3-1-2-数据模型" aria-hidden="true">#</a> <strong>3.1.2 数据模型</strong></h4><p>通过业务流程的分析，现在我们思考：</p><blockquote><p>1、课程提交审核后还允许修改课程吗？</p></blockquote><p>如果不允许修改是不合理的，因为提交审核后可以继续做下一个阶段的课程内容，比如添加课程计划，上传课程视频等。</p><blockquote><p>如果允许修改那么课程审核时看到的课程内容从哪里来？如果也从课程基本信息表、课程营销表、课程计划表查询那么存在什么问题呢？如下图：</p></blockquote><p><img src="'+an+'" alt="image-20230531094336815"></p><p>运营人员审核课程和教学机构编辑课程操作的数据是同一份，此时会导致冲突。比如：运营人员正在审核时教学机构把数据修改了。</p><p>为了解决这个问题，专门设计课程预发布表。</p><p>如下图：</p><p><img src="'+pn+'" alt="image-20230531094342527"></p><p>提交课程审核，将课程信息汇总后写入课程预发布表，课程预发布表记录了教学机构在某个时间点要发布的课程信息。</p><p>课程审核人员从预发布表查询信息进行审核。</p><p>课程审核的同时可以对课程进行修改，修改的内容不会写入课程预发布表。</p><p>课程审核通过执行课程发布，将课程预发布表的信息写入课程发布表。</p><blockquote><p>2、提交审核课程后，也修改了课程信息，可以再次提交审核吗？</p></blockquote><p>这个问题在上边分析课程审核状态时已经有了答案，如下图：</p><p><img src="'+tn+'" alt="image-20230531094352574"></p><p>提交审核课程后，必须等到课程审核完成才可以再次提交课程。</p><p>课程审核功能涉及教学机构提交审核，运营人员进行课程审核。在课堂上我们仅实现教学机构提交审核功能，课程审核的结果通过手动修改数据库来实现。</p><p>虽然课堂上不实现课程审核功能，完整的课程审核数据表设计需要理解。</p><p>提交审核将信息写入课程预发布表，课程预发布表结构如下：</p><p><img src="'+en+'" alt="image-20230531094358070"></p><p>更新课程基本信息表的课程审核状态为：已经提交</p><p>课程审核后更新<code>课程基本信息表的审核状态</code>、<code>课程预发布表的审核状态</code>，并将审核结果写入课程审核记录。</p><p>审核记录表结构如下：</p><p><img src="'+on+`" alt="image-20230531094402682"></p><h3 id="_3-2-接口定义" tabindex="-1"><a class="header-anchor" href="#_3-2-接口定义" aria-hidden="true">#</a> <strong>3.2 接口定义</strong></h3><p>下边定义提交课程审核的接口，在课程发布 Controller 中定义接口如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@PostMapping</span> <span class="token punctuation">(</span><span class="token string">&quot;/courseaudit/commit/{courseId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commitAudit</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;courseId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>

 <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-接口开发" tabindex="-1"><a class="header-anchor" href="#_3-3-接口开发" aria-hidden="true">#</a> <strong>3.3 接口开发</strong></h3><h4 id="_3-3-1-dao-开发" tabindex="-1"><a class="header-anchor" href="#_3-3-1-dao-开发" aria-hidden="true">#</a> <strong>3.3.1 Dao 开发</strong></h4><p>1、查询课程基本信息、课程营销信息、课程计划信息等课程相关信息，整合为课程预发布信息。</p><p>2、向课程预发布表 course_publish_pre 插入一条记录，如果已经存在则更新，审核状态为：已提交。</p><p>3、更新课程基本表 course_base 课程审核状态为：已提交。</p><p>约束(前提条件)：</p><p>1、对已提交审核的课程不允许提交审核。</p><p>2、本机构只允许提交本机构的课程。</p><p>3、没有上传图片不允许提交审核。</p><p>4、没有添加课程计划不允许提交审核。</p><p>使用代码生成器生成课程发布表、课程预发布表的 PO、Mpper，并拷贝到相应的工程下。</p><h4 id="_3-3-1-service-开发" tabindex="-1"><a class="header-anchor" href="#_3-3-1-service-开发" aria-hidden="true">#</a> <strong>3.3.1 Service 开发</strong></h4><p>在课程发布 Service 类中定义接口如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 提交审核
 * <span class="token keyword">@param</span> <span class="token parameter">courseId</span>  课程id
 * <span class="token keyword">@return</span> void
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/18 10:31
*/</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commitAudit</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接口实现如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commitAudit</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

 <span class="token comment">//约束校验</span>
 <span class="token class-name">CourseBase</span> courseBase <span class="token operator">=</span> courseBaseMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//课程审核状态</span>
 <span class="token class-name">String</span> auditStatus <span class="token operator">=</span> courseBase<span class="token punctuation">.</span><span class="token function">getAuditStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//当前审核状态为已提交不允许再次提交</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">&quot;202003&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>auditStatus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;当前为等待审核状态，审核完成可以再次提交。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">//本机构只允许提交本机构的课程</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>courseBase<span class="token punctuation">.</span><span class="token function">getCompanyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;不允许提交其它机构的课程。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token comment">//课程图片是否填写</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>courseBase<span class="token punctuation">.</span><span class="token function">getPic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;提交失败，请上传课程图片&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token comment">//添加课程预发布记录</span>
 <span class="token class-name">CoursePublishPre</span> coursePublishPre <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CoursePublishPre</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//课程基本信息加部分营销信息</span>
 <span class="token class-name">CourseBaseInfoDto</span> courseBaseInfo <span class="token operator">=</span> courseBaseInfoService<span class="token punctuation">.</span><span class="token function">getCourseBaseInfo</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>courseBaseInfo<span class="token punctuation">,</span>coursePublishPre<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//课程营销信息</span>
 <span class="token class-name">CourseMarket</span> courseMarket <span class="token operator">=</span> courseMarketMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//转为json</span>
 <span class="token class-name">String</span> courseMarketJson <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>courseMarket<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//将课程营销信息json数据放入课程预发布表</span>
 coursePublishPre<span class="token punctuation">.</span><span class="token function">setMarket</span><span class="token punctuation">(</span>courseMarketJson<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">//查询课程计划信息</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TeachplanDto</span><span class="token punctuation">&gt;</span></span> teachplanTree <span class="token operator">=</span> teachplanService<span class="token punctuation">.</span><span class="token function">findTeachplanTree</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>teachplanTree<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;提交失败，还没有添加课程计划&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">//转json</span>
 <span class="token class-name">String</span> teachplanTreeString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>teachplanTree<span class="token punctuation">)</span><span class="token punctuation">;</span>
 coursePublishPre<span class="token punctuation">.</span><span class="token function">setTeachplan</span><span class="token punctuation">(</span>teachplanTreeString<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">//设置预发布记录状态,已提交</span>
 coursePublishPre<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;202003&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//教学机构id</span>
 coursePublishPre<span class="token punctuation">.</span><span class="token function">setCompanyId</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//提交时间</span>
 coursePublishPre<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">CoursePublishPre</span> coursePublishPreUpdate <span class="token operator">=</span> coursePublishPreMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>coursePublishPreUpdate <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//添加课程预发布记录</span>
  coursePublishPreMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>coursePublishPre<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
  coursePublishPreMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>coursePublishPre<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token comment">//更新课程基本表的审核状态</span>
 courseBase<span class="token punctuation">.</span><span class="token function">setAuditStatus</span><span class="token punctuation">(</span><span class="token string">&quot;202003&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 courseBaseMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>courseBase<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-4-接口完善" tabindex="-1"><a class="header-anchor" href="#_3-4-接口完善" aria-hidden="true">#</a> <strong>3.4 接口完善</strong></h3><p>完善接口层的代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@PostMapping</span> <span class="token punctuation">(</span><span class="token string">&quot;/courseaudit/commit/{courseId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commitAudit</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;courseId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token class-name">Long</span> companyId <span class="token operator">=</span> <span class="token number">1232141425L</span><span class="token punctuation">;</span>
     coursePublishService<span class="token punctuation">.</span><span class="token function">commitAudit</span><span class="token punctuation">(</span>companyId<span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-5-接口测试" tabindex="-1"><a class="header-anchor" href="#_3-5-接口测试" aria-hidden="true">#</a> <strong>3.5 接口测试</strong></h3><p>使用前端提前课程审核：</p><p>1、找一门信息不全的课程，测试各各约束条件。</p><p>2、正常提交后，观察数据库中课程预发布表记录的内容是否完整。</p><p>3、测试审核过后再次提交，提交后观察数据库中课程预发布表记录的内容是否正确。</p><p>审核通过需手动修改数据库：</p><p>1、修改课程预发布表的状态为审核通过 202004。</p><p>2、修改课程基本表的审核状态为审核通过 202004。</p><h2 id="_4-课程发布" tabindex="-1"><a class="header-anchor" href="#_4-课程发布" aria-hidden="true">#</a> <strong>4 课程发布</strong></h2><h3 id="_4-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_4-1-需求分析" aria-hidden="true">#</a> <strong>4.1 需求分析</strong></h3><h4 id="_4-1-1-数据模型" tabindex="-1"><a class="header-anchor" href="#_4-1-1-数据模型" aria-hidden="true">#</a> <strong>4.1.1 数据模型</strong></h4><p>教学机构人员在课程审核通过后即可发布课程，课程发布后会公开展示在网站上供学生查看、选课和学习。</p><p>在网站上展示课程信息需要解决课程信息显示的性能问题，如果速度慢(排除网速)会影响用户的体验性。</p><blockquote><p>如何去快速搜索课程？</p></blockquote><blockquote><p>打开课程详情页面仍然去查询数据库可行吗？</p></blockquote><p>为了提高网站的速度需要将课程信息进行缓存，并且要将课程信息加入索引库方便搜索，下图显示了课程发布后课程信息的流转情况：</p><p><img src="`+cn+'" alt="image-20230531094526637"></p><p>1、向内容管理数据库的课程发布表存储课程发布信息，更新课程基本信息表中发布状态为已发布。</p><p>2、向 Redis 存储课程缓存信息。</p><p>3、向 Elasticsearch 存储课程索引信息。</p><p>4、请求分布文件系统存储课程静态化页面(即 html 页面)，实现快速浏览课程详情页面。</p><p>课程发布表的数据来源于课程预发布表，它们的结构基本一样，只是课程发布表中的状态是课程发布状态，如下图：</p><p><img src="'+ln+`" alt="image-20230531094533703"></p><p>redis 中的课程缓存信息是将课程发布表中的数据转为 json 进行存储。</p><p>elasticsearch 中的课程索引信息是根据搜索需要将课程名称、课程介绍等信息进行索引存储。</p><p>MinIO 中存储了课程的静态化页面文件（html 网页），查看课程详情是通过文件系统去浏览课程详情页面。</p><h3 id="_4-2-分布式事务技术方案" tabindex="-1"><a class="header-anchor" href="#_4-2-分布式事务技术方案" aria-hidden="true">#</a> <strong>4.2 分布式事务技术方案</strong></h3><h4 id="_4-2-1-什么是分布式事务" tabindex="-1"><a class="header-anchor" href="#_4-2-1-什么是分布式事务" aria-hidden="true">#</a> <strong>4.2.1 什么是分布式事务</strong></h4><p>一次课程发布操作需要向数据库、redis、elasticsearch、MinIO 写四份数据，这里存在分布式事务问题。</p><blockquote><p>什么是分布式事务？</p></blockquote><blockquote><p>首先理解什么是本地事务？</p></blockquote><p>平常我们在程序中通过 spring 去控制事务是利用数据库本身的事务特性来实现的，因此叫数据库事务，由于应用主要靠关系数据库来控制事务，此数据库只属于该应用，所以基于本应用自己的关系型数据库的事务又被称为本地事务。</p><p>本地事务具有 ACID 四大特性，数据库事务在实现时会将一次事务涉及的所有操作全部纳入到一个不可分割的执行单元，该执行单元中的所有操作 要么都成功，要么都失败，只要其中任一操作执行失败，都将导致整个事务的回滚。</p><blockquote><p>理解了本地事务，什么是分布式事务？</p></blockquote><p>现在的需求是课程发布操作后将数据写入数据库、redis、elasticsearch、MinIO 四个地方，这四个地方已经不限制在一个数据库内，是由四个分散的服务去提供，与这四个服务去通信需要网络通信，而网络存在不可到达性，这种分布式系统环境下，通过与不同的服务进行网络通信去完成事务称之为<strong>分布式事务。</strong></p><p>在分布式系统中分布式事务的场景很多：</p><p>例如用户注册送积分，银行转账，创建订单减库存，这些都是分布式事务。</p><p>拿转账举例：</p><p>我们知道本地事务依赖数据库本身提供的事务特性来实现，因此以下逻辑可以控制本地事务：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">begin</span> <span class="token keyword">transaction</span>；
<span class="token comment">//1.本地数据库操作：张三减少金额</span>
<span class="token comment">//2.本地数据库操作：李四增加金额</span>
<span class="token keyword">commit</span> transation<span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但是在分布式环境下，会变成下边这样：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">begin</span> <span class="token keyword">transaction</span>；
<span class="token comment">//1.本地数据库操作：张三减少金额</span>
<span class="token comment">//2.远程调用：让李四增加金额</span>

<span class="token keyword">commit</span> transation<span class="token punctuation">;</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以设想，当远程调用让李四增加金额成功了，由于网络问题远程调用并没有返回，此时本地事务提交失败就回滚了张三减少金额的操作，此时张三和李四的数据就不一致了。</p><p>因此在分布式架构的基础上，传统数据库事务就无法使用了，张三和李四的账户不在一个数据库中甚至不在一个应 用系统里，实现转账事务需要通过远程调用，由于网络问题就会导致分布式事务问题。</p><p>下边的场景都会产生分布式事务：</p><p>微服务架构下：</p><p><img src="`+un+'" alt="image-20230531094635959"></p><p>单服务多数据库：</p><p><img src="'+rn+'" alt="image-20230531094640206"></p><p>多服务单数据库:</p><p><img src="'+kn+'" alt="image-20230531094645288"></p><h4 id="_4-2-2-什么是-cap-理论" tabindex="-1"><a class="header-anchor" href="#_4-2-2-什么是-cap-理论" aria-hidden="true">#</a> <strong>4.2.2 什么是 CAP 理论</strong></h4><p>控制分布式事务首先需要理解 CAP 理论，<code>什么是CAP理论？</code></p><p>CAP 是 Consistency、Availability、Partition tolerance 三个词语的缩写，分别表示一致性、可用性、分区容忍性。</p><p>使用下边的分布式系统结构 进行说明：</p><p><img src="'+dn+'" alt="image-20230531094700210"></p><p>客户端经过网关访问用户服务的两个结点，一致性是指用户不管访问哪一个结点拿到的数据都是最新的，比如查询小明的信息，不能出现在数据没有改变的情况下两次查询结果不一样。</p><p>可用性是指任何时候查询用户信息都可以查询到结果，但不保证查询到最新的数据。</p><p>分区容忍性也叫分区容错性，当系统采用分布式架构时由于网络通信异常导致请求中断、消息丢失，但系统依然对外提供服务。</p><p>CAP 理论要强调的是在分布式系统中这三点不可能全部满足，由于是分布式系统就要满足分区容忍性，因为服务之间难免出现网络异常，不能因为局部网络异常导致整个系统不可用。</p><p>满足 P 那么 C 和 A 不能同时满足：</p><p>比如我们添加一个用户小明的信息，该信息先添加到结点 1 中，再同步到结点 2 中，如下图：</p><p><img src="'+mn+'" alt="image-20230531094711411"></p><p>如果要满足 C 一致性，必须等待小明的信息同步完成系统才可用（否则会出现请求到结点 2 时查询不到数据，违反了一致性），在信息同步过程中系统是不可用的，所以满足 C 的同时无法满足 A。</p><p>如果要满足 A 可用性，要时刻保证系统可用就不用等待信息同步完成，此时系统的一致性无法满足。</p><p>所以在分布式系统中进行分布式事务控制，要么保证 CP、要么保证 AP。</p><h4 id="_4-2-3-分布式事务控制方案" tabindex="-1"><a class="header-anchor" href="#_4-2-3-分布式事务控制方案" aria-hidden="true">#</a> <strong>4.2.3 分布式事务控制方案</strong></h4><blockquote><p>学习了 CAP 理论该如何控制分布式事务呢？</p></blockquote><p>学习了 CAP 理论我们知道进行分布式事务控制要在 C 和 A 中作出取舍，保证一致性就不要保证可用性，保证可用性就不要保证一致，首先你确认是要 CP 还是 AP，具体要根据应用场景进行判断。</p><p>CP 的场景：满足 C 舍弃 A，强调一致性。</p><p>跨行转账：一次转账请求要等待双方银行系统都完成整个事务才算完成，只要其中一个失败另一方执行回滚操作。</p><p>开户操作：在业务系统开户同时要在运营商开户，任何一方开户失败该用户都不可使用，所以要满足 CP。</p><p>AP 的场景：满足 A 舍弃 C，强调可用性。</p><p>订单退款，今日退款成功，明日账户到账，只要用户可以接受在一定时间内到账即可。</p><p>注册送积分，注册成功积分在 24 分到账。</p><p>支付短信通信，支付成功发短信，短信发送可以有延迟，甚至没有发送成功。</p><p>在实际应用中符合 AP 的场景较多，其实虽然 AP 舍弃 C 一致性，实际上最终数据还是达到了一致，也就满足了最终一致性，所以业界定义了 BASE 理论。</p><blockquote><p>什么是 BASE 理论？</p></blockquote><p>BASE 是 Basically Available(基本可用)、Soft state(软状态)和 Eventually consistent (最终一致性)三个短语的缩写。</p><p>基本可用：当系统无法满足全部可用时保证核心服务可用即可，比如一个外卖系统，每到中午 12 点左右系统并发量很高，此时要保证下单流程涉及的服务可用，其它服务暂时不可用。</p><p>软状态：是指可以存在中间状态，比如：打印自己的社保统计情况，该操作不会立即出现结果，而是提示你打印中，请在 XXX 时间后查收。虽然出现了中间状态，但最终状态是正确的。</p><p>最终一致性：退款操作后没有及时到账，经过一定的时间后账户到账，舍弃强一致性，满足最终一致性。</p><blockquote><p>分布式事务控制有哪些常用的技术方案？</p></blockquote><p>实现 CP 就是要实现强一致性:</p><p>使用 Seata 框架基于 AT 模式实现</p><p>使用 Seata 框架基于 TCC 模式实现。</p><p>实现 AP 则要保证最终数据一致性:</p><p>使用消息队列通知的方式去实现，通知失败自动重试，达到最大失败次数需要人工处理；</p><p>使用任务调度的方案，启动任务调度将课程信息由数据库同步到 elasticsearch、MinIO、redis 中。</p><h4 id="_4-2-4-课程发布的事务控制方案" tabindex="-1"><a class="header-anchor" href="#_4-2-4-课程发布的事务控制方案" aria-hidden="true">#</a> <strong>4.2.4 课程发布的事务控制方案</strong></h4><blockquote><p>学习了这么多的理论，回到课程发布，执行课程发布操作后要向数据库、redis、elasticsearch、MinIO 写四份数据，这个场景用哪种方案？</p></blockquote><p>满足 CP？</p><p>如果要满足 CP 就表示课程发布操作后向数据库、redis、elasticsearch、MinIO 写四份数据，只要有一份写失败其它的全部回滚。</p><p>满足 AP？</p><p>课程发布操作后，先更新数据库中的课程发布状态，更新后向 redis、elasticsearch、MinIO 写课程信息，只要在一定时间内最终向 redis、elasticsearch、MinIO 写数据成功即可。</p><p>目前我们已经有了任务调度的技术积累，这里选用任务调度的方案去实现分布式事务控制，课程发布满足 AP 即可。</p><p>下图是具体的技术方案：</p><p><img src="'+vn+'" alt="image-20230531094744663"></p><p>1、在内容管理服务的数据库中添加一个消息表，消息表和课程发布表在同一个数据库。</p><p>2、点击课程发布通过本地事务向课程发布表写入课程发布信息，同时向消息表写课程发布的消息。通过数据库进行控制，只要课程发布表插入成功消息表也插入成功，消息表的数据就记录了某门课程发布的任务。</p><p>3、启动任务调度系统定时调度内容管理服务去定时扫描消息表的记录。</p><p>4、当扫描到课程发布的消息时即开始完成向 redis、elasticsearch、MinIO 同步数据的操作。</p><p>5、同步数据的任务完成后删除消息表记录。</p><p>时序图如下：</p><p>下图是课程发布操作的流程：</p><p><img src="'+bn+`" alt="image-20230531094752141"></p><p>1、执行发布操作，内容管理服务存储课程发布表的同时向消息表添加一条“课程发布任务”。这里使用本地事务保证课程发布信息保存成功，同时消息表也保存成功。</p><p>2、任务调度服务定时调度内容管理服务扫描消息表，由于课程发布操作后向消息表插入一条课程发布任务，此时扫描到一条任务。</p><p>3、拿到任务开始执行任务，分别向 redis、elasticsearch 及文件系统存储数据。</p><p>4、任务完成后删除消息表记录。</p><h3 id="_4-3-课程发布接口" tabindex="-1"><a class="header-anchor" href="#_4-3-课程发布接口" aria-hidden="true">#</a> <strong>4.3 课程发布接口</strong></h3><h4 id="_4-3-1-接口定义" tabindex="-1"><a class="header-anchor" href="#_4-3-1-接口定义" aria-hidden="true">#</a> <strong>4.3.1 接口定义</strong></h4><p>根据课程发布的分布式事务控制方案，课程发布操作首先通过本地事务向课程发布表写入课程发布信息并向消息表插入一条消息，这里定义的课程发布接口要实现该功能。</p><p>在内容管理接口工程中定义课程发布接口。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 课程预览，发布
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/16 14:48
 * <span class="token keyword">@version</span> 1.0
 */</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;课程预览发布接口&quot;</span><span class="token punctuation">,</span>tags <span class="token operator">=</span> <span class="token string">&quot;课程预览发布接口&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CoursePublishController</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;课程发布&quot;</span><span class="token punctuation">)</span>
 <span class="token annotation punctuation">@ResponseBody</span>
 <span class="token annotation punctuation">@PostMapping</span> <span class="token punctuation">(</span><span class="token string">&quot;/coursepublish/{courseId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">coursepublish</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;courseId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>

<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-3-3-接口开发" tabindex="-1"><a class="header-anchor" href="#_4-3-3-接口开发" aria-hidden="true">#</a> <strong>4.3.3 接口开发</strong></h4><h5 id="_4-3-3-1-dao-开发" tabindex="-1"><a class="header-anchor" href="#_4-3-3-1-dao-开发" aria-hidden="true">#</a> <strong>4.3.3.1 DAO 开发</strong></h5><p>课程发布操作对数据库操作如下：</p><p>1、向课程发布表 course_publish 插入一条记录,记录来源于课程预发布表，如果存在则更新，发布状态为：已发布。</p><p>2、更新 course_base 表的课程发布状态为：已发布</p><p>3、删除课程预发布表的对应记录。</p><p>4、向 mq_message 消息表插入一条消息，消息类型为：course_publish</p><p>约束：</p><p>1、课程审核通过方可发布。</p><p>2、本机构只允许发布本机构的课程。</p><p>以上功能使用自动生成的 mapper 接口即可完成。</p><p>1、在内容管理数据库创建 mq_message 消息表及消息历史消息表（历史表存储已经完成的消息）。</p><p><img src="`+gn+'" alt="image-20230531094820514"></p><p>消息表结构如下：</p><p><img src="'+hn+`" alt="image-20230531094825180"></p><p>2、生成 mq_message 消息表、course_publish 课程发布表的 po 和 mapper 接口</p><p>稍后会开发一个通用的消息处理组件，这里先不生成代码。</p><h5 id="_4-3-3-2-service-开发" tabindex="-1"><a class="header-anchor" href="#_4-3-3-2-service-开发" aria-hidden="true">#</a> <strong>4.3.3.2 Service 开发</strong></h5><p>定义 Service 接口：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 课程发布接口
 * <span class="token keyword">@param</span> <span class="token parameter">companyId</span> 机构id
 * <span class="token keyword">@param</span> <span class="token parameter">courseId</span> 课程id
 * <span class="token keyword">@return</span> void
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/20 16:23
*/</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publish</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编写课程发布的 Service 方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token annotation punctuation">@Transactional</span>
 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publish</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">//约束校验</span>
  <span class="token comment">//查询课程预发布表</span>
  <span class="token class-name">CoursePublishPre</span> coursePublishPre <span class="token operator">=</span> coursePublishPreMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>coursePublishPre <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;请先提交课程审核，审核通过才可以发布&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//本机构只允许提交本机构的课程</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>coursePublishPre<span class="token punctuation">.</span><span class="token function">getCompanyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;不允许提交其它机构的课程。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token comment">//课程审核状态</span>
  <span class="token class-name">String</span> auditStatus <span class="token operator">=</span> coursePublishPre<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//审核通过方可发布</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">&quot;202004&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>auditStatus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;操作失败，课程审核通过方可发布。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//保存课程发布信息</span>
  <span class="token function">saveCoursePublish</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//保存消息表</span>
  <span class="token function">saveCoursePublishMessage</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">//删除课程预发布表对应记录</span>
  coursePublishPreMapper<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 保存课程发布信息
 * <span class="token keyword">@param</span> <span class="token parameter">courseId</span>  课程id
 * <span class="token keyword">@return</span> void
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/20 16:32
*/</span>
 <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveCoursePublish</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token comment">//整合课程发布信息</span>
  <span class="token comment">//查询课程预发布表</span>
  <span class="token class-name">CoursePublishPre</span> coursePublishPre <span class="token operator">=</span> coursePublishPreMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>coursePublishPre <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;课程预发布数据为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">CoursePublish</span> coursePublish <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CoursePublish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//拷贝到课程发布对象</span>
  <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>coursePublishPre<span class="token punctuation">,</span>coursePublish<span class="token punctuation">)</span><span class="token punctuation">;</span>
  coursePublish<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;203002&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">CoursePublish</span> coursePublishUpdate <span class="token operator">=</span> coursePublishMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>coursePublishUpdate <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   coursePublishMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>coursePublish<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
   coursePublishMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>coursePublish<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//更新课程基本表的发布状态</span>
  <span class="token class-name">CourseBase</span> courseBase <span class="token operator">=</span> courseBaseMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  courseBase<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;203002&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  courseBaseMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>courseBase<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

 <span class="token doc-comment comment">/**
  * <span class="token keyword">@description</span> 保存消息表记录，稍后实现
  * <span class="token keyword">@param</span> <span class="token parameter">courseId</span>  课程id
  * <span class="token keyword">@return</span> void
  * <span class="token keyword">@author</span> Mr.M
  * <span class="token keyword">@date</span> 2022/9/20 16:32
  */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveCoursePublishMessage</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_4-3-3-3-接口完善" tabindex="-1"><a class="header-anchor" href="#_4-3-3-3-接口完善" aria-hidden="true">#</a> <strong>4.3.3.3 接口完善</strong></h5><p>完善接口层代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;课程发布&quot;</span><span class="token punctuation">)</span>
 <span class="token annotation punctuation">@ResponseBody</span>
 <span class="token annotation punctuation">@PostMapping</span> <span class="token punctuation">(</span><span class="token string">&quot;/coursepublish/{courseId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">coursepublish</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;courseId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token class-name">Long</span> companyId <span class="token operator">=</span> <span class="token number">1232141425L</span><span class="token punctuation">;</span>
     coursePublishService<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>companyId<span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-3-4-接口测试" tabindex="-1"><a class="header-anchor" href="#_4-3-4-接口测试" aria-hidden="true">#</a> <strong>4.3.4 接口测试</strong></h4><p>先使用 httpclient 方法测试：</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>#### 课程发布
POST {{content_host}}/content/coursepublish/2

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>先测试约束条件：</p><p>1、在未提交审核时进行课程发布测试。</p><p>2、在课程未审核通过时进行发布。</p><p>正常流程测试：</p><p>1、提交审核课程</p><p>2、手动修改课程预发布表与课程基本信息的审核状态为审核通过。</p><p>3、执行课程发布</p><p>4、观察课程发布表记录是否正常，课程预发布表记录已经删除，课程基本信息表与课程发布表的发布状态为”发布“。</p><p>使用前后端联调方式测试。</p><h3 id="_4-4-消息处理-sdk" tabindex="-1"><a class="header-anchor" href="#_4-4-消息处理-sdk" aria-hidden="true">#</a> <strong>4.4 消息处理 SDK</strong></h3><h4 id="_4-4-1-消息模块技术方案" tabindex="-1"><a class="header-anchor" href="#_4-4-1-消息模块技术方案" aria-hidden="true">#</a> <strong>4.4.1 消息模块技术方案</strong></h4><p>课程发布操作执行后需要扫描消息表的记录，有关消息表处理的有哪些？</p><p><img src="`+yn+'" alt="image-20230531094943236"></p><p>上图中红色框内的都是与消息处理相关的操作：</p><p>1、新增消息表</p><p>2、扫描消息表。</p><p>3、更新消息表。</p><p>4、删除消息表。</p><p>使用消息表这种方式实现最终事务一致性的地方除了课程发布还有其它业务场景。</p><p><img src="'+wn+'" alt="image-20230531094950223"></p><p>如果在每个地方都实现一套针对消息表定时扫描、处理的逻辑基本上都是重复的，软件的可复用性太低，成本太高。</p><blockquote><p>如何解决这个问题？</p></blockquote><p>针对这个问题可以想到将消息处理相关的逻辑做成一个通用的东西。</p><p>是做成通用的服务，还是做成通用的代码组件呢？</p><p>通用的服务是完成一个通用的独立功能，并提供独立的网络接口，比如：项目中的文件系统服务，提供文件的分布式存储服务。</p><p>代码组件也是完成一个通用的独立功能，通常会提供 API 的方式供外部系统使用，比如：fastjson、Apache commons 工具包等。</p><p>如果将消息处理做成一个通用的服务，该服务需要连接多个数据库，因为它要扫描微服务数据库下的消息表，并且要提供与微服务通信的网络接口，单就针对当前需求而言开发成本有点高。</p><p>如果将消息处理做一个 SDK 工具包相比通用服务不仅可以解决将消息处理通用化的需求，还可以降低成本。</p><p>所以，本项目确定将对消息表相关的处理做成一个 SDK 组件供各微服务使用,如下图所示：</p><p><img src="'+qn+'" alt="image-20230531095001971"></p><p>下边对消息 SDK 的设计内容进行说明：</p><blockquote><p>sdk 需要提供执行任务的逻辑吗？</p></blockquote><p>拿课程发布任务举例，执行课程发布任务是要向 redis、索引库等同步数据，其它任务的执行逻辑是不同的，所以执行任务在 sdk 中不用实现任务逻辑，只需要提供一个抽象方法由具体的执行任务方去实现。</p><blockquote><p>如何保证任务的幂等性？</p></blockquote><p>在视频处理章节介绍的视频处理的幂等性方案，这里可以采用类似方案，任务执行完成后会从消息表删除，如果消息的状态是完成或不存在消息表中则不用执行。</p><blockquote><p>如何保证任务不重复执行？</p></blockquote><p>采用和视频处理章节一致方案，除了保证任务的幂等性外，任务调度采用分片广播，根据分片参数去获取任务，另外阻塞调度策略为丢弃任务。</p><p>注意：这里是信息同步类任务，即使任务重复执行也没有关系，不再使用抢占任务的方式保证任务不重复执行。</p><blockquote><p>还有一个问题，根据消息表记录是否存在或消息表中的任务状态去保证任务的幂等性，如果一个任务有好几个小任务，比如：课程发布任务需要执行三个同步操作：存储课程到 redis、存储课程到索引库，存储课程页面到文件系统。如果其中一个小任务已经完成也不应该去重复执行。这里该如何设计？</p></blockquote><p>将小任务作为任务的不同的阶段，在消息表中设计阶段状态。</p><p><img src="'+fn+`" alt="image-20230531095023051"></p><p>每完成一个阶段在相应的阶段状态字段打上完成标记，即使这个大任务没有完成再重新执行时，如果小阶段任务完成了也不会重复执行某个小阶段的任务。</p><p>综上所述，除了消息表的基本的增、删、改、查的接口外，消息 SDK 还具有如下接口功能：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">IService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MqMessage</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
 *  服务类
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
 *
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@since</span> 2022-09-21
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MqMessageService</span> <span class="token keyword">extends</span> <span class="token class-name">IService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MqMessage</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * <span class="token keyword">@description</span> 扫描消息表记录，采用与扫描视频处理表相同的思路
     * <span class="token keyword">@param</span> <span class="token parameter">shardIndex</span> 分片序号
     * <span class="token keyword">@param</span> <span class="token parameter">shardTotal</span> 分片总数
     * <span class="token keyword">@param</span> <span class="token parameter">count</span> 扫描记录数
     * <span class="token keyword">@return</span> java.util.List 消息记录
     * <span class="token keyword">@author</span> Mr.M
     * <span class="token keyword">@date</span> 2022/9/21 18:55
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MqMessage</span><span class="token punctuation">&gt;</span></span> <span class="token function">getMessageList</span><span class="token punctuation">(</span><span class="token keyword">int</span> shardIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> shardTotal<span class="token punctuation">,</span>  <span class="token class-name">String</span> messageType<span class="token punctuation">,</span><span class="token keyword">int</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * <span class="token keyword">@description</span> 完成任务
     * <span class="token keyword">@param</span> <span class="token parameter">id</span> 消息id
     * <span class="token keyword">@return</span> int 更新成功：1
     * <span class="token keyword">@author</span> Mr.M
     * <span class="token keyword">@date</span> 2022/9/21 20:49
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">completed</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * <span class="token keyword">@description</span> 完成阶段任务
     * <span class="token keyword">@param</span> <span class="token parameter">id</span> 消息id
     * <span class="token keyword">@return</span> int 更新成功：1
     * <span class="token keyword">@author</span> Mr.M
     * <span class="token keyword">@date</span> 2022/9/21 20:49
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">completedStageOne</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">completedStageTwo</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">completedStageThree</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">completedStageFour</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * <span class="token keyword">@description</span> 查询阶段状态
     * <span class="token keyword">@param</span> <span class="token parameter">id</span>
     * <span class="token keyword">@return</span> int
     * <span class="token keyword">@author</span> Mr.M
     * <span class="token keyword">@date</span> 2022/9/21 20:54
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getStageOne</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getStageTwo</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getStageThree</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getStageFour</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>消息 SDK 提供消息处理抽象类，此抽象类供使用方去继承使用，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MqMessage</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> 消息处理抽象类
 * <span class="token keyword">@date</span> 2022/9/21 19:44
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MessageProcessAbstract</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MqMessageService</span> mqMessageService<span class="token punctuation">;</span>


    <span class="token doc-comment comment">/**
     * <span class="token keyword">@param</span> <span class="token parameter">mqMessage</span> 执行任务内容
     * <span class="token keyword">@return</span> boolean true:处理成功，false处理失败
     * <span class="token keyword">@description</span> 任务处理
     * <span class="token keyword">@author</span> Mr.M
     * <span class="token keyword">@date</span> 2022/9/21 19:47
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">boolean</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token doc-comment comment">/**
     * <span class="token keyword">@description</span> 扫描消息表多线程执行任务
     * <span class="token keyword">@param</span> <span class="token parameter">shardIndex</span> 分片序号
     * <span class="token keyword">@param</span> <span class="token parameter">shardTotal</span> 分片总数
     * <span class="token keyword">@param</span> <span class="token parameter">messageType</span>  消息类型
     * <span class="token keyword">@param</span> <span class="token parameter">count</span>  一次取出任务总数
     * <span class="token keyword">@param</span> <span class="token parameter">timeout</span> 预估任务执行时间,到此时间如果任务还没有结束则强制结束 单位秒
     * <span class="token keyword">@return</span> void
     * <span class="token keyword">@author</span> Mr.M
     * <span class="token keyword">@date</span> 2022/9/21 20:35
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">int</span> shardIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> shardTotal<span class="token punctuation">,</span>  <span class="token class-name">String</span> messageType<span class="token punctuation">,</span><span class="token keyword">int</span> count<span class="token punctuation">,</span><span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//扫描消息表获取任务清单</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MqMessage</span><span class="token punctuation">&gt;</span></span> messageList <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">getMessageList</span><span class="token punctuation">(</span>shardIndex<span class="token punctuation">,</span> shardTotal<span class="token punctuation">,</span>messageType<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//任务个数</span>
            <span class="token keyword">int</span> size <span class="token operator">=</span> messageList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;取出待处理消息&quot;</span><span class="token operator">+</span>size<span class="token operator">+</span><span class="token string">&quot;条&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>size<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//创建线程池</span>
            <span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//计数器</span>
            <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>message <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;开始任务:{}&quot;</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//处理任务</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token function">execute</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">{</span>
                            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;任务执行成功:{})&quot;</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//更新任务状态,删除消息表记录,添加到历史表</span>
                            <span class="token keyword">int</span> completed <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">completed</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>completed<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;任务执行成功:{}&quot;</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;任务执行失败:{}&quot;</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;任务出现异常:{},任务:{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//计数</span>
                    countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;结束任务:{}&quot;</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//等待,给一个充裕的超时时间,防止无限等待，到达超时时间还没有处理完成则结束任务</span>
            countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;结束....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-2-消息模块-sdk-测试" tabindex="-1"><a class="header-anchor" href="#_4-4-2-消息模块-sdk-测试" aria-hidden="true">#</a> <strong>4.4.2 消息模块 SDK 测试</strong></h4><p>1、在内容管理数据库创建消息表和消息历史表</p><p>2、拷贝课程资料中的 xuecheng-plus-message-sdk 到工程目录，如下图：</p><p><img src="`+xn+`" alt="image-20230531095112695"></p><p>3、修改 test 下的 bootstrap.yml 中的数据库连接</p><p>下边测试消息 SDK 的接口：</p><p>1、继承 MessageProcessAbstract 抽象类编写任务执行方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MqMessage</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">MessageProcessAbstract</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">MqMessageService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 消息处理测试类，继承MessageProcessAbstract
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/21 21:44
 * <span class="token keyword">@version</span> 1.0
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageProcessClass</span> <span class="token keyword">extends</span> <span class="token class-name">MessageProcessAbstract</span> <span class="token punctuation">{</span>


    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MqMessageService</span> mqMessageService<span class="token punctuation">;</span>

    <span class="token comment">//执行任务</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> id <span class="token operator">=</span> mqMessage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;开始执行任务:{}&quot;</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//取出阶段状态</span>
        <span class="token keyword">int</span> stageOne <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">getStageOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>stageOne<span class="token operator">&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;开始执行第一阶段任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">completedStageOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;完成第一阶段任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;无需执行第一阶段任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、编写测试类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> TODO
 * <span class="token keyword">@date</span> 2022/9/21 21:51
 */</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageProcessClassTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MessageProcessClass</span> messageProcessClass<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;开始执行-----》&quot;</span> <span class="token operator">+</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        messageProcessClass<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;结束执行-----》&quot;</span> <span class="token operator">+</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">9000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3、准备测试数据，在消息表添加消息类型为&quot;test&quot;的消息</p><p>4、执行 MessageProcessClassTest 类中的 test()方法，观察控制台任务执行的日志信息。</p><h4 id="_4-4-3-集成消息-sdk" tabindex="-1"><a class="header-anchor" href="#_4-4-3-集成消息-sdk" aria-hidden="true">#</a> <strong>4.4.3 集成消息 SDK</strong></h4><h5 id="_4-4-3-1-添加消息" tabindex="-1"><a class="header-anchor" href="#_4-4-3-1-添加消息" aria-hidden="true">#</a> <strong>4.4.3.1 添加消息</strong></h5><p>1、在内容管理数据库创建消息表和消息历史表</p><p>2、拷贝课程资料中的 xuecheng-plus-message-sdk 到工程目录，如下图：</p><p><img src="`+_n+`" alt="image-20230531095215703"></p><p>3、在内容管理 service 工程中添加 sdk 依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.xuecheng<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>xuecheng-plus-message-sdk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4、课程发布操作使用本地事务保存课程发布信息、添加消息表。</p><p>回到当初编写课程发布时的代码，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publish</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

 <span class="token comment">//约束校验</span>
 <span class="token comment">//查询课程预发布表</span>
 <span class="token class-name">CoursePublishPre</span> coursePublishPre <span class="token operator">=</span> coursePublishPreMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>coursePublishPre <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;请先提交课程审核，审核通过才可以发布&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">//本机构只允许提交本机构的课程</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>coursePublishPre<span class="token punctuation">.</span><span class="token function">getCompanyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;不允许提交其它机构的课程。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token comment">//课程审核状态</span>
 <span class="token class-name">String</span> auditStatus <span class="token operator">=</span> coursePublishPre<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//审核通过方可发布</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">&quot;202004&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>auditStatus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;操作失败，课程审核通过方可发布。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">//保存课程发布信息</span>
 <span class="token function">saveCoursePublish</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">//保存消息表</span>
 <span class="token function">saveCoursePublishMessage</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//删除课程预发布表对应记录</span>
 coursePublishPreMapper<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们要填充的 saveCoursePublishMessage(courseId)方法，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token doc-comment comment">/**
  * <span class="token keyword">@description</span> 保存消息表记录
  * <span class="token keyword">@param</span> <span class="token parameter">courseId</span>  课程id
  * <span class="token keyword">@return</span> void
  * <span class="token keyword">@author</span> Mr.M
  * <span class="token keyword">@date</span> 2022/9/20 16:32
  */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveCoursePublishMessage</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token class-name">MqMessage</span> mqMessage <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span><span class="token string">&quot;course_publish&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>mqMessage<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token class-name">CommonError</span><span class="token punctuation">.</span><span class="token constant">UNKOWN_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下边进行测试：</p><p>发布一门课程，观察消息表是否正常添加消息。</p><p>需要手动修改课程审核状态为审核通过执行发布操作，发布后可以修改发布状态为下架重新发布测试。</p><h5 id="_4-4-3-2-课程发布任务处理" tabindex="-1"><a class="header-anchor" href="#_4-4-3-2-课程发布任务处理" aria-hidden="true">#</a> <strong>4.4.3.2 课程发布任务处理</strong></h5><p>在内容管理服务添加消息处理 sdk 的依赖即可使用它，实现 sdk 中的 MessageProcessAbstract 类，重写 execte 方法。</p><p>实现 sdk 中的 MessageProcessAbstract 类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>service<span class="token punctuation">.</span>jobhandler</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MqMessage</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">MessageProcessAbstract</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xxl<span class="token punctuation">.</span>job<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">XxlJobHelper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xxl<span class="token punctuation">.</span>job<span class="token punctuation">.</span>core<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">XxlJob</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> TODO
 * <span class="token keyword">@date</span> 2022/9/22 10:16
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CoursePublishTask</span> <span class="token keyword">extends</span> <span class="token class-name">MessageProcessAbstract</span> <span class="token punctuation">{</span>

    <span class="token comment">//课程发布任务处理</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取消息相关的业务信息</span>
        <span class="token class-name">String</span> businessKey1 <span class="token operator">=</span> mqMessage<span class="token punctuation">.</span><span class="token function">getBusinessKey1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> courseId <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>businessKey1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//课程静态化</span>
        <span class="token function">generateCourseHtml</span><span class="token punctuation">(</span>mqMessage<span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//课程索引</span>
        <span class="token function">saveCourseIndex</span><span class="token punctuation">(</span>mqMessage<span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//课程缓存</span>
        <span class="token function">saveCourseCache</span><span class="token punctuation">(</span>mqMessage<span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">//生成课程静态化页面并上传至文件系统</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">generateCourseHtml</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">,</span><span class="token keyword">long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>

        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;开始进行课程静态化,课程id:{}&quot;</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//消息id</span>
        <span class="token class-name">Long</span> id <span class="token operator">=</span> mqMessage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//消息处理的service</span>
        <span class="token class-name">MqMessageService</span> mqMessageService <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMqMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//消息幂等性处理</span>
        <span class="token keyword">int</span> stageOne <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">getStageOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>stageOne <span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;课程静态化已处理直接返回，课程id:{}&quot;</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//保存第一阶段状态</span>
        mqMessageService<span class="token punctuation">.</span><span class="token function">completedStageOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token comment">//将课程信息缓存至redis</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveCourseCache</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">,</span><span class="token keyword">long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;将课程信息缓存至redis,课程id:{}&quot;</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


    <span class="token punctuation">}</span>
    <span class="token comment">//保存课程索引信息</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveCourseIndex</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">,</span><span class="token keyword">long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;保存课程索引信息,课程id:{}&quot;</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_4-4-3-3-开启任务调度" tabindex="-1"><a class="header-anchor" href="#_4-4-3-3-开启任务调度" aria-hidden="true">#</a> <strong>4.4.3.3 开启任务调度</strong></h5><p>1、首先在内容管理 service 工程中添加 xxl-job 依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.xuxueli<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>xxl-job-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、配置执行器</p><p>在 nacos 中在 content-service-dev.yaml 中配置</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">xxl</span><span class="token punctuation">:</span>
  <span class="token key atrule">job</span><span class="token punctuation">:</span>
    <span class="token key atrule">admin</span><span class="token punctuation">:</span>
      <span class="token key atrule">addresses</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.101.65<span class="token punctuation">:</span>8088/xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin
    <span class="token key atrule">executor</span><span class="token punctuation">:</span>
      <span class="token key atrule">appname</span><span class="token punctuation">:</span> coursepublish<span class="token punctuation">-</span>job
      <span class="token key atrule">address</span><span class="token punctuation">:</span>
      <span class="token key atrule">ip</span><span class="token punctuation">:</span>
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8999</span>
      <span class="token key atrule">logpath</span><span class="token punctuation">:</span> /data/applogs/xxl<span class="token punctuation">-</span>job/jobhandler
      <span class="token key atrule">logretentiondays</span><span class="token punctuation">:</span> <span class="token number">30</span>
    <span class="token key atrule">accessToken</span><span class="token punctuation">:</span> default_token
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3、从媒资管理服务层工程中拷贝一个 XxlJobConfig 配置类到内容管理 service 工程中。</p><p>在 xxl-job-admin 控制台中添加执行器</p><p><img src="`+Sn+`" alt="image-20230531095400772"></p><p>3、编写任务调度入口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CoursePublishTask</span> <span class="token keyword">extends</span> <span class="token class-name">MessageProcessAbstract</span> <span class="token punctuation">{</span>

    <span class="token comment">//任务调度入口</span>
    <span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">&quot;CoursePublishJobHandler&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">coursePublishJobHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 分片参数</span>
        <span class="token keyword">int</span> shardIndex <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> shardTotal <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;shardIndex=&quot;</span><span class="token operator">+</span>shardIndex<span class="token operator">+</span><span class="token string">&quot;,shardTotal=&quot;</span><span class="token operator">+</span>shardTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//参数:分片序号、分片总数、消息类型、一次最多取到的任务数量、一次任务调度执行的超时时间</span>
        <span class="token function">process</span><span class="token punctuation">(</span>shardIndex<span class="token punctuation">,</span>shardTotal<span class="token punctuation">,</span><span class="token string">&quot;course_publish&quot;</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4、在 xxl-job 添加任务</p><p><img src="`+Mn+'" alt="image-20230531095419302"></p><p>任务配置如下：</p><p><img src="'+Pn+`" alt="image-20230531095422599"></p><p>到此 SDK 开发、集成完成，下一步添加课程发布后页面静态化、课程缓存、课程索引等任务。</p><h5 id="_4-4-3-4-测试" tabindex="-1"><a class="header-anchor" href="#_4-4-3-4-测试" aria-hidden="true">#</a> <strong>4.4.3.4 测试</strong></h5><p>在消息表添加课程发布的消息，消息类型为 course_publish,business_key1 为发布课程的 ID</p><p>1、测试是否可以正常调度执行。</p><p>2、测试任务幂等性</p><p>在 saveCourseCache(mqMessage,courseId);处打断点，待执行到这里观察数据库第一阶段完成的标记预期标记为 1。</p><p>结束进程，再重新启动，观察第一阶段的任务预期不再执行。</p><p>3、任务执行完成删除消息表记录，插入历史表，state 状态字段为 1</p><h3 id="_4-5-页面静态化" tabindex="-1"><a class="header-anchor" href="#_4-5-页面静态化" aria-hidden="true">#</a> <strong>4.5 页面静态化</strong></h3><h4 id="_4-5-1-什么是页面静态化" tabindex="-1"><a class="header-anchor" href="#_4-5-1-什么是页面静态化" aria-hidden="true">#</a> <strong>4.5.1 什么是页面静态化</strong></h4><p>根据课程发布的操作流程，执行课程发布后要将课程详情信息页面静态化，生成 html 页面上传至文件系统。</p><blockquote><p>什么是页面静态化？</p></blockquote><p>课程预览功能通过模板引擎技术在页面模板中填充数据，生成 html 页面，这个过程是当客户端请求服务器时服务器才开始渲染生成 html 页面，最后响应给浏览器，服务端渲染的并发能力是有限的。</p><p>页面静态化则强调将生成 html 页面的过程提前，提前使用模板引擎技术生成 html 页面，当客户端请求时直接请求 html 页面，由于是静态页面可以使用 nginx、apache 等高性能的 web 服务器，并发性能高。</p><blockquote><p>什么时候能用页面静态化技术？</p></blockquote><p>当数据变化不频繁，一旦生成静态页面很长一段时间内很少变化，此时可以使用页面静态化。因为如果数据变化频繁，一旦改变就需要重新生成静态页面，导致维护静态页面的工作量很大。</p><p>根据课程发布的业务需求，虽然课程发布后仍可以修改课程信息，但需要经过课程审核，且修改频度不大，所以适合使用页面静态化。</p><h4 id="_4-5-2-静态化测试" tabindex="-1"><a class="header-anchor" href="#_4-5-2-静态化测试" aria-hidden="true">#</a> <strong>4.5.2 静态化测试</strong></h4><p>下边使用 freemarker 技术对页面静态化生成 html 页面。</p><p>在内容管理 service 工程中添加 freemarker 依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-freemarker<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编写测试方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">CoursePreviewDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">CoursePublishService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">freemarker<span class="token punctuation">.</span>template<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">freemarker<span class="token punctuation">.</span>template<span class="token punctuation">.</span></span><span class="token class-name">Template</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">freemarker<span class="token punctuation">.</span>template<span class="token punctuation">.</span></span><span class="token class-name">TemplateException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>freemarker<span class="token punctuation">.</span></span><span class="token class-name">FreeMarkerTemplateUtils</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> freemarker测试
 * <span class="token keyword">@date</span> 2022/9/20 18:42
 */</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FreemarkerTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">CoursePublishService</span> coursePublishService<span class="token punctuation">;</span>


    <span class="token comment">//测试页面静态化</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testGenerateHtmlByTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TemplateException</span> <span class="token punctuation">{</span>
        <span class="token comment">//配置freemarker</span>
        <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span><span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//加载模板</span>
        <span class="token comment">//选指定模板路径,classpath下templates下</span>
        <span class="token comment">//得到classpath路径</span>
        <span class="token class-name">String</span> classpath <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        configuration<span class="token punctuation">.</span><span class="token function">setDirectoryForTemplateLoading</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>classpath <span class="token operator">+</span> <span class="token string">&quot;/templates/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置字符编码</span>
        configuration<span class="token punctuation">.</span><span class="token function">setDefaultEncoding</span><span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//指定模板文件名称</span>
        <span class="token class-name">Template</span> template <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getTemplate</span><span class="token punctuation">(</span><span class="token string">&quot;course_template.ftl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//准备数据</span>
        <span class="token class-name">CoursePreviewDto</span> coursePreviewInfo <span class="token operator">=</span> coursePublishService<span class="token punctuation">.</span><span class="token function">getCoursePreviewInfo</span><span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;model&quot;</span><span class="token punctuation">,</span> coursePreviewInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//静态化</span>
        <span class="token comment">//参数1：模板，参数2：数据模型</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token class-name">FreeMarkerTemplateUtils</span><span class="token punctuation">.</span><span class="token function">processTemplateIntoString</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将静态化内容输出到文件中</span>
        <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">toInputStream</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//输出流</span>
        <span class="token class-name">FileOutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">&quot;D:\\\\develop\\\\test.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将 content-api 工程下的模板拷贝到 content-service 工程下：</p><p><img src="`+In+'" alt="image-20230531095526797"></p><p>执行测试方法，观察 D:\\\\develop\\\\test.html 是否成功生成。</p><h4 id="_4-5-3-上传文件测试" tabindex="-1"><a class="header-anchor" href="#_4-5-3-上传文件测试" aria-hidden="true">#</a> <strong>4.5.3 上传文件测试</strong></h4><h5 id="_4-5-3-1-配置远程调用环境" tabindex="-1"><a class="header-anchor" href="#_4-5-3-1-配置远程调用环境" aria-hidden="true">#</a> <strong>4.5.3.1 配置远程调用环境</strong></h5><p>静态化生成文件后需要上传至分布式文件系统，根据微服务的职责划分，媒资管理服务负责维护文件系统中的文件，所以内容管理服务对页面静态化生成 html 文件需要调用媒资管理服务的上传文件接口。如下图：</p><p><img src="'+Cn+'" alt="image-20230531095531832"></p><p>微服务之间难免会存在远程调用，在 Spring Cloud 中可以使用 Feign 进行远程调用，</p>',496),os={href:"https://github.com/OpenFeign/feign",target:"_blank",rel:"noopener noreferrer"},cs=e(`<p>其作用就是帮助我们优雅的实现 http 请求的发送，解决上面提到的问题。</p><p>下边先准备 Feign 的开发环境:</p><p>1、在内容管理 content-service 工程添加依赖：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- Spring Cloud 微服务远程调用 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>feign-httpclient<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--feign支持Multipart格式传参--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.openfeign.form<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>feign-form<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.openfeign.form<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>feign-form-spring<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、在 nacos 配置 feign-dev.yaml 公用配置文件</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">circuitbreaker</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
  <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
      <span class="token key atrule">execution</span><span class="token punctuation">:</span>
        <span class="token key atrule">isolation</span><span class="token punctuation">:</span>
          <span class="token key atrule">thread</span><span class="token punctuation">:</span>
            <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">30000</span> <span class="token comment">#熔断超时时间</span>
<span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">ConnectTimeout</span><span class="token punctuation">:</span> <span class="token number">60000</span> <span class="token comment">#连接超时时间</span>
  <span class="token key atrule">ReadTimeout</span><span class="token punctuation">:</span> <span class="token number">60000</span> <span class="token comment">#读超时时间</span>
  <span class="token key atrule">MaxAutoRetries</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment">#重试次数</span>
  <span class="token key atrule">MaxAutoRetriesNextServer</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment">#切换实例的重试次数</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3、在内容管理 service 工程和内容管理 api 工程都引入此配置文件</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">shared-configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> feign<span class="token punctuation">-</span>$<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>.yaml
    <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
    <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4、在内容管理 service 工程配置 feign 支持 Multipart，拷贝课程资料下的 MultipartSupportConfig 到 content-service 工程下的 config 包下。</p><h5 id="_4-5-3-2-扩充上传文件接口" tabindex="-1"><a class="header-anchor" href="#_4-5-3-2-扩充上传文件接口" aria-hidden="true">#</a> <strong>4.5.3.2 扩充上传文件接口</strong></h5><p>现在需要将课程的静态文件上传到 minio，单独存储到 course 目录下，文件的 objectname 为&quot;课程 id.html&quot;，原有的上传文件接口需要增加一个参数 objectname。</p><p>下边扩充媒资服务的上传文件接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;上传文件&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/upload/coursefile&quot;</span><span class="token punctuation">,</span>consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">MULTIPART_FORM_DATA_VALUE</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">UploadFileResultDto</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">&quot;filedata&quot;</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> filedata<span class="token punctuation">,</span>
                                  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value<span class="token operator">=</span> <span class="token string">&quot;objectName&quot;</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">{</span>
                                  <span class="token comment">//....</span>
 <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>service 接口也增加一个参数：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 上传文件
 * <span class="token keyword">@param</span> <span class="token parameter">companyId</span> 机构id
 * <span class="token keyword">@param</span> <span class="token parameter">uploadFileParamsDto</span> 上传文件信息
 * <span class="token keyword">@param</span> <span class="token parameter">localFilePath</span> 文件磁盘路径
 * <span class="token keyword">@param</span> <span class="token parameter">objectName</span> 对象名
 * <span class="token keyword">@return</span> 文件信息
 */</span>
<span class="token keyword">public</span> <span class="token class-name">UploadFileResultDto</span> <span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span> <span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">,</span> <span class="token class-name">String</span> localFilePath<span class="token punctuation">,</span><span class="token class-name">String</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改原有 uploadFile 方法，判断如果 objectName 为空则采取年月日样式的路径方式。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//存储到minio中的对象名(带目录)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>objectName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    objectName <span class="token operator">=</span>  defaultFolderPath <span class="token operator">+</span> fileMd5 <span class="token operator">+</span> extension<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//        String objectName = defaultFolderPath + fileMd5 + extension;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_4-5-3-3-远程调用测试" tabindex="-1"><a class="header-anchor" href="#_4-5-3-3-远程调用测试" aria-hidden="true">#</a> <strong>4.5.3.3 远程调用测试</strong></h5><p>在 content-service 下编写 feign 接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>feignclient</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">MultipartSupportConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">MediaType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestPart</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>multipart<span class="token punctuation">.</span></span><span class="token class-name">MultipartFile</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 媒资管理服务远程接口
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/20 20:29
 * <span class="token keyword">@version</span> 1.0
 */</span>
 <span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;media-api&quot;</span><span class="token punctuation">,</span>configuration <span class="token operator">=</span> <span class="token class-name">MultipartSupportConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MediaServiceClient</span> <span class="token punctuation">{</span>

 <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/media/upload/coursefile&quot;</span><span class="token punctuation">,</span>consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">MULTIPART_FORM_DATA_VALUE</span><span class="token punctuation">)</span>
 <span class="token class-name">String</span> <span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">&quot;filedata&quot;</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> upload<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;objectName&quot;</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在启动类添加@EnableFeignClients 注解</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;com.xuecheng.content.feignclient&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>编写测试方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>feignclient<span class="token punctuation">.</span></span><span class="token class-name">MediaServiceClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>fileupload<span class="token punctuation">.</span></span><span class="token class-name">FileItem</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>fileupload<span class="token punctuation">.</span>disk<span class="token punctuation">.</span></span><span class="token class-name">DiskFileItemFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">MediaType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>multipart<span class="token punctuation">.</span></span><span class="token class-name">MultipartFile</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>multipart<span class="token punctuation">.</span>commons<span class="token punctuation">.</span></span><span class="token class-name">CommonsMultipartFile</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">OutputStream</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> 测试使用feign远程上传文件
 * <span class="token keyword">@date</span> 2022/9/20 20:36
 */</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignUploadTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MediaServiceClient</span> mediaServiceClient<span class="token punctuation">;</span>

    <span class="token comment">//远程调用，上传文件</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">MultipartFile</span> multipartFile <span class="token operator">=</span> <span class="token class-name">MultipartSupportConfig</span><span class="token punctuation">.</span><span class="token function">getMultipartFile</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;D:\\\\develop\\\\test.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaServiceClient<span class="token punctuation">.</span><span class="token function">uploadFile</span><span class="token punctuation">(</span>multipartFile<span class="token punctuation">,</span><span class="token string">&quot;course/test.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下边进行测试，启动媒资服务，执行测试方法，上传文件成功，进入 minIO 查看文件</p><p><img src="`+Bn+'" alt="image-20230531095749816"></p><p>访问：http://192.168.101.65:9000/mediafiles/course/74b386417bb9f3764009dc94068a5e44.html</p><p>查看是否可以正常访问。</p><h4 id="_4-5-4-熔断降级处理" tabindex="-1"><a class="header-anchor" href="#_4-5-4-熔断降级处理" aria-hidden="true">#</a> <strong>4.5.4 熔断降级处理</strong></h4><h5 id="_4-5-4-1-什么是熔断降级" tabindex="-1"><a class="header-anchor" href="#_4-5-4-1-什么是熔断降级" aria-hidden="true">#</a> <strong>4.5.4.1 什么是熔断降级</strong></h5><p>微服务中难免存在服务之间的远程调用，比如：内容管理服务远程调用媒资服务的上传文件接口，当微服务运行不正常会导致无法正常调用微服务，此时会出现异常，如果这种异常不去处理可能导致雪崩效应。</p><p>微服务的雪崩效应表现在服务与服务之间调用，当其中一个服务无法提供服务可能导致其它服务也死掉，比如：服务 B 调用服务 A，由于 A 服务异常导致 B 服务响应缓慢，最后 B、C 等服务都不可用，像这样由一个服务所引起的一连串的多个服务无法提供服务即是微服务的雪崩效应，如下图：</p><p><img src="'+jn+'" alt="image-20230531095756887"></p><p>如何解决由于微服务异常引起的雪崩效应呢？</p><p>可以采用熔断、降级的方法去解决。</p><p>熔断降级的相同点都是为了解决微服务系统崩溃的问题，但它们是两个不同的技术手段，两者又存在联系。</p><p>熔断：</p><p>当下游服务异常而断开与上游服务的交互，它就相当于保险丝，下游服务异常触发了熔断，从而保证上游服务不受影响。</p><p><img src="'+An+'" alt="image-20230531095803107"></p><p>降级：</p><p>当下游服务异常触发熔断后，上游服务就不再去调用异常的微服务而是执行了降级处理逻辑，这个降级处理逻辑可以是本地一个单独的方法。</p><p><img src="'+Tn+`" alt="image-20230531095809466"></p><p>两者都是为了保护系统，熔断是当下游服务异常时一种保护系统的手段，降级是熔断后上游服务处理熔断的方法。</p><h5 id="_4-5-4-2-熔断降级处理" tabindex="-1"><a class="header-anchor" href="#_4-5-4-2-熔断降级处理" aria-hidden="true">#</a> <strong>4.5.4.2 熔断降级处理</strong></h5><p>项目使用 Hystrix 框架实现熔断、降级处理，在 feign-dev.yaml 中配置。</p><p>1、开启 Feign 熔断保护</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">circuitbreaker</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、设置熔断的超时时间，为了防止一次处理时间较长触发熔断这里还需要设置请求和连接的超时时间，如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
  <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
      <span class="token key atrule">execution</span><span class="token punctuation">:</span>
        <span class="token key atrule">isolation</span><span class="token punctuation">:</span>
          <span class="token key atrule">thread</span><span class="token punctuation">:</span>
            <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">30000</span> <span class="token comment">#熔断超时时间</span>
<span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">ConnectTimeout</span><span class="token punctuation">:</span> <span class="token number">60000</span> <span class="token comment">#连接超时时间</span>
  <span class="token key atrule">ReadTimeout</span><span class="token punctuation">:</span> <span class="token number">60000</span> <span class="token comment">#读超时时间</span>
  <span class="token key atrule">MaxAutoRetries</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment">#重试次数</span>
  <span class="token key atrule">MaxAutoRetriesNextServer</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment">#切换实例的重试次数</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3、定义降级逻辑</p><p>两种方法：</p><p>1）fallback</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;media-api&quot;</span><span class="token punctuation">,</span>configuration <span class="token operator">=</span> <span class="token class-name">MultipartSupportConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token class-name">MediaServiceClientFallback</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/media&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MediaServiceClient</span><span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>定义一个 fallback 类 MediaServiceClientFallback，此类实现了 MediaServiceClient 接口。</p><p>第一种方法无法取出熔断所抛出的异常，第二种方法定义 MediaServiceClientFallbackFactory 可以解决这个问题。</p><p>2）fallbackFactory</p><p>第二种方法在 FeignClient 中指定 fallbackFactory ，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;media-api&quot;</span><span class="token punctuation">,</span>configuration <span class="token operator">=</span> <span class="token class-name">MultipartSupportConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>fallbackFactory <span class="token operator">=</span> <span class="token class-name">MediaServiceClientFallbackFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>定义 MediaServiceClientFallbackFactory 如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MediaServiceClientFallbackFactory</span> <span class="token keyword">implements</span> <span class="token class-name">FallbackFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaServiceClient</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">MediaServiceClient</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MediaServiceClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> upload<span class="token punctuation">,</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//降级方法</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;调用媒资管理服务上传文件时发生熔断，异常信息:{}&quot;</span><span class="token punctuation">,</span>throwable<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>降级处理逻辑：</p><p>返回一个 null 对象，上游服务请求接口得到一个 null 说明执行了降级处理。</p><p>测试：</p><p>停止媒资管理服务或人为制造异常观察是否执行降级逻辑。</p><h4 id="_4-5-4-课程静态化开发" tabindex="-1"><a class="header-anchor" href="#_4-5-4-课程静态化开发" aria-hidden="true">#</a> <strong>4.5.4 课程静态化开发</strong></h4><p>课程页面静态化和静态页面远程上传测试通过，下一步开发课程静态化功能，最终使用消息处理 SDK 去调度执行。</p><h5 id="_4-5-4-1-静态化实现" tabindex="-1"><a class="header-anchor" href="#_4-5-4-1-静态化实现" aria-hidden="true">#</a> <strong>4.5.4.1 静态化实现</strong></h5><p>课程静态化包括两部分工作：生成课程静态化页面，上传静态页面到文件系统。</p><p>在课程发布的 service 编写这两部分内容，最后通过消息去调度执行。</p><p>1、接口定义</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 课程静态化
 * <span class="token keyword">@param</span> <span class="token parameter">courseId</span>  课程id
 * <span class="token keyword">@return</span> File 静态化文件
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/23 16:59
*/</span>
<span class="token keyword">public</span> <span class="token class-name">File</span> <span class="token function">generateCourseHtml</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 上传课程静态化页面
 * <span class="token keyword">@param</span> <span class="token parameter">file</span>  静态化文件
 * <span class="token keyword">@return</span> void
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/23 16:59
*/</span>
<span class="token keyword">public</span> <span class="token keyword">void</span>  <span class="token function">uploadCourseHtml</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">,</span><span class="token class-name">File</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、接口实现</p><p>将之前编写的静态化测试代码以及上传静态文件测试代码拷贝过来使用</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Java</span>
<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">File</span> <span class="token function">generateCourseHtml</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">//静态化文件</span>
        <span class="token class-name">File</span> htmlFile  <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//配置freemarker</span>
            <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span><span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//加载模板</span>
            <span class="token comment">//选指定模板路径,classpath下templates下</span>
            <span class="token comment">//得到classpath路径</span>
            <span class="token class-name">String</span> classpath <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            configuration<span class="token punctuation">.</span><span class="token function">setDirectoryForTemplateLoading</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>classpath <span class="token operator">+</span> <span class="token string">&quot;/templates/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置字符编码</span>
            configuration<span class="token punctuation">.</span><span class="token function">setDefaultEncoding</span><span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//指定模板文件名称</span>
            <span class="token class-name">Template</span> template <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getTemplate</span><span class="token punctuation">(</span><span class="token string">&quot;course_template.ftl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//准备数据</span>
            <span class="token class-name">CoursePreviewDto</span> coursePreviewInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCoursePreviewInfo</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;model&quot;</span><span class="token punctuation">,</span> coursePreviewInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//静态化</span>
            <span class="token comment">//参数1：模板，参数2：数据模型</span>
            <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token class-name">FreeMarkerTemplateUtils</span><span class="token punctuation">.</span><span class="token function">processTemplateIntoString</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//            System.out.println(content);</span>
            <span class="token comment">//将静态化内容输出到文件中</span>
            <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">toInputStream</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//创建静态化文件</span>
            htmlFile <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">.</span><span class="token function">createTempFile</span><span class="token punctuation">(</span><span class="token string">&quot;course&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;课程静态化，生成静态文件:{}&quot;</span><span class="token punctuation">,</span>htmlFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//输出流</span>
            <span class="token class-name">FileOutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>htmlFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;课程静态化异常:{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;课程静态化异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> htmlFile<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uploadCourseHtml</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">,</span> <span class="token class-name">File</span> file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MultipartFile</span> multipartFile <span class="token operator">=</span> <span class="token class-name">MultipartSupportConfig</span><span class="token punctuation">.</span><span class="token function">getMultipartFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> course <span class="token operator">=</span> mediaServiceClient<span class="token punctuation">.</span><span class="token function">uploadFile</span><span class="token punctuation">(</span>multipartFile<span class="token punctuation">,</span> <span class="token string">&quot;course/&quot;</span><span class="token operator">+</span>courseId<span class="token operator">+</span><span class="token string">&quot;.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>course<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;上传静态文件异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>完善课程发布任务 CoursePublishTask 类的代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//生成课程静态化页面并上传至文件系统</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">generateCourseHtml</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">,</span><span class="token keyword">long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;开始进行课程静态化,课程id:{}&quot;</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//消息id</span>
    <span class="token class-name">Long</span> id <span class="token operator">=</span> mqMessage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//消息处理的service</span>
    <span class="token class-name">MqMessageService</span> mqMessageService <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMqMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//消息幂等性处理</span>
    <span class="token keyword">int</span> stageOne <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">getStageOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>stageOne <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;课程静态化已处理直接返回，课程id:{}&quot;</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//生成静态化页面</span>
    <span class="token class-name">File</span> file <span class="token operator">=</span> coursePublishService<span class="token punctuation">.</span><span class="token function">generateCourseHtml</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//上传静态化页面</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>file<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        coursePublishService<span class="token punctuation">.</span><span class="token function">uploadCourseHtml</span><span class="token punctuation">(</span>courseId<span class="token punctuation">,</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//保存第一阶段状态</span>
    mqMessageService<span class="token punctuation">.</span><span class="token function">completedStageOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_4-5-4-2-测试" tabindex="-1"><a class="header-anchor" href="#_4-5-4-2-测试" aria-hidden="true">#</a> <strong>4.5.4.2 测试</strong></h5><p>1、启动网关、媒资管理服务工程。</p><p>2、在内容管理 api 工程的启动类上配置 FeignClient</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Java</span>
<span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;com.xuecheng.content.feignclient&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 bootstrap.yml 引用 feign-dev.yaml</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> feign<span class="token punctuation">-</span>$<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>.yaml
  <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
  <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#profiles默认为dev</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动内容管理接口工程。</p><p>在 CoursePublishTask 类的 execute 方法中打上断点。</p><p>3、发布一门课程，保存消息表存在未处理的处理。</p><p>4、启动 xxl-job 调度中心、启动课程发布任务，等待定时调度。</p><p><img src="`+Rn+'" alt="image-20230531100057397"></p><p>5、观察任务调度日志，观察任务是否可以正常处理。</p><p>6、处理完成进入文件系统，查询 mediafiles 桶内是否存在以课程 id 命名的 html 文件</p><p><img src="'+Dn+'" alt="image-20230531100101680"></p><p>如果不存在说明课程静态化存在问题，再仔细查看执行日志，排查问题。</p><p>如果存在则说明课程静态化并上传到 minio 成功。</p><h5 id="_4-5-4-3-浏览详细页面" tabindex="-1"><a class="header-anchor" href="#_4-5-4-3-浏览详细页面" aria-hidden="true">#</a> <strong>4.5.4.3 浏览详细页面</strong></h5><p>课程静态化成功后可以用浏览器访问 html 文件是否可以正常浏览，下图表示可以正常浏览。</p><p><img src="'+Fn+`" alt="image-20230531100108692"></p><p>页面还没有样式，需要在 nginx 配置虚拟目录，在www.51xuecheng.cn下配置：</p><div class="language-tex line-numbers-mode" data-ext="tex"><pre class="language-tex"><code>location /course/ <span class="token punctuation">{</span>
        proxy_pass http://fileserver/mediafiles/course/;
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>加载 nginx 配置文件</p><p>访问：http://www.51xuecheng.cn/course/2.html</p><p>2.html 为以课程 id 命名的 html 文件。</p><h2 id="_5-课程搜索" tabindex="-1"><a class="header-anchor" href="#_5-课程搜索" aria-hidden="true">#</a> <strong>5 课程搜索</strong></h2><h3 id="_5-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_5-1-需求分析" aria-hidden="true">#</a> <strong>5.1 需求分析</strong></h3><h4 id="_5-1-1-模块介绍" tabindex="-1"><a class="header-anchor" href="#_5-1-1-模块介绍" aria-hidden="true">#</a> <strong>5.1.1 模块介绍</strong></h4><p>搜索功能是一个系统的重要功能，是信息查询的方式。课程搜索是课程展示的渠道，用户通过课程搜索找到课程信息，进一步去查看课程的详细信息，进行选课、支付、学习。</p><p>本项目的课程搜索支持全文检索技术，什么是全文检索？</p>`,105),is={href:"https://baike.baidu.com/item/%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2/8028630?fromModule=lemma_inlink",target:"_blank",rel:"noopener noreferrer"},ls=e('<p>全文检索可以简单理解为通过索引搜索文章。</p><p><img src="'+Ln+'" alt="image-20230531100148575"></p><p>全文检索的速度非常快，早期应用在搜索引擎技术中，比如：百度、google 等，现在通常一些大型网站的搜索功能都是采用全文检索技术。</p><p><img src="'+On+'" alt="image-20230531100152847"></p><p>课程搜索也要将课程信息建立索引，在课程发布时建立课程索引，索引建立好用户可通过搜索网页去查询课程信息。</p><p><img src="'+En+'" alt="image-20230531100158031"></p><p>所以，课程搜索模块包括两部分：课程索引、课程搜索。</p><p>课程索引是将课程信息建立索引。</p><p>课程搜索是通过前端网页，通过关键字等条件去搜索课程。</p><h4 id="_5-1-2-业务流程" tabindex="-1"><a class="header-anchor" href="#_5-1-2-业务流程" aria-hidden="true">#</a> <strong>5.1.2 业务流程</strong></h4><p>根据模块介绍的内容，课程搜索模块包括课程索引、课程搜索两部分。</p><p>1、课程索引</p><p>在课程发布操作执行后通过消息处理方式创建课程索引，如下图：</p><p><img src="'+Nn+'" alt="image-20230531100204973"></p><p>本项目使用 elasticsearch 作为索引及搜索服务。</p><p>2、课程搜索</p><p>课程索引创建完成，用户才可以通过前端搜索课程信息。</p><p>课程搜索可以从首页进入搜索页面。</p><p><img src="'+Hn+'" alt="image-20230531100209431"></p><p>下图是搜索界面，可以通过课程分类、课程难度等级等条件进行搜索。</p><p><img src="'+Qn+`" alt="image-20230531100215209"></p><h3 id="_5-2-准备环境" tabindex="-1"><a class="header-anchor" href="#_5-2-准备环境" aria-hidden="true">#</a> <strong>5.2 准备环境</strong></h3><h4 id="_5-2-1-搭建-elasticsearch" tabindex="-1"><a class="header-anchor" href="#_5-2-1-搭建-elasticsearch" aria-hidden="true">#</a> <strong>5.2.1 搭建 elasticsearch</strong></h4><p>在课前下发的虚拟中已经在 docker 容器中安装了 elasticsearch 和 kibana。</p><p>kibana 是 ELK（Elasticsearch , Logstash, Kibana ）之一，kibana 一款开源的数据分析和可视化平台，通过可视化界面访问 elasticsearch 的索引库，并可以生成一个数据报表。</p><p>开发中主要使用 kibana 通过 api 对 elasticsearch 进行索引和搜索操作，通过浏览器访问 http://192.168.101.65:5601/app/dev_tools#/console进入kibana的开发工具界面。</p><p>修改虚拟机中的启动脚本 restart.sh 添加</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> stop elasticsearch
<span class="token function">docker</span> stop kibana

<span class="token function">docker</span> start elasticsearch
<span class="token function">docker</span> start kibana

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+Un+'" alt="image-20230531100240725"></p><p>可通过命令：GET /_cat/indices?v 查看所有的索引，通过此命令判断 kibana 是否正常连接 elasticsearch。</p><p>索引相当于 MySQL 中的表，Elasticsearch 与 MySQL 之间概念的对应关系见下表：</p><p><img src="'+zn+`" alt="image-20230531100245698"></p><p>要使用 elasticsearch 需要建立索引，Mapping 相当于表结构，Mapping 创建后其字段不能删除，如果要删除需要删除整个索引，下边介绍创建索引、查询索引、删除索引的方法：</p><p>1、创建索引，并指定 Mapping。</p><p>PUT /course-publish</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;settings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;number_of_shards&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;number_of_replicas&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;companyId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;companyName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;search_analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;search_analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;users&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;search_analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;mt&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;mtName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;st&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;stName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;grade&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;teachmode&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;pic&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;search_analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;createDate&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;format&quot;</span><span class="token operator">:</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;date&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;remark&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;charge&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;scaled_float&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;scaling_factor&quot;</span><span class="token operator">:</span> <span class="token number">100</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;originalPrice&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;scaled_float&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;scaling_factor&quot;</span><span class="token operator">:</span> <span class="token number">100</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;validDays&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;integer&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、查询索引</p><p>通过 GET /_cat/indices?v 查询所有的索引，查找 course-publish 是否创建成功。</p><p>通过 GET /course-publish/_mapping 查询 course-publish 的索引结构。</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;course-publish&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;charge&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;companyId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;companyName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;search_analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;createDate&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;date&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;format&quot;</span><span class="token operator">:</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;search_analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;grade&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;mt&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;mtName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;search_analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;originalPrice&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;scaled_float&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;scaling_factor&quot;</span><span class="token operator">:</span> <span class="token number">100.0</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;pic&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;scaled_float&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;scaling_factor&quot;</span><span class="token operator">:</span> <span class="token number">100.0</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;remark&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;st&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;stName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;search_analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;teachmode&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;users&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;validDays&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;integer&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3、删除索引</p><p>如果发现创建的 course-publish 不正确可以删除重新创建。</p><p>删除索引后当中的文档数据也同时删除，一定要谨慎操作！</p><p>删除索引命令：DELETE /course-publish</p><h4 id="_5-2-2-部署搜索工程" tabindex="-1"><a class="header-anchor" href="#_5-2-2-部署搜索工程" aria-hidden="true">#</a> <strong>5.2.2 部署搜索工程</strong></h4><p>拷贝课程资料中的 xuecheng-plus-search 搜索工程到自己的工程目录。</p><p><img src="`+Vn+`" alt="image-20230531100332701"></p><p>修改 bootstrap.xml 中 nacos 的 namespace 为自己的命名空间。</p><p>启动网关、搜索服务。</p><p>部署完成通过 httpclient 进行测试</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>#### 添加课程索引
POST {{search_host}}/search/index/course
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/json</span></span>
<span class="token application-json">
<span class="token punctuation">{</span>
  <span class="token property">&quot;charge&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;201000&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;companyId&quot;</span> <span class="token operator">:</span> <span class="token number">100000</span><span class="token punctuation">,</span>
  <span class="token property">&quot;companyName&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;北京黑马程序&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;createDate&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2022-09-25 09:36:11&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;《Spring编程思想》是2007年6月1日机械工业出版社出版的图书，作者是埃克尔，译者是陈昊鹏。主要内容本书赢得了全球程序员的广泛赞誉，即使是最晦涩的概念，在Bruce Eckel的文字亲和力和小而直接的编程示例面前也会化解于无形。从Java的基础语法到最高级特性（深入的面向对象概念、多线程、自动项目构建、单元测试和调试等），本书都能逐步指导你轻松掌握。从本书获得的各项大奖以及来自世界各地的读者评论中，不难看出这是一本经典之作&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;grade&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;204001&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;id&quot;</span> <span class="token operator">:</span> <span class="token number">102</span><span class="token punctuation">,</span>
  <span class="token property">&quot;mt&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1-3&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;mtName&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;编程开发&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Spring编程思想&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;originalPrice&quot;</span> <span class="token operator">:</span> <span class="token number">200.0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;pic&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;/mediafiles/2022/09/20/1d0f0e6ed8a0c4a89bfd304b84599d9c.png&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;price&quot;</span> <span class="token operator">:</span> <span class="token number">100.0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;remark&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;没有备注&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;st&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1-3-2&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;stName&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Java语言&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;status&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;203002&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;tags&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;没有标签&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;teachmode&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;200002&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;validDays&quot;</span> <span class="token operator">:</span> <span class="token number">222</span>
<span class="token punctuation">}</span>



#### 搜索课程
GET <span class="token punctuation">{</span><span class="token punctuation">{</span>search_host<span class="token punctuation">}</span><span class="token punctuation">}</span>/search/course/list?pageNo=<span class="token number">1</span>&amp;keywords=spring
Content-Type<span class="token operator">:</span> application/json



</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>进入前端搜索界面http://www.51xuecheng.cn/course/search.html</p><p><img src="`+Jn+`" alt="image-20230531100405411"></p><h3 id="_5-3-索引管理" tabindex="-1"><a class="header-anchor" href="#_5-3-索引管理" aria-hidden="true">#</a> <strong>5.3 索引管理</strong></h3><h4 id="_5-3-1-rest-api" tabindex="-1"><a class="header-anchor" href="#_5-3-1-rest-api" aria-hidden="true">#</a> <strong>5.3.1 REST API</strong></h4><h5 id="_5-3-1-1-添加文档" tabindex="-1"><a class="header-anchor" href="#_5-3-1-1-添加文档" aria-hidden="true">#</a> <strong>5.3.1.1 添加文档</strong></h5><p>索引创建好就可以向其中添加文档，此时 elasticsearch 会根据索引的 mapping 配置对有些字段进行分词。</p><p>这里我们要向 course_publish 中添加课程信息。</p><p>使用 rest api 进行测试，如下：</p><p>使用 post 请求，/course-publish/_doc/103 第一部分为索引名称，_doc 固定，103 为文档的主键 id，这里为课程 id。</p><p>课程内容使用 json 表示。</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>POST /course-publish/_doc/103
{
  &quot;charge&quot; : &quot;201001&quot;,
  &quot;companyId&quot; : 100000,
  &quot;companyName&quot; : &quot;北京黑马程序&quot;,
  &quot;createDate&quot; : &quot;2022-09-25 09:36:11&quot;,
  &quot;description&quot; : &quot;HTML/CSS&quot;,
  &quot;grade&quot; : &quot;204001&quot;,
  &quot;id&quot; : 102,
  &quot;mt&quot; : &quot;1-1&quot;,
  &quot;mtName&quot; : &quot;前端开发&quot;,
  &quot;name&quot; : &quot;Html参考大全&quot;,
  &quot;originalPrice&quot; : 200.0,
  &quot;pic&quot; : &quot;/mediafiles/2022/09/20/e726b71ba99c70e8c9d2850c2a7019d7.jpg&quot;,
  &quot;price&quot; : 100.0,
  &quot;remark&quot; : &quot;没有备注&quot;,
  &quot;st&quot; : &quot;1-1-1&quot;,
  &quot;stName&quot; : &quot;HTML/CSS&quot;,
  &quot;status&quot; : &quot;203002&quot;,
  &quot;tags&quot; : &quot;没有标签&quot;,
  &quot;teachmode&quot; : &quot;200002&quot;,
  &quot;validDays&quot; : 222
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果要修改文档的内容可以使用上边相同的方法，如果没有则添加，如果存在则更新。</p><h5 id="_5-3-1-2-查询文档" tabindex="-1"><a class="header-anchor" href="#_5-3-1-2-查询文档" aria-hidden="true">#</a> <strong>5.3.1.2 查询文档</strong></h5><p>添加文档成功后可以通过主键 id 查询该文档的信息。</p><p>语法如下：</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>GET /{索引库名称}/_doc/{id}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-3-1-3-更新文档" tabindex="-1"><a class="header-anchor" href="#_5-3-1-3-更新文档" aria-hidden="true">#</a> <strong>5.3.1.3 更新文档</strong></h5><p>更新文档分为全量更新和局部更新。</p><p>全量更新是指先删除再更新，语法如下：</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>PUT /{索引库名}/_doc/文档id
{
    &quot;字段1&quot;: &quot;值1&quot;,
    &quot;字段2&quot;: &quot;值2&quot;,
    // ... 略
}


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>局部更新语法如下：</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>POST /{索引库名}/_update/文档id
{
    &quot;doc&quot;: {
         &quot;字段名&quot;: &quot;新的值&quot;,
    }
}

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_5-3-1-4-删除文档" tabindex="-1"><a class="header-anchor" href="#_5-3-1-4-删除文档" aria-hidden="true">#</a> <strong>5.3.1.4 删除文档</strong></h5><p>删除文档将从索引中删除文档的记录。</p><p>语法如下：</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>DELETE /{索引库名}/_doc/id值

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-3-2-接口定义" tabindex="-1"><a class="header-anchor" href="#_5-3-2-接口定义" aria-hidden="true">#</a> <strong>5.3.2 接口定义</strong></h4><p>当课程发布时请求添加课程接口添加课程信息到索引，当课程下架时请求删除课程接口从索引中删除课程信息，这里先实现添加课程接口。</p><p>根据索引的 mapping 结构创建 po 类：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>po</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JSONField</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">JsonFormat</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
 * 课程索引信息
 * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
 *
 * <span class="token keyword">@author</span> itcast
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CourseIndex</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 主键
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 机构ID
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> companyId<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 公司名称
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> companyName<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 课程名称
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 适用人群
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> users<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 标签
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> tags<span class="token punctuation">;</span>


    <span class="token doc-comment comment">/**
     * 大分类
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mt<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 大分类名称
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mtName<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 小分类
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> st<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 小分类名称
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> stName<span class="token punctuation">;</span>



    <span class="token doc-comment comment">/**
     * 课程等级
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> grade<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 教育模式
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> teachmode<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 课程图片
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> pic<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 课程介绍
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> description<span class="token punctuation">;</span>


    <span class="token doc-comment comment">/**
     * 发布时间
     */</span>
    <span class="token annotation punctuation">@JSONField</span><span class="token punctuation">(</span>format<span class="token operator">=</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JsonFormat</span><span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> createDate<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 状态
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> status<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 备注
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> remark<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 收费规则，对应数据字典--203
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> charge<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 现价
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Float</span> price<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 原价
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Float</span> originalPrice<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 课程有效期天数
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> validDays<span class="token punctuation">;</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建索引接口如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>execption<span class="token punctuation">.</span></span><span class="token class-name">XueChengPlusException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">CourseIndex</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">IndexService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Api</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiOperation</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestBody</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> 课程索引接口
 * <span class="token keyword">@date</span> 2022/9/24 22:31
 */</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;课程信息索引接口&quot;</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">&quot;课程信息索引接口&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/index&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CourseIndexController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;添加课程索引&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;course&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">CourseIndex</span> courseIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>


    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-3-3-接口开发" tabindex="-1"><a class="header-anchor" href="#_5-3-3-接口开发" aria-hidden="true">#</a> <strong>5.3.3 接口开发</strong></h4><p>定义 service 接口，请求 elasticsearch 添加课程信息。</p><p>注意：为了适应其它文档信息，将添加文档定义为通用的添加文档接口，此接口不仅适应添加课程还适应添加其它信息。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">CourseIndex</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> 课程索引service
 * <span class="token keyword">@date</span> 2022/9/24 22:40
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IndexService</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * <span class="token keyword">@param</span> <span class="token parameter">indexName</span> 索引名称
     * <span class="token keyword">@param</span> <span class="token parameter">id</span> 主键
     * <span class="token keyword">@param</span> <span class="token parameter">object</span> 索引对象
     * <span class="token keyword">@return</span> Boolean true表示成功,false失败
     * <span class="token keyword">@description</span> 添加索引
     * <span class="token keyword">@author</span> Mr.M
     * <span class="token keyword">@date</span> 2022/9/24 22:57
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">addCourseIndex</span><span class="token punctuation">(</span><span class="token class-name">String</span> indexName<span class="token punctuation">,</span><span class="token class-name">String</span> id<span class="token punctuation">,</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>



<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接口实现如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>execption<span class="token punctuation">.</span></span><span class="token class-name">XueChengPlusException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">CourseIndex</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">IndexService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span></span><span class="token class-name">DocWriteResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>delete<span class="token punctuation">.</span></span><span class="token class-name">DeleteRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>delete<span class="token punctuation">.</span></span><span class="token class-name">DeleteResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>index<span class="token punctuation">.</span></span><span class="token class-name">IndexRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>index<span class="token punctuation">.</span></span><span class="token class-name">IndexResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>update<span class="token punctuation">.</span></span><span class="token class-name">UpdateRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>update<span class="token punctuation">.</span></span><span class="token class-name">UpdateResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RequestOptions</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestHighLevelClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>common<span class="token punctuation">.</span>xcontent<span class="token punctuation">.</span></span><span class="token class-name">XContentType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 课程索引管理接口实现
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/25 7:23
 * <span class="token keyword">@version</span> 1.0
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IndexServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">IndexService</span> <span class="token punctuation">{</span>



 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">RestHighLevelClient</span> client<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">addCourseIndex</span><span class="token punctuation">(</span><span class="token class-name">String</span> indexName<span class="token punctuation">,</span><span class="token class-name">String</span> id<span class="token punctuation">,</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">String</span> jsonString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">IndexRequest</span> indexRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span>indexName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//指定索引文档内容</span>
  indexRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span><span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//索引响应对象</span>
  <span class="token class-name">IndexResponse</span> indexResponse <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
   indexResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>indexRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;添加索引出错:{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;添加索引出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token class-name">String</span> name <span class="token operator">=</span> indexResponse<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> name<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">&quot;created&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> name<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">&quot;updated&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-3-4-接口完善" tabindex="-1"><a class="header-anchor" href="#_5-3-4-接口完善" aria-hidden="true">#</a> <strong>5.3.4 接口完善</strong></h4><p>完善接口：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>execption<span class="token punctuation">.</span></span><span class="token class-name">XueChengPlusException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">CourseIndex</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">IndexService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Api</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiOperation</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestBody</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> 课程索引接口
 * <span class="token keyword">@date</span> 2022/9/24 22:31
 */</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;课程信息索引接口&quot;</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">&quot;课程信息索引接口&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/index&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CourseIndexController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${elasticsearch.course.index}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> courseIndexStore<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">IndexService</span> indexService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;添加课程索引&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;course&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">CourseIndex</span> courseIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">Long</span> id <span class="token operator">=</span> courseIndex<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;课程id为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> indexService<span class="token punctuation">.</span><span class="token function">addCourseIndex</span><span class="token punctuation">(</span>courseIndexStore<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;添加课程索引失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-3-5-接口测试" tabindex="-1"><a class="header-anchor" href="#_5-3-5-接口测试" aria-hidden="true">#</a> <strong>5.3.5 接口测试</strong></h4><p>使用 httpclient 进行测试</p><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code>#### 添加课程索引
POST {{search_host}}/search/index/course
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/json</span></span>
<span class="token application-json">
<span class="token punctuation">{</span>
  <span class="token property">&quot;charge&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;201000&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;companyId&quot;</span> <span class="token operator">:</span> <span class="token number">100000</span><span class="token punctuation">,</span>
  <span class="token property">&quot;companyName&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;北京黑马程序员&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;createDate&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2022-09-25 09:36:11&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;《Java编程思想》是2007年6月1日机械工业出版社出版的图书，作者是埃克尔，译者是陈昊鹏。主要内容本书赢得了全球程序员的广泛赞誉，即使是最晦涩的概念，在Bruce Eckel的文字亲和力和小而直接的编程示例面前也会化解于无形。从Java的基础语法到最高级特性（深入的面向对象概念、多线程、自动项目构建、单元测试和调试等），本书都能逐步指导你轻松掌握。从本书获得的各项大奖以及来自世界各地的读者评论中，不难看出这是一本经典之作&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;grade&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;204001&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;id&quot;</span> <span class="token operator">:</span> <span class="token number">102</span><span class="token punctuation">,</span>
  <span class="token property">&quot;mt&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1-3&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;mtName&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;编程开发&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Java编程思想&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;originalPrice&quot;</span> <span class="token operator">:</span> <span class="token number">200.0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;pic&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;/mediafiles/2022/09/20/1d0f0e6ed8a0c4a89bfd304b84599d9c.png&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;price&quot;</span> <span class="token operator">:</span> <span class="token number">100.0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;remark&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;没有备注&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;st&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1-3-2&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;stName&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Java语言&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;status&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;203002&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;tags&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;没有标签&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;teachmode&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;200002&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;validDays&quot;</span> <span class="token operator">:</span> <span class="token number">222</span>
<span class="token punctuation">}</span>

</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-搜索" tabindex="-1"><a class="header-anchor" href="#_5-4-搜索" aria-hidden="true">#</a> <strong>5.4 搜索</strong></h3><h4 id="_5-4-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_5-4-1-需求分析" aria-hidden="true">#</a> <strong>5.4.1 需求分析</strong></h4><p>索引信息维护完成下一步定义搜索接口搜索课程信息，首先需要搞清楚搜索功能的需求。</p><p>进入搜索界面，如下图：</p><p><img src="`+Xn+`" alt="image-20230531100837646"></p><p>根据搜索界面可知需求如下：</p><p>1、根据一级分类、二级分类搜索课程信息。</p><p>2、根据关键字搜索课程信息，搜索方式为全文检索，关键字需要匹配课程的名称、 课程内容。</p><p>3、根据难度等级搜索课程。</p><p>4、搜索结点分页显示。</p><p>技术点：</p><p>1、整体采用布尔查询。</p><p>2、根据关键字搜索，采用 MultiMatchQuery，搜索 name、description 字段。</p><p>3、根据分类、课程等级搜索采用过滤器实现。</p><p>4、分页查询。</p><p>5、高亮显示。</p><blockquote><p>为什么课程分类、课程等级等查询使用过滤器方式？</p></blockquote><p>使用关键字查询需要计算相关度得分，根据课程分类、课程等级去查询不需要计算相关度得分，使用过滤器实现根据课程分类、课程等级查询的过程不会计算相关度得分，效率更高。</p><h4 id="_5-4-2-接口定义" tabindex="-1"><a class="header-anchor" href="#_5-4-2-接口定义" aria-hidden="true">#</a> <strong>5.4.2 接口定义</strong></h4><p>1、定义搜索条件 DTO 类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>dto</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">ToString</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 搜索课程参数dtl
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/24 22:36
 * <span class="token keyword">@version</span> 1.0
 */</span>
 <span class="token annotation punctuation">@Data</span>
 <span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchCourseParamDto</span> <span class="token punctuation">{</span>

  <span class="token comment">//关键字</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> keywords<span class="token punctuation">;</span>

  <span class="token comment">//大分类</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> mt<span class="token punctuation">;</span>

  <span class="token comment">//小分类</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> st<span class="token punctuation">;</span>
  <span class="token comment">//难度等级</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> grade<span class="token punctuation">;</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、为了适应后期的扩展，定义搜索结果类，让它继承 PageResult</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>dto</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">PageResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">ToString</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> TODO
 * <span class="token keyword">@date</span> 2022/9/25 17:51
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">PageResult</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">SearchPageResultDto</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">,</span> <span class="token keyword">long</span> counts<span class="token punctuation">,</span> <span class="token keyword">long</span> page<span class="token punctuation">,</span> <span class="token keyword">long</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> counts<span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接口定义如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">PageParams</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">PageResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">SearchCourseParamDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">CourseIndex</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">CourseSearchService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Api</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiOperation</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 课程搜索接口
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/24 22:31
 * <span class="token keyword">@version</span> 1.0
 */</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;课程搜索接口&quot;</span><span class="token punctuation">,</span>tags <span class="token operator">=</span> <span class="token string">&quot;课程搜索接口&quot;</span><span class="token punctuation">)</span>
 <span class="token annotation punctuation">@RestController</span>
 <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/course&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CourseSearchController</span> <span class="token punctuation">{</span>



 <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;课程搜索列表&quot;</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/list&quot;</span><span class="token punctuation">)</span>
 <span class="token keyword">public</span> <span class="token class-name">PageResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">PageParams</span> pageParams<span class="token punctuation">,</span> <span class="token class-name">SearchCourseParamDto</span> searchCourseParamDto<span class="token punctuation">)</span><span class="token punctuation">{</span>



  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-4-3-基本功能实现" tabindex="-1"><a class="header-anchor" href="#_5-4-3-基本功能实现" aria-hidden="true">#</a> <strong>5.4.3 基本功能实现</strong></h4><p>定义 service 接口，如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">PageParams</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">PageResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">SearchCourseParamDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">SearchPageResultDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">CourseIndex</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 课程搜索service
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/24 22:40
 * <span class="token keyword">@version</span> 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CourseSearchService</span> <span class="token punctuation">{</span>


    <span class="token doc-comment comment">/**
     * <span class="token keyword">@description</span> 搜索课程列表
     * <span class="token keyword">@param</span> <span class="token parameter">pageParams</span> 分页参数
     * <span class="token keyword">@param</span> <span class="token parameter">searchCourseParamDto</span> 搜索条件
     * <span class="token keyword">@return</span> com.xuecheng.base.model.PageResult<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>com.xuecheng.search.po.CourseIndex</span><span class="token punctuation">&gt;</span></span> 课程列表
     * <span class="token keyword">@author</span> Mr.M
     * <span class="token keyword">@date</span> 2022/9/24 22:45
    */</span>
    <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryCoursePubIndex</span><span class="token punctuation">(</span><span class="token class-name">PageParams</span> pageParams<span class="token punctuation">,</span> <span class="token class-name">SearchCourseParamDto</span> searchCourseParamDto<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>搜索接口的内容较多，我们分几步实现，首先实现根据分页搜索，接口实现如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">PageParams</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">PageResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">SearchCourseParamDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">SearchPageResultDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">CourseIndex</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">CourseSearchService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>lucene<span class="token punctuation">.</span>search<span class="token punctuation">.</span></span><span class="token class-name">TotalHits</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>search<span class="token punctuation">.</span></span><span class="token class-name">SearchRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>search<span class="token punctuation">.</span></span><span class="token class-name">SearchResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RequestOptions</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestHighLevelClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>common<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">Text</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>index<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">BoolQueryBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>index<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">MultiMatchQueryBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>index<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">QueryBuilders</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span></span><span class="token class-name">SearchHit</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span></span><span class="token class-name">SearchHits</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span>aggregations<span class="token punctuation">.</span></span><span class="token class-name">AggregationBuilders</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span>aggregations<span class="token punctuation">.</span></span><span class="token class-name">Aggregations</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span>aggregations<span class="token punctuation">.</span>bucket<span class="token punctuation">.</span>terms<span class="token punctuation">.</span></span><span class="token class-name">Terms</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span>builder<span class="token punctuation">.</span></span><span class="token class-name">SearchSourceBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span>fetch<span class="token punctuation">.</span>subphase<span class="token punctuation">.</span>highlight<span class="token punctuation">.</span></span><span class="token class-name">HighlightBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span>fetch<span class="token punctuation">.</span>subphase<span class="token punctuation">.</span>highlight<span class="token punctuation">.</span></span><span class="token class-name">HighlightField</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> 课程搜索service实现类
 * <span class="token keyword">@date</span> 2022/9/24 22:48
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CourseSearchServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">CourseSearchService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${elasticsearch.course.index}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> courseIndexStore<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${elasticsearch.course.source_fields}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sourceFields<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RestHighLevelClient</span> client<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryCoursePubIndex</span><span class="token punctuation">(</span><span class="token class-name">PageParams</span> pageParams<span class="token punctuation">,</span> <span class="token class-name">SearchCourseParamDto</span> courseSearchParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">//设置索引</span>
        <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>courseIndexStore<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BoolQueryBuilder</span> boolQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//source源字段过虑</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sourceFieldsArray <span class="token operator">=</span> sourceFields<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">fetchSource</span><span class="token punctuation">(</span>sourceFieldsArray<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//分页</span>
        <span class="token class-name">Long</span> pageNo <span class="token operator">=</span> pageParams<span class="token punctuation">.</span><span class="token function">getPageNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> pageSize <span class="token operator">=</span> pageParams<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pageNo<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">toIntExact</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//布尔查询</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boolQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//请求搜索</span>
        searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;课程搜索异常：{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//结果集处理</span>
        <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> searchHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//记录总数</span>
        <span class="token class-name">TotalHits</span> totalHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//数据列表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> searchHits<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token class-name">String</span> sourceAsString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CourseIndex</span> courseIndex <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">,</span> <span class="token class-name">CourseIndex</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> pageResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> totalHits<span class="token punctuation">.</span>value<span class="token punctuation">,</span>pageNo<span class="token punctuation">,</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-4-4-基本功能测试" tabindex="-1"><a class="header-anchor" href="#_5-4-4-基本功能测试" aria-hidden="true">#</a> <strong>5.4.4 基本功能测试</strong></h4><p>当输入查询条件时会查询全部课程信息并支持分页查询。</p><p>1、准备测试</p><p>启动 nginx、网关、搜索服务。</p><p>使用 kibana 通过 rest api 向索引库添加课程信息，或通过 httpclient 添加课程信息，至少添加两条信息。</p><p>2、进入搜索界面</p><p>默认查询出刚才添加的课程信息。</p><p>3、修改分页参数测试分页</p><p>打开 course/ search.html 页面 ，找到如下图所示位置：</p><p><img src="`+Kn+'" alt="image-20230531101012368"></p><p>修改 pageSize 为 1,即一页显示一条记录。</p><p>刷新搜索界面，每页显示一条记录，如下图：</p><p><img src="'+Gn+`" alt="image-20230531101017200"></p><h4 id="_5-4-5-根据条件搜索" tabindex="-1"><a class="header-anchor" href="#_5-4-5-根据条件搜索" aria-hidden="true">#</a> <strong>5.4.5 根据条件搜索</strong></h4><p>下边实现根据关键、一级分类、二级分类、难度等级搜索。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryCoursePubIndex</span><span class="token punctuation">(</span><span class="token class-name">PageParams</span> pageParams<span class="token punctuation">,</span> <span class="token class-name">SearchCourseParamDto</span> courseSearchParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//设置索引</span>
    <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>courseIndexStore<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BoolQueryBuilder</span> boolQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//source源字段过虑</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sourceFieldsArray <span class="token operator">=</span> sourceFields<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">fetchSource</span><span class="token punctuation">(</span>sourceFieldsArray<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>courseSearchParam<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        courseSearchParam <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchCourseParamDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//关键字</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getKeywords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//匹配关键字</span>
        <span class="token class-name">MultiMatchQueryBuilder</span> multiMatchQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">multiMatchQuery</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getKeywords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;description&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置匹配占比</span>
        multiMatchQueryBuilder<span class="token punctuation">.</span><span class="token function">minimumShouldMatch</span><span class="token punctuation">(</span><span class="token string">&quot;70%&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//提升另个字段的Boost值</span>
        multiMatchQueryBuilder<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span>multiMatchQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//过虑</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getMt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;mtName&quot;</span><span class="token punctuation">,</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getMt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getSt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;stName&quot;</span><span class="token punctuation">,</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getSt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;grade&quot;</span><span class="token punctuation">,</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//分页</span>
    <span class="token class-name">Long</span> pageNo <span class="token operator">=</span> pageParams<span class="token punctuation">.</span><span class="token function">getPageNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> pageSize <span class="token operator">=</span> pageParams<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pageNo<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">toIntExact</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//布尔查询</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boolQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//请求搜索</span>
    searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;课程搜索异常：{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//结果集处理</span>
    <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> searchHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//记录总数</span>
    <span class="token class-name">TotalHits</span> totalHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//数据列表</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> searchHits<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">String</span> sourceAsString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CourseIndex</span> courseIndex <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">,</span> <span class="token class-name">CourseIndex</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> pageResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> totalHits<span class="token punctuation">.</span>value<span class="token punctuation">,</span>pageNo<span class="token punctuation">,</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>



    <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-4-6-条件搜索测试" tabindex="-1"><a class="header-anchor" href="#_5-4-6-条件搜索测试" aria-hidden="true">#</a> <strong>5.4.6 条件搜索测试</strong></h4><p>进入搜索界面，输入关键字进行测试。</p><p>一级分类、二级分类在下边的聚合搜索中测试。</p><h4 id="_5-4-7-聚合搜索" tabindex="-1"><a class="header-anchor" href="#_5-4-7-聚合搜索" aria-hidden="true">#</a> <strong>5.4.7 聚合搜索</strong></h4><p>搜索界面上显示的一级分类、二级分类来源于搜索结果，使用聚合搜索实现找到搜索结果中的一级分类、二级分类。</p><p>1、首先在搜索结构 DTO 中添加一级分类、二级分类列表</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>dto</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">PageResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">ToString</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@version</span> 1.0
 * <span class="token keyword">@description</span> TODO
 * <span class="token keyword">@date</span> 2022/9/25 17:51
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">PageResult</span> <span class="token punctuation">{</span>

    <span class="token comment">//大分类列表</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> mtList<span class="token punctuation">;</span>
    <span class="token comment">//小分类列表</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stList<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SearchPageResultDto</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">,</span> <span class="token keyword">long</span> counts<span class="token punctuation">,</span> <span class="token keyword">long</span> page<span class="token punctuation">,</span> <span class="token keyword">long</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> counts<span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、搜索方法如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryCoursePubIndex</span><span class="token punctuation">(</span><span class="token class-name">PageParams</span> pageParams<span class="token punctuation">,</span> <span class="token class-name">SearchCourseParamDto</span> courseSearchParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//设置索引</span>
    <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>courseIndexStore<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BoolQueryBuilder</span> boolQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//source源字段过虑</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sourceFieldsArray <span class="token operator">=</span> sourceFields<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">fetchSource</span><span class="token punctuation">(</span>sourceFieldsArray<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>courseSearchParam<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        courseSearchParam <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchCourseParamDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//关键字</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getKeywords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//匹配关键字</span>
        <span class="token class-name">MultiMatchQueryBuilder</span> multiMatchQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">multiMatchQuery</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getKeywords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;description&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置匹配占比</span>
        multiMatchQueryBuilder<span class="token punctuation">.</span><span class="token function">minimumShouldMatch</span><span class="token punctuation">(</span><span class="token string">&quot;70%&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//提升另个字段的Boost值</span>
        multiMatchQueryBuilder<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span>multiMatchQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//过虑</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getMt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;mtName&quot;</span><span class="token punctuation">,</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getMt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getSt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;stName&quot;</span><span class="token punctuation">,</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getSt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;grade&quot;</span><span class="token punctuation">,</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//分页</span>
    <span class="token class-name">Long</span> pageNo <span class="token operator">=</span> pageParams<span class="token punctuation">.</span><span class="token function">getPageNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> pageSize <span class="token operator">=</span> pageParams<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pageNo<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">toIntExact</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//布尔查询</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boolQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">//请求搜索</span>
    searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//聚合设置</span>
    <span class="token function">buildAggregation</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;课程搜索异常：{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//结果集处理</span>
    <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> searchHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//记录总数</span>
    <span class="token class-name">TotalHits</span> totalHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//数据列表</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> searchHits<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">String</span> sourceAsString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CourseIndex</span> courseIndex <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">,</span> <span class="token class-name">CourseIndex</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> pageResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> totalHits<span class="token punctuation">.</span>value<span class="token punctuation">,</span>pageNo<span class="token punctuation">,</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//获取聚合结果</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> mtList<span class="token operator">=</span> <span class="token function">getAggregation</span><span class="token punctuation">(</span>searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;mtAgg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stList <span class="token operator">=</span> <span class="token function">getAggregation</span><span class="token punctuation">(</span>searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;stAgg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    pageResult<span class="token punctuation">.</span><span class="token function">setMtList</span><span class="token punctuation">(</span>mtList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pageResult<span class="token punctuation">.</span><span class="token function">setStList</span><span class="token punctuation">(</span>stList<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-4-8-聚合搜索测试" tabindex="-1"><a class="header-anchor" href="#_5-4-8-聚合搜索测试" aria-hidden="true">#</a> <strong>5.4.8 聚合搜索测试</strong></h4><p>进入搜索界面，观察搜索请求的响应内容中是否存在 mtList 和 stList.</p><p>观察页面一级分类、二级分类是否有分类信息。</p><p>注意：当选中一个一级分类时才会显示二级分类。</p><h4 id="_5-4-9-高亮设置" tabindex="-1"><a class="header-anchor" href="#_5-4-9-高亮设置" aria-hidden="true">#</a> <strong>5.4.9 高亮设置</strong></h4><p>最后实现关键词在课程名称中高亮显示。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryCoursePubIndex</span><span class="token punctuation">(</span><span class="token class-name">PageParams</span> pageParams<span class="token punctuation">,</span> <span class="token class-name">SearchCourseParamDto</span> courseSearchParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//设置索引</span>
    <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>courseIndexStore<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BoolQueryBuilder</span> boolQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//source源字段过虑</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sourceFieldsArray <span class="token operator">=</span> sourceFields<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">fetchSource</span><span class="token punctuation">(</span>sourceFieldsArray<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>courseSearchParam<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        courseSearchParam <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchCourseParamDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//关键字</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getKeywords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//匹配关键字</span>
        <span class="token class-name">MultiMatchQueryBuilder</span> multiMatchQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">multiMatchQuery</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getKeywords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;description&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置匹配占比</span>
        multiMatchQueryBuilder<span class="token punctuation">.</span><span class="token function">minimumShouldMatch</span><span class="token punctuation">(</span><span class="token string">&quot;70%&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//提升另个字段的Boost值</span>
        multiMatchQueryBuilder<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span>multiMatchQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//过虑</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getMt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;mtName&quot;</span><span class="token punctuation">,</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getMt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getSt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;stName&quot;</span><span class="token punctuation">,</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getSt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;grade&quot;</span><span class="token punctuation">,</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//分页</span>
    <span class="token class-name">Long</span> pageNo <span class="token operator">=</span> pageParams<span class="token punctuation">.</span><span class="token function">getPageNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> pageSize <span class="token operator">=</span> pageParams<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pageNo<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">toIntExact</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//布尔查询</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boolQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//高亮设置</span>
    <span class="token class-name">HighlightBuilder</span> highlightBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HighlightBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    highlightBuilder<span class="token punctuation">.</span><span class="token function">preTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;font class=&#39;eslight&#39;&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    highlightBuilder<span class="token punctuation">.</span><span class="token function">postTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/font&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置高亮字段</span>
    highlightBuilder<span class="token punctuation">.</span><span class="token function">fields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HighlightBuilder<span class="token punctuation">.</span>Field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">highlighter</span><span class="token punctuation">(</span>highlightBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//请求搜索</span>
    searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//聚合设置</span>
    <span class="token function">buildAggregation</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;课程搜索异常：{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//结果集处理</span>
    <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> searchHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//记录总数</span>
    <span class="token class-name">TotalHits</span> totalHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//数据列表</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> searchHits<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">String</span> sourceAsString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CourseIndex</span> courseIndex <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">,</span> <span class="token class-name">CourseIndex</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//取出source</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> sourceAsMap <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//课程id</span>
        <span class="token class-name">Long</span> id <span class="token operator">=</span> courseIndex<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//取出名称</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> courseIndex<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//取出高亮字段内容</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">HighlightField</span><span class="token punctuation">&gt;</span></span> highlightFields <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>highlightFields<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">HighlightField</span> nameField <span class="token operator">=</span> highlightFields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>nameField<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">Text</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fragments <span class="token operator">=</span> nameField<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">StringBuffer</span> stringBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Text</span> str <span class="token operator">:</span> fragments<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    stringBuffer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                name <span class="token operator">=</span> stringBuffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        courseIndex<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        courseIndex<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> pageResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> totalHits<span class="token punctuation">.</span>value<span class="token punctuation">,</span>pageNo<span class="token punctuation">,</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//获取聚合结果</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> mtList<span class="token operator">=</span> <span class="token function">getAggregation</span><span class="token punctuation">(</span>searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;mtAgg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stList <span class="token operator">=</span> <span class="token function">getAggregation</span><span class="token punctuation">(</span>searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;stAgg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    pageResult<span class="token punctuation">.</span><span class="token function">setMtList</span><span class="token punctuation">(</span>mtList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pageResult<span class="token punctuation">.</span><span class="token function">setStList</span><span class="token punctuation">(</span>stList<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-4-10-高亮设置测试" tabindex="-1"><a class="header-anchor" href="#_5-4-10-高亮设置测试" aria-hidden="true">#</a> <strong>5.4.10 高亮设置测试</strong></h4><p>输入关键字，观察搜索结果，标题中是否对关键字信息进行高亮显示。</p><h3 id="_5-5-课程信息索引同步" tabindex="-1"><a class="header-anchor" href="#_5-5-课程信息索引同步" aria-hidden="true">#</a> <strong>5.5 课程信息索引同步</strong></h3><h4 id="_5-5-1-技术方案" tabindex="-1"><a class="header-anchor" href="#_5-5-1-技术方案" aria-hidden="true">#</a> <strong>5.5.1 技术方案</strong></h4><p>通过向索引中添加课程信息最终实现了课程的搜索，我们发现课程信息是先保存在关系数据库中，而后再写入索引，这个过程是将关系数据中的数据同步到 elasticsearch 索引中的过程，可以简单成为索引同步。</p><p>通常项目中使用 elasticsearch 需要完成索引同步，索引同步的方法很多：</p><p>1、针对实时性非常高的场景需要满足数据的及时同步，可以同步调用，或使用 Canal 去实现。</p><p>1）同步调用即在向 MySQL 写数据后远程调用搜索服务的接口写入索引，此方法简单但是耦合代码太高。</p><p>2）可以使用一个中间的软件 canal 解决耦合性的问题，但存在学习与维护成本。</p><p>canal 主要用途是基于 MySQL 数据库增量日志解析，并能提供增量数据订阅和消费，实现将 MySQL 的数据同步到消息队列、Elasticsearch、其它数据库等，应用场景十分丰富。</p><p><img src="`+$n+'" alt="image-20230531101151392"></p><p>它的地址：</p><p>github 地址：https://github.com/alibaba/canal</p><p>版本下载地址：https://github.com/alibaba/canal/releases</p><p>文档地址：https://github.com/alibaba/canal/wiki/Docker-QuickStart</p><p>Canal 基于 mysql 的 binlog 技术实现数据同步，什么是 binlog，它是一个文件，二进制格式，记录了对数据库更新的 SQL 语句，向数据库写数据的同时向 binlog 文件里记录对应的 sql 语句。当数据库服务器发生了故障就可以使用 binlog 文件对数据库进行恢复。</p><p>所以，使用 canal 是需要开启 mysql 的 binlog 写入功能，Canal 工作原理如下：</p><p><img src="'+Wn+'" alt="image-20230531101158112"></p><p>1、canal 模拟 MySQL slave 的交互协议，伪装自己为 MySQL slave ，向 MySQL master 发送 dump 协议</p><p>2、MySQL master 收到 dump 请求，开始推送 binary log 给 slave (即 canal )</p><p>3、canal 解析 binary log 对象(原始为 byte 流)</p><p>详细使用 Canal 进行索引同步的步骤参考：Canal 实现索引同步.pdf</p><p>2、当索引同步的实时性要求不高时可用的技术比较多，比如：MQ、Logstash、任务调度等。</p><p>MQ：向 mysql 写数据的时候向 mq 写入消息，搜索服务监听 MQ，收到消息后写入索引。使用 MQ 的优势是代码解耦，但是需要处理消息可靠性的问题有一定的技术成本，做到消息可靠性需要做到生产者投递成功、消息持久化以及消费者消费成功三个方面，另外还要做好消息幂等性问题。</p><p>Logstash： 开源实时日志分析平台 ELK 包括 Elasticsearch、Kibana、Logstash，Logstash 负责收集、解析和转换日志信息，可以实现 MySQL 与 Elasticsearch 之间的数据同步。也可以实现解耦合并且是官方推荐，但需要增加学习与维护成本。</p><p>任务调度：向 mysql 写数据的时候记录修改记录，开启一个定时任务根据修改记录将数据同步到 Elasticsearch。</p><p>根据本项目的需求，课程发布后信息同步的实时性要求不高，从提交审核到发布成功一般两个工作日完成。综合比较以上技术方案本项目的索引同步技术使用任务调度的方法。</p><p>如下图：</p><p><img src="'+Yn+`" alt="image-20230531101205123"></p><p>1、课程发布向消息表插入记录。</p><p>2、由任务调度程序通过消息处理 SDK 对消息记录进行处理。</p><p>3、向 elasticsearch 索引中保存课程信息。</p><p>如何向向 elasticsearch 索引中保存课程信息？</p><p>执行流程如下：</p><p>由内容管理服务远程调用搜索服务添加课程信息索引，搜索服务再请求 elasticsearch 向课程索引中添加文档。</p><h4 id="_5-5-2-课程索引任务开发" tabindex="-1"><a class="header-anchor" href="#_5-5-2-课程索引任务开发" aria-hidden="true">#</a> <strong>5.5.2 课程索引任务开发</strong></h4><p>1、拷贝 CourseIndex 模型类到内容管理 model 工程的 dto 包下。</p><p>2、在内容管理服务中添加 FeignClient</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>feignclient</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">CourseIndex</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestBody</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 搜索服务远程接口
 * <span class="token keyword">@author</span> Mr.M
 * <span class="token keyword">@date</span> 2022/9/20 20:29
 * <span class="token keyword">@version</span> 1.0
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;search&quot;</span><span class="token punctuation">,</span>fallbackFactory <span class="token operator">=</span> <span class="token class-name">SearchServiceClientFallbackFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SearchServiceClient</span> <span class="token punctuation">{</span>

 <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/search/index/course&quot;</span><span class="token punctuation">)</span>
 <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">CourseIndex</span> courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>定义 SearchServiceClientFallbackFactory ：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchServiceClientFallbackFactory</span> <span class="token keyword">implements</span> <span class="token class-name">FallbackFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SearchServiceClient</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">SearchServiceClient</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SearchServiceClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">CourseIndex</span> courseIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                throwable<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;调用搜索发生熔断走降级方法,熔断异常:&quot;</span><span class="token punctuation">,</span> throwable<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3、编写课程索引任务执行方法</p><p>完善 CoursePublishTask 类中的 saveCourseIndex 方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//保存课程索引信息</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveCourseIndex</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">,</span><span class="token keyword">long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;保存课程索引信息,课程id:{}&quot;</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//消息id</span>
    <span class="token class-name">Long</span> id <span class="token operator">=</span> mqMessage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//消息处理的service</span>
    <span class="token class-name">MqMessageService</span> mqMessageService <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMqMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//消息幂等性处理</span>
    <span class="token keyword">int</span> stageTwo <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">getStageTwo</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>stageTwo <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;课程索引已处理直接返回，课程id:{}&quot;</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token function">saveCourseIndex</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//保存第一阶段状态</span>
        mqMessageService<span class="token punctuation">.</span><span class="token function">completedStageTwo</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Boolean</span> <span class="token function">saveCourseIndex</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//取出课程发布信息</span>
    <span class="token class-name">CoursePublish</span> coursePublish <span class="token operator">=</span> coursePublishMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//拷贝至课程索引对象</span>
    <span class="token class-name">CourseIndex</span> courseIndex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CourseIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>coursePublish<span class="token punctuation">,</span>courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//远程调用搜索服务api添加课程信息到索引</span>
    <span class="token class-name">Boolean</span> add <span class="token operator">=</span> searchServiceClient<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>add<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;添加索引失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> add<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-5-3-测试" tabindex="-1"><a class="header-anchor" href="#_5-5-3-测试" aria-hidden="true">#</a> <strong>5.5.3 测试</strong></h4><p>测试流程如下：</p><p>1、启动 elasticsearch、kibana。</p><p>2、启动网关、内容管理、搜索服务、nginx。</p><p>3、启动 xxl-job 调度中心。</p><p>4、在任务调度中心开始课程发布任务。</p><p>5、发布一门课程，页面提示操作成功，查看发布课程任务是否写到任务表。</p><p>6、经过任务调度将课程信息写入索引。</p><p>7、通过门户进入搜索页面，查看课程信息是否展示。</p>`,210);function us(rs,ks){const p=c("router-link"),o=c("ExternalLinkIcon");return l(),u("div",null,[ns,n("nav",ss,[n("ul",null,[n("li",null,[a(p,{to:"#_1-模块需求分析"},{default:t(()=>[s("1 模块需求分析")]),_:1}),n("ul",null,[n("li",null,[a(p,{to:"#_1-1-模块介绍"},{default:t(()=>[s("1.1 模块介绍")]),_:1})]),n("li",null,[a(p,{to:"#_1-2-业务流程"},{default:t(()=>[s("1.2 业务流程")]),_:1})])])]),n("li",null,[a(p,{to:"#_2-课程预览"},{default:t(()=>[s("2 课程预览")]),_:1}),n("ul",null,[n("li",null,[a(p,{to:"#_2-1-需求分析"},{default:t(()=>[s("2.1 需求分析")]),_:1})]),n("li",null,[a(p,{to:"#_2-2-模板引擎"},{default:t(()=>[s("2.2 模板引擎")]),_:1})]),n("li",null,[a(p,{to:"#_2-3-测试静态页面"},{default:t(()=>[s("2.3 测试静态页面")]),_:1})]),n("li",null,[a(p,{to:"#_2-4-接口定义"},{default:t(()=>[s("2.4 接口定义")]),_:1})]),n("li",null,[a(p,{to:"#_2-5-接口开发"},{default:t(()=>[s("2.5 接口开发")]),_:1})])])]),n("li",null,[a(p,{to:"#_3-课程审核"},{default:t(()=>[s("3 课程审核")]),_:1}),n("ul",null,[n("li",null,[a(p,{to:"#_3-1-需求分析"},{default:t(()=>[s("3.1 需求分析")]),_:1})]),n("li",null,[a(p,{to:"#_3-2-接口定义"},{default:t(()=>[s("3.2 接口定义")]),_:1})]),n("li",null,[a(p,{to:"#_3-3-接口开发"},{default:t(()=>[s("3.3 接口开发")]),_:1})]),n("li",null,[a(p,{to:"#_3-4-接口完善"},{default:t(()=>[s("3.4 接口完善")]),_:1})]),n("li",null,[a(p,{to:"#_3-5-接口测试"},{default:t(()=>[s("3.5 接口测试")]),_:1})])])]),n("li",null,[a(p,{to:"#_4-课程发布"},{default:t(()=>[s("4 课程发布")]),_:1}),n("ul",null,[n("li",null,[a(p,{to:"#_4-1-需求分析"},{default:t(()=>[s("4.1 需求分析")]),_:1})]),n("li",null,[a(p,{to:"#_4-2-分布式事务技术方案"},{default:t(()=>[s("4.2 分布式事务技术方案")]),_:1})]),n("li",null,[a(p,{to:"#_4-3-课程发布接口"},{default:t(()=>[s("4.3 课程发布接口")]),_:1})]),n("li",null,[a(p,{to:"#_4-4-消息处理-sdk"},{default:t(()=>[s("4.4 消息处理 SDK")]),_:1})]),n("li",null,[a(p,{to:"#_4-5-页面静态化"},{default:t(()=>[s("4.5 页面静态化")]),_:1})])])]),n("li",null,[a(p,{to:"#_5-课程搜索"},{default:t(()=>[s("5 课程搜索")]),_:1}),n("ul",null,[n("li",null,[a(p,{to:"#_5-1-需求分析"},{default:t(()=>[s("5.1 需求分析")]),_:1})]),n("li",null,[a(p,{to:"#_5-2-准备环境"},{default:t(()=>[s("5.2 准备环境")]),_:1})]),n("li",null,[a(p,{to:"#_5-3-索引管理"},{default:t(()=>[s("5.3 索引管理")]),_:1})]),n("li",null,[a(p,{to:"#_5-4-搜索"},{default:t(()=>[s("5.4 搜索")]),_:1})]),n("li",null,[a(p,{to:"#_5-5-课程信息索引同步"},{default:t(()=>[s("5.5 课程信息索引同步")]),_:1})])])])])]),as,n("p",null,[s("FreeMarker 是一款 "),ps,s("： 即一种基于模板和要改变的数据， 并用来生成输出文本(HTML 网页，电子邮件，配置文件，源代码等)的通用工具。 它不是面向最终用户的，而是一个 Java 类库，是一款程序员可以嵌入他们所开发产品的组件。FreeMarker 是 "),n("a",ts,[s("免费的"),a(o)]),s("， 基于 Apache 许可证 2.0 版本发布。")]),es,n("p",null,[s("Feign 是一个声明式的 http 客户端，官方地址："),n("a",os,[s("https://github.com/OpenFeign/feign"),a(o)])]),cs,n("p",null,[n("a",is,[s("全文检索"),a(o)]),s("是指计算机索引程序通过扫描文章中的每一个词，对每一个词建立一个索引，指明该词在文章中出现的次数和位置，当用户查询时，检索程序就根据事先建立的索引进行查找，并将查找的结果反馈给用户的检索方式。这个过程类似于通过字典中的检索字表查字的过程。")]),ls])}const ms=i(Zn,[["render",us],["__file","index.html.vue"]]);export{ms as default};
