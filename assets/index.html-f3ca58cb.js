import{_ as r,r as t,o as c,c as d,a as s,e as a,w as e,b as n,d as l}from"./app-a153c100.js";const o="/MyBlog/assets/image-20210629114325516-55d98da4.png",m="/MyBlog/assets/image-20210629114830642-a4fad52f.png",u="/MyBlog/assets/image-20210629114941810-13d44338.png",v="/MyBlog/assets/image-20210630111505799-f3b356ee.png",b="/MyBlog/assets/image-20210630113929868-c6aeaea2.png",g="/MyBlog/assets/image-20210630183914491-47e437ad.png",k="/MyBlog/assets/image-20210630201258802-0e593f2f.png",h="/MyBlog/assets/image-20210701215227018-c409376c.png",f="/MyBlog/assets/image-20210701215534714-895e8aac.png",_="/MyBlog/assets/image-20210701220714104-7942057d.png",x="/MyBlog/assets/image-20210701222857997-b201237a.png",y="/MyBlog/assets/image-20210701223025709-d7b062c0.png",B="/MyBlog/assets/image-20210701223131264-db153330.png",R="/MyBlog/assets/image-20210702164116027-6c4dec39.png",M="/MyBlog/assets/image-20210702174255799-3c962190.png",I="/MyBlog/assets/image-20210702181101969-04b19dc2.png",P="/MyBlog/assets/image-20210702181215705-2c240f05.png",w="/MyBlog/assets/image-20210702181922809-e5b841a4.png",O="/MyBlog/assets/image-20210702182343979-92510d8b.png",q="/MyBlog/assets/image-20210702182602145-c1a7a399.png",N={},T=s("h1",{id:"redis-集群-🧙",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#redis-集群-🧙","aria-hidden":"true"},"#"),n(" Redis 集群 🧙")],-1),V={class:"table-of-contents"},z=l(`<p>本章是基于 CentOS7 下的 Redis 集群教程，包括：</p><ul><li>单机安装 Redis</li><li>Redis 主从</li><li>Redis 分片集群</li></ul><h1 id="_1-单机安装-redis" tabindex="-1"><a class="header-anchor" href="#_1-单机安装-redis" aria-hidden="true">#</a> 1.单机安装 Redis</h1><p>首先需要安装 Redis 所需要的依赖：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> gcc tcl
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>然后将课前资料提供的 Redis 安装包上传到虚拟机的任意目录：</p><p><img src="`+o+'" alt="image-20210629114325516"></p><p>例如，我放到了/tmp 目录：</p><p><img src="'+m+`" alt="image-20210629114830642"></p><p>解压缩：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">tar</span> <span class="token parameter variable">-xvf</span> redis-6.2.4.tar.gz
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>解压后：</p><p><img src="`+u+`" alt="image-20210629114941810"></p><p>进入 redis 目录：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> redis-6.2.4
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>运行编译命令：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>如果没有出错，应该就安装成功了。</p><p>然后修改 redis.conf 文件中的一些配置：</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># 绑定地址，默认是127.0.0.1，会导致只能在本地访问。修改为0.0.0.0则可以在任意IP访问</span>
<span class="token key attr-name">bind</span> <span class="token value attr-value">0.0.0.0</span>
<span class="token comment"># 数据库数量，设置为1</span>
<span class="token key attr-name">databases</span> <span class="token value attr-value">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动 Redis：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-server redis.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>停止 redis 服务：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-cli <span class="token function">shutdown</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h1 id="_2-redis-主从集群" tabindex="-1"><a class="header-anchor" href="#_2-redis-主从集群" aria-hidden="true">#</a> 2.Redis 主从集群</h1><h2 id="_2-1-集群结构" tabindex="-1"><a class="header-anchor" href="#_2-1-集群结构" aria-hidden="true">#</a> 2.1.集群结构</h2><p>我们搭建的主从集群结构如图：</p><p><img src="`+v+`" alt="image-20210630111505799"></p><p>共包含三个节点，一个主节点，两个从节点。</p><p>这里我们会在同一台虚拟机中开启 3 个 redis 实例，模拟主从集群，信息如下：</p><table><thead><tr><th style="text-align:center;">IP</th><th style="text-align:center;">PORT</th><th style="text-align:center;">角色</th></tr></thead><tbody><tr><td style="text-align:center;">192.168.150.101</td><td style="text-align:center;">7001</td><td style="text-align:center;">master</td></tr><tr><td style="text-align:center;">192.168.150.101</td><td style="text-align:center;">7002</td><td style="text-align:center;">slave</td></tr><tr><td style="text-align:center;">192.168.150.101</td><td style="text-align:center;">7003</td><td style="text-align:center;">slave</td></tr></tbody></table><h2 id="_2-2-准备实例和配置" tabindex="-1"><a class="header-anchor" href="#_2-2-准备实例和配置" aria-hidden="true">#</a> 2.2.准备实例和配置</h2><p>要在同一台虚拟机开启 3 个实例，必须准备三份不同的配置文件和目录，配置文件所在目录也就是工作目录。</p><p>1）创建目录</p><p>我们创建三个文件夹，名字分别叫 7001、7002、7003：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 进入/tmp目录</span>
<span class="token builtin class-name">cd</span> /tmp
<span class="token comment"># 创建目录</span>
<span class="token function">mkdir</span> <span class="token number">7001</span> <span class="token number">7002</span> <span class="token number">7003</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如图：</p><p><img src="`+b+`" alt="image-20210630113929868"></p><p>2）恢复原始配置</p><p>修改 redis-6.2.4/redis.conf 文件，将其中的持久化模式改为默认的 RDB 模式，AOF 保持关闭状态。</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># 开启RDB</span>
<span class="token comment"># save &quot;&quot;</span>
<span class="token key attr-name">save</span> <span class="token value attr-value">3600 1</span>
<span class="token key attr-name">save</span> <span class="token value attr-value">300 100</span>
<span class="token key attr-name">save</span> <span class="token value attr-value">60 10000</span>

<span class="token comment"># 关闭AOF</span>
<span class="token key attr-name">appendonly</span> <span class="token value attr-value">no</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3）拷贝配置文件到每个实例目录</p><p>然后将 redis-6.2.4/redis.conf 文件拷贝到三个目录中（在/tmp 目录执行下列命令）：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 方式一：逐个拷贝</span>
<span class="token function">cp</span> redis-6.2.4/redis.conf <span class="token number">7001</span>
<span class="token function">cp</span> redis-6.2.4/redis.conf <span class="token number">7002</span>
<span class="token function">cp</span> redis-6.2.4/redis.conf <span class="token number">7003</span>
<span class="token comment"># 方式二：管道组合命令，一键拷贝</span>
<span class="token builtin class-name">echo</span> <span class="token number">7001</span> <span class="token number">7002</span> <span class="token number">7003</span> <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token parameter variable">-t</span> <span class="token parameter variable">-n</span> <span class="token number">1</span> <span class="token function">cp</span> redis-6.2.4/redis.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4）修改每个实例的端口、工作目录</p><p>修改每个文件夹内的配置文件，将端口分别修改为 7001、7002、7003，将 rdb 文件保存位置都修改为自己所在目录（在/tmp 目录执行下列命令）：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-e</span> <span class="token string">&#39;s/6379/7001/g&#39;</span> <span class="token parameter variable">-e</span> <span class="token string">&#39;s/dir .\\//dir \\/tmp\\/7001\\//g&#39;</span> <span class="token number">7001</span>/redis.conf
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-e</span> <span class="token string">&#39;s/6379/7002/g&#39;</span> <span class="token parameter variable">-e</span> <span class="token string">&#39;s/dir .\\//dir \\/tmp\\/7002\\//g&#39;</span> <span class="token number">7002</span>/redis.conf
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-e</span> <span class="token string">&#39;s/6379/7003/g&#39;</span> <span class="token parameter variable">-e</span> <span class="token string">&#39;s/dir .\\//dir \\/tmp\\/7003\\//g&#39;</span> <span class="token number">7003</span>/redis.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>5）修改每个实例的声明 IP</p><p>虚拟机本身有多个 IP，为了避免将来混乱，我们需要在 redis.conf 文件中指定每一个实例的绑定 ip 信息，格式如下：</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># redis实例的声明 IP</span>
<span class="token key attr-name">replica-announce-ip</span> <span class="token value attr-value">192.168.150.101</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>每个目录都要改，我们一键完成修改（在/tmp 目录执行下列命令）：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 逐一执行</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&#39;1a replica-announce-ip 192.168.150.101&#39;</span> <span class="token number">7001</span>/redis.conf
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&#39;1a replica-announce-ip 192.168.150.101&#39;</span> <span class="token number">7002</span>/redis.conf
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&#39;1a replica-announce-ip 192.168.150.101&#39;</span> <span class="token number">7003</span>/redis.conf

<span class="token comment"># 或者一键修改</span>
<span class="token builtin class-name">printf</span> <span class="token string">&#39;%s\\n&#39;</span> <span class="token number">7001</span> <span class="token number">7002</span> <span class="token number">7003</span> <span class="token operator">|</span> <span class="token function">xargs</span> -I<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token parameter variable">-t</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&#39;1a replica-announce-ip 192.168.126.129&#39;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>/redis.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-3-启动" tabindex="-1"><a class="header-anchor" href="#_2-3-启动" aria-hidden="true">#</a> 2.3.启动</h2><p>为了方便查看日志，我们打开 3 个 ssh 窗口，分别启动 3 个 redis 实例，启动命令：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 第1个</span>
redis-server <span class="token number">7001</span>/redis.conf
<span class="token comment"># 第2个</span>
redis-server <span class="token number">7002</span>/redis.conf
<span class="token comment"># 第3个</span>
redis-server <span class="token number">7003</span>/redis.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动后：</p><p><img src="`+g+`" alt="image-20210630183914491"></p><p>如果要一键停止，可以运行下面命令：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">printf</span> <span class="token string">&#39;%s\\n&#39;</span> <span class="token number">7001</span> <span class="token number">7002</span> <span class="token number">7003</span> <span class="token operator">|</span> <span class="token function">xargs</span> -I<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token parameter variable">-t</span> redis-cli <span class="token parameter variable">-p</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token function">shutdown</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_2-4-开启主从关系" tabindex="-1"><a class="header-anchor" href="#_2-4-开启主从关系" aria-hidden="true">#</a> 2.4.开启主从关系</h2><p>现在三个实例还没有任何关系，要配置主从可以使用 replicaof 或者 slaveof（5.0 以前）命令。</p><p>有临时和永久两种模式：</p><ul><li><p>修改配置文件（永久生效）</p><ul><li>在 redis.conf 中添加一行配置：<code>slaveof &lt;masterip&gt; &lt;masterport&gt;</code></li></ul></li><li><p>使用 redis-cli 客户端连接到 redis 服务，执行 slaveof 命令（重启后失效）：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>slaveof <span class="token operator">&lt;</span>masterip<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>masterport<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul>`,63),C=l(`<p>这里我们为了演示方便，使用方式二。</p><p>通过 redis-cli 命令连接 7002，执行下面命令：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 连接 7002</span>
redis-cli <span class="token parameter variable">-p</span> <span class="token number">7002</span>
<span class="token comment"># 执行slaveof</span>
slaveof <span class="token number">192.168</span>.126.129 <span class="token number">7001</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过 redis-cli 命令连接 7003，执行下面命令：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 连接 7003</span>
redis-cli <span class="token parameter variable">-p</span> <span class="token number">7003</span>
<span class="token comment"># 执行slaveof</span>
slaveof <span class="token number">192.168</span>.126.129 <span class="token number">7001</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后连接 7001 节点，查看集群状态：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 连接 7001</span>
redis-cli <span class="token parameter variable">-p</span> <span class="token number">7001</span>
<span class="token comment"># 查看状态</span>
info replication
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果：</p><p><img src="`+k+'" alt="image-20210630201258802"></p><h2 id="_2-5-测试" tabindex="-1"><a class="header-anchor" href="#_2-5-测试" aria-hidden="true">#</a> 2.5.测试</h2><p>执行下列操作以测试：</p><ul><li><p>利用 redis-cli 连接 7001，执行<code>set num 123</code></p></li><li><p>利用 redis-cli 连接 7002，执行<code>get num</code>，再执行<code>set num 666</code></p></li><li><p>利用 redis-cli 连接 7003，执行<code>get num</code>，再执行<code>set num 888</code></p></li></ul><p>可以发现，只有在 7001 这个 master 节点上可以执行写操作，7002 和 7003 这两个 slave 节点只能执行读操作。</p><h1 id="_3-搭建哨兵集群" tabindex="-1"><a class="header-anchor" href="#_3-搭建哨兵集群" aria-hidden="true">#</a> 3.搭建哨兵集群</h1><h2 id="_3-1-集群结构" tabindex="-1"><a class="header-anchor" href="#_3-1-集群结构" aria-hidden="true">#</a> 3.1.集群结构</h2><p>这里我们搭建一个三节点形成的 Sentinel 集群，来监管之前的 Redis 主从集群。如图：</p><p><img src="'+h+`" alt="image-20210701215227018"></p><p>三个 sentinel 实例信息如下：</p><table><thead><tr><th>节点</th><th style="text-align:center;">IP</th><th style="text-align:center;">PORT</th></tr></thead><tbody><tr><td>s1</td><td style="text-align:center;">192.168.150.101</td><td style="text-align:center;">27001</td></tr><tr><td>s2</td><td style="text-align:center;">192.168.150.101</td><td style="text-align:center;">27002</td></tr><tr><td>s3</td><td style="text-align:center;">192.168.150.101</td><td style="text-align:center;">27003</td></tr></tbody></table><h2 id="_3-2-准备实例和配置" tabindex="-1"><a class="header-anchor" href="#_3-2-准备实例和配置" aria-hidden="true">#</a> 3.2.准备实例和配置</h2><p>要在同一台虚拟机开启 3 个实例，必须准备三份不同的配置文件和目录，配置文件所在目录也就是工作目录。</p><p>我们创建三个文件夹，名字分别叫 s1、s2、s3：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 进入/tmp目录</span>
<span class="token builtin class-name">cd</span> /tmp
<span class="token comment"># 创建目录</span>
<span class="token function">mkdir</span> s1 s2 s3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如图：</p><p><img src="`+f+`" alt="image-20210701215534714"></p><p>然后我们在 s1 目录创建一个 sentinel.conf 文件，添加下面的内容：</p><div class="language-ini line-numbers-mode" data-ext="ini"><pre class="language-ini"><code>port 27001
sentinel announce-ip 192.168.126.129
sentinel monitor mymaster 192.168.126.129 7001 2
sentinel down-after-milliseconds mymaster 5000
sentinel failover-timeout mymaster 60000
dir &quot;/tmp/s1&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>解读：</p><ul><li><code>port 27001</code>：是当前 sentinel 实例的端口</li><li><code>sentinel monitor mymaster 192.168.150.101 7001 2</code>：指定主节点信息 <ul><li><code>mymaster</code>：主节点名称，自定义，任意写</li><li><code>192.168.150.101 7001</code>：主节点的 ip 和端口</li><li><code>2</code>：选举 master 时的 quorum 值</li></ul></li></ul><p>然后将 s1/sentinel.conf 文件拷贝到 s2、s3 两个目录中（在/tmp 目录执行下列命令）：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 方式一：逐个拷贝</span>
<span class="token function">cp</span> s1/sentinel.conf s2
<span class="token function">cp</span> s1/sentinel.conf s3
<span class="token comment"># 方式二：管道组合命令，一键拷贝</span>
<span class="token builtin class-name">echo</span> s2 s3 <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token parameter variable">-t</span> <span class="token parameter variable">-n</span> <span class="token number">1</span> <span class="token function">cp</span> s1/sentinel.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改 s2、s3 两个文件夹内的配置文件，将端口分别修改为 27002、27003：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-e</span> <span class="token string">&#39;s/27001/27002/g&#39;</span> <span class="token parameter variable">-e</span> <span class="token string">&#39;s/s1/s2/g&#39;</span> s2/sentinel.conf
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-e</span> <span class="token string">&#39;s/27001/27003/g&#39;</span> <span class="token parameter variable">-e</span> <span class="token string">&#39;s/s1/s3/g&#39;</span> s3/sentinel.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-3-启动" tabindex="-1"><a class="header-anchor" href="#_3-3-启动" aria-hidden="true">#</a> 3.3.启动</h2><p>为了方便查看日志，我们打开 3 个 ssh 窗口，分别启动 3 个 redis 实例，启动命令：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 第1个</span>
redis-sentinel s1/sentinel.conf
<span class="token comment"># 第2个</span>
redis-sentinel s2/sentinel.conf
<span class="token comment"># 第3个</span>
redis-sentinel s3/sentinel.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动后：</p><p><img src="`+_+'" alt="image-20210701220714104"></p><h2 id="_3-4-测试" tabindex="-1"><a class="header-anchor" href="#_3-4-测试" aria-hidden="true">#</a> 3.4.测试</h2><p>尝试让 master 节点 7001 宕机，查看 sentinel 日志：</p><p><img src="'+x+'" alt="image-20210701222857997"></p><p>查看 7003 的日志：</p><p><img src="'+y+'" alt="image-20210701223025709"></p><p>查看 7002 的日志：</p><p><img src="'+B+'" alt="image-20210701223131264"></p><h1 id="_4-搭建分片集群" tabindex="-1"><a class="header-anchor" href="#_4-搭建分片集群" aria-hidden="true">#</a> 4.搭建分片集群</h1><h2 id="_4-1-集群结构" tabindex="-1"><a class="header-anchor" href="#_4-1-集群结构" aria-hidden="true">#</a> 4.1.集群结构</h2><p>分片集群需要的节点数量较多，这里我们搭建一个最小的分片集群，包含 3 个 master 节点，每个 master 包含一个 slave 节点，结构如下：</p><p><img src="'+R+`" alt="image-20210702164116027"></p><p>这里我们会在同一台虚拟机中开启 6 个 redis 实例，模拟分片集群，信息如下：</p><table><thead><tr><th style="text-align:center;">IP</th><th style="text-align:center;">PORT</th><th style="text-align:center;">角色</th></tr></thead><tbody><tr><td style="text-align:center;">192.168.150.101</td><td style="text-align:center;">7001</td><td style="text-align:center;">master</td></tr><tr><td style="text-align:center;">192.168.150.101</td><td style="text-align:center;">7002</td><td style="text-align:center;">master</td></tr><tr><td style="text-align:center;">192.168.150.101</td><td style="text-align:center;">7003</td><td style="text-align:center;">master</td></tr><tr><td style="text-align:center;">192.168.150.101</td><td style="text-align:center;">8001</td><td style="text-align:center;">slave</td></tr><tr><td style="text-align:center;">192.168.150.101</td><td style="text-align:center;">8002</td><td style="text-align:center;">slave</td></tr><tr><td style="text-align:center;">192.168.150.101</td><td style="text-align:center;">8003</td><td style="text-align:center;">slave</td></tr></tbody></table><h2 id="_4-2-准备实例和配置" tabindex="-1"><a class="header-anchor" href="#_4-2-准备实例和配置" aria-hidden="true">#</a> 4.2.准备实例和配置</h2><p>删除之前的 7001、7002、7003 这几个目录，重新创建出 7001、7002、7003、8001、8002、8003 目录：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 进入/tmp目录</span>
<span class="token builtin class-name">cd</span> /tmp
<span class="token comment"># 删除旧的，避免配置干扰</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> <span class="token number">7001</span> <span class="token number">7002</span> <span class="token number">7003</span>
<span class="token comment"># 创建目录</span>
<span class="token function">mkdir</span> <span class="token number">7001</span> <span class="token number">7002</span> <span class="token number">7003</span> <span class="token number">8001</span> <span class="token number">8002</span> <span class="token number">8003</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在/tmp 下准备一个新的 redis.conf 文件，内容如下：</p><div class="language-ini line-numbers-mode" data-ext="ini"><pre class="language-ini"><code>port 6379
<span class="token comment"># 开启集群功能</span>
cluster-enabled yes
<span class="token comment"># 集群的配置文件名称，不需要我们创建，由redis自己维护</span>
cluster-config-file /tmp/6379/nodes.conf
<span class="token comment"># 节点心跳失败的超时时间</span>
cluster-node-timeout 5000
<span class="token comment"># 持久化文件存放目录</span>
dir /tmp/6379
<span class="token comment"># 绑定地址</span>
bind 0.0.0.0
<span class="token comment"># 让redis后台运行</span>
daemonize yes
<span class="token comment"># 注册的实例ip</span>
replica-announce-ip 192.168.150.101
<span class="token comment"># 保护模式</span>
protected-mode no
<span class="token comment"># 数据库数量</span>
databases 1
<span class="token comment"># 日志</span>
logfile /tmp/6379/run.log
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将这个文件拷贝到每个目录下：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 进入/tmp目录</span>
<span class="token builtin class-name">cd</span> /tmp
<span class="token comment"># 执行拷贝</span>
<span class="token builtin class-name">echo</span> <span class="token number">7001</span> <span class="token number">7002</span> <span class="token number">7003</span> <span class="token number">8001</span> <span class="token number">8002</span> <span class="token number">8003</span> <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token parameter variable">-t</span> <span class="token parameter variable">-n</span> <span class="token number">1</span> <span class="token function">cp</span> redis.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改每个目录下的 redis.conf，将其中的 6379 修改为与所在目录一致：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 进入/tmp目录</span>
<span class="token builtin class-name">cd</span> /tmp
<span class="token comment"># 修改配置文件</span>
<span class="token builtin class-name">printf</span> <span class="token string">&#39;%s\\n&#39;</span> <span class="token number">7001</span> <span class="token number">7002</span> <span class="token number">7003</span> <span class="token number">8001</span> <span class="token number">8002</span> <span class="token number">8003</span> <span class="token operator">|</span> <span class="token function">xargs</span> -I<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token parameter variable">-t</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&#39;s/6379/{}/g&#39;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>/redis.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-3-启动" tabindex="-1"><a class="header-anchor" href="#_4-3-启动" aria-hidden="true">#</a> 4.3.启动</h2><p>因为已经配置了后台启动模式，所以可以直接启动服务：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 进入/tmp目录</span>
<span class="token builtin class-name">cd</span> /tmp
<span class="token comment"># 一键启动所有服务</span>
<span class="token builtin class-name">printf</span> <span class="token string">&#39;%s\\n&#39;</span> <span class="token number">7001</span> <span class="token number">7002</span> <span class="token number">7003</span> <span class="token number">8001</span> <span class="token number">8002</span> <span class="token number">8003</span> <span class="token operator">|</span> <span class="token function">xargs</span> -I<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token parameter variable">-t</span> redis-server <span class="token punctuation">{</span><span class="token punctuation">}</span>/redis.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过 ps 查看状态：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> redis
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>发现服务都已经正常启动：</p><p><img src="`+M+`" alt="image-20210702174255799"></p><p>如果要关闭所有进程，可以执行命令：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> redis <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;{print $2}&#39;</span> <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token function">kill</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>或者（推荐这种方式）：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">printf</span> <span class="token string">&#39;%s\\n&#39;</span> <span class="token number">7001</span> <span class="token number">7002</span> <span class="token number">7003</span> <span class="token number">8001</span> <span class="token number">8002</span> <span class="token number">8003</span> <span class="token operator">|</span> <span class="token function">xargs</span> -I<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token parameter variable">-t</span> redis-cli <span class="token parameter variable">-p</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token function">shutdown</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_4-4-创建集群" tabindex="-1"><a class="header-anchor" href="#_4-4-创建集群" aria-hidden="true">#</a> 4.4.创建集群</h2><p>虽然服务启动了，但是目前每个服务之间都是独立的，没有任何关联。</p><p>我们需要执行命令来创建集群，在 Redis5.0 之前创建集群比较麻烦，5.0 之后集群管理命令都集成到了 redis-cli 中。</p><p>1）Redis5.0 之前</p><p>Redis5.0 之前集群命令都是用 redis 安装包下的 src/redis-trib.rb 来实现的。因为 redis-trib.rb 是有 ruby 语言编写的所以需要安装 ruby 环境。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 安装依赖</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> zlib ruby rubygems
gem <span class="token function">install</span> redis
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后通过命令来管理集群：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 进入redis的src目录</span>
<span class="token builtin class-name">cd</span> /tmp/redis-6.2.4/src
<span class="token comment"># 创建集群</span>
./redis-trib.rb create <span class="token parameter variable">--replicas</span> <span class="token number">1</span> <span class="token number">192.168</span>.150.101:7001 <span class="token number">192.168</span>.150.101:7002 <span class="token number">192.168</span>.150.101:7003 <span class="token number">192.168</span>.150.101:8001 <span class="token number">192.168</span>.150.101:8002 <span class="token number">192.168</span>.150.101:8003
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2）Redis5.0 以后</p><p>我们使用的是 Redis6.2.4 版本，集群管理以及集成到了 redis-cli 中，格式如下：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-cli <span class="token parameter variable">--cluster</span> create --cluster-replicas <span class="token number">1</span> <span class="token number">192.168</span>.126.129:7001 <span class="token number">192.168</span>.126.129:7002 <span class="token number">192.168</span>.126.129:7003 <span class="token number">192.168</span>.126.129:8001 <span class="token number">192.168</span>.126.129:8002  <span class="token number">192.168</span>.126.129:8003
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>命令说明：</p><ul><li><code>redis-cli --cluster</code>或者<code>./redis-trib.rb</code>：代表集群操作命令</li><li><code>create</code>：代表是创建集群</li><li><code>--replicas 1</code>或者<code>--cluster-replicas 1</code> ：指定集群中每个 master 的副本个数为 1，此时<code>节点总数 ÷ (replicas + 1)</code> 得到的就是 master 的数量。因此节点列表中的前 n 个就是 master，其它节点都是 slave 节点，随机分配到不同 master</li></ul><p>运行后的样子：</p><p><img src="`+I+'" alt="image-20210702181101969"></p><p>这里输入 yes，则集群开始创建：</p><p><img src="'+P+`" alt="image-20210702181215705"></p><p>通过命令可以查看集群状态：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-cli <span class="token parameter variable">-p</span> <span class="token number">7001</span> cluster nodes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="`+w+`" alt="image-20210702181922809"></p><h2 id="_4-5-测试" tabindex="-1"><a class="header-anchor" href="#_4-5-测试" aria-hidden="true">#</a> 4.5.测试</h2><p>尝试连接 7001 节点，存储一个数据：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 连接</span>
redis-cli <span class="token parameter variable">-p</span> <span class="token number">7001</span>
<span class="token comment"># 存储数据</span>
<span class="token builtin class-name">set</span> num <span class="token number">123</span>
<span class="token comment"># 读取数据</span>
get num
<span class="token comment"># 再次存储</span>
<span class="token builtin class-name">set</span> a <span class="token number">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果悲剧了：</p><p><img src="`+O+`" alt="image-20210702182343979"></p><p>集群操作时，需要给<code>redis-cli</code>加上<code>-c</code>参数才可以：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-cli <span class="token parameter variable">-c</span> <span class="token parameter variable">-p</span> <span class="token number">7001</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这次可以了：</p><p><img src="`+q+'" alt="image-20210702182602145"></p>',100);function S(A,D){const i=t("router-link"),p=t("font");return c(),d("div",null,[T,s("nav",V,[s("ul",null,[s("li",null,[a(i,{to:"#_2-1-集群结构"},{default:e(()=>[n("2.1.集群结构")]),_:1})]),s("li",null,[a(i,{to:"#_2-2-准备实例和配置"},{default:e(()=>[n("2.2.准备实例和配置")]),_:1})]),s("li",null,[a(i,{to:"#_2-3-启动"},{default:e(()=>[n("2.3.启动")]),_:1})]),s("li",null,[a(i,{to:"#_2-4-开启主从关系"},{default:e(()=>[n("2.4.开启主从关系")]),_:1})]),s("li",null,[a(i,{to:"#_2-5-测试"},{default:e(()=>[n("2.5.测试")]),_:1})]),s("li",null,[a(i,{to:"#_3-1-集群结构"},{default:e(()=>[n("3.1.集群结构")]),_:1})]),s("li",null,[a(i,{to:"#_3-2-准备实例和配置"},{default:e(()=>[n("3.2.准备实例和配置")]),_:1})]),s("li",null,[a(i,{to:"#_3-3-启动"},{default:e(()=>[n("3.3.启动")]),_:1})]),s("li",null,[a(i,{to:"#_3-4-测试"},{default:e(()=>[n("3.4.测试")]),_:1})]),s("li",null,[a(i,{to:"#_4-1-集群结构"},{default:e(()=>[n("4.1.集群结构")]),_:1})]),s("li",null,[a(i,{to:"#_4-2-准备实例和配置"},{default:e(()=>[n("4.2.准备实例和配置")]),_:1})]),s("li",null,[a(i,{to:"#_4-3-启动"},{default:e(()=>[n("4.3.启动")]),_:1})]),s("li",null,[a(i,{to:"#_4-4-创建集群"},{default:e(()=>[n("4.4.创建集群")]),_:1})]),s("li",null,[a(i,{to:"#_4-5-测试"},{default:e(()=>[n("4.5.测试")]),_:1})])])]),z,s("p",null,[s("strong",null,[a(p,{color:"red"},{default:e(()=>[n("注意")]),_:1})]),n("：在 5.0 以后新增命令 replicaof，与 salveof 效果一致。")]),C])}const E=r(N,[["render",S],["__file","index.html.vue"]]);export{E as default};
