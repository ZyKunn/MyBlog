import{_ as e,r as o,o as c,c as u,a as n,e as t,w as p,b as s,d as i}from"./app-a153c100.js";const l="/MyBlog/assets/image-20231117141219478-ce57019e.png",r={},d=n("h1",{id:"ğŸŒˆes-ä¸­çš„-nested-æ•°æ®ç±»å‹",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#ğŸŒˆes-ä¸­çš„-nested-æ•°æ®ç±»å‹","aria-hidden":"true"},"#"),s(" ğŸŒˆES ä¸­çš„ Nested æ•°æ®ç±»å‹")],-1),k=n("hr",null,null,-1),v={class:"table-of-contents"},q=i(`<h2 id="å‰è¨€" tabindex="-1"><a class="header-anchor" href="#å‰è¨€" aria-hidden="true">#</a> å‰è¨€</h2><p>åœ¨å¼€å§‹ä¹‹å‰éœ€è¦æå‰ç†è§£ä¸€ä¸‹ä¸¤ç‚¹</p><ul><li>ä¸€ä¸ª object å­—æ®µåªèƒ½å­˜å…¥ä¸€ä¸ª JSON å¯¹è±¡, ä¸é€‚åˆå­˜å¯¹è±¡æ•°ç»„</li><li>å¦‚æœæƒ³è¦ä¸€ä¸ªå­—æ®µå­˜ä¸€ä¸ªå¯¹è±¡æ•°ç»„,å¯ä»¥ä½¿ç”¨ nested å­—æ®µç±»å‹</li></ul><p>åœ¨å·¥ä½œå¼€å‘ä¸­, æˆ‘ä»¬å¸¸é‡åˆ° 2 å¼ è¡¨ç¤º 1 å¯¹å¤šçš„å…³ç³»,è¿™æ ·çš„çˆ¶å­ç»“æ„, å¦‚æœç”¨ MySQL å­˜çš„è¯,å­è¡¨è®¾ä¸€ä¸ªå­—æ®µ parentId å­˜å‚¨çˆ¶è¡¨çš„ id,è¿™æ ·å°±å¯ä»¥ç”¨ join å…³è”æŸ¥è¯¢. é‚£ä¹ˆ ES ä½œä¸º NoSQL,å®ƒæœ‰æ›´ä¾¿æ·çš„å­˜å‚¨æ–¹å¼æ¥ä¿å­˜çˆ¶å­ç»“æ„:</p><ul><li>ç¬¬ä¸€ç§:join å­—æ®µç±»å‹,å­æ–‡æ¡£åŒ…å«çˆ¶æ–‡æ¡£ ID,å¯ç”¨ has_parent å’Œ has_child æ¥æŸ¥è¯¢</li><li>ç¬¬äºŒç§:nested å­—æ®µç±»å‹,å­æ–‡æ¡£å°±å­˜åœ¨çˆ¶æ–‡æ¡£æŸä¸ªå­—æ®µå†…éƒ¨,é€‚åˆå­æ–‡æ¡£æ•°é‡è¾ƒå°‘çš„æƒ…å†µ</li></ul><p>object å­˜å‚¨å¯¹è±¡æ•°ç»„çš„ç¼ºé™·, å¦‚æœè¦å­˜å¯¹è±¡æ•°ç»„, å¹¶ä¸”å¯¹æ•°ç»„ä¸­æ¯ä¸€ä¸ªå¯¹è±¡è¿›è¡Œå•ç‹¬æŸ¥è¯¢, ç”¨ nested ç±»å‹æ¯”è¾ƒåˆé€‚. ä½†æ˜¯ nested ç±»å‹é€‚åˆå­æ–‡æ¡£æ•°é‡è¾ƒå°‘æƒ…å†µ,æœ‰ es æœ‰å¦‚ä¸‹é»˜è®¤è®¾ç½®</p><ul><li>ä¸€ä¸ªæ–‡æ¡£æœ€å¤šæœ‰ 50 ä¸ª nested ç±»å‹çš„å­—æ®µ</li><li>ä¸€ä¸ªæ–‡æ¡£æ‰€æœ‰ nested ç±»å‹çš„å­—æ®µå­˜å‚¨æ–‡æ¡£æœ€å¤§æ•°é‡æ˜¯ 10000 æ¡</li></ul><h2 id="ä¸€-es-å¦‚ä½•å­˜å‚¨å¯¹è±¡" tabindex="-1"><a class="header-anchor" href="#ä¸€-es-å¦‚ä½•å­˜å‚¨å¯¹è±¡" aria-hidden="true">#</a> ï¼ˆä¸€ï¼‰ES å¦‚ä½•å­˜å‚¨å¯¹è±¡</h2><p>ElasticSearch ä¸­å¯ä»¥å°†æ•°æ®ä»¥å¯¹è±¡çš„æ–¹å¼å­˜å‚¨å¹¶æŸ¥è¯¢ï¼Œä½†æ˜¯ ES åº•å±‚çš„ Lucene æ²¡æœ‰å†…éƒ¨å¯¹è±¡çš„æ¦‚å¿µï¼Œå› æ­¤å¦‚æœ<strong>é€šè¿‡é»˜è®¤çš„æ–¹å¼</strong>å¾€ ES ä¸­æ’å…¥å¯¹è±¡**ã€æš‚ä¸”æˆ‘ä»¬å«ä»–ä¸º Object ç±»å‹ã€‘**ï¼ŒES ä¼šå°†å¯¹è±¡å±‚æ¬¡ç»“æ„æ‰å¹³åŒ–ä¸ºå­—æ®µåç§°å’Œå€¼çš„ç®€å•åˆ—è¡¨ã€‚ æ¯”å¦‚ä¸‹é¢è¿™ä¸€æ®µæ•°æ®ï¼š</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>PUT my_index/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;group&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;fans&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;user&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;first&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;last&quot;</span> <span class="token operator">:</span>  <span class="token string">&quot;Smith&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;first&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Alice&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;last&quot;</span> <span class="token operator">:</span>  <span class="token string">&quot;White&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ES å†…éƒ¨ä¼šå°†è¿™ä»½æ•°æ®å˜æˆä¸‹é¢è¿™ä¸ªæ ·å­ï¼š</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;group&quot;</span><span class="token operator">:</span> <span class="token string">&quot;fans&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;user.first&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;alice&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;john&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;user.last&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;smith&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;white&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¼ºå¤±äº†<strong>first</strong>å’Œ<strong>last</strong>ä¹‹é—´çš„å…³è”æ€§ã€‚æ¯”å¦‚è¿™ä¸ªæ—¶å€™æƒ³æŸ¥è¯¢ä¸€ä¸ª first ä¸º<strong>John</strong>ï¼Œlast ä¸º<strong>White</strong>çš„äººï¼Œç†è®ºä¸Šæ˜¯æ²¡æœ‰è¿™ä¸ªäººçš„ï¼Œä½†æ˜¯å®é™…ä¸Šåä¸º fans çš„è¿™ä¸ªç»„è¿˜æ˜¯è¢«æŸ¥å‡ºæ¥äº†ã€‚</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET my_index/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;user.first&quot;</span><span class="token operator">:</span> <span class="token string">&quot;John&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;user.last&quot;</span><span class="token operator">:</span>  <span class="token string">&quot;White&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œä¸¤æ¡æ•°æ®éƒ½è¢«æŸ¥è¯¢å‡ºæ¥äº†ã€‚</p><p><img src="`+l+`" alt="image-20231117141219478"></p><h2 id="äºŒ-nested-ç±»å‹" tabindex="-1"><a class="header-anchor" href="#äºŒ-nested-ç±»å‹" aria-hidden="true">#</a> ï¼ˆäºŒï¼‰Nested ç±»å‹</h2><p>è¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”¨åˆ°<strong>nested</strong>ï¼Œnested ç±»å‹æ˜¯ object æ•°æ®ç±»å‹çš„ç‰¹æ®Šç‰ˆæœ¬ï¼Œå®ƒå…è®¸å¯¹è±¡æ•°ç»„ä»¥ä¸€ç§å¯ä»¥ç›¸äº’ç‹¬ç«‹æŸ¥è¯¢çš„æ–¹å¼è¿›è¡Œç´¢å¼•ã€‚</p><p>åœ¨ Nested å†…éƒ¨ï¼Œæ¯ä¸ªå¯¹è±¡ç´¢å¼•å…¶å®æ˜¯ä¸€ä¸ªå•ç‹¬çš„éšè—æ–‡æ¡£ï¼Œè¿™æ„å‘³ç€æ¯ä¸ªåµŒå¥—å¯¹è±¡éƒ½å¯ä»¥ç‹¬ç«‹äºå…¶ä»–å¯¹è±¡è¿›è¡ŒæŸ¥è¯¢ã€‚</p><p>ä½¿ç”¨ Nested éœ€è¦å…ˆåˆ›å»ºç´¢å¼•ï¼Œä¾æ—§é€šè¿‡ä¸Šè¾¹çš„è¿™ä¸ªä¾‹å­</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>DELETE my_index

PUT my_index
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;user&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nested&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

PUT my_index/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;group&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;fans&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;user&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;first&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;last&quot;</span> <span class="token operator">:</span>  <span class="token string">&quot;Smith&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;age&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;23&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;first&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Alice&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;last&quot;</span> <span class="token operator">:</span>  <span class="token string">&quot;White&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;age&quot;</span><span class="token operator">:</span><span class="token string">&quot;24&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é¦–å…ˆåˆ›å»º my_index ç´¢å¼•ï¼Œè®¾ç½® user çš„ç±»å‹ä¸º nestedï¼Œæ¥ç€åœ¨æŸ¥è¯¢æ—¶ï¼Œéœ€è¦é€šè¿‡ es çš„ nested æŸ¥è¯¢è¯­å¥æŸ¥è¯¢ï¼Œä½¿ç”¨åŒæ ·çš„æ–¹å¼æŸ¥è¯¢ first ä¸º Johnï¼Œlast ä¸º White çš„ç”¨æˆ·ï¼Œè¿™æ¬¡çš„ç»“æœæ˜¯ä¸å­˜åœ¨ã€‚å› ä¸ºé€šè¿‡ nested å­˜å‚¨çš„å¯¹è±¡æ˜¯å…·æœ‰å…³è”æ€§çš„ã€‚</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET my_index/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span> <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;user.first&quot;</span><span class="token operator">:</span> <span class="token string">&quot;John&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;user.last&quot;</span><span class="token operator">:</span>  <span class="token string">&quot;White&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¾¹çš„ DSL è¯­å¥ç”¨ Java API å®ç°å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testNested</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
    <span class="token comment">//è‡ªå·±å°è£…çš„ä¸€ä¸ªè·å–RestHighLevelClientçš„ç±»</span>
    <span class="token class-name">RestHighLevelClient</span> client<span class="token operator">=</span><span class="token class-name">ElasticSearchClient</span><span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">&quot;my_index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BoolQueryBuilder</span> boolQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boolQueryBuilder<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;user.first&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;John&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boolQueryBuilder<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;user.last&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;White&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">nestedQuery</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>boolQueryBuilder<span class="token punctuation">,</span> <span class="token class-name">ScoreMode<span class="token punctuation">.</span>None</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchResponse</span> search <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> search<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> hits<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SearchHit</span> hit <span class="token operator">=</span> hits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ä¸‰-ä½¿ç”¨-nested-è¿›è¡ŒèšåˆæŸ¥è¯¢" tabindex="-1"><a class="header-anchor" href="#ä¸‰-ä½¿ç”¨-nested-è¿›è¡ŒèšåˆæŸ¥è¯¢" aria-hidden="true">#</a> ï¼ˆä¸‰ï¼‰ä½¿ç”¨ nested è¿›è¡ŒèšåˆæŸ¥è¯¢</h2><p>é™¤äº†ä½¿ç”¨ nested è¿›è¡Œæ™®é€šæŸ¥è¯¢å¤–ï¼Œnested ä¹Ÿæ”¯æŒèšåˆæŸ¥è¯¢ï¼ŒåŒæ ·æ˜¯ä¸Šé¢çš„ä¾‹å­ï¼Œç°åœ¨åšä¸€ä¸ªå¯¹å¹´é¾„èšåˆçš„æ“ä½œï¼š</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET my_index/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;nestedAgg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;user&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;ageAgg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;user.age.keyword&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="å››-nested-ä¸­çš„-inner-hits" tabindex="-1"><a class="header-anchor" href="#å››-nested-ä¸­çš„-inner-hits" aria-hidden="true">#</a> ï¼ˆå››ï¼‰nested ä¸­çš„ inner_hits</h2><p>æŸ¥è¯¢ nested å¯¹è±¡æ—¶ï¼Œåªè¦æŸ¥è¯¢æ¡ä»¶ç¬¦åˆè¿™ä¸ª nested å¯¹è±¡é‡Œçš„æŸä¸€ä¸ªæ¡ä»¶ï¼Œæ•´ä¸ª nested å¯¹è±¡éƒ½ä¼šè¢«æ£€ç´¢å‡ºæ¥ã€‚æ¯”å¦‚ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘åªæƒ³æŸ¥è¯¢å«åš John Smith çš„è¿™ä¸ªäººï¼Œä½†æ˜¯é€šè¿‡æ™®é€šçš„ query æŸ¥è¯¢ä¼šæŠŠæ•´æ¡è®°å½•éƒ½æŸ¥è¯¢å‡ºæ¥ï¼Œæ•ˆæœå°±æ˜¯è¿™æ ·ï¼š</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token property">&quot;hits&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;my_index&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_score&quot;</span> <span class="token operator">:</span> <span class="token number">1.3862942</span><span class="token punctuation">,</span>
        <span class="token property">&quot;_source&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;group&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;fans&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;user&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
              <span class="token property">&quot;first&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span>
              <span class="token property">&quot;last&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Smith&quot;</span><span class="token punctuation">,</span>
              <span class="token property">&quot;age&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;23&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
              <span class="token property">&quot;first&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Alice&quot;</span><span class="token punctuation">,</span>
              <span class="token property">&quot;last&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;White&quot;</span><span class="token punctuation">,</span>
              <span class="token property">&quot;age&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;24&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœåªæƒ³è¦ nested ä¸­é‡Œçš„ä¸€ä¸ªå¯¹è±¡ï¼Œå°±å¯ä»¥ä½¿ç”¨ inner_hitsã€‚ä½¿ç”¨æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦åœ¨æŸ¥è¯¢è¯­å¥ä¹‹ååŠ ä¸Š inner_hits å³å¯ã€‚</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET my_index/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;nested&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span> <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;user.first&quot;</span><span class="token operator">:</span> <span class="token string">&quot;John&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;user.last&quot;</span><span class="token operator">:</span>  <span class="token string">&quot;Smith&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;inner_hits&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æŸ¥è¯¢ç»“æœé‡Œå°±ä¼šå¤šå‡ºæ¥ä¸€å—æ•°æ®ï¼Œé‡Œé¢å°±åªä¼šå±•ç¤ºå…·ä½“çš„ nested å¯¹è±¡ï¼š</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token property">&quot;inner_hits&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;user&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;hits&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;total&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;value&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token property">&quot;relation&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;eq&quot;</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token property">&quot;max_score&quot;</span> <span class="token operator">:</span> <span class="token number">1.3862942</span><span class="token punctuation">,</span>
              <span class="token property">&quot;hits&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                  <span class="token property">&quot;_index&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;my_index&quot;</span><span class="token punctuation">,</span>
                  <span class="token property">&quot;_type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span>
                  <span class="token property">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
                  <span class="token property">&quot;_nested&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;field&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;offset&quot;</span> <span class="token operator">:</span> <span class="token number">0</span>
                  <span class="token punctuation">}</span><span class="token punctuation">,</span>
                  <span class="token property">&quot;_score&quot;</span> <span class="token operator">:</span> <span class="token number">1.3862942</span><span class="token punctuation">,</span>
                  <span class="token property">&quot;_source&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;last&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Smith&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;first&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;age&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;23&quot;</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="äº”-nested-çš„ä½¿ç”¨å»ºè®®" tabindex="-1"><a class="header-anchor" href="#äº”-nested-çš„ä½¿ç”¨å»ºè®®" aria-hidden="true">#</a> ï¼ˆäº”ï¼‰nested çš„ä½¿ç”¨å»ºè®®</h2><p>nested å¯ä»¥å¾ˆå¥½åœ°å­˜å‚¨å’ŒæŸ¥è¯¢å¯¹è±¡ç±»å‹æ•°æ®ï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½æ»¥ç”¨ nestedã€‚æ¯ä¸ª nested å¯¹è±¡éƒ½è¢«ç´¢å¼•ä¸ºä¸€ä¸ªå•ç‹¬çš„æ–‡æ¡£ï¼Œç®€å•æ¥è®²å°±æ˜¯å¦‚æœä¸€ä¸ªç´¢å¼•é‡ŒåŒ…å« 100 ä¸ª user å¯¹è±¡ï¼Œé‚£ä¹ˆåœ¨å®é™…åº•å±‚å°†åˆ›å»º 101 ä¸ª Lucene æ–‡æ¡£ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ¶ˆè€—ã€‚</p><p>nested ç±»å‹åªåº”åœ¨ç‰¹æ®Šæƒ…å†µä¸‹ä½¿ç”¨ï¼Œä¸€ä¸ªç´¢å¼•åœ¨åˆ›å»ºçš„æ—¶å€™ï¼Œnested ç±»å‹çš„å¯¹è±¡é»˜è®¤ä¸èƒ½è¶…è¿‡ 50 ä¸ªï¼Œå¯é€šè¿‡<code>index.mapping.nested_fields.limit</code>ä¿®æ”¹ã€‚</p><p>ä¸€ä¸ªå…·ä½“çš„æ–‡æ¡£ä¸­ï¼Œnested ç±»å‹ä¸­åŒ…å«çš„åµŒå¥—å¯¹è±¡çš„æ•°é‡é»˜è®¤ä¸èƒ½è¶…è¿‡ 10000 ä¸ªï¼Œä¹Ÿå°±æ˜¯è¯´ä¸Šé¢åˆ›å»ºçš„ user åœ¨ä¸€ä¸ªæ–‡æ¡£é‡Œä¸èƒ½è¶…è¿‡ 10000 ä¸ªï¼Œå¯é€šè¿‡<code>index.mapping.nested_objects.limit</code>ä¿®æ”¹ã€‚</p>`,39);function m(b,h){const a=o("router-link");return c(),u("div",null,[d,k,n("nav",v,[n("ul",null,[n("li",null,[t(a,{to:"#å‰è¨€"},{default:p(()=>[s("å‰è¨€")]),_:1})]),n("li",null,[t(a,{to:"#ä¸€-es-å¦‚ä½•å­˜å‚¨å¯¹è±¡"},{default:p(()=>[s("ï¼ˆä¸€ï¼‰ES å¦‚ä½•å­˜å‚¨å¯¹è±¡")]),_:1})]),n("li",null,[t(a,{to:"#äºŒ-nested-ç±»å‹"},{default:p(()=>[s("ï¼ˆäºŒï¼‰Nested ç±»å‹")]),_:1})]),n("li",null,[t(a,{to:"#ä¸‰-ä½¿ç”¨-nested-è¿›è¡ŒèšåˆæŸ¥è¯¢"},{default:p(()=>[s("ï¼ˆä¸‰ï¼‰ä½¿ç”¨ nested è¿›è¡ŒèšåˆæŸ¥è¯¢")]),_:1})]),n("li",null,[t(a,{to:"#å››-nested-ä¸­çš„-inner-hits"},{default:p(()=>[s("ï¼ˆå››ï¼‰nested ä¸­çš„ inner_hits")]),_:1})]),n("li",null,[t(a,{to:"#äº”-nested-çš„ä½¿ç”¨å»ºè®®"},{default:p(()=>[s("ï¼ˆäº”ï¼‰nested çš„ä½¿ç”¨å»ºè®®")]),_:1})])])]),q])}const y=e(r,[["render",m],["__file","index.html.vue"]]);export{y as default};
